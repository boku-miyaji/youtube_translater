# Commit Diff Summary - 20251101220645

## Commit Information

**Commit Hash**: d8b0440
**Branch**: feature/implement-28
**Date**: 2025-11-01
**Parent Commit**: 4661a30

## Summary

YouTube transcript 抽出のエラーレスポンス形式を改善し、bot 検出エラーへの対応を追加しました。JSON.stringify を使った文字列化から、専用のエラークラスと toJSON() メソッドによる構造化されたエラーレスポンスに変更しました。

## 問題点（Before）

### JSON 文字列化されたエラーメッセージ

**エラー出力例:**
```json
{
  "error": "{\"message\": \"文字起こしの抽出に失敗しました\", \"reasons\": {...}, \"suggestions\": [...]}"
}
```

**問題:**
- エラーオブジェクトが JSON 文字列として返される
- クライアント側でパースが必要
- 読みにくく、デバッグが困難
- 適切な型情報が失われる

### YouTube bot 検出エラーが特定されない

**エラー例:**
```
Whisper文字起こし失敗: 音声ダウンロード失敗: Sign in to confirm you're not a bot
```

**問題:**
- YouTube の bot 検出が原因とわからない
- 一般的なネットワークエラーと同じ扱い
- ユーザーへの適切な対処方法が提示されない

## 改善内容（After）

### 1. TranscriptExtractionError クラスの作成

**新規エラークラス (lines 951-975):**
```typescript
class TranscriptExtractionError extends Error {
  reasons: {
    subtitle: string;
    whisper: string;
  };
  suggestions: string[];
  statusCode: number;

  constructor(message: string, reasons: { subtitle: string; whisper: string }, suggestions: string[]) {
    super(message);
    this.name = 'TranscriptExtractionError';
    this.reasons = reasons;
    this.suggestions = suggestions;
    this.statusCode = 500;
  }

  toJSON() {
    return {
      message: this.message,
      reasons: this.reasons,
      suggestions: this.suggestions
    };
  }
}
```

**利点:**
- ✅ 専用の型定義で型安全性向上
- ✅ toJSON() メソッドで適切なシリアライゼーション
- ✅ 構造化されたエラー情報
- ✅ エラーハンドリングの一貫性

### 2. YouTube Bot 検出ロジックの追加

**Bot 検出コード (lines 2503-2505):**
```typescript
const isBotCheckError = whisperErrorMsg.includes('Sign in to confirm') ||
                        whisperErrorMsg.includes('not a bot');
```

**検出パターン:**
- "Sign in to confirm" を含むエラー
- "not a bot" を含むエラー

### 3. コンテキスト依存の提案メッセージ

**Before (固定の提案):**
```typescript
suggestions: [
  subtitleError
    ? '字幕付きの動画を使用するか、別の言語を試してください'
    : '字幕が利用できない動画です。OpenAI APIキーが正しく設定されているか確認してください',
  'ネットワーク接続を確認してください',
  '動画のURLが正しいか確認してください'
]
```

**After (コンテキスト依存の提案) (lines 2506-2519):**
```typescript
const suggestions: string[] = [];

if (isBotCheckError) {
  suggestions.push('YouTube が bot として検出しています。字幕付きの動画を使用してください');
  suggestions.push('別の動画を試すか、しばらく待ってから再試行してください');
} else if (subtitleError) {
  suggestions.push('字幕付きの動画を使用するか、別の言語を試してください');
} else {
  suggestions.push('字幕が利用できない動画です。OpenAI APIキーが正しく設定されているか確認してください');
}

suggestions.push('ネットワーク接続を確認してください');
suggestions.push('動画のURLが正しいか確認してください');
```

**改善点:**
- ✅ Bot 検出時に特定のガイダンスを表示
- ✅ エラーの原因に応じた対処方法
- ✅ より具体的で実行可能な提案

### 4. エラースロー方法の変更

**Before:**
```typescript
const detailedError = {
  message: '文字起こしの抽出に失敗しました',
  reasons: { ... },
  suggestions: [ ... ]
};

throw new Error(JSON.stringify(detailedError, null, 2));
```

**After (lines 2522-2529):**
```typescript
throw new TranscriptExtractionError(
  '文字起こしの抽出に失敗しました',
  {
    subtitle: subtitleFailureReason,
    whisper: `Whisper文字起こし失敗: ${whisperErrorMsg}`
  },
  suggestions
);
```

**利点:**
- ✅ 型安全なエラー生成
- ✅ JSON.stringify 不要
- ✅ エラーの意図が明確

### 5. エラーハンドリングの改善

**Before:**
```typescript
} catch (error) {
  console.error('Error in /api/upload-youtube:', error);

  if (progressId) {
    analysisProgressDB.completeAnalysis(progressId, false, error instanceof Error ? error.message : 'Unknown error');
  }

  res.status(500).json({ error: error instanceof Error ? error.message : 'Unknown error' });
}
```

**After (lines 2696-2713):**
```typescript
} catch (error) {
  console.error('Error in /api/upload-youtube:', error);

  if (progressId) {
    analysisProgressDB.completeAnalysis(progressId, false, error instanceof Error ? error.message : 'Unknown error');
  }

  // Handle TranscriptExtractionError with detailed information
  if (error instanceof TranscriptExtractionError) {
    return res.status(error.statusCode).json({
      error: error.toJSON()
    });
  }

  // Handle generic errors
  res.status(500).json({ error: error instanceof Error ? error.message : 'Unknown error' });
}
```

**改善点:**
- ✅ TranscriptExtractionError を特別扱い
- ✅ toJSON() で適切にシリアライズ
- ✅ 他のエラーは従来通りの処理

## 変更されたファイル

```
 src/server.ts | 74 +++++++++++++++++++++++++++++++++++++++++++++++------------
 1 file changed, 59 insertions(+), 15 deletions(-)
```

## エラーレスポンスの比較

### Before: JSON 文字列化

**レスポンス:**
```json
{
  "error": "{\"message\":\"文字起こしの抽出に失敗しました\",\"reasons\":{\"subtitle\":\"字幕が利用不可（動画に字幕がないか、指定言語の字幕がありません）\",\"whisper\":\"Whisper文字起こし失敗: 音声ダウンロード失敗: Sign in to confirm you're not a bot\"},\"suggestions\":[\"字幕が利用できない動画です。OpenAI APIキーが正しく設定されているか確認してください\",\"ネットワーク接続を確認してください\",\"動画のURLが正しいか確認してください\"]}"
}
```

**問題:**
- 読みにくい
- パースが必要
- 型情報なし

### After: 構造化オブジェクト

**レスポンス:**
```json
{
  "error": {
    "message": "文字起こしの抽出に失敗しました",
    "reasons": {
      "subtitle": "字幕が利用不可（動画に字幕がないか、指定言語の字幕がありません）",
      "whisper": "Whisper文字起こし失敗: 音声ダウンロード失敗: Sign in to confirm you're not a bot"
    },
    "suggestions": [
      "YouTube が bot として検出しています。字幕付きの動画を使用してください",
      "別の動画を試すか、しばらく待ってから再試行してください",
      "ネットワーク接続を確認してください",
      "動画のURLが正しいか確認してください"
    ]
  }
}
```

**利点:**
- ✅ そのまま読める
- ✅ パース不要
- ✅ 構造化された情報
- ✅ Bot 検出を明示

## YouTube Bot 検出エラーの処理フロー

```
YouTube 動画処理
  ↓
字幕取得 → 失敗
  ↓
Whisper 文字起こし
  ↓
音声ダウンロード → 失敗
  ↓
エラーメッセージ: "Sign in to confirm you're not a bot"
  ↓
Bot 検出チェック ✓
  ↓
専用の提案メッセージ生成:
  - "YouTube が bot として検出しています"
  - "字幕付きの動画を使用してください"
  - "別の動画を試すか、しばらく待ってから再試行してください"
  ↓
TranscriptExtractionError を throw
  ↓
/api/upload-youtube catch block
  ↓
instanceof TranscriptExtractionError? → Yes
  ↓
error.toJSON() で構造化レスポンス返却
```

## エラーメッセージの例

### ケース1: Bot 検出エラー

**エラー内容:**
```json
{
  "message": "文字起こしの抽出に失敗しました",
  "reasons": {
    "subtitle": "字幕が利用不可（動画に字幕がないか、指定言語の字幕がありません）",
    "whisper": "Whisper文字起こし失敗: 音声ダウンロード失敗: Sign in to confirm you're not a bot. This helps protect our community."
  },
  "suggestions": [
    "YouTube が bot として検出しています。字幕付きの動画を使用してください",
    "別の動画を試すか、しばらく待ってから再試行してください",
    "ネットワーク接続を確認してください",
    "動画のURLが正しいか確認してください"
  ]
}
```

**ユーザーへの指示:**
- YouTube が bot として検出している
- 字幕付き動画を使用する必要がある
- または、しばらく待ってから再試行

### ケース2: 字幕エラー（Bot なし）

**エラー内容:**
```json
{
  "message": "文字起こしの抽出に失敗しました",
  "reasons": {
    "subtitle": "字幕取得エラー: No subtitles available",
    "whisper": "Whisper文字起こし失敗: OpenAI API key is not configured"
  },
  "suggestions": [
    "字幕付きの動画を使用するか、別の言語を試してください",
    "ネットワーク接続を確認してください",
    "動画のURLが正しいか確認してください"
  ]
}
```

**ユーザーへの指示:**
- 字幕が利用できない
- OpenAI API キーが設定されていない
- 字幕付き動画を使用するか、API キーを設定

### ケース3: API キー未設定（Bot なし、字幕エラーなし）

**エラー内容:**
```json
{
  "message": "文字起こしの抽出に失敗しました",
  "reasons": {
    "subtitle": "字幕が利用不可（動画に字幕がないか、指定言語の字幕がありません）",
    "whisper": "Whisper文字起こし失敗: OpenAI API key is not configured. Cannot use Whisper transcription."
  },
  "suggestions": [
    "字幕が利用できない動画です。OpenAI APIキーが正しく設定されているか確認してください",
    "ネットワーク接続を確認してください",
    "動画のURLが正しいか確認してください"
  ]
}
```

**ユーザーへの指示:**
- OpenAI API キーが必要
- または字幕付き動画を使用

## 技術的な改善点

### 型安全性

**Before:**
```typescript
throw new Error(JSON.stringify(detailedError, null, 2));
// Error の message に JSON 文字列が入る
// 型情報なし
```

**After:**
```typescript
throw new TranscriptExtractionError(message, reasons, suggestions);
// 専用のエラークラス
// 型定義あり
// toJSON() で適切にシリアライズ
```

### エラーハンドリングの明確さ

**Before:**
```typescript
res.status(500).json({ error: error.message }); // JSON 文字列が入る
```

**After:**
```typescript
if (error instanceof TranscriptExtractionError) {
  return res.status(error.statusCode).json({
    error: error.toJSON() // 構造化オブジェクトを返す
  });
}
```

### 保守性

- ✅ TranscriptExtractionError クラスで一元管理
- ✅ エラーフォーマットが統一
- ✅ テストが書きやすい
- ✅ 将来的な拡張が容易

## テスト項目

### 手動テスト

- [ ] Bot 検出エラー時の提案メッセージが適切か
- [ ] エラーレスポンスが JSON オブジェクトとして返されるか
- [ ] 字幕エラー時の提案メッセージが適切か
- [ ] API キー未設定時の提案メッセージが適切か

### 期待される結果

1. **構造化されたエラーレスポンス**
   - JSON 文字列ではなくオブジェクトで返却
   - reasons と suggestions が適切に構造化

2. **Bot 検出時の適切な提案**
   - "YouTube が bot として検出" というメッセージ
   - 字幕付き動画使用の推奨
   - 再試行の提案

3. **コンテキスト依存の提案**
   - Bot エラー: YouTube bot 検出の説明
   - 字幕エラー: 別の言語や字幕付き動画の推奨
   - API キーエラー: API キー設定の確認

## クライアント側への影響

### Before
```typescript
// クライアント側でパースが必要
const errorMessage = JSON.parse(errorData.error);
console.log(errorMessage.suggestions);
```

### After
```typescript
// そのままアクセス可能
console.log(errorData.error.suggestions);
```

## 影響範囲

### サーバー側 (src/server.ts)
- ✅ TranscriptExtractionError クラス追加 (lines 951-975)
- ✅ Bot 検出ロジック追加 (lines 2503-2519)
- ✅ コンテキスト依存の提案生成 (lines 2506-2519)
- ✅ エラーハンドリング改善 (lines 2696-2713)

### 後方互換性
- ✅ 既存の正常系フローに影響なし
- ✅ 他のエラータイプは従来通りの処理
- ⚠️ クライアント側でエラー構造の変更に対応が必要

### セキュリティ
- ✅ API キーなどの機密情報は含まれない
- ✅ 内部パスは公開しない
- ✅ ユーザーフレンドリーなメッセージのみ

## パフォーマンス

- ✅ JSON.stringify のオーバーヘッド削減
- ✅ toJSON() は必要時のみ呼ばれる
- ✅ エラー処理のパフォーマンスに影響なし

## Next Steps

このコミットにより、YouTube transcript 抽出のエラーレスポンス形式が改善され、bot 検出エラーへの対応が追加されました。

**将来的な改善:**
1. クライアント側での構造化エラー表示の実装
2. Bot 検出時の自動リトライロジック
3. エラーメトリクスの収集
4. エラーメッセージの多言語対応

**クライアント側の対応が必要:**
```typescript
// エラーレスポンスの構造が変更されたため、クライアント側で対応が必要
if (errorData.error && typeof errorData.error === 'object') {
  // 新しい構造化エラー
  const { message, reasons, suggestions } = errorData.error;
  // 適切に表示
} else if (typeof errorData.error === 'string') {
  // 従来の文字列エラー（後方互換性）
  // または他のエンドポイントのエラー
}
```
