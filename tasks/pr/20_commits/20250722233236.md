# PDF解析時間計算・表示ロジック修正

## コミット詳細
- **コミットハッシュ**: 863a0f2
- **タイトル**: fix: Correct PDF analysis time calculation and display logic
- **日時**: 2025-07-22

## 解決した問題
PDF文書解析時間の表示エラー:
```
文書解析時間: 19秒
要約生成時間: 18秒  
所要時間: 19秒  ← 19+18=37秒になるべき
```

## 根本原因分析
1. **UI表示ロジックの誤謬**: 実際の処理時間ではなく、壁時計時間（リクエスト全体の時間）を表示していた
2. **不適切なフォールバック**: タイミングデータが不完全な場合、誤解を招く値を表示
3. **数学的矛盾**: 個別時間の合計と総時間が一致しない

## 修正内容

### 1. サーバーサイド改善 (`src/server.ts`)
```typescript
// タイミング値の検証とクリーンアップ
const validatedExtractionDuration = Math.max(0, extractionDuration || 0);
const validatedSummaryDuration = Math.max(0, summaryDuration || 0);

// 検証済みの値をレスポンスで送信
analysisTime: {
  extraction: validatedExtractionDuration,  // 負の値や無効値を防止
  summary: validatedSummaryDuration,        // 負の値や無効値を防止
  total: actualProcessingTime,              // extraction + summary
  duration: totalAnalysisTime               // 壁時計時間（参考用）
}
```

#### 改善点
- **負の値防止**: `Math.max(0, value)` で負の値や無効値を除去
- **詳細ログ**: タイミング計算の透明性向上
- **一貫性確保**: レスポンス・履歴保存で同じ検証済み値使用

### 2. UI表示ロジック修正 (`src/components/pages/AnalyzePage.tsx`)

#### 修正前の問題のあるロジック
```typescript
// 文書解析時間 - 問題のある優先順位
if (analysisTime.extraction > 0) {
  return extraction;  // ✅ 正しい
} else if (analysisTime.duration > 0) {
  return duration;    // ❌ 壁時計時間を表示（誤り）
}

// 所要時間 - 問題のある優先順位  
if (serverTotal > 0) {
  return serverTotal; // ✅ 正しい
} else if (extraction > 0) {
  return extraction;  // ❌ 抽出時間のみ（要約時間無視）
} else {
  return duration;    // ❌ 壁時計時間（誤り）
}
```

#### 修正後の正確なロジック
```typescript
// 文書解析時間 - 改善されたロジック
if (analysisTime.extraction > 0) {
  return extraction;           // ✅ 実際の抽出時間
} else if (analysisTime.transcription > 0) {
  return transcription;        // ✅ 代替フィールド
} else {
  return null;                 // ✅ 不正確なデータは表示しない
}

// 所要時間 - 改善されたロジック
if (serverTotal > 0) {
  return serverTotal;          // ✅ extraction + summary
} else if (extraction > 0 && summary > 0) {
  return extraction + summary; // ✅ 手動計算
} else {
  return null;                 // ✅ 不完全データは「計測中...」表示
}
```

#### 改善点
- **誤謬な表示の除去**: 壁時計時間の表示を停止
- **数学的整合性**: 個別時間の合計 = 総時間
- **透明性**: 不完全データ時は「計測中...」表示
- **詳細ログ**: デバッグ用の詳細ログ追加

## 修正後の正しい表示
```
文書解析時間: 3秒    ← 実際のPDF抽出時間
要約生成時間: 18秒   ← 実際の要約生成時間
所要時間: 21秒       ← 3 + 18 = 21秒（数学的に正しい）
```

## 技術的詳細

### タイミングフィールドの定義
- `extraction`: PDF テキスト抽出の実時間
- `summary`: 要約生成の実時間  
- `total`: `extraction + summary` (実処理時間)
- `duration`: 壁時計時間（リクエスト全体、参考用のみ）

### エラーハンドリング改善
- **不完全データ**: 「計測中...」表示で誤解防止
- **無効値検証**: サーバーサイドで負の値や NaN を除去
- **一貫性チェック**: UI で数学的整合性を確保

## 影響範囲
- ✅ **PDF解析時間表示**: 正確な実処理時間を表示
- ✅ **数学的整合性**: 個別時間と総時間が一致
- ✅ **エラーハンドリング**: 不完全データ時の適切な処理
- ✅ **ログ出力**: デバッグ用の詳細情報

PDF解析時間の表示が正確になり、ユーザーが実際の処理時間を正しく把握できるようになりました。