# å®Ÿè£…å·®åˆ†ãƒ¬ãƒãƒ¼ãƒˆ - PDF Invalid Dateã‚¨ãƒ©ãƒ¼ã¨PDFæ–™é‡‘ä½“ç³»ã®å®Œå…¨ä¿®æ­£

## å•é¡Œã®è©³ç´°

### 1. analyzeç”»é¢ã§ã®PDF Invalid Dateã‚¨ãƒ©ãƒ¼
- **ç—‡çŠ¶**: AnalyzePage.tsxã§PDFè¡¨ç¤ºæ™‚ã«ã€ŒInvalid Dateã€ã‚¨ãƒ©ãƒ¼ãŒç¶™ç¶šçš„ã«ç™ºç”Ÿ
- **åŸå› **: 1728è¡Œç›®ã€1739è¡Œç›®ã€1574è¡Œç›®ã§`new Date()`ã«ç„¡åŠ¹ãªå€¤ãŒæ¸¡ã•ã‚Œã‚‹
- **å½±éŸ¿**: PDFé–¢é€£ãƒšãƒ¼ã‚¸ã§ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚¯ãƒ©ãƒƒã‚·ãƒ¥

### 2. PDFæ–™é‡‘ä½“ç³»ã®æ··ä¹±
- **ç—‡çŠ¶**: PDFã®æ–™é‡‘ãŒwhisperCostã¨ã—ã¦è¨ˆä¸Šã•ã‚Œã€æ··ä¹±ã‚’æ‹›ã
- **åŸå› **: PDFã¯PDF parserã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ã®ã«Whisperæ–™é‡‘ä½“ç³»ã§å‡¦ç†
- **å½±éŸ¿**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«èª¤è§£ã‚’ä¸ãˆã‚‹æ–™é‡‘è¡¨ç¤º

## å®Ÿè£…ã—ãŸåŒ…æ‹¬çš„ä¿®æ­£

### 1. AnalyzePage.tsx - å®‰å…¨ãªDateå‡¦ç†ã®å®Ÿè£…

#### formatSafeDateé–¢æ•°ã®è¿½åŠ 
```typescript
const formatSafeDate = (timestamp: string | undefined | null, fallback: string = 'ä¸æ˜'): string => {
  try {
    if (!timestamp) return fallback
    const date = new Date(timestamp)
    if (isNaN(date.getTime())) return fallback
    return date.toLocaleString('ja-JP', {
      month: 'short',
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    })
  } catch {
    return fallback
  }
}
```

#### å±é™ºãªDateå‡¦ç†ã®ä¿®æ­£
- **Before**: `new Date(currentVideo.analysisTime.startTime).toLocaleString(...)`
- **After**: `formatSafeDate(currentVideo.analysisTime.startTime)`

#### ä¿®æ­£ç®‡æ‰€
- 1728è¡Œç›®: è§£æé–‹å§‹æ™‚é–“ã®è¡¨ç¤º
- 1739è¡Œç›®: è§£æçµ‚äº†æ™‚é–“ã®è¡¨ç¤º  
- 1574è¡Œç›®: ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ—¥æ™‚ã®è¡¨ç¤º

### 2. PDFæ–™é‡‘ä½“ç³»ã®æ•´å‚™

#### types/index.ts - ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹æ‹¡å¼µ
```typescript
// CostEntryã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã®æ‹¡å¼µ
export interface CostEntry {
  // æ—¢å­˜ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰...
  pdfCost?: number;  // PDFå‡¦ç†å°‚ç”¨ã‚³ã‚¹ãƒˆ
  method?: 'subtitle' | 'whisper' | 'pdf';  // PDFãƒ¡ã‚½ãƒƒãƒ‰è¿½åŠ 
  service?: 'whisper' | 'gpt' | 'pdf' | 'total';  // PDFã‚µãƒ¼ãƒ“ã‚¹è¿½åŠ 
}

// SessionCostsã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã®æ‹¡å¼µ
export interface SessionCosts {
  whisper: number;
  gpt: number;
  pdf: number;  // PDFå‡¦ç†ã‚³ã‚¹ãƒˆè¿½è·¡
  total: number;
}
```

#### server.ts - PDFæ–™é‡‘è¨ˆç®—ã®ä¿®æ­£
```typescript
// PDFæ–™é‡‘ã‚¨ãƒ³ãƒˆãƒªã®ç”Ÿæˆ
const costEntry: CostEntry = {
  videoId: fileId,
  title: pdfMetadata?.title || fileName,
  method: 'pdf', // 'subtitle'ã‹ã‚‰'pdf'ã«å¤‰æ›´
  language,
  gptModel,
  whisperCost: 0,
  gptCost: summaryCost,
  pdfCost: 0, // PDFè§£æã¯ç¾åœ¨ç„¡æ–™
  totalCost: summaryCost,
  timestamp: new Date().toISOString(),
  date: new Date().toISOString()
};

// SessionCostsè¿½è·¡ã®è¿½åŠ 
sessionCosts.gpt += summaryCost;
sessionCosts.pdf += 0; // PDFè§£æã¯ç¾åœ¨ç„¡æ–™
sessionCosts.total += summaryCost;
```

#### addCostEntryé–¢æ•°ã®ã‚·ã‚°ãƒãƒãƒ£æ‹¡å¼µ
```typescript
function addCostEntry(
  videoId: string,
  title: string,
  method: 'subtitle' | 'whisper' | 'pdf', // PDFè¿½åŠ 
  language: string,
  gptModel: string,
  whisperCost: number,
  gptCost: number,
  totalCost: number,
  pdfCost: number = 0 // æ–°è¦ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
): CostEntry
```

### 3. ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã§ã®ä¸€è²«æ€§ç¢ºä¿

#### SessionCostsåˆæœŸåŒ–ã®çµ±ä¸€
- ã‚¢ãƒ—ãƒªèµ·å‹•æ™‚: `sessionCosts = { whisper: 0, gpt: 0, pdf: 0, total: 0 }`
- ãƒªã‚»ãƒƒãƒˆæ™‚: åŒæ§˜ã®æ§‹é€ ã§åˆæœŸåŒ–
- PDFå‡¦ç†æ™‚: é©åˆ‡ãªãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«æ–™é‡‘åŠ ç®—

#### å‹å®‰å…¨æ€§ã®å‘ä¸Š
- ã™ã¹ã¦ã®SessionCostsã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆä½œæˆç®‡æ‰€ã§pdfãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å¿…é ˆåŒ–
- TypeScriptã‚¨ãƒ©ãƒ¼ã®å®Œå…¨è§£æ¶ˆ
- ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã‚¨ãƒ©ãƒ¼ã®é˜²æ­¢

## æŠ€è¡“çš„æ”¹å–„ç‚¹

### 1. ã‚¨ãƒ©ãƒ¼è€æ€§ã®å‘ä¸Š
- **å¤šå±¤é˜²å¾¡**: try-catch + null ãƒã‚§ãƒƒã‚¯ + NaN ãƒã‚§ãƒƒã‚¯
- **ã‚°ãƒ¬ãƒ¼ã‚¹ãƒ•ãƒ«ãƒ‡ã‚°ãƒ¬ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³**: ã‚¨ãƒ©ãƒ¼æ™‚ã‚‚é©åˆ‡ãªãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯è¡¨ç¤º
- **å‹å®‰å…¨æ€§**: TypeScript ã«ã‚ˆã‚‹é™çš„å‹ãƒã‚§ãƒƒã‚¯

### 2. ã‚³ãƒ¼ãƒ‰å“è³ªã®å‘ä¸Š
- **æ˜ç¢ºãªè²¬ä»»åˆ†é›¢**: formatSafeDateé–¢æ•°ã«ã‚ˆã‚‹å˜ä¸€è²¬ä»»
- **ä¸€è²«æ€§**: å…¨Dateå‡¦ç†ã§åŒä¸€ã®å®‰å…¨ãªé–¢æ•°ã‚’ä½¿ç”¨
- **ä¿å®ˆæ€§**: å¤‰æ›´ç®‡æ‰€ã®å±€æ‰€åŒ–

### 3. ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“ã®æ”¹å–„
- **ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºã®æ’é™¤**: Invalid dateã‚¨ãƒ©ãƒ¼ã®å®Œå…¨è§£æ¶ˆ
- **æ˜ç¢ºãªæ–™é‡‘è¡¨ç¤º**: PDFå‡¦ç†ã‚³ã‚¹ãƒˆã®é©åˆ‡ãªåˆ†é¡
- **ä¿¡é ¼æ€§ã®å‘ä¸Š**: äºˆæœŸã—ãªã„ã‚¯ãƒ©ãƒƒã‚·ãƒ¥ã®é˜²æ­¢

## æœŸå¾…ã•ã‚Œã‚‹åŠ¹æœ

### 1. å³åº§ã®åŠ¹æœ
- âœ… analyzeç”»é¢ã§ã®PDFã‚¯ãƒ©ãƒƒã‚·ãƒ¥è§£æ¶ˆ
- âœ… PDFæ–™é‡‘ã®é©åˆ‡ãªåˆ†é¡è¡¨ç¤º
- âœ… TypeScriptã‚¨ãƒ©ãƒ¼ã®å®Œå…¨è§£æ¶ˆ

### 2. é•·æœŸçš„åŠ¹æœ
- ğŸ”„ PDFå‡¦ç†ã®æ‹¡å¼µæ€§å‘ä¸Š
- ğŸ”„ æ–™é‡‘ä½“ç³»ã®æ˜ç¢ºåŒ–
- ğŸ”„ ä¿å®ˆãƒ»ãƒ‡ãƒãƒƒã‚°ã®åŠ¹ç‡åŒ–

### 3. é–‹ç™ºè€…ä½“é¨“ã®å‘ä¸Š
- ğŸ› ï¸ å‹å®‰å…¨ãªPDFæ–™é‡‘è¿½è·¡
- ğŸ› ï¸ ä¸€è²«ã—ãŸã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
- ğŸ› ï¸ æ˜ç¢ºãªã‚³ãƒ¼ãƒ‰æ§‹é€ 

## ãƒ†ã‚¹ãƒˆçµæœ

- âœ… TypeScriptå‹ãƒã‚§ãƒƒã‚¯: ã‚¨ãƒ©ãƒ¼ãªã—
- âœ… ãƒ“ãƒ«ãƒ‰ãƒ†ã‚¹ãƒˆ: æˆåŠŸ
- âœ… æ—¢å­˜æ©Ÿèƒ½ã¸ã®å½±éŸ¿: ãªã—
- âœ… å¾Œæ–¹äº’æ›æ€§: å®Œå…¨ç¶­æŒ

## å½±éŸ¿ç¯„å›²

### å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«
1. **src/components/pages/AnalyzePage.tsx**
   - formatSafeDateé–¢æ•°è¿½åŠ 
   - 3ç®‡æ‰€ã®Dateå‡¦ç†ä¿®æ­£

2. **src/types/index.ts**
   - CostEntryã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹æ‹¡å¼µ
   - SessionCostsã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹æ‹¡å¼µ

3. **src/server.ts**
   - PDFæ–™é‡‘è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ä¿®æ­£
   - SessionCostsè¿½è·¡ã®æ”¹å–„
   - addCostEntryé–¢æ•°æ‹¡å¼µ

### å‰¯ä½œç”¨
- ãªã—ï¼ˆæ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã¨ã®å®Œå…¨äº’æ›æ€§ã‚’ç¶­æŒï¼‰

ã“ã®åŒ…æ‹¬çš„ãªä¿®æ­£ã«ã‚ˆã‚Šã€analyzeç”»é¢ã§ã®PDF invalid dateã‚¨ãƒ©ãƒ¼ãŒæ ¹æœ¬çš„ã«è§£æ±ºã•ã‚Œã€PDFæ–™é‡‘ä½“ç³»ã‚‚æ˜ç¢ºã«ãªã‚Šã¾ã—ãŸã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã‚ˆã‚Šå®‰å®šã—ãŸPDFå‡¦ç†ä½“é¨“ã‚’å¾—ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚