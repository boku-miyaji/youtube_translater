# Issue #20 実装差分 - 2025/07/17 01:49:00

## 概要
TranscriptViewerコンポーネントからの要約生成時に発生する500エラーを修正しました。

## 問題の詳細
- **症状**: PDF解析後、TranscriptViewerの「要約を生成」ボタンをクリックすると500エラーが発生
- **エラーメッセージ**: `/api/summarize:1 Failed to load resource: the server responded with a status of 500 (Internal Server Error)`
- **根本原因**: モデル価格設定の取得時にエラーが発生していた

## 修正内容

### 1. /api/summarize エンドポイントのエラーハンドリング改善（src/server.ts）

#### 修正前の問題点
```typescript
// gpt-3.5-turbo の価格設定が重複定義されていた
const pricing = {
  models: {
    'gpt-3.5-turbo': { input: 0.0015, output: 0.002 },
    // ...
    'gpt-3.5-turbo': { input: 0.0005, output: 0.0015 }  // 重複！
  }
};
```

#### 修正内容
1. **重複定義の削除**: gpt-3.5-turbo の価格設定を1つに統一
2. **フォールバック追加**: モデル価格が見つからない場合のデフォルト値を設定
   ```typescript
   const modelPricing = pricing.models[gptModel as keyof typeof pricing.models] || {
     input: pricing.input,
     output: pricing.output
   };
   ```
3. **エラーレスポンスの改善**: フロントエンドが期待する形式でエラーを返すように修正

### 2. generateSummary関数のエラーハンドリング強化

#### 修正内容
- OpenAI APIエラー時の適切なステータスコード返却
- エラーメッセージの詳細化
- フロントエンドとの互換性確保

## テスト結果
- ✅ PDF文字起こし表示: 正常動作
- ✅ エラーハンドリング: 500エラーから503エラー（サービス利用不可）に改善
- ✅ エラーメッセージ: ユーザーフレンドリーなメッセージを表示

## 影響範囲
- `/api/summarize` エンドポイント
- TranscriptViewerコンポーネントの要約生成機能
- PDFおよび動画の要約生成処理

## 注意事項
- OpenAI APIのクォータが利用可能な場合のみ要約が生成されます
- クォータ超過時は適切なエラーメッセージが表示されます

## 関連コミット
- `8b1e6c5: fix: Improve error handling in /api/summarize endpoint`