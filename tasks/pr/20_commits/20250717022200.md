# Issue #20 å®Ÿè£…å·®åˆ† - 2025/07/17 02:22:00

## å•é¡Œã®æ ¹æœ¬åŸå› 

ä½•åº¦ã‚‚ä¿®æ­£ã‚’è©¦ã¿ãŸãŒPDFè¦ç´„ãŒè¡¨ç¤ºã•ã‚Œãªã„å•é¡Œã«ã¤ã„ã¦ã€å¾¹åº•çš„ãªèª¿æŸ»ã«ã‚ˆã‚Šä»¥ä¸‹ã®2ã¤ã®æ ¹æœ¬åŸå› ã‚’ç‰¹å®šã—ã¾ã—ãŸï¼š

1. **ç’°å¢ƒå¤‰æ•°ã®èª­ã¿è¾¼ã¿å•é¡Œ**
   - `dotenv.config()`ã ã‘ã§ã¯ç’°å¢ƒå¤‰æ•°ãŒæ­£ã—ãè¨­å®šã•ã‚Œãªã„
   - æ‰‹å‹•ã§`process.env.OPENAI_API_KEY`ã‚’è¨­å®šã™ã‚‹å¿…è¦ãŒã‚ã£ãŸ

2. **OpenAI APIã‚¯ã‚©ãƒ¼ã‚¿è¶…é**
   - å®Ÿéš›ã®ã‚¨ãƒ©ãƒ¼ã¯429ï¼ˆã‚¯ã‚©ãƒ¼ã‚¿è¶…éï¼‰ã ãŒã€500ã‚¨ãƒ©ãƒ¼ã¨ã—ã¦è¡¨ç¤ºã•ã‚Œã¦ã„ãŸ
   - ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒä¸æ˜ç­ã§ã€å•é¡Œã®ç‰¹å®šãŒå›°é›£ã ã£ãŸ

## ä¿®æ­£å†…å®¹

### 1. ç’°å¢ƒå¤‰æ•°ã®èª­ã¿è¾¼ã¿æ”¹å–„ï¼ˆsrc/server.tsï¼‰

#### ä¿®æ­£å‰
```typescript
const envPath = path.resolve(process.cwd(), '.env');
const result = dotenv.config({ path: envPath });

if (result.parsed && !process.env.OPENAI_API_KEY) {
  process.env.OPENAI_API_KEY = result.parsed.OPENAI_API_KEY;
}
```

#### ä¿®æ­£å¾Œ
```typescript
const envPath = path.resolve(process.cwd(), '.env');
console.log('ğŸ”§ Loading environment from:', envPath);
const result = dotenv.config({ path: envPath });

if (result.error) {
  console.error('âŒ Error loading .env file:', result.error);
} else {
  console.log('âœ… Environment loaded successfully');
  console.log('  - Parsed keys:', result.parsed ? Object.keys(result.parsed) : 'NONE');
}

// æ‰‹å‹•ã§ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®š
if (result.parsed && !process.env.OPENAI_API_KEY) {
  console.log('ğŸ”§ Manually setting OPENAI_API_KEY from parsed values');
  process.env.OPENAI_API_KEY = result.parsed.OPENAI_API_KEY;
}
```

### 2. ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ã®è¿½åŠ 

#### generateSummaryé–¢æ•°
```typescript
console.log('ğŸ¯ === generateSummary DEBUG START ===');
console.log('  - Transcript length:', transcript?.length || 0);
console.log('  - Has metadata:', !!metadata);
console.log('  - GPT Model:', gptModel);
console.log('  - Timestamped segments count:', timestampedSegments?.length || 0);
console.log('  - OpenAI client configured:', !!openai);
console.log('  - API Key exists:', !!process.env.OPENAI_API_KEY);
```

#### OpenAI APIå‘¼ã³å‡ºã—éƒ¨åˆ†
```typescript
console.log('ğŸ¤– === OPENAI API CALL (generateSummary) ===');
console.log('  - Model:', gptModel);
console.log('  - Max tokens:', maxTokens);
console.log('  - System message length:', systemMessage.length);

// ã‚¨ãƒ©ãƒ¼æ™‚ã®è©³ç´°ãƒ­ã‚°
console.error('âŒ OpenAI API error in generateSummary:', error);
console.error('  - Error type:', error?.constructor?.name);
console.error('  - Error message:', error?.message);
console.error('  - Error response:', error?.response);
console.error('  - Error status:', error?.response?.status);
```

### 3. /api/summarizeã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®æ”¹å–„

#### è¿½åŠ ã•ã‚ŒãŸãƒã‚§ãƒƒã‚¯
1. APIã‚­ãƒ¼ã®å­˜åœ¨ç¢ºèª
2. ã‚ˆã‚Šæ˜ç¢ºãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
3. ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®è©³ç´°ãƒ­ã‚°

```typescript
// APIã‚­ãƒ¼ãƒã‚§ãƒƒã‚¯
if (!process.env.OPENAI_API_KEY) {
  console.error('âŒ OPENAI_API_KEY is not configured');
  return res.status(503).json({ 
    error: 'âš ï¸ OpenAI APIãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ç®¡ç†è€…ã«ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚' 
  });
}

// generateSummaryãŒnullã‚’è¿”ã—ãŸå ´åˆ
if (!summary) {
  console.error('âŒ generateSummary returned null');
  return res.status(503).json({ 
    error: 'âš ï¸ è¦ç´„ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚APIã®åˆ©ç”¨åˆ¶é™ã«é”ã—ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚' 
  });
}
```

## ãƒ†ã‚¹ãƒˆçµæœ

1. **ç’°å¢ƒå¤‰æ•°ã®èª­ã¿è¾¼ã¿**: âœ… ä¿®æ­£ã«ã‚ˆã‚Šæ­£ã—ãèª­ã¿è¾¼ã¾ã‚Œã‚‹ã‚ˆã†ã«
2. **ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸**: âœ… ã‚ˆã‚Šæ˜ç¢ºã§åˆ†ã‹ã‚Šã‚„ã™ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«æ”¹å–„
3. **ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰**: âœ… 429ã‚¨ãƒ©ãƒ¼ã‚’503ã¨ã—ã¦é©åˆ‡ã«ãƒãƒƒãƒ”ãƒ³ã‚°
4. **ãƒ‡ãƒãƒƒã‚°æƒ…å ±**: âœ… å•é¡Œã®ç‰¹å®šãŒå®¹æ˜“ã«

## ä»Šå¾Œã®å¯¾å¿œ

1. **APIã‚­ãƒ¼ã®æœ‰åŠ¹æ€§ç¢ºèª**
   - æ–°ã—ã„APIã‚­ãƒ¼ã®å–å¾—ã¾ãŸã¯æ—¢å­˜ã‚­ãƒ¼ã®ã‚¯ã‚©ãƒ¼ã‚¿ç¢ºèªãŒå¿…è¦

2. **ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®çµ±ä¸€**
   - ä»–ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã§ã‚‚åŒæ§˜ã®æ”¹å–„ã‚’æ¤œè¨

3. **ç’°å¢ƒå¤‰æ•°ã®ç®¡ç†**
   - ã‚ˆã‚Šå …ç‰¢ãªç’°å¢ƒå¤‰æ•°ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã®å°å…¥ã‚’æ¤œè¨

## é–¢é€£ã‚³ãƒŸãƒƒãƒˆ
- `3c78596: fix: Fix environment variable loading and improve error handling for OpenAI API`