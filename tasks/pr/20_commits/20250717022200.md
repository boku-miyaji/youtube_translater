# Issue #20 実装差分 - 2025/07/17 02:22:00

## 問題の根本原因

何度も修正を試みたがPDF要約が表示されない問題について、徹底的な調査により以下の2つの根本原因を特定しました：

1. **環境変数の読み込み問題**
   - `dotenv.config()`だけでは環境変数が正しく設定されない
   - 手動で`process.env.OPENAI_API_KEY`を設定する必要があった

2. **OpenAI APIクォータ超過**
   - 実際のエラーは429（クォータ超過）だが、500エラーとして表示されていた
   - エラーメッセージが不明瞭で、問題の特定が困難だった

## 修正内容

### 1. 環境変数の読み込み改善（src/server.ts）

#### 修正前
```typescript
const envPath = path.resolve(process.cwd(), '.env');
const result = dotenv.config({ path: envPath });

if (result.parsed && !process.env.OPENAI_API_KEY) {
  process.env.OPENAI_API_KEY = result.parsed.OPENAI_API_KEY;
}
```

#### 修正後
```typescript
const envPath = path.resolve(process.cwd(), '.env');
console.log('🔧 Loading environment from:', envPath);
const result = dotenv.config({ path: envPath });

if (result.error) {
  console.error('❌ Error loading .env file:', result.error);
} else {
  console.log('✅ Environment loaded successfully');
  console.log('  - Parsed keys:', result.parsed ? Object.keys(result.parsed) : 'NONE');
}

// 手動で環境変数を設定
if (result.parsed && !process.env.OPENAI_API_KEY) {
  console.log('🔧 Manually setting OPENAI_API_KEY from parsed values');
  process.env.OPENAI_API_KEY = result.parsed.OPENAI_API_KEY;
}
```

### 2. デバッグログの追加

#### generateSummary関数
```typescript
console.log('🎯 === generateSummary DEBUG START ===');
console.log('  - Transcript length:', transcript?.length || 0);
console.log('  - Has metadata:', !!metadata);
console.log('  - GPT Model:', gptModel);
console.log('  - Timestamped segments count:', timestampedSegments?.length || 0);
console.log('  - OpenAI client configured:', !!openai);
console.log('  - API Key exists:', !!process.env.OPENAI_API_KEY);
```

#### OpenAI API呼び出し部分
```typescript
console.log('🤖 === OPENAI API CALL (generateSummary) ===');
console.log('  - Model:', gptModel);
console.log('  - Max tokens:', maxTokens);
console.log('  - System message length:', systemMessage.length);

// エラー時の詳細ログ
console.error('❌ OpenAI API error in generateSummary:', error);
console.error('  - Error type:', error?.constructor?.name);
console.error('  - Error message:', error?.message);
console.error('  - Error response:', error?.response);
console.error('  - Error status:', error?.response?.status);
```

### 3. /api/summarizeエンドポイントの改善

#### 追加されたチェック
1. APIキーの存在確認
2. より明確なエラーメッセージ
3. リクエストの詳細ログ

```typescript
// APIキーチェック
if (!process.env.OPENAI_API_KEY) {
  console.error('❌ OPENAI_API_KEY is not configured');
  return res.status(503).json({ 
    error: '⚠️ OpenAI APIが設定されていません。管理者にお問い合わせください。' 
  });
}

// generateSummaryがnullを返した場合
if (!summary) {
  console.error('❌ generateSummary returned null');
  return res.status(503).json({ 
    error: '⚠️ 要約の生成に失敗しました。APIの利用制限に達している可能性があります。' 
  });
}
```

## テスト結果

1. **環境変数の読み込み**: ✅ 修正により正しく読み込まれるように
2. **エラーメッセージ**: ✅ より明確で分かりやすいメッセージに改善
3. **ステータスコード**: ✅ 429エラーを503として適切にマッピング
4. **デバッグ情報**: ✅ 問題の特定が容易に

## 今後の対応

1. **APIキーの有効性確認**
   - 新しいAPIキーの取得または既存キーのクォータ確認が必要

2. **エラーハンドリングの統一**
   - 他のエンドポイントでも同様の改善を検討

3. **環境変数の管理**
   - より堅牢な環境変数管理システムの導入を検討

## 関連コミット
- `3c78596: fix: Fix environment variable loading and improve error handling for OpenAI API`