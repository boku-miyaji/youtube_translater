# PDF解析ネットワークエラー修正

## コミット詳細
- **コミットハッシュ**: 76d683c
- **タイトル**: fix: Resolve PDF analysis ERR_CONTENT_LENGTH_MISMATCH error
- **日時**: 2025-07-22

## 解決した問題
PDF解析実行時に発生していたエラー:
```
POST http://localhost:3001/api/analyze-pdf net::ERR_CONTENT_LENGTH_MISMATCH 200 (OK)
```

## 根本原因
- **大きなPDFレスポンス**: `extractStructure: true` 時に全PDF内容が含まれ、レスポンスサイズが巨大化
- **ネットワーク制限**: ブラウザやネットワーク層でのコンテンツ長制限に抵触
- **レスポンス切り捨て**: Content-Length ヘッダーと実際のレスポンス本文の不一致

## 修正内容

### 1. サーバーサイド修正 (`src/server.ts`)
レスポンスサイズ制限による大型PDF対応:
```typescript
// PDFコンテンツの制限
limitedPdfContent = {
  fullText: pdfContent.fullText.length > 50000 
    ? pdfContent.fullText.substring(0, 50000) + '... [Content truncated for network transmission]'
    : pdfContent.fullText,
  sections: pdfContent.sections.map(section => ({
    ...section,
    content: section.content.length > 1000 
      ? section.content.substring(0, 1000) + '... [Truncated]'
      : section.content
  })).slice(0, 20), // 最初の20セクションのみ
  pageCount: pdfContent.pageCount,
  language: pdfContent.language
}
```

### 2. フロントエンド修正 (`src/components/pages/AnalyzePage.tsx`)
ネットワークエラー対応とリトライロジック:
```typescript
// リトライロジック実装
let retryCount = 0;
const maxRetries = 2;

while (retryCount <= maxRetries) {
  try {
    response = await fetch('/api/analyze-pdf', {...});
    data = await response.json();
    break; // 成功時はループ終了
  } catch (networkError) {
    const isNetworkError = errorMessage.includes('ERR_CONTENT_LENGTH_MISMATCH') ||
                           errorMessage.includes('ERR_NETWORK') ||
                           errorMessage.includes('Failed to fetch');
    
    if (isNetworkError && retryCount < maxRetries) {
      retryCount++;
      await new Promise(resolve => setTimeout(resolve, 1000 * retryCount));
      continue; // リトライ実行
    } else {
      throw networkError; // リトライ限界またはネットワークエラー以外
    }
  }
}
```

### 3. ユーザーフレンドリーなエラーメッセージ
```typescript
if (errorMessage.includes('ERR_CONTENT_LENGTH_MISMATCH')) {
  errorMessage = 'PDF processing failed due to network issues. The file may be too large or there was a connection problem. Please try again with a smaller PDF.';
}
```

## 実装した機能
1. **レスポンス制限**: 大型PDFでもネットワーク送信可能なサイズに調整
2. **リトライ機能**: ネットワーク一時的問題への自動対応
3. **指数バックオフ**: リトライ間隔の段階的延長
4. **エラー分類**: ネットワークエラーと他のエラーの区別
5. **ユーザー体験改善**: 分かりやすいエラーメッセージ提供

## テスト結果
- ✅ ビルド成功（TypeScriptエラーなし）
- ✅ Lint通過（新規エラーなし）
- ✅ ネットワークエラー対応機能動作確認

## 影響範囲
- PDF URL/File解析機能の信頼性向上
- 大型PDFファイルの処理安定性改善
- ネットワーク一時障害への自動対応
- 他の入力形式（YouTube、動画、音声）に影響なし