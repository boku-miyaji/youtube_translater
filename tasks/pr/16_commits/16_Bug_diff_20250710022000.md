# Issue 16 - Comprehensive Chat Error Handling and Model Validation Fixes
å®Ÿè£…æ—¥æ™‚: 2025-07-10 02:20:00

## å•é¡Œã®è©³ç´°åˆ†æ

ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¬ãƒãƒ¼ãƒˆ:
- éå»å‹•ç”»ã§æ–‡å­—èµ·ã“ã—çµæœã¯å–å¾—ã§ãã¦ã„ã‚‹
- ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°: `{type: 'string', length: 30, preview: 'ã‚ã£ã¡ã«ã‹ã£ã“ã„ã„ãƒˆã‚«ã‚²ã„ãŸã‚ˆ ã‚ã‚ã€è¦‹ã«è¡Œã“ã† ã†ã‚“ ã‚ã‚...'}`
- ã—ã‹ã—ã€ãƒãƒ£ãƒƒãƒˆã§ "sorry, I encountered an error" ãŒè¡¨ç¤ºã•ã‚Œã‚‹

## æ ¹æœ¬åŸå› ã®ç‰¹å®š

### 1. **ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®å•é¡Œ**
ChatInterfaceã§ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã®å®Ÿéš›ã®ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œãšã€æ±ç”¨çš„ãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ãŸã€‚

### 2. **gptModelãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®æ¬ è½**
å±¥æ­´å‹•ç”»ã§ã¯ "gpt-4.1-mini" ãƒ¢ãƒ‡ãƒ«ãŒä½¿ç”¨ã•ã‚Œã¦ã„ãŸãŒã€ChatInterfaceã‹ã‚‰ã‚µãƒ¼ãƒãƒ¼ã«gptModelãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒé€ä¿¡ã•ã‚Œã¦ã„ãªã‹ã£ãŸã€‚

### 3. **ãƒ¢ãƒ‡ãƒ«æ¤œè¨¼ã®ä¸å‚™**
ã‚µãƒ¼ãƒãƒ¼å´ã§ã®ãƒ¢ãƒ‡ãƒ«ä¾¡æ ¼è¨ˆç®—æ™‚ã«ãƒ¢ãƒ‡ãƒ«ãŒå­˜åœ¨ã—ãªã„å ´åˆã®é©åˆ‡ãªå‡¦ç†ãŒãªã‹ã£ãŸã€‚

## åŒ…æ‹¬çš„ä¿®æ­£å†…å®¹

### 1. **ChatInterface ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å¼·åŒ–**

#### ä¿®æ­£å‰
```typescript
let errorContent = 'Sorry, I encountered an error. Please try again.'

if (error instanceof Error) {
  // åŸºæœ¬çš„ãªã‚¨ãƒ©ãƒ¼ã‚¿ã‚¤ãƒ—ãƒã‚§ãƒƒã‚¯ã®ã¿
  if (error.message.includes('Failed to send message')) {
    errorContent = 'ãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚å‹•ç”»ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ã‹ã‚‰è³ªå•ã—ã¦ãã ã•ã„ã€‚'
  }
}
```

#### ä¿®æ­£å¾Œ
```typescript
let errorContent = 'Sorry, I encountered an error. Please try again.'

if (error instanceof Error) {
  console.error('ğŸš¨ Chat error details:', error.message)
  console.error('ğŸš¨ Full error object:', error)
  
  // å®Ÿéš›ã®ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä½¿ç”¨ã™ã‚‹åŒ…æ‹¬çš„å‡¦ç†
  if (error.message.includes('å‹•ç”»ã®æ–‡å­—èµ·ã“ã—ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“')) {
    errorContent = error.message // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã®å®Ÿéš›ã®ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä½¿ç”¨
  } else if (error.message.includes('Failed to process chat message')) {
    errorContent = 'ãƒãƒ£ãƒƒãƒˆå‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã—ã°ã‚‰ãã—ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚'
  } else if (error.message.length > 10 && error.message.length < 200) {
    // é©åˆ‡ãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å ´åˆã¯ä½¿ç”¨
    errorContent = error.message
  }
  
  console.error('ğŸš¨ Final error content to display:', errorContent)
}
```

### 2. **gptModelãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å¯¾å¿œ**

#### ChatInterfaceæ‹¡å¼µ
```typescript
interface ChatInterfaceProps {
  videoId?: string
  prefillQuestion?: string
  videoTitle?: string
  transcript?: string
  summary?: string
  gptModel?: string  // è¿½åŠ 
}

const requestData = {
  message: input.trim(),
  videoId,
  history: messages,
  transcript: hasValidTranscript ? safeTranscript : '',
  summary: hasValidSummary ? safeSummary : '',
  gptModel: gptModel || 'gpt-4o-mini',  // è¿½åŠ 
}
```

#### HistoryTable ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼ä¿®æ­£
```typescript
const videoData = {
  // ... existing fields
  gptModel: video.gptModel || 'gpt-4o-mini'  // è¿½åŠ 
}
```

#### AnalyzePage propsè¿½åŠ 
```typescript
<ChatInterface 
  videoId={currentVideo.basic?.videoId} 
  prefillQuestion={prefillQuestion}
  videoTitle={currentVideo.basic?.title}
  transcript={currentVideo.transcript}
  summary={currentVideo.summary}
  gptModel={currentVideo.gptModel}  // è¿½åŠ 
/>
```

### 3. **ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å¼·åŒ–**

#### ä¿®æ­£å‰
```typescript
} catch (error) {
  console.error('Error in chat:', error);
  res.status(500).json({ 
    success: false,
    response: 'Failed to process chat message',
    // ...
  });
}
```

#### ä¿®æ­£å¾Œ
```typescript
} catch (error) {
  console.error('ğŸš¨ Error in chat:', error);
  
  let errorMessage = 'Failed to process chat message';
  let statusCode = 500;
  
  if (error instanceof Error) {
    console.error('ğŸš¨ Error details:', error.message, error.stack);
    
    // å…·ä½“çš„ãªã‚¨ãƒ©ãƒ¼ã‚¿ã‚¤ãƒ—ã«åŸºã¥ãå‡¦ç†
    if (error.message.includes('API key')) {
      errorMessage = 'OpenAI APIè¨­å®šã‚¨ãƒ©ãƒ¼: APIã‚­ãƒ¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
      statusCode = 401;
    } else if (error.message.includes('rate limit')) {
      errorMessage = 'ãƒªã‚¯ã‚¨ã‚¹ãƒˆåˆ¶é™ã«é”ã—ã¾ã—ãŸã€‚ã—ã°ã‚‰ãã—ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚';
      statusCode = 429;
    } else if (error.message.includes('model')) {
      errorMessage = 'AI ãƒ¢ãƒ‡ãƒ«ã®è¨­å®šã«å•é¡ŒãŒã‚ã‚Šã¾ã™ã€‚ç®¡ç†è€…ã«é€£çµ¡ã—ã¦ãã ã•ã„ã€‚';
      statusCode = 400;
    } else {
      errorMessage = `ãƒãƒ£ãƒƒãƒˆå‡¦ç†ã‚¨ãƒ©ãƒ¼: ${error.message}`;
    }
  }
  
  res.status(statusCode).json({ 
    success: false,
    response: errorMessage,
    // ...
  });
}
```

### 4. **åŒ…æ‹¬çš„ãƒ‡ãƒãƒƒã‚°ã‚·ã‚¹ãƒ†ãƒ **

#### OpenAI APIå‘¼ã³å‡ºã—ãƒ‡ãƒãƒƒã‚°
```typescript
console.log('ğŸ¤– === OPENAI API CALL DEBUG ===')
console.log('  - Model:', gptModel)
console.log('  - Messages count:', messages.length)
console.log('  - OpenAI instance ready:', !!openai)
console.log('  - API Key configured:', process.env.OPENAI_API_KEY ? 'YES' : 'NO')

const response = await openai.chat.completions.create({...});

console.log('ğŸ¤– === OPENAI API RESPONSE ===')
console.log('  - Response received:', !!response)
console.log('  - Choices count:', response.choices?.length || 0)
```

#### ãƒ¢ãƒ‡ãƒ«ä¾¡æ ¼è¨ˆç®—ãƒ‡ãƒãƒƒã‚°
```typescript
console.log('ğŸ¤– === PRICING DEBUG ===')
console.log('  - Model for pricing:', gptModel)
console.log('  - Available models:', Object.keys(pricing.models))
console.log('  - Model exists in pricing:', gptModel in pricing.models)

if (!(gptModel in pricing.models)) {
  console.log('  - âš ï¸ WARNING: Model not found in pricing, using fallback');
}

const modelPricing = pricing.models[gptModel as keyof typeof pricing.models] || pricing.models['gpt-4o-mini'];
```

### 5. **ãƒ†ã‚¹ãƒˆæ›´æ–°**
ChatInterfaceãƒ†ã‚¹ãƒˆã§gptModelãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è¿½åŠ ã—ã€ä¸€è²«æ€§ã‚’ä¿ã¤ã€‚

## æœŸå¾…ã•ã‚Œã‚‹åŠ¹æœ

### ğŸ¯ ä¸»è¦æ”¹å–„
1. **å®Ÿéš›ã®ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å…·ä½“çš„ãªã‚¨ãƒ©ãƒ¼åŸå› ã‚’é€šçŸ¥
2. **ãƒ¢ãƒ‡ãƒ«äº’æ›æ€§**: å±¥æ­´å‹•ç”»ã®æ­£ã—ã„ãƒ¢ãƒ‡ãƒ«ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ä½¿ç”¨
3. **å …ç‰¢ãªã‚¨ãƒ©ãƒ¼å‡¦ç†**: æ§˜ã€…ãªã‚¨ãƒ©ãƒ¼ã‚¿ã‚¤ãƒ—ã«å¯¾ã™ã‚‹é©åˆ‡ãªå¯¾å¿œ
4. **ãƒ‡ãƒãƒƒã‚°æ©Ÿèƒ½å¼·åŒ–**: å•é¡Œã®è¿…é€Ÿãªç‰¹å®šã¨è§£æ±º

### ğŸ“Š æŠ€è¡“çš„ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆ
- **å¾Œæ–¹äº’æ›æ€§**: æ—¢å­˜æ©Ÿèƒ½ã¸ã®å½±éŸ¿ãªã—
- **æ‹¡å¼µæ€§**: æ–°ã—ã„ãƒ¢ãƒ‡ãƒ«ã®è¿½åŠ ãŒå®¹æ˜“
- **ä¿å®ˆæ€§**: åŒ…æ‹¬çš„ãƒ­ã‚°ã«ã‚ˆã‚‹å•é¡Œè§£æ±ºã®åŠ¹ç‡åŒ–
- **ä¿¡é ¼æ€§**: ã‚¨ãƒ©ãƒ¼çŠ¶æ³ã§ã®é©åˆ‡ãªå‹•ä½œä¿è¨¼

### ğŸ”§ è§£æ±ºã•ã‚Œã‚‹å•é¡Œ
- âœ… å±¥æ­´å‹•ç”»ã§ã® "sorry, I encountered an error" è¡¨ç¤º
- âœ… gptModelãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®ä¸æ•´åˆã«ã‚ˆã‚‹ã‚¨ãƒ©ãƒ¼
- âœ… ä¸æ˜ç¢ºãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«ã‚ˆã‚‹ãƒ‡ãƒãƒƒã‚°å›°é›£
- âœ… ãƒ¢ãƒ‡ãƒ«ä¾¡æ ¼è¨ˆç®—ã§ã®ã‚¨ãƒ©ãƒ¼

ã“ã®ä¿®æ­£ã«ã‚ˆã‚Šã€å±¥æ­´å‹•ç”»ã®ãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½ãŒæ­£å¸¸ã«å‹•ä½œã—ã€ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã‚‚é©åˆ‡ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒãƒ¦ãƒ¼ã‚¶ãƒ¼ã«è¡¨ç¤ºã•ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚