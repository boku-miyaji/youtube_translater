# Commit Summary: Fix PDF Detailed Rationale Display

**Commit Hash**: f732f1e
**Date**: 2025-10-24 22:44:49
**Type**: fix

## 概要

PDF解析完了後の詳細根拠で、ページ単位のコスト・時間内訳が表示されない問題を修正しました。

## 問題

ユーザーがPDF解析完了後に詳細根拠を見ると、以下のように基本情報のみが表示され、詳細な計算式が表示されていませんでした:

```
コスト内訳
文字起こし: $0.0000
要約生成: $0.0027
合計: $0.0027

⏱️ 処理時間内訳
テキスト抽出: 15 sec
要約生成: 2 min
合計: 2 min 15 sec
テキスト抽出: 11% | 要約生成: 89%
```

期待される表示:

```
コスト内訳
文字起こし: $0.0000
要約生成: $0.0027
  → 1ページあたり: 約$0.000270
合計: $0.0027
  → 1ページあたり: 約$0.000270

このPDF (10ページ) の場合:
10ページ × $0.000270/ページ = $0.0027 (要約)
合計: $0.0027

⏱️ 処理時間内訳
テキスト抽出: 15秒
  → 1ページあたり: 1.5秒
要約生成: 2分
  → 1ページあたり: 12秒
合計: 2分15秒

このPDF (10ページ) の場合:
10ページ × 1.5秒/ページ = 15秒 (テキスト抽出)
10ページ × 12秒/ページ = 2分 (要約)
合計: 2分15秒

テキスト抽出: 11% | 要約生成: 89%
```

## 原因

PDF解析完了後のレスポンス構造 (`analysisTime` オブジェクト) に `durationMinutes` フィールドが含まれていなかったため、フロントエンドの `generateEstimationRationale` 関数が詳細な計算式を表示できませんでした。

### 詳細

1. **事前推定時**: `/api/estimate-cost-pdf` のレスポンスは `calculateProcessingTime()` を使用しており、`durationMinutes` が含まれていた
2. **解析完了後**: `/api/analyze-pdf` のレスポンスは `analysisTime` オブジェクトを手動で構築しており、`durationMinutes` が欠けていた
3. フロントエンドの `generateEstimationRationale()` は `durationMinutes > 0` のチェックで詳細表示を制御しており、これが0だと詳細が表示されない

## 実装内容

### バックエンド（server.ts）

1. **PDF解析レスポンスの `analysisTime` に `durationMinutes` を追加**:
   ```typescript
   analysisTime: {
     startTime: analysisStartTime.toISOString(),
     endTime: analysisEndTime.toISOString(),
     duration: totalAnalysisTime,
     extraction: validatedExtractionDuration,
     summary: validatedSummaryDuration,
     total: actualProcessingTime,
     durationMinutes: pdfContent.pageCount  // 追加
   }
   ```

2. **`addToHistory` 呼び出しでも `durationMinutes` を追加**:
   - 履歴データにもページ数を保存し、一貫性を確保

3. **`addToHistory` 関数のパラメータ型定義を更新**:
   ```typescript
   analysisTime: {
     // ...既存フィールド
     durationMinutes?: number;  // 追加
   } | null = null
   ```

### 型定義（types/index.ts）

1. **`PDFAnalysisResponse` インターフェースを更新**:
   ```typescript
   analysisTime?: {
     // ...既存フィールド
     durationMinutes?: number;  // Page count for PDFs
   }
   ```

2. **`HistoryEntry` インターフェースを更新**:
   - 同様に `durationMinutes?` フィールドを追加

## 変更の詳細

### 変更されたファイル
- `src/server.ts`: 17行の変更（+11, -6）
- `src/types/index.ts`: 4行の追加

### 影響範囲
- **事前推定**: 変更なし（既に動作していた）
- **解析完了後**: 詳細なページ単位の計算式が表示されるようになった
- **履歴表示**: 履歴からの再表示でも詳細が表示される

## テスト結果

- ✅ TypeScript型チェック通過
- ✅ ビルド成功（server + client）
- ✅ PDF解析完了後に詳細根拠が正しく表示されることを確認

## 関連コミット

- 58ec59c: 詳細なページ単位説明の追加（フロントエンド）
- b0cb84d: PDF URL用のコスト・時間推定表示の追加
- 8aee9c9: 推定根拠表示の簡素化
