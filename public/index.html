<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube ÊñáÂ≠óËµ∑„Åì„Åó & „ÉÅ„É£„ÉÉ„Éà</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://www.youtube.com/iframe_api"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            font-size: 16px;
            line-height: 1.6;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem;
            height: 100vh;
            overflow: hidden;
        }
        .app-header {
            text-align: center;
            padding: 1rem 0;
            color: white;
            margin-bottom: 1rem;
        }
        .app-header h1 {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        .app-header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        .section {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
        }
        .section h2 {
            margin: 0 0 1rem 0;
            color: #2d3748;
            font-size: 1.3rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .section-icon {
            width: 24px;
            height: 24px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.8rem;
        }
        input, textarea, select {
            width: 100%;
            padding: 0.75rem 1rem;
            margin: 0.5rem 0;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 1rem;
            background: #f8fafc;
            transition: all 0.3s ease;
            font-family: inherit;
        }
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #667eea;
            background: white;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        button {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin: 0.5rem 0;
            font-family: inherit;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }
        button:active {
            transform: translateY(0);
        }
        button:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .transcript {
            background: #f9f9f9;
            border-left: 4px solid #007cba;
            padding: 15px;
            margin: 10px 0;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .chat-messages {
            height: 100%;
            overflow-y: auto;
            background: transparent;
            scrollbar-width: thin;
            scrollbar-color: #cbd5e0 transparent;
        }
        .chat-messages::-webkit-scrollbar {
            width: 6px;
        }
        .chat-messages::-webkit-scrollbar-track {
            background: transparent;
        }
        .chat-messages::-webkit-scrollbar-thumb {
            background: #cbd5e0;
            border-radius: 3px;
        }
        .message {
            margin-bottom: 0.75rem;
            padding: 0.75rem;
            border-radius: 12px;
            max-width: 90%;
            animation: fadeIn 0.3s ease;
            font-size: 0.9rem;
            line-height: 1.4;
        }
        .user-message {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            margin-left: auto;
            text-align: right;
        }
        .ai-message {
            background: linear-gradient(135deg, #f1f5f9, #e2e8f0);
            color: #2d3748;
            margin-right: auto;
            white-space: normal;
            word-wrap: break-word;
            line-height: 1.6;
        }
        
        /* AI„É°„ÉÉ„Çª„Éº„Ç∏ÂÜÖ„ÅÆMarkdownË¶ÅÁ¥†„ÅÆ„Çπ„Çø„Ç§„É´ */
        .ai-message h1, .ai-message h2, .ai-message h3, .ai-message h4, .ai-message h5, .ai-message h6 {
            margin: 0.5rem 0;
            color: #1a202c;
        }
        .ai-message p {
            margin: 0.5rem 0;
        }
        .ai-message ul, .ai-message ol {
            margin: 0.5rem 0;
            padding-left: 1.5rem;
        }
        .ai-message li {
            margin: 0.25rem 0;
        }
        .ai-message code {
            background: rgba(102, 126, 234, 0.1);
            padding: 2px 4px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
        }
        .ai-message pre {
            background: #f8fafc;
            padding: 0.75rem;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
            overflow-x: auto;
            margin: 0.5rem 0;
        }
        .ai-message pre code {
            background: none;
            padding: 0;
        }
        .ai-message blockquote {
            border-left: 4px solid #667eea;
            padding-left: 1rem;
            margin: 0.5rem 0;
            color: #4a5568;
            font-style: italic;
        }
        .ai-message strong {
            font-weight: 600;
            color: #2d3748;
        }
        .ai-message em {
            font-style: italic;
            color: #4a5568;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .loading {
            text-align: center;
            color: #666;
            font-style: italic;
        }
        .error {
            color: #dc3545;
            background: #f8d7da;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .success {
            color: #155724;
            background: #d4edda;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .costs-display {
            background: linear-gradient(135deg, #f7fafc, #edf2f7);
            padding: 1.5rem;
            border-radius: 16px;
            border: 2px solid #e2e8f0;
            backdrop-filter: blur(10px);
        }
        .video-player-container {
            margin-bottom: 1rem;
            border-radius: 12px;
            overflow: hidden;
            background: #000;
            position: relative;
            padding-bottom: 56.25%; /* 16:9„ÅÆÊ®ôÊ∫ñÊØîÁéá */
            height: 0;
            width: 100%;
            transition: all 0.3s ease;
        }
        
        .video-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            border: 1px solid #dee2e6;
            overflow: visible; /* „ÅØ„ÅøÂá∫„Åó„ÇíË®±ÂèØ */
            position: relative;
        }
        .video-player-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: none;
        }
        .timestamp-link {
            color: #667eea;
            cursor: pointer;
            text-decoration: underline;
            font-weight: 600;
            padding: 2px 4px;
            border-radius: 4px;
            transition: all 0.3s ease;
        }
        .timestamp-link:hover {
            background: rgba(102, 126, 234, 0.1);
            transform: scale(1.05);
        }
        .timestamp-segment {
            margin: 0 !important;
            padding: 0 !important;
            transition: all 0.3s ease;
            display: block;
            line-height: 1;
        }
        .timestamp-row {
            display: flex;
            align-items: center;
            padding: 2px 4px !important;
            border-radius: 3px;
            transition: all 0.3s ease;
            height: 18px !important;
            min-height: 18px !important;
            max-height: 18px !important;
            overflow: hidden;
            margin: 0;
        }
        .timestamp-row:hover {
            background: rgba(102, 126, 234, 0.08);
        }
        .timestamp-segment.current-segment .timestamp-row {
            background: rgba(102, 126, 234, 0.2);
            border-left: 2px solid #667eea;
            padding-left: 6px !important;
        }
        .timestamp-time {
            min-width: 45px;
            width: 45px;
            font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
            font-size: 0.7rem;
            color: #667eea;
            font-weight: 600;
            cursor: pointer;
            margin-right: 6px;
            text-align: right;
            padding: 0;
            border-radius: 2px;
            transition: all 0.3s ease;
            flex-shrink: 0;
            line-height: 1;
        }
        .timestamp-time:hover {
            background: rgba(102, 126, 234, 0.1);
            transform: scale(1.05);
        }
        .timestamp-text {
            flex: 1;
            line-height: 1 !important;
            color: #2d3748;
            font-size: 0.8rem;
            margin: 0;
            padding: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .timestamp-transcript {
            font-family: inherit;
            line-height: 1 !important;
            padding: 0 !important;
            margin: 0 !important;
        }
        .ai-message {
            background: linear-gradient(135deg, #f1f5f9, #e2e8f0);
            color: #2d3748;
            margin-right: auto;
        }
        .ai-message .timestamp-link {
            background: rgba(102, 126, 234, 0.15);
            color: #667eea;
            padding: 2px 6px;
            border-radius: 4px;
            margin: 0 2px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 500;
            text-decoration: none;
            border: 1px solid rgba(102, 126, 234, 0.2);
        }
        .ai-message .timestamp-link:hover {
            background: rgba(102, 126, 234, 0.25);
            color: #5a67d8;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(102, 126, 234, 0.2);
        }
        .cost-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-family: monospace;
        }
        .total-cost {
            border-top: 2px solid #007cba;
            padding-top: 8px;
            font-weight: bold;
            font-size: 1.1em;
        }
        .costs-tabs {
            display: flex;
            background: #f8fafc;
            border-radius: 8px;
            padding: 2px;
            margin-bottom: 1rem;
        }
        .costs-tab-button {
            flex: 1;
            padding: 0.5rem;
            background: transparent;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.85rem;
            font-weight: 600;
        }
        .costs-tab-button.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }
        .costs-tab-button:not(.active) {
            color: #718096;
            opacity: 0.7;
        }
        .costs-tab-button:not(.active):hover {
            background: #e2e8f0;
            opacity: 1;
        }
        .costs-tab-content {
            display: none;
        }
        .costs-tab-content.active {
            display: block;
        }
        .costs-filter {
            margin-bottom: 1rem;
        }
        .costs-filter select {
            width: 100%;
            padding: 0.5rem;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
        }
        .costs-analysis-summary {
            background: #f8fafc;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }
        .costs-chart {
            background: white;
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            margin-bottom: 1rem;
        }
        .history-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
            background: #fafafa;
        }
        .history-item {
            background: linear-gradient(135deg, #f8fafc, #e2e8f0);
            border: 1px solid rgba(255,255,255,0.5);
            border-radius: 16px;
            padding: 1rem;
            margin-bottom: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }
        .history-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            background: linear-gradient(135deg, #ffffff, #f1f5f9);
        }
        .history-title {
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }
        .history-meta {
            font-size: 0.9em;
            color: #666;
            display: flex;
            justify-content: space-between;
        }
        .history-channel {
            font-size: 0.9em;
            color: #666;
            margin: 3px 0;
        }
        .history-url {
            font-size: 0.85em;
            margin: 3px 0;
        }
        .history-url a {
            color: #007cba;
            text-decoration: none;
        }
        .history-url a:hover {
            text-decoration: underline;
        }
        
        /* Â±•Ê≠¥„Çø„Éñ„Å®„Éï„Ç£„É´„Çø„Éº */
        .history-controls {
            margin-bottom: 1rem;
        }
        
        .history-tabs {
            display: flex;
            background: #f8fafc;
            border-radius: 8px;
            padding: 2px;
            margin-bottom: 1rem;
        }
        
        .history-tab-button {
            flex: 1;
            padding: 0.5rem;
            background: transparent;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        .history-tab-button.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }
        
        .history-tab-button:not(.active) {
            color: #718096;
            opacity: 0.7;
        }
        
        .history-tab-button:not(.active):hover {
            background: #e2e8f0;
            opacity: 1;
        }
        
        /* „Çø„Ç∞Ë°®Á§∫ */
        .video-tags {
            margin: 0.5rem 0;
            display: flex;
            flex-wrap: wrap;
            gap: 0.25rem;
        }
        
        .tag-item {
            background: linear-gradient(135deg, #ebf8ff, #e6fffa);
            color: #2d3748;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.75rem;
            border: 1px solid #bee3f8;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .tag-item:hover {
            background: linear-gradient(135deg, #bee3f8, #81e6d9);
            transform: translateY(-1px);
        }
        
        .suggestion-tag {
            background: #f7fafc;
            color: #4a5568;
            padding: 0.25rem 0.5rem;
            border-radius: 8px;
            font-size: 0.75rem;
            cursor: pointer;
            margin: 0.125rem;
            display: inline-block;
            transition: all 0.3s ease;
        }
        
        .suggestion-tag:hover {
            background: #667eea;
            color: white;
        }
        
        /* „Éï„Ç©„É´„ÉÄ„Çµ„Ç∏„Çß„Çπ„ÉÅ„Éß„É≥ */
        .folder-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            z-index: 1000;
        }
        
        .folder-suggestion-item {
            padding: 0.75rem 1rem;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .folder-suggestion-item:last-child {
            border-bottom: none;
        }
        
        .folder-suggestion-item:hover {
            background: linear-gradient(135deg, #ebf8ff, #e6fffa);
            color: #2d3748;
        }
        
        .folder-suggestion-item .folder-icon {
            color: #667eea;
            font-size: 1rem;
        }
        
        .folder-suggestion-item .folder-name {
            font-weight: 600;
            flex: 1;
        }
        
        .folder-suggestion-item .folder-count {
            font-size: 0.8rem;
            color: #666;
            background: #f1f5f9;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
        }
        
        /* „Ç∞„É´„Éº„ÉóÂåñ„Åï„Çå„ÅüÂ±•Ê≠¥ */
        .history-group {
            margin-bottom: 1.5rem;
        }
        
        .history-group-header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 0.75rem 1rem;
            border-radius: 12px 12px 0 0;
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .history-group-items {
            background: #f8fafc;
            border-radius: 0 0 12px 12px;
            padding: 0.5rem;
        }
        
        .history-group-items .history-item {
            margin-bottom: 0.5rem;
            font-size: 0.85rem;
        }
        
        /* ÈÅ∏Êäû„Åï„Çå„Åü„É°„Ç§„É≥„Çø„Ç∞ */
        .selected-tag {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 0.5rem 0.75rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .selected-tag:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        
        .selected-tag .remove-tag {
            cursor: pointer;
            font-weight: bold;
            padding: 0.125rem 0.25rem;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }
        
        .selected-tag .remove-tag:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        /* „Ç¢„Ç≥„Éº„Éá„Ç£„Ç™„É≥Ê©üËÉΩ */
        .history-group-header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 0.75rem 1rem;
            border-radius: 12px;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .history-group-header:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        
        .history-group-header .toggle-icon {
            font-size: 0.8rem;
            transition: transform 0.3s ease;
        }
        
        .history-group.collapsed .toggle-icon {
            transform: rotate(-90deg);
        }
        
        .history-group-items {
            background: #f8fafc;
            border-radius: 0 0 12px 12px;
            padding: 0.5rem;
            transition: all 0.3s ease;
            overflow: hidden;
        }
        
        .history-group.collapsed .history-group-items {
            display: none;
        }
        .method-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .method-subtitle {
            background: linear-gradient(135deg, #48bb78, #38a169);
            color: white;
        }
        .method-whisper {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }
        .language-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            background: linear-gradient(135deg, #a0aec0, #718096);
            color: white;
            margin-left: 0.5rem;
        }
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }
        .info-item {
            background: white;
            padding: 8px 12px;
            border-radius: 4px;
            border: 1px solid #e9ecef;
        }
        .chapters-info {
            margin-top: 15px;
            padding: 10px;
            background: white;
            border-radius: 4px;
            border: 1px solid #e9ecef;
        }
        .chapter-item {
            padding: 5px 0;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
        }
        .chapter-item:hover {
            background: #f8f9fa;
        }
        .chapter-timestamp {
            font-weight: bold;
            color: #007cba;
            margin-right: 10px;
        }
        .summary {
            background: linear-gradient(135deg, #f0fff4, #ffffff);
            border-left: 4px solid #48bb78;
            border-radius: 16px;
            padding: 1.5rem;
            margin: 1rem 0;
            max-height: 500px;
            overflow-y: auto;
            font-size: 1rem;
            line-height: 1.6;
            scrollbar-width: thin;
            scrollbar-color: #cbd5e0 transparent;
        }
        .summary::-webkit-scrollbar {
            width: 6px;
        }
        .summary::-webkit-scrollbar-track {
            background: transparent;
        }
        .summary::-webkit-scrollbar-thumb {
            background: #cbd5e0;
            border-radius: 3px;
        }
        .summary h2 {
            color: #28a745;
            margin-top: 20px;
            margin-bottom: 10px;
            font-size: 1.2em;
        }
        .summary h3 {
            color: #155724;
            margin-top: 15px;
            margin-bottom: 8px;
            font-size: 1.1em;
        }
        .summary ul {
            padding-left: 20px;
            margin: 10px 0;
        }
        .summary li {
            margin-bottom: 5px;
        }
        .summary p {
            margin: 10px 0;
        }
        .summary code {
            background: #e9ecef;
            padding: 2px 4px;
            border-radius: 3px;
            font-family: monospace;
        }
        .suggested-questions {
            margin-bottom: 0.3rem;
            padding: 0.3rem;
            background: linear-gradient(135deg, #ebf8ff, #e6fffa);
            border-radius: 8px;
            border: 1px solid #bee3f8;
            max-height: 80px;
            overflow-y: auto;
            flex-shrink: 0;
        }
        .question-item {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 0.2rem 0.4rem;
            margin: 0.1rem 0;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.75rem;
            line-height: 1.2;
        }
        .question-item:hover {
            background: linear-gradient(135deg, #f7fafc, #edf2f7);
            border-color: #667eea;
            transform: translateX(4px);
        }
        .transcript {
            background: linear-gradient(135deg, #f8fafc, #ffffff);
            border-left: 4px solid #667eea;
            border-radius: 16px;
            padding: 1.5rem;
            margin: 1rem 0;
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 500px;
            overflow-y: auto;
            font-size: 1rem;
            line-height: 1.8;
            font-family: 'Hiragino Sans', 'Yu Gothic', sans-serif;
            scrollbar-width: thin;
            scrollbar-color: #cbd5e0 transparent;
        }
        .transcript::-webkit-scrollbar {
            width: 6px;
        }
        .transcript::-webkit-scrollbar-track {
            background: transparent;
        }
        .transcript::-webkit-scrollbar-thumb {
            background: #cbd5e0;
            border-radius: 3px;
        }
        .input-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 15px;
        }
        .controls-row {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
        }
        .language-selector,
        .model-selector {
            background: #f8fafc;
            padding: 1rem;
            border-radius: 12px;
            border: 2px solid #e2e8f0;
        }
        .language-selector label,
        .model-selector label {
            font-weight: 600;
            color: #2d3748;
            display: block;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }
        .language-selector select,
        .model-selector select {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            background: white;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .language-selector select:focus,
        .model-selector select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        .chat-input-container {
            display: flex;
            gap: 0.75rem;
            align-items: flex-end;
        }
        .chat-input-container input {
            flex: 1;
            margin: 0;
        }
        .chat-input-container button {
            width: auto;
            min-width: 80px;
            margin: 0;
        }
        
        /* Responsive Design */
        @media (min-width: 768px) {
            .container {
                padding: 2rem;
            }
            .controls-row {
                grid-template-columns: 1fr 1fr;
            }
            .app-header h1 {
                font-size: 3rem;
            }
            .section {
                padding: 2rem;
            }
        }
        @media (min-width: 1024px) {
            .controls-row {
                grid-template-columns: 1fr 1fr;
                gap: 2rem;
            }
        }
        
        /* Êñ∞„Åó„ÅÑ„É¨„Ç§„Ç¢„Ç¶„ÉàÁî®CSS */
        .main-content {
            display: flex;
            gap: 0;
            max-width: 100vw;
            margin: 0 auto;
            padding: 1rem;
            height: calc(100vh - 200px);
        }
        
        .left-panel {
            height: 100%;
            overflow-y: auto;
            width: 350px;
            transition: width 0.3s ease;
            flex-shrink: 0;
        }
        
        .left-panel .section {
            overflow-y: auto;
            position: relative;
            transition: all 0.3s ease;
            max-height: calc(100vh - 280px);
        }
        
        /* „É¨„Çµ„Ç§„Ç∂„Éº */
        .resize-handle {
            position: relative;
            width: 16px;
            height: 100%;
            cursor: col-resize;
            background: #667eea;
            border-radius: 4px;
            opacity: 0.7;
            transition: all 0.3s ease;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 4px;
            flex-shrink: 0;
        }
        
        .resize-handle:hover {
            background: #764ba2;
            opacity: 1;
        }
        
        .resize-handle::before {
            content: '‚ãÆ‚ãÆ';
            color: white;
            font-size: 14px;
            line-height: 1;
            transform: rotate(90deg);
        }
        
        .right-panel {
            flex: 1;
            height: 100%;
            display: flex;
            flex-direction: column;
            min-width: 400px;
        }
        
        .content-tabs {
            display: flex;
            background: #f8fafc;
            border-radius: 12px;
            padding: 4px;
            margin-bottom: 1rem;
        }
        
        .tab-button {
            flex: 1;
            padding: 1rem;
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            font-size: 0.85rem;
            text-align: center;
            line-height: 1.2;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.25rem;
            min-height: 60px;
            color: #4a5568;
        }
        
        .tab-button.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
            border-color: #667eea;
        }
        
        .tab-button:not(.active):hover {
            background: #e2e8f0;
            border-color: #cbd5e0;
            transform: translateY(-1px);
        }
        
        .tab-content {
            display: none;
            height: 500px;
            overflow-y: auto;
            background: white;
            border-radius: 12px;
            padding: 0.5rem;
            border: 2px solid #e2e8f0;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .chat-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: white;
            border-radius: 12px;
            border: 2px solid #e2e8f0;
            margin-top: 1rem;
            min-height: 500px;
            max-height: 600px;
            height: auto;
            overflow: hidden;
            position: relative;
        }
        
        .chat-header {
            padding: 1rem;
            border-bottom: 1px solid #e2e8f0;
            background: linear-gradient(135deg, #f8fafc, #ffffff);
            border-radius: 10px 10px 0 0;
            flex-shrink: 0;
        }
        
        .chat-messages-panel {
            flex: 1;
            padding: 1rem;
            padding-bottom: 100px;
            overflow-y: auto;
            min-height: 300px;
            max-height: 420px;
        }
        
        .chat-input-panel {
            padding: 1rem;
            border-top: 1px solid #e2e8f0;
            background: #f8fafc;
            border-radius: 0 0 10px 10px;
            flex-shrink: 0 !important;
            min-height: 80px !important;
            height: auto !important;
            position: absolute !important;
            bottom: 0 !important;
            left: 0 !important;
            right: 0 !important;
            z-index: 100 !important;
            display: flex !important;
            visibility: visible !important;
        }
        
        .chat-input-container {
            display: flex !important;
            gap: 0.75rem;
            align-items: center;
            width: 100% !important;
        }
        
        .chat-input-container input {
            flex: 1;
            margin: 0;
            display: block !important;
            visibility: visible !important;
            width: auto !important;
            min-width: 200px;
        }
        
        .chat-input-container button {
            width: auto;
            min-width: 80px;
            margin: 0;
            display: block !important;
            visibility: visible !important;
        }
        
        /* Mobile-first improvements */
        @media (max-width: 1200px) {
            .main-content {
                flex-direction: column;
                gap: 1rem;
                height: auto;
            }
            
            .left-panel {
                width: 100%;
                height: auto;
                max-height: 400px;
            }
            
            .right-panel {
                position: static;
                height: auto;
                min-height: 600px;
            }
            
            .chat-panel {
                min-height: 400px;
                max-height: 550px;
            }
            
            .chat-messages-panel {
                min-height: 200px;
                max-height: 320px;
            }
        }
        
        @media (max-width: 767px) {
            .app-header h1 {
                font-size: 2rem;
            }
            .section {
                padding: 1rem;
                margin-bottom: 1rem;
            }
            .message {
                max-width: 95%;
            }
            .main-content {
                padding: 0.5rem;
            }
            
            .chat-input-container {
                gap: 0.5rem;
            }
            
            .chat-input-container input {
                font-size: 16px; /* iOS„Åß„Ç∫„Éº„É†„Ç§„É≥„ÇíÈò≤„Åê */
            }
        }
        
        /* Ë®ò‰∫ã„Éû„Éº„ÇØ„ÉÄ„Ç¶„É≥Áî®„Çπ„Çø„Ç§„É´ */
        .article-markdown {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.7;
        }
        
        .article-markdown h1 {
            color: #1a202c;
            font-size: 1.75rem;
            font-weight: 700;
            margin: 0 0 1rem 0;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 0.5rem;
        }
        
        .article-markdown h2 {
            color: #2d3748;
            font-size: 1.4rem;
            font-weight: 600;
            margin: 1.5rem 0 1rem 0;
        }
        
        .article-markdown h3 {
            color: #4a5568;
            font-size: 1.2rem;
            font-weight: 600;
            margin: 1.25rem 0 0.75rem 0;
        }
        
        .article-markdown p {
            margin: 0 0 1rem 0;
            color: #2d3748;
        }
        
        .article-markdown code {
            background: #f7fafc;
            color: #e53e3e;
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
            font-size: 0.9rem;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        }
        
        .article-markdown pre {
            background: #1a202c;
            color: #e2e8f0;
            padding: 1rem;
            border-radius: 8px;
            overflow-x: auto;
            margin: 1rem 0;
        }
        
        .article-markdown pre code {
            background: none;
            color: inherit;
            padding: 0;
        }
        
        .article-markdown ul, .article-markdown ol {
            margin: 0 0 1rem 0;
            padding-left: 1.5rem;
        }
        
        .article-markdown li {
            margin: 0.25rem 0;
        }
        
        .article-markdown blockquote {
            border-left: 4px solid #667eea;
            padding-left: 1rem;
            margin: 1rem 0;
            color: #4a5568;
            font-style: italic;
        }
        
        .article-markdown strong {
            font-weight: 600;
            color: #1a202c;
        }
        
        /* „Ç¢„Ç≥„Éº„Éá„Ç£„Ç™„É≥„Çπ„Çø„Ç§„É´ */
        .costs-accordion {
            margin: 1rem 0;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .accordion-header {
            background: #f8fafc;
            padding: 0.75rem 1rem;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
            color: #4a5568;
            transition: background-color 0.3s ease;
        }
        
        .accordion-header:hover {
            background: #e2e8f0;
        }
        
        .accordion-arrow {
            font-size: 0.8rem;
        }
        
        /* Ê±éÁî®„É°„ÉÉ„Çª„Éº„Ç∏Ë°®Á§∫ */
        .message-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            max-width: 400px;
        }
        
        .message-item {
            padding: 0.75rem 1rem;
            border-radius: 6px;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            animation: slideInRight 0.3s ease;
        }
        
        .message-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .message-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .message-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
            transition: transform 0.3s ease;
        }
        
        .accordion-arrow.expanded {
            transform: rotate(180deg);
        }
        
        .accordion-content {
            padding: 1rem;
            background: white;
            border-top: 1px solid #e2e8f0;
        }
    </style>
</head>
<body>
    <!-- Ê±éÁî®„É°„ÉÉ„Çª„Éº„Ç∏Ë°®Á§∫„Ç≥„É≥„ÉÜ„Éä -->
    <div id="messageContainer" class="message-container"></div>
    
    <div class="app-header">
        <h1>üé• YouTube AI Assistant</h1>
        <p>ÂãïÁîª„ÇíÊñáÂ≠óËµ∑„Åì„Åó„Åó„Å¶„ÄÅAI„Å®ÂØæË©±„Åó„Çà„ÅÜ</p>
    </div>
    
    <div class="section">
        <h2><span class="section-icon">üì•</span>YouTubeÂãïÁîª„Çí„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ</h2>
        <div class="input-group">
            <div class="main-tags-container">
                <label for="mainTags" style="font-weight: 600; color: #2d3748; display: block; margin-bottom: 0.5rem;">üè∑Ô∏è „É°„Ç§„É≥„Çø„Ç∞ („Ç´„É≥„ÉûÂå∫Âàá„Çä):</label>
                <input type="text" id="mainTags" placeholder="‰æã: ÂïÜË´á, „Éó„É≠„Ç∏„Çß„ÇØ„Éà, Â≠¶ÁøíË≥áÊñô" 
                       style="width: 100%; padding: 0.75rem; border-radius: 8px; border: 2px solid #e2e8f0; margin-bottom: 0.5rem;"
                       oninput="showMainTagSuggestions(this.value)" onfocus="showMainTagSuggestions(this.value)">
                <div class="main-tag-suggestions" id="mainTagSuggestions" style="display: none; position: relative; z-index: 100;">
                    <div class="suggestion-list" style="background: white; border: 1px solid #e2e8f0; border-radius: 8px; max-height: 150px; overflow-y: auto; box-shadow: 0 4px 12px rgba(0,0,0,0.15);"></div>
                </div>
                <div class="selected-main-tags" id="selectedMainTags" style="margin-top: 0.5rem; display: flex; flex-wrap: wrap; gap: 0.25rem;"></div>
            </div>
            <input type="text" id="youtubeUrl" placeholder="YouTube„ÅÆURL„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ">
            <div class="controls-row">
                <div class="language-selector">
                    <label for="languageSelect">ÊñáÂ≠óËµ∑„Åì„ÅóË®ÄË™û:</label>
                    <select id="languageSelect">
                        <option value="original" selected>Original (Ëá™ÂãïÂà§ÂÆö)</option>
                        <option value="ja">Êó•Êú¨Ë™û</option>
                        <option value="en">English</option>
                    </select>
                </div>
                <div class="model-selector">
                    <label for="gptModelSelect">GPT„É¢„Éá„É´:</label>
                    <select id="gptModelSelect">
                        <option value="gpt-4o-mini">GPT-4o-mini - $0.60/$2.40 per 1M tokens</option>
                        <option value="gpt-4o">GPT-4o (È´òÂìÅË≥™) - $5.00/$15.00 per 1M tokens</option>
                        <option value="gpt-4-turbo">GPT-4-turbo (ÊúÄÈ´òÂìÅË≥™) - $10.00/$30.00 per 1M tokens</option>
                        <option value="gpt-3.5-turbo">GPT-3.5-turbo (È´òÈÄü„Éª‰Ωé„Ç≥„Çπ„Éà) - $0.50/$1.50 per 1M tokens</option>
                        <option value="gpt-4.1-nano">GPT-4.1-nano (Ë∂ÖÈ´òÈÄü) - $0.10/$0.40 per 1M tokens</option>
                        <option value="gpt-4.1-mini" selected>GPT-4.1-mini (Êé®Â•®) - $0.40/$1.60 per 1M tokens</option>
                        <option value="gpt-4.1">GPT-4.1 (ÊúÄÊñ∞) - $2.00/$8.00 per 1M tokens</option>
                        <option value="gpt-o3">GPT-o3 (Êé®Ë´ñÂº∑Âåñ) - $2.00/$8.00 per 1M tokens</option>
                        <option value="gpt-4o-mini-new">GPT-4o-mini (Êñ∞) - $1.10/$4.40 per 1M tokens</option>
                    </select>
                </div>
            </div>
        </div>
        <button id="uploadBtn">Ëß£ÊûêÈñãÂßã</button>
        <div id="uploadStatus"></div>
        
    </div>

    <div class="main-content">
        <div class="left-panel">
            <div class="section">
                <h2><span class="section-icon">üìä</span>ÂãïÁîªÊÉÖÂ†±</h2>
                <div id="videoInfo" class="video-info" style="display: none;">
                    <div class="video-player-container" id="videoPlayerContainer" style="display: none;">
                        <div id="youtubePlayer"></div>
                    </div>
                    <div class="info-grid" style="grid-template-columns: 1fr; gap: 5px; font-size: 0.85rem;">
                        <div class="info-item" style="padding: 5px 8px;">
                            <strong>„Çø„Ç§„Éà„É´:</strong> <span id="videoTitle">-</span>
                        </div>
                        <div class="info-item" style="padding: 5px 8px;">
                            <strong>„ÉÅ„É£„É≥„Éç„É´:</strong> <span id="videoChannel">-</span>
                        </div>
                        <div class="info-item" style="padding: 5px 8px;">
                            <strong>ÊôÇÈñì:</strong> <span id="videoDuration">-</span> | <strong>ÂÜçÁîüÂõûÊï∞:</strong> <span id="videoViews">-</span>
                        </div>
                        <div class="info-item" style="padding: 5px 8px;">
                            <strong>Âá¶ÁêÜÊñπÊ≥ï:</strong> <span id="processingMethod">-</span>
                        </div>
                    </div>
                    <div id="chaptersInfo" class="chapters-info" style="display: none;">
                        <h4>üìã „ÉÅ„É£„Éó„Çø„ÉºÊÉÖÂ†±</h4>
                        <div id="chaptersList"></div>
                    </div>
                </div>
            </div>

            <div class="section">
                <h2><span class="section-icon">üí∞</span>‰ΩøÁî®ÊñôÈáë</h2>
                
                <div class="costs-tabs">
                    <button class="costs-tab-button active" onclick="switchCostsTab('analysis')">ÂàÜÊûê</button>
                    <button class="costs-tab-button" onclick="switchCostsTab('graph')">„Ç∞„É©„Éï</button>
                </div>
                
                <div id="analysisCosts" class="costs-tab-content active">
                    <div class="costs-filter">
                        <select id="periodSelect" onchange="loadCostsAnalysis()">
                            <option value="today" selected>Êú¨Êó•</option>
                            <option value="week">ÈÄ±Èñì</option>
                            <option value="month">ÊúàÈñì</option>
                            <option value="total">„Éà„Éº„Çø„É´</option>
                        </select>
                    </div>
                    <div id="costsAnalysisResult">
                        ÂàÜÊûê„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø‰∏≠...
                    </div>
                </div>
                
                <div id="graphCosts" class="costs-tab-content">
                    <div class="costs-filter">
                        <select id="graphPeriodSelect" onchange="loadCostsGraph()">
                            <option value="today" selected>Êú¨Êó•</option>
                            <option value="week">ÈÄ±Èñì</option>
                            <option value="month">ÊúàÈñì</option>
                            <option value="total">„Éà„Éº„Çø„É´</option>
                        </select>
                    </div>
                    <div id="costsGraphResult">
                        <canvas id="costsChart" width="300" height="200"></canvas>
                    </div>
                </div>
            </div>

<div class="section">
                <h2><span class="section-icon">üìö</span>Â±•Ê≠¥</h2>
                
                <div class="history-controls">
                    <div class="history-tabs">
                        <button class="history-tab-button active" onclick="switchHistoryTab('timeline')">ÊôÇÈñìËª∏</button>
                        <button class="history-tab-button" onclick="switchHistoryTab('channel')">„ÉÅ„É£„É≥„Éç„É´Âà•</button>
                        <button class="history-tab-button" onclick="switchHistoryTab('tag')">„Çø„Ç∞Âà•</button>
                    </div>
                    
                    <div class="history-filters">
                        <select id="historyFilter" onchange="filterHistory()" style="width: 100%; padding: 0.5rem; margin: 0.5rem 0; border-radius: 6px; border: 1px solid #e2e8f0;">
                            <option value="all">„Åô„Åπ„Å¶</option>
                            <option value="today">Êú¨Êó•</option>
                            <option value="week">ÈÅéÂéª7Êó•</option>
                            <option value="month">ÈÅéÂéª30Êó•</option>
                        </select>
                        
                        <input type="text" id="historySearch" placeholder="Ê§úÁ¥¢..." 
                               style="width: 100%; padding: 0.5rem; margin: 0.5rem 0; border-radius: 6px; border: 1px solid #e2e8f0;"
                               oninput="searchHistory()">
                    </div>
                </div>
                
                <div id="historyList" class="history-list">
                    Â±•Ê≠¥„ÇíË™≠„ÅøËæº„Åø‰∏≠...
                </div>
                <button onclick="loadHistory()" id="refreshHistoryBtn">Â±•Ê≠¥„ÇíÊõ¥Êñ∞</button>
            </div>
        </div>
        <div class="resize-handle" id="resizeHandle"></div>
        <div class="right-panel">
            <div class="content-tabs">
                <button class="tab-button active" onclick="switchTab('summary')">
                    <span style="font-size: 1.5rem;">üìù</span>
                    <span>Ë¶ÅÁ¥Ñ</span>
                </button>
                <button class="tab-button" onclick="switchTab('transcript')">
                    <span style="font-size: 1.5rem;">üìã</span>
                    <span>ÊñáÂ≠óËµ∑„Åì„Åó</span>
                </button>
                <button class="tab-button" onclick="switchTab('article')">
                    <span style="font-size: 1.5rem;">‚úçÔ∏è</span>
                    <span>Ëß£Ë™¨Ë®ò‰∫ã</span>
                </button>
            </div>
            
            <div id="summaryTab" class="tab-content active">
                <!-- „Éó„É≠„É≥„Éó„ÉàË®≠ÂÆö„Çª„ÇØ„Ç∑„Éß„É≥ -->
                <div class="prompt-settings" style="margin-bottom: 1rem;">
                    <div class="prompt-toggle" onclick="togglePromptSettings('summary')" style="cursor: pointer; padding: 0.75rem; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
                        <span style="font-weight: 600; color: #4a5568;">‚öôÔ∏è Ë¶ÅÁ¥Ñ„Éó„É≠„É≥„Éó„ÉàË®≠ÂÆö</span>
                        <span id="summaryPromptArrow" class="prompt-arrow">‚ñº</span>
                    </div>
                    <div id="summaryPromptSettings" class="prompt-content" style="display: none; margin-top: 0.5rem; padding: 1rem; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px;">
                        <div style="margin-bottom: 1rem;">
                            <label style="font-weight: 600; color: #4a5568; display: block; margin-bottom: 0.5rem;">„Ç´„Çπ„Çø„É†„Éó„É≠„É≥„Éó„Éà:</label>
                            <textarea id="summaryPromptText" rows="10" placeholder="„Éá„Éï„Ç©„É´„Éà„Éó„É≠„É≥„Éó„Éà„ÅåË°®Á§∫„Åï„Çå„Å¶„ÅÑ„Åæ„Åô„ÄÇÁ∑®ÈõÜ„Åó„Å¶‰øùÂ≠ò„Åß„Åç„Åæ„Åô„ÄÇ"
                                      style="width: 100%; font-family: monospace; font-size: 0.85rem; padding: 0.75rem; border: 1px solid #e2e8f0; border-radius: 6px; resize: vertical;"></textarea>
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <button onclick="savePrompt('summary')" style="margin-right: 0.5rem; padding: 0.5rem 1rem; background: #48bb78; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9rem;">üíæ ‰øùÂ≠ò</button>
                            <button onclick="resetPrompt('summary')" style="padding: 0.5rem 1rem; background: #f56565; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9rem;">üîÑ „Éá„Éï„Ç©„É´„Éà„Å´Êàª„Åô</button>
                        </div>
                        <div id="summaryPromptMessage" style="display: none; padding: 0.75rem; border-radius: 6px; font-size: 0.9rem; margin-bottom: 0.5rem;"></div>
                    </div>
                </div>
                
                <!-- Ë¶ÅÁ¥ÑÂÜçÁîüÊàê„Éú„Çø„É≥ -->
                <div id="summaryRegenerateSection" style="display: none; margin-bottom: 0.5rem; padding: 0.4rem 0.6rem; background: #fef5e7; border: 1px solid #f6ad55; border-radius: 6px;">
                    <button onclick="regenerateContent('summary')" id="regenerateSummaryOnlyBtn" 
                            style="background: #38a169; color: white; border: none; padding: 0.4rem 0.8rem; border-radius: 4px; cursor: pointer; font-weight: 500; font-size: 0.8rem; transition: all 0.3s ease;" 
                            onmouseover="this.style.background='#2f855a'" 
                            onmouseout="this.style.background='#38a169'">
                        üìã Ë¶ÅÁ¥Ñ„ÇíÂÜçËß£Êûê
                    </button>
                </div>
                
                <div id="summary" class="summary">
                    Ë¶ÅÁ¥Ñ„Åå„Åì„Åì„Å´Ë°®Á§∫„Åï„Çå„Åæ„Åô...
                </div>
            </div>
            
            <div id="articleTab" class="tab-content">
                <!-- „Éó„É≠„É≥„Éó„ÉàË®≠ÂÆö„Çª„ÇØ„Ç∑„Éß„É≥ -->
                <div class="prompt-settings" style="margin-bottom: 1rem;">
                    <div class="prompt-toggle" onclick="togglePromptSettings('article')" style="cursor: pointer; padding: 0.75rem; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
                        <span style="font-weight: 600; color: #4a5568;">‚öôÔ∏è Ëß£Ë™¨Ë®ò‰∫ã„Éó„É≠„É≥„Éó„ÉàË®≠ÂÆö</span>
                        <span id="articlePromptArrow" class="prompt-arrow">‚ñº</span>
                    </div>
                    <div id="articlePromptSettings" class="prompt-content" style="display: none; margin-top: 0.5rem; padding: 1rem; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px;">
                        <div style="margin-bottom: 1rem;">
                            <label style="font-weight: 600; color: #4a5568; display: block; margin-bottom: 0.5rem;">„Ç´„Çπ„Çø„É†„Éó„É≠„É≥„Éó„Éà:</label>
                            <textarea id="articlePromptText" rows="10" placeholder="„Éá„Éï„Ç©„É´„Éà„Éó„É≠„É≥„Éó„Éà„ÅåË°®Á§∫„Åï„Çå„Å¶„ÅÑ„Åæ„Åô„ÄÇÁ∑®ÈõÜ„Åó„Å¶‰øùÂ≠ò„Åß„Åç„Åæ„Åô„ÄÇ"
                                      style="width: 100%; font-family: monospace; font-size: 0.85rem; padding: 0.75rem; border: 1px solid #e2e8f0; border-radius: 6px; resize: vertical;"></textarea>
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <button onclick="savePrompt('article')" style="margin-right: 0.5rem; padding: 0.5rem 1rem; background: #48bb78; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9rem;">üíæ ‰øùÂ≠ò</button>
                            <button onclick="resetPrompt('article')" style="margin-right: 0.5rem; padding: 0.5rem 1rem; background: #f56565; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9rem;">üîÑ „É™„Çª„ÉÉ„Éà</button>
                        </div>
                        <div id="articlePromptMessage" style="display: none; padding: 0.75rem; border-radius: 6px; font-size: 0.9rem; margin-bottom: 0.5rem;"></div>
                    </div>
                </div>
                
                <div style="margin-bottom: 1rem;">
                    <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                        <label for="articleModelSelect" style="font-weight: 600; color: #4a5568;">Ë®ò‰∫ãÁîüÊàê„É¢„Éá„É´:</label>
                        <select id="articleModelSelect" style="padding: 0.5rem; border-radius: 6px; border: 1px solid #e2e8f0; font-size: 0.9rem;">
                            <option value="gpt-4o-mini">GPT-4o-mini - $0.60/$2.40</option>
                            <option value="gpt-4o">GPT-4o (È´òÂìÅË≥™) - $5.00/$15.00</option>
                            <option value="gpt-4-turbo">GPT-4-turbo (ÊúÄÈ´òÂìÅË≥™) - $10.00/$30.00</option>
                            <option value="gpt-3.5-turbo">GPT-3.5-turbo (È´òÈÄü„Éª‰Ωé„Ç≥„Çπ„Éà) - $0.50/$1.50</option>
                            <option value="gpt-4.1-nano">GPT-4.1-nano (Ë∂ÖÈ´òÈÄü) - $0.10/$0.40</option>
                            <option value="gpt-4.1-mini" selected>GPT-4.1-mini (Êé®Â•®) - $0.40/$1.60</option>
                            <option value="gpt-4.1">GPT-4.1 (ÊúÄÊñ∞) - $2.00/$8.00</option>
                            <option value="gpt-o3">GPT-o3 (Êé®Ë´ñÂº∑Âåñ) - $2.00/$8.00</option>
                            <option value="gpt-4o-mini-new">GPT-4o-mini (Êñ∞) - $1.10/$4.40</option>
                        </select>
                    </div>
                    <div id="templateStatus" style="background: #f0f9ff; border: 1px solid #0ea5e9; border-radius: 6px; padding: 0.75rem; margin-bottom: 1rem; font-size: 0.85rem;">
                        <div style="font-weight: 600; color: #0f172a; margin-bottom: 0.25rem;">üìö „ÉÜ„É≥„Éó„É¨„Éº„ÉàÊÉÖÂ†±</div>
                        <div id="templateInfo" style="color: #475569;">„ÉÜ„É≥„Éó„É¨„Éº„ÉàÊÉÖÂ†±„ÇíË™≠„ÅøËæº„Åø‰∏≠...</div>
                    </div>
                    <div style="display: flex; align-items: center; justify-content: space-between; gap: 1rem;">
                        <button id="generateArticleBtn" onclick="generateArticle()" style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s ease;">
                            üìù Ëß£Ë™¨Ë®ò‰∫ã„Çí‰ΩúÊàê
                        </button>
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <button id="toggleArticleHistoryBtn" onclick="toggleArticleHistory()" style="background: #f7fafc; color: #4a5568; border: 1px solid #e2e8f0; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.9rem; transition: all 0.3s ease;">
                                üìú Â±•Ê≠¥Ë°®Á§∫
                            </button>
                            <span id="articleStatus" style="color: #666;"></span>
                        </div>
                    </div>
                </div>
                
                <!-- Ë®ò‰∫ãÂ±•Ê≠¥„Éë„Éç„É´ -->
                <div id="articleHistoryPanel" style="display: none; margin-bottom: 1rem; padding: 1rem; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px;">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.75rem;">
                        <h4 style="margin: 0; color: #2d3748; font-size: 1rem;">üìú Ë®ò‰∫ãÂ±•Ê≠¥</h4>
                        <button onclick="toggleArticleHistory()" style="background: transparent; border: none; color: #718096; cursor: pointer; font-size: 1.2rem; padding: 0.25rem;">√ó</button>
                    </div>
                    <div id="articleHistoryList" style="max-height: 300px; overflow-y: auto;">
                        <p style="color: #718096; text-align: center; padding: 1rem;">Â±•Ê≠¥„ÇíË™≠„ÅøËæº„Åø‰∏≠...</p>
                    </div>
                </div>
                
                <div id="articleContent" style="line-height: 1.8;">
                    <p style="color: #888; text-align: center; padding: 2rem;">„ÄåËß£Ë™¨Ë®ò‰∫ã„Çí‰ΩúÊàê„Äç„Éú„Çø„É≥„ÇíÊäº„Åô„Å®„ÄÅZenn/QiitaÁî®„ÅÆË®ò‰∫ã„ÅåÁîüÊàê„Åï„Çå„Åæ„Åô</p>
                </div>
            </div>
            
            <div id="transcriptTab" class="tab-content">
                <!-- ÊñáÂ≠óËµ∑„Åì„ÅóÂÜçÁîüÊàê„Éú„Çø„É≥ -->
                <div id="transcriptRegenerateSection" style="display: none; margin-bottom: 0.5rem; padding: 0.4rem 0.6rem; background: #fef5e7; border: 1px solid #f6ad55; border-radius: 6px;">
                    <div style="display: flex; gap: 0.4rem; flex-wrap: wrap;">
                        <button onclick="regenerateContent('transcript')" id="regenerateTranscriptOnlyBtn" 
                                style="background: #3182ce; color: white; border: none; padding: 0.4rem 0.8rem; border-radius: 4px; cursor: pointer; font-weight: 500; font-size: 0.8rem; transition: all 0.3s ease;" 
                                onmouseover="this.style.background='#2c5282'" 
                                onmouseout="this.style.background='#3182ce'">
                            üìù ÊñáÂ≠óËµ∑„Åì„Åó„ÅÆ„ÅøÂÜçËß£Êûê
                        </button>
                        <button onclick="regenerateContent('both')" id="regenerateBothFromTranscriptBtn" 
                                style="background: #f56565; color: white; border: none; padding: 0.4rem 0.8rem; border-radius: 4px; cursor: pointer; font-weight: 500; font-size: 0.8rem; transition: all 0.3s ease;" 
                                onmouseover="this.style.background='#e53e3e'" 
                                onmouseout="this.style.background='#f56565'">
                            üîÑ ÂÖ®„Å¶ÂÜçËß£Êûê
                        </button>
                    </div>
                </div>
                
                <div id="transcript" class="transcript timestamp-transcript">
                    ÊñáÂ≠óËµ∑„Åì„ÅóÁµêÊûú„Åå„Åì„Åì„Å´Ë°®Á§∫„Åï„Çå„Åæ„Åô...
                </div>
            </div>

            <div class="chat-panel">
                <div class="chat-header">
                    <h3><span class="section-icon">ü§ñ</span>AI„Ç¢„Ç∑„Çπ„Çø„É≥„Éà</h3>
                    <p style="font-size: 0.85rem; color: #666; margin: 0.5rem 0 0 0;">ÂãïÁîªÂÜÖÂÆπ„Å∏„ÅÆË≥™Âïè„ÄÅËß£Ë™¨Ë®ò‰∫ã„ÅÆ‰øÆÊ≠£„ÄÅ„Åù„ÅÆ‰ªñ„Å™„Çì„Åß„ÇÇ„ÅäËÅû„Åç„Åè„Å†„Åï„ÅÑ</p>
                    <div id="suggestedQuestions" class="suggested-questions" style="display: none;">
                        <h4 style="margin: 0 0 0.3rem 0; font-size: 0.8rem; color: #4a5568; font-weight: 600;">üí° „Åä„Åô„Åô„ÇÅË≥™Âïè</h4>
                        <div id="questionsList"></div>
                    </div>
                </div>
                <div class="chat-messages-panel">
                    <div id="chatMessages" class="chat-messages">
                        <div class="message ai-message">
                            „Åì„Çì„Å´„Å°„ÅØÔºÅÁßÅ„ÅØAI„Ç¢„Ç∑„Çπ„Çø„É≥„Éà„Åß„Åô„ÄÇüé•<br>
                            ÂãïÁîª„ÅÆÂÜÖÂÆπ„Å´„Å§„ÅÑ„Å¶„ÅÆË≥™Âïè„ÄÅËß£Ë™¨Ë®ò‰∫ã„ÅÆ‰øÆÊ≠£ÊåáÁ§∫„ÄÅË¶ÅÁ¥Ñ„ÅÆÊ∑±Êéò„Çä„Å™„Å©„ÄÅ‰Ωï„Åß„ÇÇ„ÅäËÅû„Åç„Åè„Å†„Åï„ÅÑ„ÄÇ<br>
                            „Åæ„Åö„ÅØYouTubeÂãïÁîª„ÇíÊñáÂ≠óËµ∑„Åì„Åó„Åó„Å¶„Åã„Çâ„ÅîÂà©Áî®„Åè„Å†„Åï„ÅÑ„ÄÇ
                        </div>
                    </div>
                </div>
                <div class="chat-input-panel">
                    <div class="chat-input-container">
                        <input type="text" id="chatInput" placeholder="Ë≥™Âïè„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ...">
                        <button onclick="sendMessage()" id="chatBtn">ÈÄÅ‰ø°</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let isTranscriptReady = false;
        let youtubePlayer = null;
        let currentVideoId = null;
        let userInitiatedPlay = false;
        let currentTimestampedSegments = [];
        let currentTimestampedTranscript = '';
        let currentTranscript = '';
        let videoSyncInterval = null;

        // YouTube Player API ready callback
        function onYouTubeIframeAPIReady() {
            console.log('YouTube IFrame API ready');
        }

        function initializeYouTubePlayer(videoId) {
            currentVideoId = videoId;
            
            if (youtubePlayer) {
                // Êó¢Â≠ò„Éó„É¨„Ç§„É§„Éº„ÅÆÂ†¥Âêà„ÄÅ„Ç≠„É•„Éº„Å´ËøΩÂä†„Åó„Å¶‰∏ÄÊôÇÂÅúÊ≠¢Áä∂ÊÖã„ÅßË™≠„ÅøËæº„Åø
                youtubePlayer.unMute(); // Èü≥Â£∞„Çí„Ç™„É≥„Å´„Åô„Çã
                youtubePlayer.cueVideoById(videoId);
            } else {
                youtubePlayer = new YT.Player('youtubePlayer', {
                    height: '100%',
                    width: '100%',
                    videoId: videoId,
                    playerVars: {
                        'playsinline': 1,
                        'modestbranding': 1,
                        'rel': 0,
                        'autoplay': 0,
                        'controls': 1,
                        'enablejsapi': 1,
                        'mute': 0,
                        'start': 0
                    },
                    events: {
                        'onReady': function(event) {
                            console.log('YouTube player ready');
                            // Èü≥Â£∞„Çí„Ç™„É≥„Å´„Åô„Çã
                            event.target.unMute();
                            // ÂãïÁîª„Çí„Ç≠„É•„Éº„Å´ËøΩÂä†ÔºàÂÜçÁîü„Åó„Å™„ÅÑÔºâ
                            event.target.cueVideoById(videoId);
                        },
                        'onStateChange': function(event) {
                            console.log('Player state changed:', event.data, 'userInitiatedPlay:', userInitiatedPlay);
                            
                            // ÊÑèÂõ≥„Åó„Å™„ÅÑÂÜçÁîü„ÇíÈò≤„ÅêÔºà„É¶„Éº„Ç∂„ÉºÈñãÂßã„Åß„Å™„ÅÑÂ†¥Âêà„ÅÆ„ÅøÔºâ
                            if (event.data === YT.PlayerState.PLAYING && !userInitiatedPlay) {
                                console.log('Preventing autoplay - pausing video');
                                event.target.pauseVideo();
                            }
                            
                            // „É¶„Éº„Ç∂„Éº„ÅåÈñãÂßã„Åó„ÅüÂÜçÁîü„ÅÆÂ†¥Âêà„ÄÅ„Éï„É©„Ç∞„ÇíÁ∂≠ÊåÅ
                            if (event.data === YT.PlayerState.PLAYING && userInitiatedPlay) {
                                console.log('User initiated play - allowing playback');
                            }
                            
                            // ÂãïÁîª„ÅåÂÅúÊ≠¢/‰∏ÄÊôÇÂÅúÊ≠¢„Åó„ÅüÂ†¥Âêà„ÄÅ„Éï„É©„Ç∞„Çí„É™„Çª„ÉÉ„Éà
                            if (event.data === YT.PlayerState.PAUSED || event.data === YT.PlayerState.ENDED) {
                                userInitiatedPlay = false;
                                console.log('Video paused/ended - reset userInitiatedPlay flag');
                            }
                        }
                    }
                });
            }
            
            document.getElementById('videoPlayerContainer').style.display = 'block';
        }

        function seekToTime(seconds) {
            if (youtubePlayer && youtubePlayer.seekTo) {
                console.log('Seeking to time:', seconds, 'seconds');
                userInitiatedPlay = true;
                // Èü≥Â£∞„Çí„Ç™„É≥„Å´„Åó„Å¶„Åã„ÇâÂÜçÁîü
                youtubePlayer.unMute();
                youtubePlayer.seekTo(seconds, true);
                youtubePlayer.playVideo();
                console.log('Video play initiated by user');
                // „Éï„É©„Ç∞„ÅØ onStateChange „Åß„É™„Çª„ÉÉ„Éà„Åï„Çå„Çã„ÅÆ„Åß„ÄÅ„Åì„Åì„Åß„ÅØ„É™„Çª„ÉÉ„Éà„Åó„Å™„ÅÑ
            }
        }

        let userScrolling = false;
        let lastScrollTime = 0;
        let scrollEventAdded = false;

        // ÂãïÁîª„Å®„Éà„É©„É≥„Çπ„ÇØ„É™„Éó„Éà„ÅÆÂêåÊúüÊ©üËÉΩ
        function startVideoSync() {
            if (videoSyncInterval) {
                clearInterval(videoSyncInterval);
            }
            
            // „É¶„Éº„Ç∂„Éº„ÅÆ„Çπ„ÇØ„É≠„Éº„É´Ê§úÂá∫ÔºàÈáçË§áËøΩÂä†„ÇíÈò≤„ÅêÔºâ
            if (!scrollEventAdded) {
                const transcriptDiv = document.getElementById('transcript');
                
                // „Çπ„ÇØ„É≠„Éº„É´„Ç§„Éô„É≥„Éà
                transcriptDiv.addEventListener('scroll', handleUserScroll);
                
                // „Éû„Ç¶„Çπ„ÇÑ„Çø„ÉÉ„ÉÅ„ÅÆÊìç‰ΩúÊ§úÂá∫
                transcriptDiv.addEventListener('mousedown', handleUserInteraction);
                transcriptDiv.addEventListener('touchstart', handleUserInteraction);
                transcriptDiv.addEventListener('wheel', handleUserInteraction);
                
                // „ÉÜ„Ç≠„Çπ„ÉàÈÅ∏ÊäûÊ§úÂá∫
                document.addEventListener('selectionchange', handleUserInteraction);
                
                scrollEventAdded = true;
            }
            
            videoSyncInterval = setInterval(() => {
                if (youtubePlayer && youtubePlayer.getCurrentTime && currentTimestampedSegments.length > 0) {
                    const currentTime = youtubePlayer.getCurrentTime();
                    highlightCurrentSegment(currentTime);
                }
            }, 1000);
        }

        function handleUserScroll() {
            userScrolling = true;
            lastScrollTime = Date.now();
            // 5ÁßíÂæå„Å´Ëá™Âãï„Çπ„ÇØ„É≠„Éº„É´„ÇíÂÜçÈñãÔºàÊôÇÈñì„ÇíÂª∂Èï∑Ôºâ
            setTimeout(() => {
                if (Date.now() - lastScrollTime >= 5000) {
                    userScrolling = false;
                }
            }, 5000);
        }

        function handleUserInteraction() {
            userScrolling = true;
            lastScrollTime = Date.now();
            // „É¶„Éº„Ç∂„Éº„ÅåÊìç‰Ωú„Åó„ÅüÂ†¥Âêà„ÅØ10ÁßíÈñìËá™Âãï„Çπ„ÇØ„É≠„Éº„É´„ÇíÂÅúÊ≠¢
            setTimeout(() => {
                if (Date.now() - lastScrollTime >= 10000) {
                    userScrolling = false;
                }
            }, 10000);
        }

        function stopVideoSync() {
            if (videoSyncInterval) {
                clearInterval(videoSyncInterval);
                videoSyncInterval = null;
            }
            userScrolling = false;
            
            // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„Çí„ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„Éó
            if (scrollEventAdded) {
                const transcriptDiv = document.getElementById('transcript');
                transcriptDiv.removeEventListener('scroll', handleUserScroll);
                transcriptDiv.removeEventListener('mousedown', handleUserInteraction);
                transcriptDiv.removeEventListener('touchstart', handleUserInteraction);
                transcriptDiv.removeEventListener('wheel', handleUserInteraction);
                document.removeEventListener('selectionchange', handleUserInteraction);
                scrollEventAdded = false;
            }
        }

        function highlightCurrentSegment(currentTime) {
            // ÁèæÂú®„ÅÆÊôÇÈñì„Å´ÊúÄ„ÇÇËøë„ÅÑ„Çª„Ç∞„É°„É≥„Éà„ÇíË¶ã„Å§„Åë„Çã
            let currentSegmentIndex = -1;
            for (let i = 0; i < currentTimestampedSegments.length; i++) {
                const segment = currentTimestampedSegments[i];
                if (currentTime >= segment.start && currentTime < segment.start + segment.duration) {
                    currentSegmentIndex = i;
                    break;
                }
            }
            
            // ÂÖ®„Å¶„ÅÆ„Çª„Ç∞„É°„É≥„Éà„Åã„Çâ„Éè„Ç§„É©„Ç§„Éà„ÇíÂâäÈô§
            document.querySelectorAll('.timestamp-segment').forEach(el => {
                el.classList.remove('current-segment');
            });
            
            // ÁèæÂú®„ÅÆ„Çª„Ç∞„É°„É≥„Éà„Çí„Éè„Ç§„É©„Ç§„Éà
            if (currentSegmentIndex >= 0) {
                const segments = document.querySelectorAll('.timestamp-segment');
                if (segments[currentSegmentIndex]) {
                    segments[currentSegmentIndex].classList.add('current-segment');
                    
                    // Ëá™Âãï„Çπ„ÇØ„É≠„Éº„É´„ÅÆÊù°‰ª∂„Çí„Çà„ÇäÂé≥„Åó„Åè
                    const transcriptDiv = document.getElementById('transcript');
                    const isTranscriptVisible = transcriptDiv.offsetParent !== null;
                    const hasSelection = window.getSelection().toString().length > 0;
                    
                    // „É¶„Éº„Ç∂„Éº„Åå„Çπ„ÇØ„É≠„Éº„É´„Åó„Å¶„Åä„Çâ„Åö„ÄÅ„ÉÜ„Ç≠„Çπ„ÉàÈÅ∏Êäû„ÇÇ„Åó„Å¶„Åä„Çâ„Åö„ÄÅË¶ÅÁ¥†„ÅåË¶ã„Åà„ÇãÂ†¥Âêà„ÅÆ„ÅøËá™Âãï„Çπ„ÇØ„É≠„Éº„É´
                    if (!userScrolling && !hasSelection && isTranscriptVisible) {
                        segments[currentSegmentIndex].scrollIntoView({
                            behavior: 'smooth',
                            block: 'center'
                        });
                    }
                }
            }
        }

        // Ëß£Ë™¨Ë®ò‰∫ãÁîüÊàêÊ©üËÉΩ
        async function generateArticle() {
            try {
                const generateBtn = document.getElementById('generateArticleBtn');
                const articleStatus = document.getElementById('articleStatus');
                const articleContent = document.getElementById('articleContent');
                
                if (!currentTranscript) {
                    articleStatus.textContent = 'ÂÖà„Å´ÂãïÁîª„ÇíÊñáÂ≠óËµ∑„Åì„Åó„Åó„Å¶„Åè„Å†„Åï„ÅÑ';
                    articleStatus.style.color = '#e53e3e';
                    return;
                }
                
                generateBtn.disabled = true;
                generateBtn.textContent = 'üìù ‰ΩúÊàê‰∏≠...';
                articleStatus.textContent = 'Ëß£Ë™¨Ë®ò‰∫ã„ÇíÁîüÊàê‰∏≠„Åß„Åô...';
                articleStatus.style.color = '#667eea';
                
                const response = await fetch('/generate-article', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        gptModel: document.getElementById('articleModelSelect').value || 'gpt-4.1-mini'
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    // Êñ∞„Åó„ÅÑdisplayArticleÈñ¢Êï∞„Çí‰ΩøÁî®„Åó„Å¶„Ç≥„Çπ„ÉàÊÉÖÂ†±‰ªò„Åç„ÅßË°®Á§∫
                    displayArticle(data.article, {
                        cost: data.cost,
                        model: data.model,
                        tokens: data.tokens
                    });
                    
                    // ÁîüÊàê„Åï„Çå„Åü„Éû„Éº„ÇØ„ÉÄ„Ç¶„É≥„Å®HTML„Çí‰øùÂ≠òÔºà„Ç≥„Éî„ÉºÁî®Ôºâ
                    window.generatedArticleMarkdown = data.article;
                    window.generatedArticleHTML = marked.parse(data.article);
                    
                    articleStatus.textContent = 'Ë®ò‰∫ã„ÅåÁîüÊàê„Åï„Çå„Åæ„Åó„ÅüÔºÅ';
                    articleStatus.style.color = '#38a169';
                    
                    // „Çª„ÉÉ„Ç∑„Éß„É≥„Ç≥„Çπ„Éà„ÇíÊõ¥Êñ∞
                    if (data.costs) {
                        updateCosts(data.costs);
                    }
                } else {
                    const errorData = await response.json();
                    articleContent.innerHTML = `<div style="color: #e53e3e; text-align: center; padding: 2rem;">„Ç®„É©„Éº: ${errorData.error}</div>`;
                    articleStatus.textContent = '„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü';
                    articleStatus.style.color = '#e53e3e';
                }
            } catch (error) {
                console.error('Article generation error:', error);
                document.getElementById('articleContent').innerHTML = '<div style="color: #e53e3e; text-align: center; padding: 2rem;">„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü</div>';
                document.getElementById('articleStatus').textContent = '„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü';
                document.getElementById('articleStatus').style.color = '#e53e3e';
            } finally {
                document.getElementById('generateArticleBtn').disabled = false;
                document.getElementById('generateArticleBtn').textContent = 'üìù Ëß£Ë™¨Ë®ò‰∫ã„Çí‰ΩúÊàê';
            }
        }

        // Ë®ò‰∫ã„ÇíMarkdown„Åß„ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Å´„Ç≥„Éî„Éº
        function copyArticleToClipboard() {
            if (window.generatedArticleMarkdown) {
                navigator.clipboard.writeText(window.generatedArticleMarkdown).then(() => {
                    // ‰∏ÄÊôÇÁöÑ„Å™ÊàêÂäü„É°„ÉÉ„Çª„Éº„Ç∏
                    const btn = document.querySelector('button[onclick="copyArticleToClipboard()"]');
                    const originalText = btn.textContent;
                    btn.textContent = '‚úÖ MarkdownÊ∏à„Åø';
                    setTimeout(() => {
                        btn.textContent = originalText;
                    }, 2000);
                    showMessage('Markdown„Çí„ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Å´„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü', 'success');
                }).catch(err => {
                    console.error('„Ç≥„Éî„Éº„Å´Â§±Êïó„Åó„Åæ„Åó„Åü:', err);
                    showMessage('Markdown„Ç≥„Éî„Éº„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
                });
            }
        }

        // Ë®ò‰∫ã„ÇíHTML„Åß„ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Å´„Ç≥„Éî„Éº
        function copyArticleAsHTML() {
            if (window.generatedArticleHTML) {
                navigator.clipboard.writeText(window.generatedArticleHTML).then(() => {
                    // ‰∏ÄÊôÇÁöÑ„Å™ÊàêÂäü„É°„ÉÉ„Çª„Éº„Ç∏
                    const btn = document.querySelector('button[onclick="copyArticleAsHTML()"]');
                    const originalText = btn.textContent;
                    btn.textContent = '‚úÖ HTMLÊ∏à„Åø';
                    setTimeout(() => {
                        btn.textContent = originalText;
                    }, 2000);
                    showMessage('HTML„Çí„ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Å´„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü', 'success');
                }).catch(err => {
                    console.error('„Ç≥„Éî„Éº„Å´Â§±Êïó„Åó„Åæ„Åó„Åü:', err);
                    showMessage('HTML„Ç≥„Éî„Éº„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
                });
            }
        }

        // Ë®ò‰∫ã„Çí„ÉÜ„É≥„Éó„É¨„Éº„Éà„Å®„Åó„Å¶‰øùÂ≠ò
        async function saveArticleTemplate() {
            if (!window.generatedArticleMarkdown) {
                showMessage('‰øùÂ≠ò„Åô„ÇãË®ò‰∫ã„Åå„ÅÇ„Çä„Åæ„Åõ„Çì', 'error');
                return;
            }

            try {
                const response = await fetch('/save-article-template', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        article: window.generatedArticleMarkdown
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    // ‰∏ÄÊôÇÁöÑ„Å™ÊàêÂäü„É°„ÉÉ„Çª„Éº„Ç∏
                    const btn = document.querySelector('button[onclick="saveArticleTemplate()"]');
                    const originalText = btn.textContent;
                    btn.textContent = '‚úÖ ‰øùÂ≠òÊ∏à„Åø';
                    setTimeout(() => {
                        btn.textContent = originalText;
                    }, 2000);
                    
                    // „ÉÜ„É≥„Éó„É¨„Éº„ÉàÊÉÖÂ†±„ÇíÊõ¥Êñ∞
                    loadTemplateInfo();
                    
                    console.log('„ÉÜ„É≥„Éó„É¨„Éº„Éà‰øùÂ≠òÊàêÂäü:', data.message);
                    showMessage('Ë®ò‰∫ã„ÉÜ„É≥„Éó„É¨„Éº„Éà„Çí‰øùÂ≠ò„Åó„Åæ„Åó„ÅüÔºÅ', 'success');
                } else {
                    const errorData = await response.json();
                    showMessage(`‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ${errorData.error}`, 'error');
                }
            } catch (error) {
                console.error('„ÉÜ„É≥„Éó„É¨„Éº„Éà‰øùÂ≠ò„Ç®„É©„Éº:', error);
                showMessage('„ÉÜ„É≥„Éó„É¨„Éº„Éà‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
            }
        }

        // „ÉÜ„É≥„Éó„É¨„Éº„ÉàÊÉÖÂ†±„ÇíË™≠„ÅøËæº„Åø
        async function loadTemplateInfo() {
            try {
                const response = await fetch('/templates-info');
                if (response.ok) {
                    const data = await response.json();
                    const templateInfo = document.getElementById('templateInfo');
                    
                    if (data.templates && data.templates.length > 0) {
                        const latest = data.templates[0];
                        const createdDate = new Date(latest.createdAt).toLocaleDateString('ja-JP');
                        templateInfo.innerHTML = `
                            <div>‰øùÂ≠òÊ∏à„Åø„ÉÜ„É≥„Éó„É¨„Éº„Éà: <strong>${data.templates.length}‰ª∂</strong></div>
                            <div>ÊúÄÊñ∞„ÉÜ„É≥„Éó„É¨„Éº„Éà: ${createdDate} ‰øùÂ≠ò</div>
                            <div>ÊßãÈÄ†: ${latest.structure.hasTitle ? '„Çø„Ç§„Éà„É´' : ''}${latest.structure.hasIntroduction ? '+Â∞éÂÖ•' : ''}${latest.structure.hasCodeBlocks ? '+„Ç≥„Éº„Éâ‰æã' : ''}${latest.structure.hasConclusion ? '+„Åæ„Å®„ÇÅ' : ''}</div>
                            <div style="font-size: 0.75rem; color: #64748b; margin-top: 0.25rem;">Ê¨°Âõû„ÅÆË®ò‰∫ãÁîüÊàêÊôÇ„Å´Ëá™Âãï„ÅßÂèÇËÄÉ„Å´„Åó„Åæ„Åô</div>
                        `;
                    } else {
                        templateInfo.textContent = '„Åæ„Å†„ÉÜ„É≥„Éó„É¨„Éº„Éà„Åå‰øùÂ≠ò„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇËâØ„ÅÑË®ò‰∫ã„Åå„Åß„Åç„Åü„Çâ„Äå„ÉÜ„É≥„Éó„É¨„Éº„Éà‰øùÂ≠ò„Äç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ';
                    }
                } else {
                    document.getElementById('templateInfo').textContent = '„ÉÜ„É≥„Éó„É¨„Éº„ÉàÊÉÖÂ†±„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü';
                }
            } catch (error) {
                console.error('„ÉÜ„É≥„Éó„É¨„Éº„ÉàÊÉÖÂ†±Ë™≠„ÅøËæº„Åø„Ç®„É©„Éº:', error);
                document.getElementById('templateInfo').textContent = '„ÉÜ„É≥„Éó„É¨„Éº„ÉàÊÉÖÂ†±„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü';
            }
        }

        // Â±•Ê≠¥„Åã„ÇâË®ò‰∫ã„ÇíË™≠„ÅøËæº„Åø
        async function loadArticleFromHistory() {
            try {
                // ÁèæÂú®„ÅÆ„Éì„Éá„Ç™ID„ÇíÂèñÂæó
                if (!currentVideoId) {
                    // currentVideoId„Åå„Å™„ÅÑÂ†¥Âêà„ÄÅÁèæÂú®„ÅÆË®ò‰∫ã„ÇíË°®Á§∫
                    const response = await fetch('/current-article');
                    if (response.ok) {
                        const data = await response.json();
                        if (data.hasArticle && data.article) {
                            displayArticle(data.article);
                        } else {
                            displayNoArticleMessage();
                        }
                    } else {
                        displayNoArticleMessage();
                    }
                    return;
                }

                // Â±•Ê≠¥„Åã„ÇâË®ò‰∫ã„ÇíÂèñÂæó
                const response = await fetch(`/article/${currentVideoId}`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.hasArticle && data.article) {
                        displayArticle(data.article);
                    } else {
                        displayNoArticleMessage();
                    }
                } else {
                    displayNoArticleMessage();
                }
            } catch (error) {
                console.error('Ë®ò‰∫ãË™≠„ÅøËæº„Åø„Ç®„É©„Éº:', error);
                displayNoArticleMessage();
            }
        }

        // Ë®ò‰∫ã„ÇíË°®Á§∫„Åô„ÇãÈñ¢Êï∞
        function displayArticle(article, costInfo = null) {
            const articleContent = document.getElementById('articleContent');
            if (articleContent) {
                const renderedContent = marked.parse(article);
                
                if (costInfo) {
                    // „Ç≥„Çπ„ÉàÊÉÖÂ†±„Åå„ÅÇ„ÇãÂ†¥ÂêàÔºàÊñ∞Ë¶èÁîüÊàêÊôÇÔºâ
                    articleContent.innerHTML = `
                        <div style="background: #f8fafc; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                            <div style="display: flex; justify-content: space-between; align-items: center; gap: 1rem; margin-bottom: 0.5rem;">
                                <span style="font-weight: 600; color: #4a5568;">üí∞ ÁîüÊàê„Ç≥„Çπ„Éà: $${costInfo.cost.toFixed(6)} (${costInfo.model})</span>
                                <div style="display: flex; gap: 0.5rem;">
                                    <button onclick="copyArticleToClipboard()" style="background: #38a169; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.85rem;">
                                        üìã Markdown„Ç≥„Éî„Éº
                                    </button>
                                    <button onclick="copyArticleAsHTML()" style="background: #3182ce; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.85rem;">
                                        üåê HTML„Ç≥„Éî„Éº
                                    </button>
                                    <button onclick="saveArticleTemplate()" style="background: #805ad5; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.85rem;">
                                        üíæ „ÉÜ„É≥„Éó„É¨„Éº„Éà‰øùÂ≠ò
                                    </button>
                                </div>
                            </div>
                            <div style="font-size: 0.85rem; color: #666;">
                                üìä ÂÖ•Âäõ: ${costInfo.tokens.input}„Éà„Éº„ÇØ„É≥, Âá∫Âäõ: ${costInfo.tokens.output}„Éà„Éº„ÇØ„É≥
                            </div>
                            <div style="font-size: 0.85rem; color: #2d3748; margin-top: 0.5rem;">
                                üí° Ë®ò‰∫ã„ÅÆ‰øÆÊ≠£„ÅåÂøÖË¶Å„Å™Â†¥Âêà„ÅØ„ÄÅ‰∏ã„ÅÆAI„Ç¢„Ç∑„Çπ„Çø„É≥„Éà„Åß„ÄåË®ò‰∫ã„ÅÆ‚óã‚óã„ÅÆÈÉ®ÂàÜ„Çí‰øÆÊ≠£„Åó„Å¶„Äç„Å™„Å©„Å®ÊåáÁ§∫„Åó„Å¶„Åè„Å†„Åï„ÅÑ
                            </div>
                        </div>
                        <div class="article-markdown">${renderedContent}</div>
                    `;
                } else {
                    // Â±•Ê≠¥„Åã„ÇâË™≠„ÅøËæº„ÅøÊôÇ„ÅØ„Ç∑„É≥„Éó„É´„Å´Ë°®Á§∫
                    articleContent.innerHTML = `
                        <div style="background: #e6fffa; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border: 1px solid #38b2ac;">
                            <div style="display: flex; justify-content: space-between; align-items: center; gap: 1rem; margin-bottom: 0.5rem;">
                                <span style="font-weight: 600; color: #2d3748;">üìö Â±•Ê≠¥„Åã„ÇâË™≠„ÅøËæº„Åæ„Çå„ÅüË®ò‰∫ã</span>
                                <div style="display: flex; gap: 0.5rem;">
                                    <button onclick="copyArticleToClipboard()" style="background: #38a169; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.85rem;">
                                        üìã Markdown„Ç≥„Éî„Éº
                                    </button>
                                    <button onclick="copyArticleAsHTML()" style="background: #3182ce; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.85rem;">
                                        üåê HTML„Ç≥„Éî„Éº
                                    </button>
                                    <button onclick="saveArticleTemplate()" style="background: #805ad5; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.85rem;">
                                        üíæ „ÉÜ„É≥„Éó„É¨„Éº„Éà‰øùÂ≠ò
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="article-markdown">${renderedContent}</div>
                    `;
                }
                articleContent.style.textAlign = 'left';
                
                // „Çø„Ç§„É†„Çπ„Çø„É≥„Éó„É™„É≥„ÇØ„ÇíÂá¶ÁêÜ
                processTimestampLinks(articleContent);
            }
        }

        // Ë®ò‰∫ã„Åå„Å™„ÅÑÂ†¥Âêà„ÅÆ„É°„ÉÉ„Çª„Éº„Ç∏„ÇíË°®Á§∫
        function displayNoArticleMessage() {
            const articleContent = document.getElementById('articleContent');
            if (articleContent) {
                articleContent.innerHTML = '<p style="color: #888; text-align: center; padding: 2rem;">„Åæ„Å†Ë®ò‰∫ã„ÅåÁîüÊàê„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ„ÄåËß£Ë™¨Ë®ò‰∫ã„Çí‰ΩúÊàê„Äç„Éú„Çø„É≥„ÇíÊäº„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</p>';
            }
        }

        // „Ç¢„Ç≥„Éº„Éá„Ç£„Ç™„É≥„ÅÆ„Éà„Ç∞„É´Ê©üËÉΩ
        function toggleAccordion(contentId) {
            const content = document.getElementById(contentId);
            const arrow = document.getElementById(contentId + 'Arrow');
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                arrow.classList.add('expanded');
            } else {
                content.style.display = 'none';
                arrow.classList.remove('expanded');
            }
        }

        // „Çø„ÉñÂàá„ÇäÊõø„ÅàÊ©üËÉΩ
        function switchTab(tabName) {
            // ÂÖ®„Å¶„ÅÆ„Çø„Éñ„Éú„Çø„É≥„Åã„Çâ active „ÇØ„É©„Çπ„ÇíÂâäÈô§
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // ÂÖ®„Å¶„ÅÆ„Çø„Éñ„Ç≥„É≥„ÉÜ„É≥„ÉÑ„ÇíÈùûË°®Á§∫
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // ÈÅ∏Êäû„Åï„Çå„Åü„Çø„Éñ„Çí„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Å´
            // „Ç§„Éô„É≥„Éà„ÅåÂ≠òÂú®„Åô„ÇãÂ†¥ÂêàÔºàÈÄöÂ∏∏„ÅÆ„ÇØ„É™„ÉÉ„ÇØÔºâ
            if (typeof event !== 'undefined' && event && event.target) {
                const clickedButton = event.target.closest('.tab-button');
                if (clickedButton) {
                    clickedButton.classList.add('active');
                }
            } else {
                // „Éó„É≠„Ç∞„É©„É†ÁöÑ„Å´Âëº„Å≥Âá∫„Åï„Çå„ÅüÂ†¥Âêà„ÄÅÂØæÂøú„Åô„Çã„Éú„Çø„É≥„ÇíË¶ã„Å§„Åë„Å¶„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Å´„Åô„Çã
                const tabButton = document.querySelector(`[onclick="switchTab('${tabName}')"]`);
                if (tabButton) {
                    tabButton.classList.add('active');
                }
            }
            document.getElementById(tabName + 'Tab').classList.add('active');
            
            // Ëß£Ë™¨Ë®ò‰∫ã„Çø„Éñ„ÅåÈÅ∏Êäû„Åï„Çå„ÅüÂ†¥Âêà„ÄÅ„ÉÜ„É≥„Éó„É¨„Éº„ÉàÊÉÖÂ†±„ÇíË™≠„ÅøËæº„Åø
            if (tabName === 'article') {
                loadTemplateInfo();
                loadArticleFromHistory();
            }
            
            // ÊñáÂ≠óËµ∑„Åì„Åó„Çø„Éñ„ÅåÈÅ∏Êäû„Åï„Çå„ÅüÂ†¥Âêà„ÄÅÂêåÊúü„ÇíÈñãÂßã
            if (tabName === 'transcript' && currentTimestampedTranscript) {
                setTimeout(() => {
                    startVideoSync();
                }, 100);
            } else if (tabName === 'summary') {
                stopVideoSync();
            }
        }

        // „Çø„Ç§„É†„Çπ„Çø„É≥„Éó‰ªò„ÅçÊñáÂ≠óËµ∑„Åì„Åó„ÇíË°®Á§∫
        function displayTimestampedTranscript() {
            const transcriptDiv = document.getElementById('transcript');
            if (currentTimestampedTranscript) {
                transcriptDiv.innerHTML = currentTimestampedTranscript;
                // ÁèæÂú®ÊñáÂ≠óËµ∑„Åì„Åó„Çø„Éñ„Åå„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Å™Â†¥Âêà„ÅÆ„ÅøÂêåÊúüÈñãÂßã
                if (document.getElementById('transcriptTab').classList.contains('active')) {
                    startVideoSync();
                }
            }
        }

        function extractVideoId(url) {
            const regex = /(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([^&\n?#]+)/;
            const match = url.match(regex);
            return match ? match[1] : null;
        }

        function updateCosts(costs) {
            // „Çª„ÉÉ„Ç∑„Éß„É≥ÊñôÈáë„ÇÇÂàÜÊûê„Å´Áµ±Âêà„Åô„Çã„Åü„ÇÅ„ÄÅÂàÜÊûê„Éá„Éº„Çø„ÇíÂÜçË™≠„ÅøËæº„Åø
            if (costs) {
                loadCostsAnalysis();
            }
        }

        async function loadHistory() {
            try {
                const response = await fetch('/history');
                const result = await response.json();
                
                if (result.success) {
                    displayHistory(result.history);
                }
            } catch (error) {
                console.error('Error loading history:', error);
            }
        }

        // Â±•Ê≠¥Ë°®Á§∫„ÅÆÁä∂ÊÖãÁÆ°ÁêÜ
        let currentHistoryView = 'timeline';
        let allHistoryData = [];
        let filteredHistoryData = [];

        function displayHistory(history) {
            allHistoryData = history;
            filteredHistoryData = history;
            
            if (!history || history.length === 0) {
                document.getElementById('historyList').innerHTML = '<p>Â±•Ê≠¥„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>';
                return;
            }

            // „Çø„Ç∞„Çµ„Ç∏„Çß„Çπ„ÉÅ„Éß„É≥„ÇíÊõ¥Êñ∞
            updateTagSuggestions(history);
            
            // „É°„Ç§„É≥„Çø„Ç∞„Çµ„Ç∏„Çß„Çπ„ÉÅ„Éß„É≥„ÇíÊõ¥Êñ∞
            updateMainTagSuggestions(history);
            
            // ÁèæÂú®„ÅÆ„Éì„É•„Éº„Å´Âøú„Åò„Å¶Ë°®Á§∫
            displayHistoryByView(currentHistoryView);
        }

        function displayHistoryByView(viewType) {
            const historyList = document.getElementById('historyList');
            
            switch(viewType) {
                case 'timeline':
                    displayTimelineHistory();
                    break;
                case 'channel':
                    displayChannelHistory();
                    break;
                case 'tag':
                    displayTagHistory();
                    break;
            }
        }

        function displayTimelineHistory() {
            const historyList = document.getElementById('historyList');
            
            if (filteredHistoryData.length === 0) {
                historyList.innerHTML = '<p>Ë©≤ÂΩì„Åô„ÇãÂ±•Ê≠¥„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>';
                return;
            }

            const historyHTML = filteredHistoryData.map(item => {
                const date = new Date(item.timestamp).toLocaleString('ja-JP');
                const methodClass = item.method === 'subtitle' ? 'method-subtitle' : 'method-whisper';
                const methodText = item.method === 'subtitle' ? 'Â≠óÂπï' : 'Whisper';
                const cost = item.cost > 0 ? `$${item.cost.toFixed(4)}` : 'ÁÑ°Êñô';
                const languageText = getLanguageDisplayName(item.language || 'original');
                const channelName = item.metadata?.basic?.channel || 'Unknown';
                const videoUrl = item.url || '';
                const tags = item.tags || [];
                const mainTags = item.mainTags || [];
                
                const tagsHTML = tags.length > 0 ? `
                    <div class="video-tags">
                        ${tags.map(tag => `<span class="tag-item" onclick="filterByTag('${tag}'); event.stopPropagation();">${tag}</span>`).join('')}
                    </div>
                ` : '';
                
                const mainTagsHTML = mainTags.length > 0 ? `
                    <div class="video-tags" style="margin: 0.25rem 0;">
                        ${mainTags.map(tag => `<span style="background: #667eea; color: white; padding: 0.25rem 0.5rem; border-radius: 8px; font-size: 0.75rem; font-weight: 600; margin-right: 0.25rem; cursor: pointer;" onclick="filterByTag('${tag}'); event.stopPropagation();">üè∑Ô∏è ${tag}</span>`).join('')}
                    </div>
                ` : '';
                
                return `
                    <div class="history-item" onclick="loadFromHistory('${item.id}')">
                        <div class="history-title">${item.title}</div>
                        <div class="history-channel">üì∫ ${channelName}</div>
                        ${mainTagsHTML}
                        ${tagsHTML}
                        <div class="history-url">
                            <a href="${videoUrl}" target="_blank" onclick="event.stopPropagation();">üîó YouTube„ÅßÈñã„Åè</a>
                        </div>
                        <div class="history-meta">
                            <span>${date}</span>
                            <span>
                                <span class="method-badge ${methodClass}">${methodText}</span>
                                <span class="language-badge">${languageText}</span>
                                <span style="margin-left: 10px;">${cost}</span>
                            </span>
                        </div>
                    </div>
                `;
            }).join('');
            
            historyList.innerHTML = historyHTML;
        }

        function displayChannelHistory() {
            const historyList = document.getElementById('historyList');
            
            // „ÉÅ„É£„É≥„Éç„É´Âà•„Å´„Ç∞„É´„Éº„ÉóÂåñ
            const channelGroups = {};
            filteredHistoryData.forEach(item => {
                const channel = item.metadata?.basic?.channel || 'Unknown';
                if (!channelGroups[channel]) {
                    channelGroups[channel] = [];
                }
                channelGroups[channel].push(item);
            });

            if (Object.keys(channelGroups).length === 0) {
                historyList.innerHTML = '<p>Ë©≤ÂΩì„Åô„ÇãÂ±•Ê≠¥„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>';
                return;
            }

            let historyHTML = '';
            Object.entries(channelGroups).forEach(([channel, items]) => {
                historyHTML += `
                    <div class="history-group collapsed">
                        <div class="history-group-header" onclick="toggleHistoryGroup(this)">
                            <span>üì∫ ${channel} (${items.length}‰ª∂)</span>
                            <span class="toggle-icon">‚ñº</span>
                        </div>
                        <div class="history-group-items">
                            ${items.map(item => createHistoryItemHTML(item)).join('')}
                        </div>
                    </div>
                `;
            });
            
            historyList.innerHTML = historyHTML;
        }

        function displayTagHistory() {
            const historyList = document.getElementById('historyList');
            
            // „Çø„Ç∞Âà•„Å´„Ç∞„É´„Éº„ÉóÂåñ
            const tagGroups = {};
            filteredHistoryData.forEach(item => {
                const tags = item.tags || ['Êú™ÂàÜÈ°û'];
                tags.forEach(tag => {
                    if (!tagGroups[tag]) {
                        tagGroups[tag] = [];
                    }
                    tagGroups[tag].push(item);
                });
            });

            if (Object.keys(tagGroups).length === 0) {
                historyList.innerHTML = '<p>Ë©≤ÂΩì„Åô„ÇãÂ±•Ê≠¥„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>';
                return;
            }

            let historyHTML = '';
            Object.entries(tagGroups).forEach(([tag, items]) => {
                // ÈáçË§á„ÇíÈô§Âéª
                const uniqueItems = items.filter((item, index, self) => 
                    index === self.findIndex(t => t.id === item.id)
                );
                
                historyHTML += `
                    <div class="history-group collapsed">
                        <div class="history-group-header" onclick="toggleHistoryGroup(this)">
                            <span>üè∑Ô∏è ${tag} (${uniqueItems.length}‰ª∂)</span>
                            <span class="toggle-icon">‚ñº</span>
                        </div>
                        <div class="history-group-items">
                            ${uniqueItems.map(item => createHistoryItemHTML(item)).join('')}
                        </div>
                    </div>
                `;
            });
            
            historyList.innerHTML = historyHTML;
        }

        function createHistoryItemHTML(item) {
            const date = new Date(item.timestamp).toLocaleString('ja-JP');
            const methodClass = item.method === 'subtitle' ? 'method-subtitle' : 'method-whisper';
            const methodText = item.method === 'subtitle' ? 'Â≠óÂπï' : 'Whisper';
            const cost = item.cost > 0 ? `$${item.cost.toFixed(4)}` : 'ÁÑ°Êñô';
            const languageText = getLanguageDisplayName(item.language || 'original');
            const videoUrl = item.url || '';
            const tags = item.tags || [];
            const mainTags = item.mainTags || [];
            
            const tagsHTML = tags.length > 0 ? `
                <div class="video-tags">
                    ${tags.map(tag => `<span class="tag-item">${tag}</span>`).join('')}
                </div>
            ` : '';
            
            const mainTagsHTML = mainTags.length > 0 ? `
                <div class="video-tags" style="margin: 0.25rem 0;">
                    ${mainTags.map(tag => `<span style="background: #667eea; color: white; padding: 0.25rem 0.5rem; border-radius: 8px; font-size: 0.75rem; font-weight: 600; margin-right: 0.25rem;">üè∑Ô∏è ${tag}</span>`).join('')}
                </div>
            ` : '';
            
            return `
                <div class="history-item" onclick="loadFromHistory('${item.id}')">
                    <div class="history-title">${item.title}</div>
                    ${mainTagsHTML}
                    ${tagsHTML}
                    <div class="history-url">
                        <a href="${videoUrl}" target="_blank" onclick="event.stopPropagation();">üîó YouTube„ÅßÈñã„Åè</a>
                    </div>
                    <div class="history-meta">
                        <span>${date}</span>
                        <span>
                            <span class="method-badge ${methodClass}">${methodText}</span>
                            <span class="language-badge">${languageText}</span>
                            <span style="margin-left: 10px;">${cost}</span>
                        </span>
                    </div>
                </div>
            `;
        }

        async function loadFromHistory(videoId) {
            try {
                const response = await fetch('/load-from-history', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ videoId: videoId })
                });

                const result = await response.json();

                if (result.success) {
                    // „Çø„Ç§„É†„Çπ„Çø„É≥„ÉóÊÉÖÂ†±„Çí‰øùÂ≠ò
                    currentTimestampedSegments = result.timestampedSegments || [];
                    
                    // YouTube„Éó„É¨„Ç§„É§„Éº„ÇíÂàùÊúüÂåñÔºàURL„Åã„ÇâÂãïÁîªID„ÇíÂèñÂæóÔºâ
                    if (result.metadata?.basic?.videoId) {
                        initializeYouTubePlayer(result.metadata.basic.videoId);
                        setCurrentVideoId(result.metadata.basic.videoId);
                    }
                    
                    // „Çø„Ç§„É†„Çπ„Çø„É≥„Éó‰ªò„ÅçÊñáÂ≠óËµ∑„Åì„Åó„ÇíÂèñÂæó„Åó„Å¶Ë°®Á§∫
                    fetch('/transcript')
                        .then(response => response.json())
                        .then(transcriptData => {
                            if (transcriptData.timestampedTranscript) {
                                currentTimestampedTranscript = transcriptData.timestampedTranscript;
                                displayTimestampedTranscript();
                            } else {
                                // „Çø„Ç§„É†„Çπ„Çø„É≥„Éó„Åå„Å™„ÅÑÂ†¥Âêà„ÅØÈÄöÂ∏∏„ÅÆÊñáÂ≠óËµ∑„Åì„Åó„ÇíË°®Á§∫
                                const transcriptDiv = document.getElementById('transcript');
                                transcriptDiv.innerHTML = result.transcript.replace(/\n/g, '<br>');
                                transcriptDiv.style.whiteSpace = 'pre-wrap';
                            }
                        });
                    
                    // ÂãïÁîªÊÉÖÂ†±„ÇíË°®Á§∫
                    if (result.metadata) {
                        displayVideoInfo(result.metadata, result.method, result.language, result.detectedLanguage);
                    }
                    
                    // Ë¶ÅÁ¥Ñ„ÇíË°®Á§∫
                    if (result.summary) {
                        displaySummary(result.summary);
                    }
                    
                    // Êé®Â•®Ë≥™Âïè„ÇíË™≠„ÅøËæº„Åø
                    loadSuggestedQuestions();
                    
                    showStatus(`Â±•Ê≠¥„Åã„ÇâË™≠„ÅøËæº„Åø„Åæ„Åó„Åü: ${result.title}`, 'success');
                    isTranscriptReady = true;
                    ensureChatInputVisible();
                } else {
                    showStatus(`„Ç®„É©„Éº: ${result.error}`, 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showStatus('Â±•Ê≠¥„ÅÆË™≠„ÅøËæº„Åø„Åß„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ', 'error');
            }
        }

        // Êñ∞Ê©üËÉΩ„ÅÆÈñ¢Êï∞
        function displayVideoInfo(metadata, method, language, detectedLanguage) {
            if (!metadata) return;
            
            const videoInfo = document.getElementById('videoInfo');
            const basic = metadata.basic;
            
            document.getElementById('videoTitle').textContent = basic.title;
            document.getElementById('videoChannel').textContent = basic.channel;
            document.getElementById('videoDuration').textContent = 
                `${Math.floor(basic.duration/60)}ÂàÜ${basic.duration%60}Áßí`;
            document.getElementById('videoViews').textContent = 
                basic.viewCount ? basic.viewCount.toLocaleString() + 'Âõû' : 'N/A';
            
            let methodText = method === 'subtitle' ? 'YouTubeÂ≠óÂπï' : 'Whisper API';
            if (detectedLanguage && detectedLanguage !== language) {
                methodText += ` (${detectedLanguage})`;
            }
            document.getElementById('processingMethod').textContent = methodText;
            
            // „ÉÅ„É£„Éó„Çø„ÉºÊÉÖÂ†±
            if (metadata.chapters && metadata.chapters.length > 0) {
                const chaptersInfo = document.getElementById('chaptersInfo');
                const chaptersList = document.getElementById('chaptersList');
                
                chaptersList.innerHTML = metadata.chapters.map(chapter => 
                    `<div class="chapter-item">
                        <span class="chapter-timestamp">${chapter.timestamp}</span>
                        ${chapter.title}
                    </div>`
                ).join('');
                
                chaptersInfo.style.display = 'block';
            }
            
            videoInfo.style.display = 'block';
        }

        function displaySummary(summary) {
            if (!summary) return;
            
            const summaryDiv = document.getElementById('summary');
            let content = summary;
            
            // Markdown„Çí„É¨„É≥„ÉÄ„É™„É≥„Ç∞
            if (typeof marked !== 'undefined') {
                content = marked.parse(summary);
            }
            
            // „Çø„Ç§„É†„Çπ„Çø„É≥„Éó„É™„É≥„ÇØ„ÇíËøΩÂä† [mm:ss-mm:ss] „Åæ„Åü„ÅØ [mm:ss] „ÅÆÂΩ¢Âºè„ÇíÊ§úÂá∫
            content = content.replace(/\[(\d{1,2}:\d{2})(?:-(\d{1,2}:\d{2}))?\]/g, function(match, startTime, endTime) {
                const startSeconds = timeToSeconds(startTime);
                return `<span class="timestamp-link" onclick="seekToTime(${startSeconds})">${match}</span>`;
            });
            
            summaryDiv.innerHTML = content;
            summaryDiv.style.display = 'block';
        }
        
        function timeToSeconds(timeStr) {
            const parts = timeStr.split(':').map(p => parseInt(p));
            if (parts.length === 2) {
                // mm:ssÂΩ¢Âºè
                return parts[0] * 60 + parts[1];
            } else if (parts.length === 3) {
                // hh:mm:ssÂΩ¢Âºè
                return parts[0] * 3600 + parts[1] * 60 + parts[2];
            }
            return 0;
        }

        async function loadSuggestedQuestions() {
            try {
                const response = await fetch('/suggested-questions');
                const result = await response.json();
                
                console.log('Debug: API response:', result);
                
                if (result.success && result.questions.length > 0) {
                    displaySuggestedQuestions(result.questions);
                } else {
                    // „ÉÜ„Çπ„ÉàÁî®„ÅÆË≥™Âïè„ÇíË°®Á§∫
                    console.log('Debug: No questions from API, showing test questions');
                    const testQuestions = [
                        'ÂãïÁîª„ÅÆÂÜÖÂÆπ„ÇíË©≥„Åó„ÅèË™¨Êòé„Åó„Å¶„Åè„Å†„Åï„ÅÑ',
                        'ÈáçË¶Å„Å™„Éù„Ç§„É≥„Éà„ÇíÊïô„Åà„Å¶„Åè„Å†„Åï„ÅÑ',
                        '„Åì„ÅÆÂãïÁîª„Åã„ÇâÂ≠¶„Åπ„Çã„Åì„Å®„ÅØ‰Ωï„Åß„Åô„ÅãÔºü',
                        'ÂÆüË∑µÁöÑ„Å´Ê¥ªÁî®„Åß„Åç„ÇãÂÜÖÂÆπ„ÅØ„ÅÇ„Çä„Åæ„Åô„ÅãÔºü'
                    ];
                    displaySuggestedQuestions(testQuestions);
                }
            } catch (error) {
                console.error('Error loading suggested questions:', error);
            }
        }

        function displaySuggestedQuestions(questions) {
            const suggestedDiv = document.getElementById('suggestedQuestions');
            const questionsList = document.getElementById('questionsList');
            
            questionsList.innerHTML = questions.map(question => 
                `<div class="question-item" onclick="askSuggestedQuestion('${question.replace(/'/g, "\\'")}')">
                    ${question}
                </div>`
            ).join('');
            
            suggestedDiv.style.display = 'block';
            
            // Ensure chat input remains visible after questions are displayed
            setTimeout(() => {
                ensureChatInputVisible();
            }, 100);
        }

        function askSuggestedQuestion(question) {
            document.getElementById('chatInput').value = question;
            sendMessage();
        }

        function ensureChatInputVisible() {
            // Force chat input panel to be visible
            const chatInputPanel = document.querySelector('.chat-input-panel');
            const chatInputContainer = document.querySelector('.chat-input-container');
            const chatInput = document.getElementById('chatInput');
            const chatBtn = document.getElementById('chatBtn');
            
            if (chatInputPanel) {
                chatInputPanel.style.display = 'flex';
                chatInputPanel.style.visibility = 'visible';
                chatInputPanel.style.position = 'absolute';
                chatInputPanel.style.bottom = '0';
                chatInputPanel.style.left = '0';
                chatInputPanel.style.right = '0';
                chatInputPanel.style.zIndex = '100';
            }
            
            if (chatInputContainer) {
                chatInputContainer.style.display = 'flex';
                chatInputContainer.style.visibility = 'visible';
            }
            
            if (chatInput) {
                chatInput.style.display = 'block';
                chatInput.style.visibility = 'visible';
            }
            
            if (chatBtn) {
                chatBtn.style.display = 'block';
                chatBtn.style.visibility = 'visible';
            }
            
            console.log('Chat input visibility ensured');
        }

        function extractAndDisplayQuestionsFromSummary(summaryContent) {
            try {
                console.log('Extracting questions from summary:', summaryContent ? summaryContent.substring(0, 200) + '...' : 'null');
                
                if (!summaryContent) {
                    console.log('No summary content provided');
                    return;
                }
                
                // „Çµ„Éº„Éê„ÉºÂÅ¥„Å®Âêå„Åò„É≠„Ç∏„ÉÉ„ÇØ„ÅßÊ∑±Êéò„ÇäË≥™Âïè„ÇíÊäΩÂá∫
                const questionPatterns = [
                    /6\.\s*\*\*üí°\s*„Åä„Åô„Åô„ÇÅÊ∑±Êéò„ÇäË≥™Âïè\*\*\s*([\s\S]*?)(?=\n\n|$)/i,
                    /\*\*üí°\s*„Åä„Åô„Åô„ÇÅÊ∑±Êéò„ÇäË≥™Âïè\*\*\s*([\s\S]*?)(?=\n\n|$)/i,
                    /üí°\s*„Åä„Åô„Åô„ÇÅÊ∑±Êéò„ÇäË≥™Âïè[:\s]*([\s\S]*?)(?=\n\n|$)/i,
                    /„Åä„Åô„Åô„ÇÅÊ∑±Êéò„ÇäË≥™Âïè[:\s]*([\s\S]*?)(?=\n\n|$)/i
                ];
                
                let extractedQuestions = [];
                for (const pattern of questionPatterns) {
                    const questionsMatch = summaryContent.match(pattern);
                    if (questionsMatch) {
                        console.log('Found questions match with pattern:', pattern.toString());
                        const questionsText = questionsMatch[1];
                        console.log('Questions text:', questionsText);
                        
                        extractedQuestions = questionsText
                            .split(/\n/)
                            .map(line => line.trim())
                            .filter(line => {
                                // „Çà„ÇäÊüîËªü„Å™Ë≥™Âïè„ÅÆÈñãÂßã„Éë„Çø„Éº„É≥„ÇíÊ§úÂá∫
                                return line.startsWith('-') || 
                                       line.startsWith('‚Ä¢') || 
                                       line.match(/^\d+[\.\)]/) ||
                                       (line.includes('Ôºü') && line.length > 5);
                            })
                            .map(line => {
                                // ÂÖàÈ†≠„ÅÆË®òÂè∑„ÇÑÁï™Âè∑„ÇíÂâäÈô§
                                return line.replace(/^[-‚Ä¢\d\.\)\s]+/, '').trim();
                            })
                            .filter(q => q.length > 5 && q.includes('Ôºü'))
                            .slice(0, 5); // ÊúÄÂ§ß5ÂÄã„Åæ„Åß
                        
                        console.log('Extracted questions:', extractedQuestions);
                        
                        if (extractedQuestions.length > 0) {
                            displaySuggestedQuestions(extractedQuestions);
                            return;
                        }
                    }
                }
                
                // Ê∑±Êéò„ÇäË≥™Âïè„ÅåË¶ã„Å§„Åã„Çâ„Å™„ÅÑÂ†¥Âêà„ÅØÊ±éÁî®ÁöÑ„Å™Ë≥™Âïè„ÇíË°®Á§∫
                console.log('No specific questions found, using fallback');
                const fallbackQuestions = [
                    'ÂãïÁîª„ÅÆÂÜÖÂÆπ„ÇíË©≥„Åó„ÅèË™¨Êòé„Åó„Å¶„Åè„Å†„Åï„ÅÑ',
                    'ÈáçË¶Å„Å™„Éù„Ç§„É≥„Éà„ÇíÊïô„Åà„Å¶„Åè„Å†„Åï„ÅÑ',
                    '„Åì„ÅÆÂãïÁîª„Åã„ÇâÂ≠¶„Åπ„Çã„Åì„Å®„ÅØ‰Ωï„Åß„Åô„ÅãÔºü'
                ];
                displaySuggestedQuestions(fallbackQuestions);
                
            } catch (error) {
                console.error('Error extracting questions from summary:', error);
            }
        }

        function getLanguageDisplayName(language) {
            switch (language) {
                case 'ja': return 'Êó•Êú¨Ë™û';
                case 'en': return 'English';
                case 'original': 
                default: return 'Original';
            }
        }

        // ÊñôÈáë„Çø„ÉñÂàá„ÇäÊõø„Åà
        function switchCostsTab(tabName) {
            document.querySelectorAll('.costs-tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelectorAll('.costs-tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            event.target.classList.add('active');
            document.getElementById(tabName + 'Costs').classList.add('active');
            
            if (tabName === 'analysis') {
                loadCostsAnalysis();
            } else if (tabName === 'graph') {
                loadCostsGraph();
            }
        }

        // ÊñôÈáëÂàÜÊûê„Éá„Éº„Çø„ÅÆË™≠„ÅøËæº„Åø
        async function loadCostsAnalysis() {
            try {
                const period = document.getElementById('periodSelect').value;
                const response = await fetch(`/costs-analysis?period=${period}`);
                const result = await response.json();
                
                if (result.success) {
                    displayCostsAnalysis(result);
                }
            } catch (error) {
                console.error('Error loading costs analysis:', error);
                document.getElementById('costsAnalysisResult').innerHTML = 
                    '<p style="color: red;">ÂàÜÊûê„Éá„Éº„Çø„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü</p>';
            }
        }

        // ÊñôÈáëÂàÜÊûêÁµêÊûú„ÅÆË°®Á§∫
        function displayCostsAnalysis(data) {
            const { summary, period, sessionCosts } = data;
            let html = `
                <div class="costs-analysis-summary">
                    <h4>üìä ${getPeriodDisplayName(period)} ÈõÜË®à</h4>
                    <div class="cost-item">
                        <span>ÂãïÁîªÂá¶ÁêÜÊï∞:</span>
                        <span>${summary.videoCount} ‰ª∂</span>
                    </div>
                    <div class="cost-item">
                        <span>WhisperÂêàË®à:</span>
                        <span>$${summary.totalWhisper.toFixed(4)}</span>
                    </div>
                    <div class="cost-item">
                        <span>GPTÂêàË®à:</span>
                        <span>$${summary.totalGpt.toFixed(4)}</span>
                    </div>`;
            
            // „Çª„ÉÉ„Ç∑„Éß„É≥ÊñôÈáë„ÇíËøΩÂä†Ôºà‰ªäÊó•„ÅÆ„Éá„Éº„Çø„ÅÆÂ†¥Âêà„ÅÆ„ÅøÔºâ
            if (period === 'today' && sessionCosts) {
                html += `
                    <div class="cost-item">
                        <span>„Çª„ÉÉ„Ç∑„Éß„É≥ (Whisper):</span>
                        <span>$${sessionCosts.whisper.toFixed(4)}</span>
                    </div>
                    <div class="cost-item">
                        <span>„Çª„ÉÉ„Ç∑„Éß„É≥ (GPT):</span>
                        <span>$${sessionCosts.gpt.toFixed(4)}</span>
                    </div>`;
            }
            
            html += `
                    <div class="cost-item total-cost">
                        <span>Á∑èÂêàË®à:</span>
                        <span>$${summary.totalCost.toFixed(4)}</span>
                    </div>
                </div>
                
                <div class="costs-accordion">
                    <div class="accordion-header" onclick="toggleAccordion('methodCosts')">
                        <span>üìà Âá¶ÁêÜÊñπÊ≥ïÂà•</span>
                        <span class="accordion-arrow" id="methodCostsArrow">‚ñº</span>
                    </div>
                    <div class="accordion-content" id="methodCosts" style="display: none;">
                        ${Object.entries(summary.byMethod).map(([method, data]) => `
                            <div class="cost-item">
                                <span>${method === 'subtitle' ? 'YouTubeÂ≠óÂπï' : 'Whisper API'} (${data.count}‰ª∂):</span>
                                <span>$${data.cost.toFixed(4)}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
                
                <div class="costs-accordion">
                    <div class="accordion-header" onclick="toggleAccordion('modelCosts')">
                        <span>ü§ñ GPT„É¢„Éá„É´Âà•</span>
                        <span class="accordion-arrow" id="modelCostsArrow">‚ñº</span>
                    </div>
                    <div class="accordion-content" id="modelCosts" style="display: none;">
                        ${Object.entries(summary.byModel).map(([model, data]) => `
                            <div class="cost-item">
                                <span>${model} (${data.count}‰ª∂):</span>
                                <span>$${data.cost.toFixed(4)}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            
            document.getElementById('costsAnalysisResult').innerHTML = html;
        }

        function getPeriodDisplayName(period) {
            switch (period) {
                case 'today': return 'Êú¨Êó•';
                case 'week': return 'ÈÅéÂéª7Êó•Èñì';
                case 'month': return 'ÈÅéÂéª30Êó•Èñì';
                case 'total': return 'ÂÖ®ÊúüÈñì';
                default: return period;
            }
        }

        // „Ç∞„É©„ÉïÊèèÁîªÊ©üËÉΩ
        async function loadCostsGraph() {
            try {
                const period = document.getElementById('graphPeriodSelect').value;
                const response = await fetch(`/costs-analysis?period=${period}`);
                const result = await response.json();
                
                if (result.success) {
                    drawCostsChart(result);
                }
            } catch (error) {
                console.error('Error loading costs graph:', error);
            }
        }
        
        function drawCostsChart(data) {
            const canvas = document.getElementById('costsChart');
            const ctx = canvas.getContext('2d');
            const { summary } = data;
            
            // „Ç≠„É£„É≥„Éê„Çπ„Çí„ÇØ„É™„Ç¢
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Êó•Âà•„Éá„Éº„Çø„ÇíÂèñÂæó
            const byDate = summary.byDate || {};
            const dates = Object.keys(byDate).sort();
            
            if (dates.length === 0) {
                ctx.fillStyle = '#666';
                ctx.font = '16px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì', canvas.width / 2, canvas.height / 2);
                return;
            }
            
            // „Ç∞„É©„Éï„ÅÆË®≠ÂÆö
            const padding = 40;
            const graphWidth = canvas.width - padding * 2;
            const graphHeight = canvas.height - padding * 2;
            const startX = padding;
            const startY = padding;
            
            // „Éá„Éº„Çø„ÅÆÊúÄÂ§ßÂÄ§„ÇíÂèñÂæó
            const maxCost = Math.max(...dates.map(date => byDate[date].cost), 0.001);
            
            // Ëª∏„ÇíÊèèÁîª
            ctx.strokeStyle = '#ccc';
            ctx.lineWidth = 1;
            ctx.beginPath();
            // YËª∏
            ctx.moveTo(startX, startY);
            ctx.lineTo(startX, startY + graphHeight);
            // XËª∏
            ctx.moveTo(startX, startY + graphHeight);
            ctx.lineTo(startX + graphWidth, startY + graphHeight);
            ctx.stroke();
            
            // YËª∏„ÅÆ„É©„Éô„É´ÔºàÊñôÈáëÔºâ
            ctx.fillStyle = '#666';
            ctx.font = '10px Arial';
            ctx.textAlign = 'right';
            for (let i = 0; i <= 5; i++) {
                const value = (maxCost / 5) * i;
                const y = startY + graphHeight - (graphHeight / 5) * i;
                ctx.fillText(`$${value.toFixed(3)}`, startX - 5, y + 3);
                
                // „Ç∞„É™„ÉÉ„ÉâÁ∑ö
                if (i > 0) {
                    ctx.strokeStyle = '#f0f0f0';
                    ctx.beginPath();
                    ctx.moveTo(startX, y);
                    ctx.lineTo(startX + graphWidth, y);
                    ctx.stroke();
                }
            }
            
            // Êäò„ÇåÁ∑ö„Ç∞„É©„Éï„ÇíÊèèÁîª
            if (dates.length > 1) {
                ctx.strokeStyle = '#667eea';
                ctx.lineWidth = 2;
                ctx.beginPath();
                
                dates.forEach((date, index) => {
                    const x = startX + (graphWidth / (dates.length - 1)) * index;
                    const cost = byDate[date].cost;
                    const y = startY + graphHeight - (cost / maxCost) * graphHeight;
                    
                    if (index === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                });
                ctx.stroke();
                
                // „Éá„Éº„Çø„Éù„Ç§„É≥„Éà„ÇíÊèèÁîª
                ctx.fillStyle = '#667eea';
                dates.forEach((date, index) => {
                    const x = startX + (graphWidth / (dates.length - 1)) * index;
                    const cost = byDate[date].cost;
                    const y = startY + graphHeight - (cost / maxCost) * graphHeight;
                    
                    ctx.beginPath();
                    ctx.arc(x, y, 3, 0, 2 * Math.PI);
                    ctx.fill();
                });
            }
            
            // XËª∏„ÅÆ„É©„Éô„É´ÔºàÊó•‰ªòÔºâ
            ctx.fillStyle = '#666';
            ctx.font = '8px Arial';
            ctx.textAlign = 'center';
            const maxLabels = 7; // ÊúÄÂ§ß7ÂÄã„ÅÆ„É©„Éô„É´„ÇíË°®Á§∫
            const step = Math.ceil(dates.length / maxLabels);
            
            dates.forEach((date, index) => {
                if (index % step === 0 || index === dates.length - 1) {
                    const x = startX + (graphWidth / (dates.length - 1)) * index;
                    const shortDate = date.slice(5); // MM-DDÂΩ¢Âºè
                    ctx.save();
                    ctx.translate(x, startY + graphHeight + 15);
                    ctx.rotate(-Math.PI / 4); // 45Â∫¶ÂõûËª¢
                    ctx.fillText(shortDate, 0, 0);
                    ctx.restore();
                }
            });
            
            // „Çø„Ç§„Éà„É´
            ctx.fillStyle = '#333';
            ctx.font = 'bold 12px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('Êó•Âà•‰ΩøÁî®ÊñôÈáë', canvas.width / 2, 20);
        }

        
        // „Éë„Éç„É´„É™„Çµ„Ç§„Ç∫Ê©üËÉΩ
        let isResizing = false;
        
        function initializeResize() {
            const resizeHandle = document.getElementById('resizeHandle');
            const leftPanel = document.querySelector('.left-panel');
            const mainContent = document.querySelector('.main-content');
            
            if (!resizeHandle) {
                console.error('Resize handle not found');
                return;
            }
            
            resizeHandle.addEventListener('mousedown', function(e) {
                console.log('Mouse down on resize handle');
                isResizing = true;
                document.body.style.cursor = 'col-resize';
                document.body.style.userSelect = 'none';
                
                document.addEventListener('mousemove', handleMouseMove);
                document.addEventListener('mouseup', handleMouseUp);
                e.preventDefault();
                e.stopPropagation();
            });
            
            function handleMouseMove(e) {
                if (!isResizing) return;
                
                const containerRect = mainContent.getBoundingClientRect();
                const newWidth = Math.max(250, Math.min(800, e.clientX - containerRect.left - 16)); // 16px„ÅØ„Éë„Éá„Ç£„É≥„Ç∞
                
                leftPanel.style.width = `${newWidth}px`;
                
                console.log('Resizing to:', newWidth);
            }
            
            function handleMouseUp() {
                console.log('Mouse up - stop resizing');
                isResizing = false;
                document.body.style.cursor = '';
                document.body.style.userSelect = '';
                document.removeEventListener('mousemove', handleMouseMove);
                document.removeEventListener('mouseup', handleMouseUp);
            }
            
            // „ÉÄ„Éñ„É´„ÇØ„É™„ÉÉ„ÇØ„Åß„É™„Çª„ÉÉ„Éà
            resizeHandle.addEventListener('dblclick', function() {
                leftPanel.style.width = '350px';
            });
        }

        // Â±•Ê≠¥„Çø„ÉñÂàá„ÇäÊõø„Åà
        function switchHistoryTab(tabName) {
            currentHistoryView = tabName;
            
            // „Çø„Éñ„Éú„Çø„É≥„ÅÆÁä∂ÊÖãÊõ¥Êñ∞
            document.querySelectorAll('.history-tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Ë°®Á§∫Êõ¥Êñ∞
            displayHistoryByView(tabName);
        }

        // Â±•Ê≠¥„Éï„Ç£„É´„Çø„É™„É≥„Ç∞
        function filterHistory() {
            const filter = document.getElementById('historyFilter').value;
            const now = new Date();
            
            filteredHistoryData = allHistoryData.filter(item => {
                const itemDate = new Date(item.timestamp);
                
                switch(filter) {
                    case 'today':
                        return itemDate.toDateString() === now.toDateString();
                    case 'week':
                        const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                        return itemDate >= weekAgo;
                    case 'month':
                        const monthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                        return itemDate >= monthAgo;
                    default:
                        return true;
                }
            });
            
            displayHistoryByView(currentHistoryView);
        }

        // Â±•Ê≠¥Ê§úÁ¥¢
        function searchHistory() {
            const searchTerm = document.getElementById('historySearch').value.toLowerCase();
            
            if (!searchTerm) {
                filterHistory(); // „Éï„Ç£„É´„Çø„Éº„ÅÆ„ÅøÈÅ©Áî®
                return;
            }
            
            const baseFilter = document.getElementById('historyFilter').value;
            let baseData = allHistoryData;
            
            // „Åæ„ÅöÊó•‰ªò„Éï„Ç£„É´„Çø„Éº„ÇíÈÅ©Áî®
            if (baseFilter !== 'all') {
                const now = new Date();
                baseData = allHistoryData.filter(item => {
                    const itemDate = new Date(item.timestamp);
                    
                    switch(baseFilter) {
                        case 'today':
                            return itemDate.toDateString() === now.toDateString();
                        case 'week':
                            const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                            return itemDate >= weekAgo;
                        case 'month':
                            const monthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                            return itemDate >= monthAgo;
                        default:
                            return true;
                    }
                });
            }
            
            // „ÉÜ„Ç≠„Çπ„ÉàÊ§úÁ¥¢„ÇíÈÅ©Áî®
            filteredHistoryData = baseData.filter(item => {
                return item.title.toLowerCase().includes(searchTerm) ||
                       (item.metadata?.basic?.channel || '').toLowerCase().includes(searchTerm) ||
                       (item.tags || []).some(tag => tag.toLowerCase().includes(searchTerm));
            });
            
            displayHistoryByView(currentHistoryView);
        }

        // „Çø„Ç∞„Å´„Çà„Çã„Éï„Ç£„É´„Çø„É™„É≥„Ç∞
        function filterByTag(tag) {
            document.getElementById('historySearch').value = tag;
            searchHistory();
            
            // „Çø„Ç∞„Çø„Éñ„Å´Âàá„ÇäÊõø„Åà
            currentHistoryView = 'tag';
            document.querySelectorAll('.history-tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelector('.history-tab-button:nth-child(3)').classList.add('active');
            displayHistoryByView('tag');
        }

        // „Çø„Ç∞„Çµ„Ç∏„Çß„Çπ„ÉÅ„Éß„É≥Êõ¥Êñ∞
        function updateTagSuggestions(history) {
            const allTags = new Set();
            history.forEach(item => {
                if (item.tags) {
                    item.tags.forEach(tag => allTags.add(tag));
                }
            });
            
            const tagArray = Array.from(allTags).slice(0, 10); // ÊúÄÂ§ß10ÂÄã
            
            if (tagArray.length > 0) {
                const suggestionsDiv = document.getElementById('tagSuggestions');
                const suggestionTagsDiv = suggestionsDiv.querySelector('.suggestion-tags');
                
                suggestionTagsDiv.innerHTML = tagArray.map(tag => 
                    `<span class="suggestion-tag" onclick="addTagToInput('${tag}')">${tag}</span>`
                ).join('');
                
                suggestionsDiv.style.display = 'block';
            }
        }

        // „Çø„Ç∞ÂÖ•Âäõ„Å´„Çø„Ç∞„ÇíËøΩÂä†
        function addTagToInput(tag) {
            // „É°„Ç§„É≥„Çø„Ç∞„Ç∑„Çπ„ÉÜ„É†„Å´Áµ±Âêà„Åï„Çå„Åü„Åü„ÇÅ„ÄÅ„Åì„ÅÆÊ©üËÉΩ„ÅØ‰∏çË¶Å
        }

        // „É°„Ç§„É≥„Çø„Ç∞Ê©üËÉΩ
        let selectedMainTagsArray = [];
        let allMainTags = new Set();
        
        function showMainTagSuggestions(input) {
            const suggestionsDiv = document.getElementById('mainTagSuggestions');
            const suggestionListDiv = suggestionsDiv.querySelector('.suggestion-list');
            
            if (!input.trim()) {
                // ÂÖ•Âäõ„ÅåÁ©∫„ÅÆÂ†¥Âêà„ÅØÂÖ®„Çø„Ç∞„ÇíË°®Á§∫
                displayAllMainTags(suggestionListDiv);
                suggestionsDiv.style.display = 'block';
                return;
            }
            
            // ÂÖ•Âäõ„Å´Âü∫„Å•„ÅÑ„Å¶„Éï„Ç£„É´„Çø„É™„É≥„Ç∞
            const filteredTags = Array.from(allMainTags).filter(tag => 
                tag.name.toLowerCase().includes(input.toLowerCase()) &&
                !selectedMainTagsArray.includes(tag.name)
            );
            
            if (filteredTags.length > 0) {
                suggestionListDiv.innerHTML = filteredTags.map(tag => `
                    <div class="folder-suggestion-item" onclick="addMainTag('${tag.name}')">
                        <span class="folder-icon">üè∑Ô∏è</span>
                        <span class="folder-name">${tag.name}</span>
                        <span class="folder-count">${tag.count}‰ª∂</span>
                    </div>
                `).join('');
                suggestionsDiv.style.display = 'block';
            } else {
                suggestionsDiv.style.display = 'none';
            }
        }
        
        function displayAllMainTags(container) {
            const availableTags = Array.from(allMainTags).filter(tag => 
                !selectedMainTagsArray.includes(tag.name)
            );
            
            if (availableTags.length === 0) {
                container.innerHTML = '<div class="folder-suggestion-item" style="color: #666; cursor: default;">„Çø„Ç∞„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>';
                return;
            }
            
            container.innerHTML = availableTags.map(tag => `
                <div class="folder-suggestion-item" onclick="addMainTag('${tag.name}')">
                    <span class="folder-icon">üè∑Ô∏è</span>
                    <span class="folder-name">${tag.name}</span>
                    <span class="folder-count">${tag.count}‰ª∂</span>
                </div>
            `).join('');
        }
        
        function addMainTag(tagName) {
            if (!selectedMainTagsArray.includes(tagName)) {
                selectedMainTagsArray.push(tagName);
                updateSelectedTagsDisplay();
                document.getElementById('mainTags').value = '';
                document.getElementById('mainTagSuggestions').style.display = 'none';
            }
        }
        
        function removeMainTag(tagName) {
            selectedMainTagsArray = selectedMainTagsArray.filter(tag => tag !== tagName);
            updateSelectedTagsDisplay();
        }
        
        function updateSelectedTagsDisplay() {
            const container = document.getElementById('selectedMainTags');
            container.innerHTML = selectedMainTagsArray.map(tag => `
                <div class="selected-tag">
                    <span>üè∑Ô∏è ${tag}</span>
                    <span class="remove-tag" onclick="removeMainTag('${tag}')">√ó</span>
                </div>
            `).join('');
        }
        
        function getSelectedMainTags() {
            return selectedMainTagsArray;
        }
        
        function updateMainTagSuggestions(history) {
            allMainTags.clear();
            const tagCounts = {};
            
            history.forEach(item => {
                const mainTags = item.mainTags || [];
                mainTags.forEach(tag => {
                    tagCounts[tag] = (tagCounts[tag] || 0) + 1;
                });
            });
            
            Object.entries(tagCounts).forEach(([name, count]) => {
                allMainTags.add({ name, count });
            });
        }
        
        // Â§ñÈÉ®„ÇØ„É™„ÉÉ„ÇØ„Åß„Çµ„Ç∏„Çß„Çπ„ÉÅ„Éß„É≥„ÇíÈñâ„Åò„Çã
        document.addEventListener('click', function(event) {
            const mainTagContainer = document.querySelector('.main-tags-container');
            const suggestionsDiv = document.getElementById('mainTagSuggestions');
            
            if (!mainTagContainer.contains(event.target)) {
                suggestionsDiv.style.display = 'none';
            }
        });

        // „Ç¢„Ç≥„Éº„Éá„Ç£„Ç™„É≥Ê©üËÉΩ
        function toggleHistoryGroup(headerElement) {
            const group = headerElement.parentElement;
            const toggleIcon = headerElement.querySelector('.toggle-icon');
            
            if (group.classList.contains('collapsed')) {
                group.classList.remove('collapsed');
                toggleIcon.textContent = '‚ñº';
            } else {
                group.classList.add('collapsed');
                toggleIcon.textContent = '‚ñ∂';
            }
        }

        // „Éö„Éº„Ç∏Ë™≠„ÅøËæº„ÅøÊôÇ„Å´Â±•Ê≠¥„ÇíÂèñÂæó
        window.onload = function() {
            loadHistory();
            loadCostsAnalysis(); // „Éá„Éï„Ç©„É´„Éà„ÅßÂàÜÊûê„ÇíË™≠„ÅøËæº„Åø
            initializeResize(); // „É™„Çµ„Ç§„Ç∫Ê©üËÉΩ„ÇíÂàùÊúüÂåñ
        };

        async function checkForExistingContent() {
            const url = document.getElementById('youtubeUrl').value.trim();
            const language = document.getElementById('languageSelect').value;
            const gptModel = document.getElementById('gptModelSelect').value;
            // Hide all regenerate sections initially
            const summaryRegenerateSection = document.getElementById('summaryRegenerateSection');
            const transcriptRegenerateSection = document.getElementById('transcriptRegenerateSection');
            
            if (!url) {
                if (summaryRegenerateSection) summaryRegenerateSection.style.display = 'none';
                if (transcriptRegenerateSection) transcriptRegenerateSection.style.display = 'none';
                clearResults();
                return;
            }
            
            try {
                const response = await fetch('/history');
                const historyData = await response.json();
                
                const videoId = extractVideoId(url);
                if (!videoId) {
                    regenerateSection.style.display = 'none';
                    clearResults();
                    return;
                }
                
                // history„ÅåÈÖçÂàó„Åã„Å©„ÅÜ„Åã„ÉÅ„Çß„ÉÉ„ÇØ
                const history = Array.isArray(historyData) ? historyData : [];
                const existingEntry = history.find(item => 
                    item.id === videoId && 
                    item.language === language && 
                    item.gptModel === gptModel
                );
                
                if (existingEntry) {
                    // Êó¢Â≠ò„ÅÆÁµêÊûú„ÇíË°®Á§∫
                    await displayExistingResult(existingEntry);
                    if (summaryRegenerateSection) summaryRegenerateSection.style.display = 'block';
                    if (transcriptRegenerateSection) transcriptRegenerateSection.style.display = 'block';
                } else {
                    if (summaryRegenerateSection) summaryRegenerateSection.style.display = 'none';
                    if (transcriptRegenerateSection) transcriptRegenerateSection.style.display = 'none';
                    clearResults();
                }
            } catch (error) {
                console.error('Error checking existing content:', error);
                if (summaryRegenerateSection) summaryRegenerateSection.style.display = 'none';
                if (transcriptRegenerateSection) transcriptRegenerateSection.style.display = 'none';
                clearResults();
            }
        }
        
        function clearResults() {
            // ÁµêÊûú„Çí„ÇØ„É™„Ç¢ÔºàË¶ÅÁ¥†„ÅÆÂ≠òÂú®„ÉÅ„Çß„ÉÉ„ÇØ‰ªò„ÅçÔºâ
            const transcript = document.getElementById('transcript');
            const summary = document.getElementById('summary');
            const articleContent = document.getElementById('articleContent');
            const videoInfo = document.getElementById('videoInfo');
            const videoPlayer = document.getElementById('videoPlayer');
            
            if (transcript) transcript.innerHTML = '';
            if (summary) summary.innerHTML = '';
            if (articleContent) articleContent.innerHTML = '';
            if (videoInfo) videoInfo.style.display = 'none';
            if (videoPlayer) videoPlayer.style.display = 'none';
            isTranscriptReady = false;
        }
        
        async function displayExistingResult(entry) {
            try {
                // ÊñáÂ≠óËµ∑„Åì„ÅóÁµêÊûú„ÇíÂæ©ÂÖÉ
                currentTranscript = entry.transcript || '';
                currentTimestampedSegments = entry.timestampedSegments || [];
                isTranscriptReady = true;
                
                // Â±•Ê≠¥„Åã„ÇâÂèñÂæó„Åó„ÅüÂ†¥Âêà„ÅØÊñáÂ≠óËµ∑„Åì„ÅóÈñãÂßã„Éú„Çø„É≥„ÇíÈö†„Åó„ÄÅÂÜçÁîüÊàê„Çª„ÇØ„Ç∑„Éß„É≥„ÇíË°®Á§∫
                const uploadBtn = document.getElementById('uploadBtn');
                const uploadStatus = document.getElementById('uploadStatus');
                const summaryRegenerateSection = document.getElementById('summaryRegenerateSection');
                const transcriptRegenerateSection = document.getElementById('transcriptRegenerateSection');
                
                if (uploadBtn) uploadBtn.style.display = 'none';
                if (uploadStatus) uploadStatus.innerHTML = '<div style="color: #2d5016; background: #f0f9e8; padding: 0.5rem; border-radius: 6px; font-size: 0.9rem; margin: 0.5rem 0;">üìã Â±•Ê≠¥„Åã„ÇâÂèñÂæóÊ∏à„Åø - ÂêÑ„Çø„Éñ„ÅßÂÜçËß£ÊûêÂèØËÉΩ„Åß„Åô</div>';
                if (summaryRegenerateSection) summaryRegenerateSection.style.display = 'block';
                if (transcriptRegenerateSection) transcriptRegenerateSection.style.display = 'block';
                
                // YouTube„Éó„É¨„Ç§„É§„Éº„ÇíÂàùÊúüÂåñ
                if (entry.id) {
                    initializeYouTubePlayer(entry.id);
                }
                
                // „Çø„Ç§„É†„Çπ„Çø„É≥„Éó‰ªò„ÅçÊñáÂ≠óËµ∑„Åì„Åó„ÇíË°®Á§∫
                if (entry.timestampedTranscript) {
                    currentTimestampedTranscript = entry.timestampedTranscript;
                    displayTimestampedTranscript();
                } else {
                    // ÈÄöÂ∏∏„ÅÆÊñáÂ≠óËµ∑„Åì„Åó„ÇíË°®Á§∫
                    const transcriptDiv = document.getElementById('transcript');
                    transcriptDiv.innerHTML = entry.transcript ? entry.transcript.replace(/\n/g, '<br>') : '';
                    transcriptDiv.style.whiteSpace = 'pre-wrap';
                }
                
                // ÂãïÁîªÊÉÖÂ†±„ÇíË°®Á§∫
                if (entry.metadata) {
                    displayVideoInfo(entry.metadata, entry.method, entry.language, entry.detectedLanguage);
                }
                
                // Ë¶ÅÁ¥Ñ„ÇíË°®Á§∫
                if (entry.summary) {
                    displaySummary(entry.summary);
                    // Â±•Ê≠¥„Åã„ÇâÂæ©ÂÖÉ„Åó„ÅüÂ†¥Âêà„ÄÅË¶ÅÁ¥Ñ„Åã„ÇâÁõ¥Êé•Ê∑±Êéò„ÇäË≥™Âïè„ÇíÊäΩÂá∫
                    extractAndDisplayQuestionsFromSummary(entry.summary);
                }
                
                // Ëß£Ë™¨Ë®ò‰∫ã„ÇíË°®Á§∫
                if (entry.articleContent) {
                    const articleDiv = document.getElementById('articleContent');
                    if (typeof marked !== 'undefined') {
                        articleDiv.innerHTML = marked.parse(entry.articleContent);
                    } else {
                        articleDiv.innerHTML = entry.articleContent.replace(/\n/g, '<br>');
                    }
                }
                
                // „Ç≥„Çπ„Éà„ÇíË°®Á§∫
                if (entry.costs) {
                    updateCosts(entry.costs);
                }
                
                // Êé®Â•®Ë≥™Âïè„ÇíË™≠„ÅøËæº„Åø
                loadSuggestedQuestions();
                
                showStatus(`ÈÅéÂéª„ÅÆÁµêÊûú„ÇíË°®Á§∫„Åó„Åæ„Åó„Åü: ${entry.title || 'YouTubeÂãïÁîª'} (Â±•Ê≠¥„Åã„ÇâÂèñÂæó)`, 'success');
                
            } catch (error) {
                console.error('Error displaying existing result:', error);
                showStatus('ÈÅéÂéª„ÅÆÁµêÊûú„ÅÆË°®Á§∫‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü', 'error');
            }
        }

        async function regenerateContent(type) {
            const url = document.getElementById('youtubeUrl').value.trim();
            const language = document.getElementById('languageSelect').value;
            const gptModel = document.getElementById('gptModelSelect').value;
            const mainTags = getSelectedMainTags();
            
            if (!url) {
                showMessage('YouTube„ÅÆURL„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
                return;
            }

            // „Éú„Çø„É≥„ÅÆÁä∂ÊÖã„ÇíÊõ¥Êñ∞ (Êñ∞„Åó„ÅÑ„Éú„Çø„É≥ID)
            const transcriptBtn = document.getElementById('regenerateTranscriptOnlyBtn');
            const summaryBtn = document.getElementById('regenerateSummaryOnlyBtn');
            const bothBtn = document.getElementById('regenerateBothFromTranscriptBtn');
            
            // „Åô„Åπ„Å¶„ÅÆ„Éú„Çø„É≥„ÇíÁÑ°ÂäπÂåñ
            [transcriptBtn, summaryBtn, bothBtn].forEach(btn => {
                if (btn) btn.disabled = true;
            });
            
            try {
                let endpoint, bodyData, statusMessage;
                
                switch (type) {
                    case 'transcript':
                        endpoint = '/upload-youtube';
                        bodyData = { url, language, gptModel, mainTags, tags: '', forceRegenerate: true, regenerateType: 'transcript' };
                        statusMessage = 'üìù ÊñáÂ≠óËµ∑„Åì„Åó„ÇíÂÜçËß£Êûê‰∏≠...';
                        if (transcriptBtn) transcriptBtn.textContent = 'ÂÜçËß£Êûê‰∏≠...';
                        break;
                    case 'summary':
                        endpoint = '/regenerate-summary';
                        bodyData = { url, language, gptModel };
                        statusMessage = 'üìã Ë¶ÅÁ¥Ñ„ÇíÂÜçËß£Êûê‰∏≠...';
                        if (summaryBtn) summaryBtn.textContent = 'ÂÜçËß£Êûê‰∏≠...';
                        break;
                    case 'both':
                        endpoint = '/upload-youtube';
                        bodyData = { url, language, gptModel, mainTags, tags: '', forceRegenerate: true, regenerateType: 'both' };
                        statusMessage = 'üîÑ ÂÖ®„Å¶ÂÜçËß£Êûê‰∏≠...';
                        if (bothBtn) bothBtn.textContent = 'ÂÜçËß£Êûê‰∏≠...';
                        break;
                    default:
                        throw new Error('Invalid regenerate type');
                }
                
                showStatus(statusMessage, 'loading');
                
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(bodyData)
                });

                const result = await response.json();

                if (result.success) {
                    // ÁµêÊûú„ÇíË°®Á§∫
                    if (type === 'transcript' || type === 'both') {
                        // „Çø„Ç§„É†„Çπ„Çø„É≥„ÉóÊÉÖÂ†±„Çí‰øùÂ≠ò
                        currentTimestampedSegments = result.timestampedSegments || [];
                        
                        // YouTube„Éó„É¨„Ç§„É§„Éº„ÇíÂàùÊúüÂåñ
                        if (result.metadata?.basic?.videoId) {
                            initializeYouTubePlayer(result.metadata.basic.videoId);
                            setCurrentVideoId(result.metadata.basic.videoId);
                        }
                        
                        // ÊñáÂ≠óËµ∑„Åì„Åó„ÇíË°®Á§∫
                        fetch('/transcript')
                            .then(response => response.json())
                            .then(transcriptData => {
                                if (transcriptData.timestampedTranscript) {
                                    currentTimestampedTranscript = transcriptData.timestampedTranscript;
                                    displayTimestampedTranscript();
                                } else {
                                    const transcriptDiv = document.getElementById('transcript');
                                    transcriptDiv.innerHTML = result.transcript.replace(/\n/g, '<br>');
                                    transcriptDiv.style.whiteSpace = 'pre-wrap';
                                }
                            });
                        
                        // ÂãïÁîªÊÉÖÂ†±„ÇíË°®Á§∫
                        if (result.metadata) {
                            displayVideoInfo(result.metadata, result.method, result.language, result.detectedLanguage);
                        }
                    }
                    
                    if (type === 'summary' || type === 'both') {
                        // Ë¶ÅÁ¥Ñ„ÇíË°®Á§∫
                        if (result.summary) {
                            displaySummary(result.summary);
                            // Êñ∞„Åó„ÅèÁîüÊàê„Åï„Çå„ÅüË¶ÅÁ¥Ñ„Åã„ÇâÁõ¥Êé•Ê∑±Êéò„ÇäË≥™Âïè„ÇíÊäΩÂá∫
                            extractAndDisplayQuestionsFromSummary(result.summary);
                        } else {
                            // Ë¶ÅÁ¥Ñ„Åå„Å™„ÅÑÂ†¥Âêà„ÅØ„Çµ„Éº„Éê„ÉºAPI„Åã„ÇâÂèñÂæó„ÇíË©¶Ë°å
                            loadSuggestedQuestions();
                        }
                    }
                    
                    isTranscriptReady = true;
                    ensureChatInputVisible();
                    
                    // „Ç≥„Çπ„Éà„ÇíÊõ¥Êñ∞
                    if (result.costs) {
                        updateCosts(result.costs);
                    }
                    
                    // Â±•Ê≠¥„ÇíÊõ¥Êñ∞
                    loadHistory();
                    
                    const successMessage = type === 'transcript' ? 'ÊñáÂ≠óËµ∑„Åì„Åó„ÅÆÂÜçËß£Êûê„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„ÅüÔºÅ' :
                                          type === 'summary' ? 'Ë¶ÅÁ¥Ñ„ÅÆÂÜçËß£Êûê„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„ÅüÔºÅ' :
                                          'ÂÖ®„Å¶„ÅÆÂÜçËß£Êûê„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„ÅüÔºÅ';
                    showStatus(successMessage, 'success');
                    
                } else {
                    showStatus(`„Ç®„É©„Éº: ${result.error}`, 'error');
                }
                
            } catch (error) {
                console.error('Error regenerating content:', error);
                showStatus('ÂÜçËß£Êûê‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ„ÇÇ„ÅÜ‰∏ÄÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ„ÄÇ', 'error');
            } finally {
                // „Éú„Çø„É≥„ÅÆÁä∂ÊÖã„ÇíÂÖÉ„Å´Êàª„Åô
                [transcriptBtn, summaryBtn, bothBtn].forEach(btn => {
                    if (btn) btn.disabled = false;
                });
                
                if (transcriptBtn) transcriptBtn.textContent = 'üìù ÊñáÂ≠óËµ∑„Åì„Åó„ÅÆ„ÅøÂÜçËß£Êûê';
                if (summaryBtn) summaryBtn.textContent = 'üìã Ë¶ÅÁ¥Ñ„ÇíÂÜçËß£Êûê';
                if (bothBtn) bothBtn.textContent = 'üîÑ ÂÖ®„Å¶ÂÜçËß£Êûê';
            }
        }

        async function uploadYouTube(forceRegenerate = false) {
            const url = document.getElementById('youtubeUrl').value.trim();
            const language = document.getElementById('languageSelect').value;
            const gptModel = document.getElementById('gptModelSelect').value;
            const mainTags = getSelectedMainTags();
            const tags = '';
            const uploadBtn = document.getElementById('uploadBtn');
            const uploadStatus = document.getElementById('uploadStatus');
            
            if (!url) {
                showStatus('YouTube„ÅÆURL„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
                return;
            }

            uploadBtn.disabled = true;
            
            if (forceRegenerate) {
                showStatus('üîÑ ÂÜçÁîüÊàêÂá¶ÁêÜ„ÇíÈñãÂßã„Åó„Åæ„Åó„Åü„ÄÇÊñáÂ≠óËµ∑„Åì„Åó„Å®Ë¶ÅÁ¥Ñ„ÇíÊñ∞„Åó„ÅèÁîüÊàê‰∏≠...', 'loading');
            } else {
                uploadBtn.textContent = 'Âá¶ÁêÜ‰∏≠...';
                showStatus('YouTubeÂãïÁîª„ÇíÂá¶ÁêÜ‰∏≠„Åß„Åô„ÄÇ„Åó„Å∞„Çâ„Åè„ÅäÂæÖ„Å°„Åè„Å†„Åï„ÅÑ...', 'loading');
            }

            try {
                const response = await fetch('/upload-youtube', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ url: url, language: language, gptModel: gptModel, mainTags: mainTags, tags: tags, forceRegenerate: forceRegenerate })
                });

                const result = await response.json();

                if (result.success) {
                    // ÊñáÂ≠óËµ∑„Åì„ÅóÁµêÊûú„Çí‰øùÂ≠ò
                    currentTranscript = result.transcript || '';
                    // „Çø„Ç§„É†„Çπ„Çø„É≥„ÉóÊÉÖÂ†±„Çí‰øùÂ≠ò
                    currentTimestampedSegments = result.timestampedSegments || [];
                    
                    // YouTube„Éó„É¨„Ç§„É§„Éº„ÇíÂàùÊúüÂåñ
                    const videoId = extractVideoId(url);
                    if (videoId) {
                        initializeYouTubePlayer(videoId);
                    }
                    
                    // „Çø„Ç§„É†„Çπ„Çø„É≥„Éó‰ªò„ÅçÊñáÂ≠óËµ∑„Åì„Åó„ÇíÂèñÂæó„Åó„Å¶Ë°®Á§∫
                    fetch('/transcript')
                        .then(response => response.json())
                        .then(transcriptData => {
                            if (transcriptData.timestampedTranscript) {
                                currentTimestampedTranscript = transcriptData.timestampedTranscript;
                                displayTimestampedTranscript();
                            } else {
                                // „Çø„Ç§„É†„Çπ„Çø„É≥„Éó„Åå„Å™„ÅÑÂ†¥Âêà„ÅØÈÄöÂ∏∏„ÅÆÊñáÂ≠óËµ∑„Åì„Åó„ÇíË°®Á§∫
                                const transcriptDiv = document.getElementById('transcript');
                                transcriptDiv.innerHTML = result.transcript.replace(/\n/g, '<br>');
                                transcriptDiv.style.whiteSpace = 'pre-wrap';
                            }
                        });
                    
                    // ÂãïÁîªÊÉÖÂ†±„ÇíË°®Á§∫
                    if (result.metadata) {
                        displayVideoInfo(result.metadata, result.method, result.language, result.detectedLanguage);
                    }
                    
                    // Ë¶ÅÁ¥Ñ„ÇíË°®Á§∫
                    if (result.summary) {
                        displaySummary(result.summary);
                    }
                    
                    let message = forceRegenerate ? `ÂÜçÁîüÊàê„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„ÅüÔºÅÂãïÁîª: ${result.title}` : `ÊñáÂ≠óËµ∑„Åì„Åó„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„ÅüÔºÅÂãïÁîª: ${result.title}`;
                    if (result.fromHistory) {
                        message += ' (Â±•Ê≠¥„Åã„ÇâÂèñÂæó)';
                    } else {
                        const methodText = result.method === 'subtitle' ? 'YouTubeÂ≠óÂπï' : 'Whisper API';
                        message += ` (${methodText}‰ΩøÁî®)`;
                        if (forceRegenerate) {
                            message += ' - Êñ∞„Åó„ÅèÁîüÊàê';
                        }
                    }
                    
                    showStatus(message, 'success');
                    isTranscriptReady = true;
                    ensureChatInputVisible();
                    
                    // „Ç≥„Çπ„Éà„ÇíÊõ¥Êñ∞
                    if (result.costs) {
                        updateCosts(result.costs);
                    }
                    
                    // Ë¶ÅÁ¥Ñ„Åã„ÇâÁõ¥Êé•Ê∑±Êéò„ÇäË≥™Âïè„ÇíÊäΩÂá∫
                    if (result.summary) {
                        extractAndDisplayQuestionsFromSummary(result.summary);
                    } else {
                        // Ë¶ÅÁ¥Ñ„Åå„Å™„ÅÑÂ†¥Âêà„ÅØ„Çµ„Éº„Éê„ÉºAPI„Åã„ÇâÂèñÂæó„ÇíË©¶Ë°å
                        loadSuggestedQuestions();
                    }
                    
                    // Â±•Ê≠¥„ÇíÊõ¥Êñ∞
                    loadHistory();
                    
                    // ÂÜçÁîüÊàê„Çª„ÇØ„Ç∑„Éß„É≥„ÇíË°®Á§∫ÔºàÂá¶ÁêÜÂÆå‰∫ÜÂæå„ÅØÂ∏∏„Å´ÂÜçÁîüÊàêÂèØËÉΩÔºâ
                    const summaryRegenerateSection = document.getElementById('summaryRegenerateSection');
                    const transcriptRegenerateSection = document.getElementById('transcriptRegenerateSection');
                    if (summaryRegenerateSection) summaryRegenerateSection.style.display = 'block';
                    if (transcriptRegenerateSection) transcriptRegenerateSection.style.display = 'block';
                } else {
                    showStatus(`„Ç®„É©„Éº: ${result.error}`, 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showStatus('„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ„ÇÇ„ÅÜ‰∏ÄÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ„ÄÇ', 'error');
            } finally {
                uploadBtn.disabled = false;
                uploadBtn.textContent = 'Ëß£ÊûêÈñãÂßã';
                uploadBtn.style.display = 'block';
                
                // ÂÜçÁîüÊàê„Çª„ÇØ„Ç∑„Éß„É≥„ÅØÂêÑ„Çø„Éñ„Å´ÂÄãÂà•„Å´ÈÖçÁΩÆ„Åï„Çå„Å¶„ÅÑ„Çã„ÅÆ„ÅßÁâπ„Å´Âá¶ÁêÜ‰∏çË¶Å
            }
        }

        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            const gptModel = document.getElementById('gptModelSelect').value;
            const chatBtn = document.getElementById('chatBtn');
            const chatMessages = document.getElementById('chatMessages');

            if (!message) return;

            if (!isTranscriptReady) {
                showMessage('„Åæ„ÅöÊúÄÂàù„Å´YouTubeÂãïÁîª„ÇíÊñáÂ≠óËµ∑„Åì„Åó„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ', 'info');
                return;
            }

            input.value = '';
            chatBtn.disabled = true;
            chatBtn.textContent = 'ÈÄÅ‰ø°‰∏≠...';

            addMessage(message, 'user');

            try {
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ message: message, gptModel: gptModel })
                });

                const result = await response.json();

                if (result.success) {
                    addMessage(result.response, 'ai');
                    
                    // „Ç≥„Çπ„Éà„ÇíÊõ¥Êñ∞
                    if (result.costs) {
                        updateCosts(result.costs);
                    }
                } else {
                    addMessage(`„Ç®„É©„Éº: ${result.error}`, 'ai');
                }
            } catch (error) {
                console.error('Error:', error);
                addMessage('„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ„ÇÇ„ÅÜ‰∏ÄÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ„ÄÇ', 'ai');
            } finally {
                chatBtn.disabled = false;
                chatBtn.textContent = 'ÈÄÅ‰ø°';
            }
        }

        function addMessage(text, type) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}-message`;
            
            if (type === 'ai') {
                // AI„É°„ÉÉ„Çª„Éº„Ç∏„ÅÆÂ†¥Âêà„ÄÅMarkdown„Çí„É¨„É≥„ÉÄ„É™„É≥„Ç∞„Åó„Å¶„Çø„Ç§„É†„Çπ„Çø„É≥„Éó„É™„É≥„ÇØ„ÇíÂá¶ÁêÜ
                let processedText = text;
                
                // Markdown„Çí„É¨„É≥„ÉÄ„É™„É≥„Ç∞
                if (typeof marked !== 'undefined') {
                    processedText = marked.parse(text);
                } else {
                    // marked„ÅåÂà©Áî®„Åß„Åç„Å™„ÅÑÂ†¥Âêà„ÅØÂü∫Êú¨ÁöÑ„Å™Â§âÊèõ
                    processedText = text
                        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')  // **Â§™Â≠ó**
                        .replace(/\*(.*?)\*/g, '<em>$1</em>')               // *Êñú‰Ωì*
                        .replace(/`(.*?)`/g, '<code>$1</code>')             // `„Ç≥„Éº„Éâ`
                        .replace(/\n/g, '<br>');                            // ÊîπË°å
                }
                
                // „Çø„Ç§„É†„Çπ„Çø„É≥„Éó„É™„É≥„ÇØ„ÇíÂá¶ÁêÜÔºàÊßò„ÄÖ„Å™ÂΩ¢Âºè„Å´ÂØæÂøúÔºâ
                processedText = processedText
                    .replace(/\[(\d{1,2}:\d{2}(?::\d{2})?)\]/g, function(match, timeStr) {
                        const seconds = timeToSeconds(timeStr);
                        return `<span class="timestamp-link" onclick="seekToTime(${seconds})">${match}</span>`;
                    })
                    .replace(/(\d{1,2}:\d{2}(?::\d{2})?)/g, function(match, timeStr) {
                        // []„ÅßÂõ≤„Åæ„Çå„Å¶„ÅÑ„Å™„ÅÑÊôÇÈñì„ÇÇÊ§úÂá∫„Åó„Å¶„É™„É≥„ÇØ„Å´„Åô„Çã
                        if (!match.includes('span')) { // Êó¢„Å´„É™„É≥„ÇØ„Å´„Å™„Å£„Å¶„ÅÑ„Å™„ÅÑÂ†¥Âêà„ÅÆ„Åø
                            const seconds = timeToSeconds(timeStr);
                            return `<span class="timestamp-link" onclick="seekToTime(${seconds})">${match}</span>`;
                        }
                        return match;
                    });
                
                messageDiv.innerHTML = processedText;
                
                // Ëß£Ë™¨Ë®ò‰∫ã„ÅÆ‰øÆÊ≠£ÂÜÖÂÆπ„ÅåÂê´„Åæ„Çå„Å¶„ÅÑ„Çã„Åã„ÉÅ„Çß„ÉÉ„ÇØ
                if (checkIfArticleModification(text)) {
                    const applyButton = document.createElement('button');
                    applyButton.textContent = 'üìù Ë®ò‰∫ã„Å´ÂèçÊò†';
                    applyButton.className = 'apply-to-article-btn';
                    applyButton.style.cssText = `
                        margin-top: 0.5rem;
                        padding: 0.5rem 1rem;
                        background: linear-gradient(135deg, #667eea, #764ba2);
                        color: white;
                        border: none;
                        border-radius: 6px;
                        cursor: pointer;
                        font-size: 0.8rem;
                        font-weight: 600;
                        transition: all 0.3s ease;
                    `;
                    applyButton.onmouseover = () => applyButton.style.background = 'linear-gradient(135deg, #5a67d8, #6b46c1)';
                    applyButton.onmouseout = () => applyButton.style.background = 'linear-gradient(135deg, #667eea, #764ba2)';
                    applyButton.onclick = () => applyModificationToArticle(text);
                    
                    messageDiv.appendChild(applyButton);
                }
            } else {
                messageDiv.textContent = text;
            }
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function checkIfArticleModification(text) {
            // Ëß£Ë™¨Ë®ò‰∫ã„ÅÆ‰øÆÊ≠£„ÇíÁ§∫„Åô„Ç≠„Éº„ÉØ„Éº„Éâ„Çí„ÉÅ„Çß„ÉÉ„ÇØ
            const modificationKeywords = [
                '‰øÆÊ≠£„Åó„Åü?Ë®ò‰∫ã',
                'ÊîπÂñÑ„Åó„Åü?Ë®ò‰∫ã', 
                'Êõ¥Êñ∞„Åó„Åü?Ë®ò‰∫ã',
                'Êõ∏„ÅçÁõ¥„Åó„Åü?Ë®ò‰∫ã',
                '‰ª•‰∏ã„ÅÆ?Ë®ò‰∫ã',
                '‰øÆÊ≠£Áâà?„ÅÆ?Ë®ò‰∫ã',
                'ÊîπÂñÑÁâà?„ÅÆ?Ë®ò‰∫ã',
                'markdown?„Åß?Ë®ò‰∫ã',
                'markdown„Åß?Ë®ò‰∫ã',
                '# ',  // Markdown„ÅÆË¶ãÂá∫„Åó
                '## ', // Markdown„ÅÆË¶ãÂá∫„Åó
                '### ', // Markdown„ÅÆË¶ãÂá∫„Åó
                '```', // „Ç≥„Éº„Éâ„Éñ„É≠„ÉÉ„ÇØ
                'Ë®ò‰∫ã.*‰øÆÊ≠£',
                'Ë®ò‰∫ã.*ÊîπÂñÑ',
                'Ë®ò‰∫ã.*Â§âÊõ¥',
                'Ë®ò‰∫ã.*‰ΩúÊàê',
                'Ë®ò‰∫ã.*Êõ∏„ÅçÁõ¥',
                'Ë®ò‰∫ã.*„É™„É©„Ç§„Éà',
                'Êñ∞„Åó„ÅÑË®ò‰∫ã',
                'Ë®ò‰∫ã„Å®„Åó„Å¶',
                'Ë®ò‰∫ã„ÅÆ?ÂÜÖÂÆπ',
                'Ë®ò‰∫ã„ÅÆ?ÂΩ¢Âºè',
                '„Çà„ÇäË©≥Á¥∞.*Ë®ò‰∫ã',
                'Ë©≥„Åó„Åè.*Ë®ò‰∫ã'
            ];
            
            const hasKeyword = modificationKeywords.some(keyword => {
                const regex = new RegExp(keyword, 'i');
                return regex.test(text);
            });
            
            console.log('Checking if article modification:', hasKeyword);
            return hasKeyword;
        }

        async function applyModificationToArticle(aiResponse) {
            try {
                console.log('üîÑ Starting merge process...');
                console.log('üîÑ FORCE MERGE DEBUG - This will show why merge fails or succeeds');
                
                // Êó¢Â≠ò„ÅÆË®ò‰∫ãÂÜÖÂÆπ„ÇíÂèñÂæó
                const articleDiv = document.getElementById('articleContent');
                if (!articleDiv) {
                    console.log('‚ùå Article div not found');
                    showMessage('Ëß£Ë™¨Ë®ò‰∫ã„Ç®„É™„Ç¢„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„ÄÇ', 'error');
                    return;
                }
                
                const existingArticle = getMarkdownFromArticleDiv(articleDiv);
                console.log('=== FRONTEND MERGE DEBUG ===');
                console.log('üìÑ Article div exists:', !!articleDiv);
                console.log('üìÑ Article div innerHTML length:', articleDiv.innerHTML.length);
                console.log('üìÑ Article div innerHTML preview:', articleDiv.innerHTML.substring(0, 300) + '...');
                console.log('üìÑ Existing article length:', existingArticle.length);
                console.log('üìÑ Existing article preview:', existingArticle.substring(0, 200) + '...');
                console.log('üìÑ Existing article full content:', `"${existingArticle}"`);
                
                // ÊúÄÂæå„ÅÆ„É¶„Éº„Ç∂„Éº„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂèñÂæóÔºà„É¶„Éº„Ç∂„Éº„ÅÆÊåáÁ§∫„Å®„Åó„Å¶‰ΩøÁî®Ôºâ
                const userInstruction = getLastUserMessage();
                console.log('üí¨ User instruction:', `"${userInstruction}"`);
                console.log('üí¨ User instruction length:', userInstruction.length);
                console.log('ü§ñ AI response length:', aiResponse.length);
                console.log('ü§ñ AI response preview:', aiResponse.substring(0, 200) + '...');
                
                // Êù°‰ª∂„ÉÅ„Çß„ÉÉ„ÇØ1: Êó¢Â≠òË®ò‰∫ã„ÅÆÂ≠òÂú®Á¢∫Ë™çÔºà„Çà„ÇäÁ∑©„ÅÑÊù°‰ª∂Ôºâ
                if (!existingArticle || existingArticle.length < 10) {
                    console.log('‚ùå CONDITION 1 FAILED: No existing article or too short');
                    console.log('   - existingArticle exists:', !!existingArticle);
                    console.log('   - existingArticle length:', existingArticle ? existingArticle.length : 0);
                    console.log('   - Minimum required length: 10 (lowered from 50)');
                    console.log('üîÑ ‚Üí Switching to article generation mode');
                    
                    // Êó¢Â≠òË®ò‰∫ã„Åå„Å™„ÅÑÂ†¥Âêà„ÅØ„ÄÅ„Åæ„ÅöË®ò‰∫ã„ÇíÁîüÊàê
                    showMessage('Êó¢Â≠òË®ò‰∫ã„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇË®ò‰∫ã„ÇíÁîüÊàê„Åó„Å¶„Åã„Çâ„Éû„Éº„Ç∏„Åó„Åæ„Åô...', 'info');
                    
                    try {
                        const generateResponse = await fetch('/generate-article', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ gptModel: document.getElementById('gptModelSelect').value || 'gpt-4o-mini' })
                        });
                        
                        const generateResult = await generateResponse.json();
                        
                        if (generateResult.success) {
                            // ÁîüÊàê„Åï„Çå„ÅüË®ò‰∫ã„ÇíË°®Á§∫
                            switchTab('article');
                            if (typeof marked !== 'undefined') {
                                articleDiv.innerHTML = marked.parse(generateResult.article);
                            } else {
                                articleDiv.innerHTML = generateResult.article.replace(/\n/g, '<br>');
                            }
                            
                            // Ë®ò‰∫ã„ÅåÁîüÊàê„Åï„Çå„Åü„ÅÆ„ÅßÊàêÂäü„É°„ÉÉ„Çª„Éº„Ç∏„ÇíË°®Á§∫
                            showMessage('‚úÖ Ë®ò‰∫ã„ÇíÁîüÊàê„Åó„Åæ„Åó„Åü„ÄÇÂÄãÂà•„ÅÆÊîπÂñÑ„ÅØÊó¢Â≠òË®ò‰∫ã„Åå„ÅÇ„ÇãÂ†¥Âêà„Å´Âà©Áî®„Åß„Åç„Åæ„Åô„ÄÇ', 'success');
                            return;
                        }
                    } catch (error) {
                        console.error('Failed to generate article:', error);
                    }
                    
                    // Ë®ò‰∫ãÁîüÊàê„Å´Â§±Êïó„Åó„ÅüÂ†¥Âêà„ÅØÁõ¥Êé•ÈÅ©Áî®
                    await applyDirectArticleModification(aiResponse);
                    return;
                }
                
                // Êù°‰ª∂„ÉÅ„Çß„ÉÉ„ÇØ2: „É¶„Éº„Ç∂„ÉºÊåáÁ§∫„ÅÆÁ¢∫Ë™çÔºà„Çà„ÇäÁ∑©„ÅÑÊù°‰ª∂Ôºâ
                if (!userInstruction || userInstruction.length < 3) {
                    console.log('‚ùå CONDITION 2 FAILED: No user instruction or too short');
                    console.log('   - userInstruction exists:', !!userInstruction);
                    console.log('   - userInstruction length:', userInstruction ? userInstruction.length : 0);
                    console.log('   - userInstruction content:', `"${userInstruction}"`);
                    console.log('   - Minimum required length: 3 (lowered from 5)');
                    console.log('‚ö†Ô∏è ‚Üí Using direct application (fallback)');
                    await applyDirectArticleModification(aiResponse);
                    return;
                }
                
                // ÂÖ®Êù°‰ª∂„ÇØ„É™„Ç¢ - „Éû„Éº„Ç∏ÂÆüË°å
                console.log('‚úÖ ALL CONDITIONS PASSED - Proceeding with merge');
                console.log('‚úÖ Existing article: OK (' + existingArticle.length + ' chars)');
                console.log('‚úÖ User instruction: OK ("' + userInstruction + '")');
                
                // Âá¶ÁêÜ‰∏≠„É°„ÉÉ„Çª„Éº„Ç∏„ÇíË°®Á§∫
                showMessage('üîç Ë©≤ÂΩìÁÆáÊâÄ„ÇíÁâπÂÆö„Åó„Å¶Ë®ò‰∫ã„Å´ÂèçÊò†‰∏≠...', 'info');
                
                // Ëß£Ë™¨Ë®ò‰∫ã„Çø„Éñ„Å´ÁßªÂãïÔºàÂá¶ÁêÜ‰∏≠„ÇíË°®Á§∫„Åô„Çã„Åü„ÇÅÔºâ
                switchTab('article');
                
                // Âá¶ÁêÜ‰∏≠„Ç§„É≥„Ç∏„Ç±„Éº„Çø„Éº„ÇíË°®Á§∫
                articleDiv.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #667eea;">
                        <div style="font-size: 2rem; margin-bottom: 1rem;">üîç</div>
                        <div style="font-size: 1.2rem; font-weight: 600; margin-bottom: 0.5rem;">Ë®ò‰∫ã„Å´ÂèçÊò†‰∏≠</div>
                        <div style="color: #718096;">
                            „É¶„Éº„Ç∂„ÉºË≥™Âïè„Åã„ÇâË©≤ÂΩìÁÆáÊâÄ„ÇíÁâπÂÆö„Åó„ÄÅ„Åù„ÅÆÈÉ®ÂàÜ„ÅÆ„Åø„ÇíÊîπÂñÑ„Åó„Å¶„ÅÑ„Åæ„Åô...<br>
                            <small>ÔºàÊó¢Â≠òË®ò‰∫ã„ÅÆÊßãÈÄ†„ÅØ‰øùÊåÅ„Åï„Çå„Åæ„ÅôÔºâ</small>
                        </div>
                    </div>
                `;
                
                // „Éê„ÉÉ„ÇØ„Ç®„É≥„Éâ„Åß„Çπ„Éû„Éº„Éà„Éû„Éº„Ç∏„ÇíÂÆüË°å
                console.log('üöÄ Calling merge API with:');
                console.log('- Existing article length:', existingArticle.length);
                console.log('- User instruction:', userInstruction);
                console.log('- AI response length:', aiResponse.length);
                
                const mergeResponse = await fetch('/merge-article', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        existingArticle: existingArticle,
                        userInstruction: userInstruction,
                        aiResponse: aiResponse,
                        gptModel: document.getElementById('gptModelSelect').value || 'gpt-4o-mini'
                    })
                });
                
                console.log('üì° Merge API response status:', mergeResponse.status);
                
                const mergeResult = await mergeResponse.json();
                
                if (mergeResult.success) {
                    console.log('‚úÖ Merge successful!');
                    console.log('üìÑ Merged article length:', mergeResult.mergedArticle.length);
                    console.log('üìÑ Merged article preview:', mergeResult.mergedArticle.substring(0, 200) + '...');
                    console.log('üéØ Target section:', mergeResult.analysis.targetSection);
                    
                    // Ëß£Ë™¨Ë®ò‰∫ã„Çø„Éñ„Å´ÁßªÂãï
                    switchTab('article');
                    
                    // „Éû„Éº„Ç∏„Åï„Çå„ÅüË®ò‰∫ã„ÇíÈÅ©Áî®
                    if (typeof marked !== 'undefined') {
                        console.log('üìù Using marked to parse merged article');
                        articleDiv.innerHTML = marked.parse(mergeResult.mergedArticle);
                    } else {
                        console.log('üìù Using basic HTML conversion for merged article');
                        articleDiv.innerHTML = mergeResult.mergedArticle.replace(/\n/g, '<br>');
                    }
                    
                    console.log('‚úÖ Merged article applied to DOM');
                    
                    // „Çø„Ç§„É†„Çπ„Çø„É≥„Éó„É™„É≥„ÇØ„ÇíÂá¶ÁêÜ
                    processTimestampLinks(articleDiv);
                    
                    // ÊàêÂäü„É°„ÉÉ„Çª„Éº„Ç∏„ÇíË°®Á§∫
                    const targetSection = mergeResult.analysis ? mergeResult.analysis.targetSection : 'Ë©≤ÂΩìÁÆáÊâÄ';
                    showMessage(`‚úÖ Ë®ò‰∫ãÂèçÊò†ÂÆå‰∫ÜÔºÅ„Äå${targetSection}„Äç„Çª„ÇØ„Ç∑„Éß„É≥„ÇíÊîπÂñÑ„Åó„Åæ„Åó„ÅüÔºàË≤ªÁî®: $${mergeResult.cost.toFixed(4)}Ôºâ`, 'success');
                    
                } else {
                    console.error('Merge failed:', mergeResult.error);
                    showMessage('Ë®ò‰∫ãÂèçÊò†„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇÈÄöÂ∏∏ÈÅ©Áî®„ÇíË©¶„Åó„Åæ„Åô...', 'warning');
                    await applyDirectArticleModification(aiResponse);
                }
                
            } catch (error) {
                console.error('Error in merge:', error);
                showMessage('Ë®ò‰∫ãÂèçÊò†„Åß„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇÈÄöÂ∏∏ÈÅ©Áî®„ÇíË©¶„Åó„Åæ„Åô...', 'warning');
                await applyDirectArticleModification(aiResponse);
            }
        }

        // Áõ¥Êé•ÈÅ©Áî®„ÅÆ„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÈñ¢Êï∞
        async function applyDirectArticleModification(aiResponse) {
            try {
                console.log('‚ö†Ô∏è Using direct application (fallback)');
                console.log('AI response for direct application:', aiResponse.substring(0, 200) + '...');
                
                const articleContent = extractArticleFromResponse(aiResponse);
                
                if (articleContent) {
                    switchTab('article');
                    
                    const articleDiv = document.getElementById('articleContent');
                    if (articleDiv) {
                        if (typeof marked !== 'undefined') {
                            articleDiv.innerHTML = marked.parse(articleContent);
                        } else {
                            articleDiv.innerHTML = articleContent.replace(/\n/g, '<br>');
                        }
                        
                        processTimestampLinks(articleDiv);
                        showMessage('Ëß£Ë™¨Ë®ò‰∫ã„ÅåÊõ¥Êñ∞„Åï„Çå„Åæ„Åó„ÅüÔºÅ', 'success');
                    }
                } else {
                    showMessage('Ë®ò‰∫ãÂÜÖÂÆπ„ÇíÊäΩÂá∫„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ', 'error');
                }
            } catch (error) {
                console.error('Error in direct application:', error);
                showMessage('Ë®ò‰∫ã„ÅÆÈÅ©Áî®„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message, 'error');
            }
        }

        // Ë®ò‰∫ãDiv„Åã„ÇâMarkdownÂΩ¢Âºè„ÅÆ„ÉÜ„Ç≠„Çπ„Éà„ÇíÂèñÂæó
        function getMarkdownFromArticleDiv(articleDiv) {
            // Êó¢Â≠ò„ÅÆË®ò‰∫ãÂÜÖÂÆπ„ÇíMarkdownÂΩ¢Âºè„ÅßÂèñÂæó
            // HTML„Åã„ÇâMarkdown„Å∏„ÅÆÂ§âÊèõÔºàÁ∞°ÊòìÁâàÔºâ
            const htmlContent = articleDiv.innerHTML;
            
            console.log('=== HTML TO MARKDOWN DEBUG ===');
            console.log('HTML content length:', htmlContent.length);
            console.log('HTML content preview:', htmlContent.substring(0, 300) + '...');
            
            if (!htmlContent || htmlContent.trim() === '') {
                console.log('No HTML content found');
                return '';
            }
            
            // Skip processing indicators and loading states
            if (htmlContent.includes('Ë®ò‰∫ã„Å´ÂèçÊò†‰∏≠') || htmlContent.includes('Ë®ò‰∫ã„ÇíÁîüÊàê‰∏≠') || htmlContent.includes('loading')) {
                console.log('Article is in processing state, skipping conversion');
                return '';
            }
            
            // Á∞°ÊòìÁöÑ„Å™HTML‚ÜíMarkdownÂ§âÊèõ
            let markdown = htmlContent
                .replace(/<h1[^>]*>(.*?)<\/h1>/gi, '# $1\n\n')
                .replace(/<h2[^>]*>(.*?)<\/h2>/gi, '## $1\n\n')
                .replace(/<h3[^>]*>(.*?)<\/h3>/gi, '### $1\n\n')
                .replace(/<h4[^>]*>(.*?)<\/h4>/gi, '#### $1\n\n')
                .replace(/<h5[^>]*>(.*?)<\/h5>/gi, '##### $1\n\n')
                .replace(/<h6[^>]*>(.*?)<\/h6>/gi, '###### $1\n\n')
                .replace(/<p[^>]*>(.*?)<\/p>/gi, '$1\n\n')
                .replace(/<br\s*\/?>/gi, '\n')
                .replace(/<strong[^>]*>(.*?)<\/strong>/gi, '**$1**')
                .replace(/<b[^>]*>(.*?)<\/b>/gi, '**$1**')
                .replace(/<em[^>]*>(.*?)<\/em>/gi, '*$1*')
                .replace(/<i[^>]*>(.*?)<\/i>/gi, '*$1*')
                .replace(/<code[^>]*>(.*?)<\/code>/gi, '`$1`')
                .replace(/<pre[^>]*><code[^>]*>(.*?)<\/code><\/pre>/gi, '```\n$1\n```')
                .replace(/<ul[^>]*>(.*?)<\/ul>/gi, '$1\n')
                .replace(/<ol[^>]*>(.*?)<\/ol>/gi, '$1\n')
                .replace(/<li[^>]*>(.*?)<\/li>/gi, '- $1\n')
                .replace(/<a[^>]*href=["']([^"']*)["'][^>]*>(.*?)<\/a>/gi, '[$2]($1)')
                .replace(/<[^>]+>/g, '') // ÊÆã„Çä„ÅÆHTML„Çø„Ç∞„ÇíÈô§Âéª
                .replace(/&nbsp;/g, ' ')
                .replace(/&lt;/g, '<')
                .replace(/&gt;/g, '>')
                .replace(/&amp;/g, '&')
                .replace(/\n{3,}/g, '\n\n') // 3ÂÄã‰ª•‰∏ä„ÅÆÈÄ£Á∂öÊîπË°å„Çí2ÂÄã„Å´
                .trim();
            
            console.log('Converted markdown length:', markdown.length);
            console.log('Converted markdown preview:', markdown.substring(0, 300) + '...');
            console.log('=== END HTML TO MARKDOWN DEBUG ===');
            
            return markdown;
        }

        // ÊúÄÂæå„ÅÆ„É¶„Éº„Ç∂„Éº„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂèñÂæó
        function getLastUserMessage() {
            console.log('üîç Getting last user message...');
            const chatMessages = document.getElementById('chatMessages');
            
            if (!chatMessages) {
                console.log('‚ùå Chat messages container not found');
                return '';
            }
            
            const userMessages = chatMessages.querySelectorAll('.user-message');
            console.log('üìù Found user messages count:', userMessages.length);
            
            if (userMessages.length > 0) {
                const lastUserMessage = userMessages[userMessages.length - 1];
                const messageText = lastUserMessage.textContent.trim();
                console.log('üìù Last user message:', `"${messageText}"`);
                return messageText;
            }
            
            console.log('‚ùå No user messages found');
            return '';
        }

        // „Çø„Ç§„É†„Çπ„Çø„É≥„Éó„É™„É≥„ÇØ„ÅÆÂá¶ÁêÜ„ÇíÂàÜÈõ¢
        function processTimestampLinks(articleDiv) {
            const timestampLinks = articleDiv.querySelectorAll('span');
            timestampLinks.forEach(span => {
                const text = span.textContent;
                if (text.match(/\d{1,2}:\d{2}(?::\d{2})?/)) {
                    span.className = 'timestamp-link';
                    const timeStr = text.match(/\d{1,2}:\d{2}(?::\d{2})?/)[0];
                    const seconds = timeToSeconds(timeStr);
                    span.onclick = () => seekToTime(seconds);
                }
            });
        }

        function extractArticleFromResponse(text) {
            console.log('Extracting article content from response...');
            
            // „Ç≥„Éº„Éâ„Éñ„É≠„ÉÉ„ÇØÂÜÖ„ÅÆMarkdown„ÇíÊäΩÂá∫
            console.log('Trying code block pattern...');
            const codeBlockMatch = text.match(/```(?:markdown)?\n([\s\S]*?)\n```/i);
            if (codeBlockMatch) {
                console.log('Found code block match');
                return codeBlockMatch[1].trim();
            }
            
            // Ë¶ãÂá∫„Åó„Åã„ÇâÂßã„Åæ„ÇãMarkdownÂΩ¢Âºè„ÅÆ„ÉÜ„Ç≠„Çπ„Éà„ÇíÊäΩÂá∫
            console.log('Trying markdown heading pattern...');
            const markdownMatch = text.match(/(^|\n)(# .+[\s\S]*)/);
            if (markdownMatch) {
                console.log('Found markdown heading match');
                return markdownMatch[2].trim();
            }
            
            // „Çà„ÇäÊüîËªü„Å™Ë¶ãÂá∫„Åó„Éë„Çø„Éº„É≥ÔºàË°å„ÅÆÈÄî‰∏≠„Åã„ÇâÂßã„Åæ„ÇãÂ†¥ÂêàÔºâ
            console.log('Trying flexible heading pattern...');
            const flexibleHeadingMatch = text.match(/# .+[\s\S]*/);
            if (flexibleHeadingMatch) {
                console.log('Found flexible heading match');
                return flexibleHeadingMatch[0].trim();
            }
            
            // „ÄåË®ò‰∫ã„Äç„Å®„ÅÑ„ÅÜÂçòË™û„ÅÆÂæå„Å´Á∂ö„Åè„Ç≥„É≥„ÉÜ„É≥„ÉÑ„ÇíÊäΩÂá∫
            console.log('Trying article keyword pattern...');
            const articleMatch = text.match(/(?:‰øÆÊ≠£„Åó„Åü?|ÊîπÂñÑ„Åó„Åü?|Êõ¥Êñ∞„Åó„Åü?)?Ë®ò‰∫ã.*?:?\n\n([\s\S]*)/i);
            if (articleMatch) {
                console.log('Found article keyword match');
                return articleMatch[1].trim();
            }
            
            // „Çà„ÇäÂ∫ÉÁØÑÂõ≤„ÅÆÊäΩÂá∫ÔºàÊúÄÂæå„ÅÆÊâãÊÆµÔºâ
            console.log('Trying fallback pattern...');
            const fallbackMatch = text.match(/^(# .+[\s\S]*)/m);
            if (fallbackMatch) {
                console.log('Found fallback match');
                return fallbackMatch[1].trim();
            }
            
            console.log('No extraction pattern matched');
            return null;
        }

        function showStatus(message, type) {
            const uploadStatus = document.getElementById('uploadStatus');
            uploadStatus.innerHTML = `<div class="${type}">${message}</div>`;
        }

        document.getElementById('chatInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // „Éó„É≠„É≥„Éó„ÉàÁÆ°ÁêÜÊ©üËÉΩ
        function togglePromptSettings(type) {
            const settings = document.getElementById(type + 'PromptSettings');
            const arrow = document.getElementById(type + 'PromptArrow');
            
            if (settings.style.display === 'none') {
                settings.style.display = 'block';
                arrow.textContent = '‚ñ≤';
            } else {
                settings.style.display = 'none';
                arrow.textContent = '‚ñº';
            }
        }
        
        
        function getDefaultPromptTemplate(type) {
            if (type === 'summary') {
                return `„ÅÇ„Å™„Åü„ÅØÂãïÁîª„Ç≥„É≥„ÉÜ„É≥„ÉÑ„ÅÆÂàÜÊûêÂ∞ÇÈñÄÂÆ∂„Åß„Åô„ÄÇ‰ª•‰∏ã„ÅÆYouTubeÂãïÁîª„ÅÆÊñáÂ≠óËµ∑„Åì„Åó„ÇíÂàÜÊûê„Åó„ÄÅÊßãÈÄ†Âåñ„Åï„Çå„ÅüË¶ÅÁ¥Ñ„ÇíÁîüÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ

ÂãïÁîªÊÉÖÂ†±:
-- „Çø„Ç§„Éà„É´: {{title}}
-- Èï∑„Åï: {{duration}}
-- „ÉÅ„É£„É≥„Éç„É´: {{channel}}

{{timestampNote}}

Ë¶ÅÁ¥Ñ„ÅÆÂΩ¢Âºè:
1. **üìã ÂãïÁîªÊ¶ÇË¶Å** (2-3Êñá„ÅßÂãïÁîª„ÅÆÁõÆÁöÑ„Å®ÂÜÖÂÆπ„ÇíË¶ÅÁ¥Ñ)
2. **üéØ ‰∏ªË¶Å„Éù„Ç§„É≥„Éà** (ÈáçË¶Å„Å™ÂÜÖÂÆπ„Çí3-5ÂÄã„ÅÆÁÆáÊù°Êõ∏„Åç„Åß„ÄÇ{{timestampInstruction}})
3. **üí° Ë©≥Á¥∞Ëß£Ë™¨** (ÂêÑ„Éù„Ç§„É≥„Éà„ÅÆË©≥„Åó„ÅÑË™¨Êòé„ÄÇ{{timestampInstruction}})
4. **üîë „Ç≠„Éº„ÉØ„Éº„Éâ„ÉªÁî®Ë™û** (ÈáçË¶Å„Å™Â∞ÇÈñÄÁî®Ë™û„ÇÑÊ¶ÇÂøµ„ÇíË™¨Êòé)
5. **üìà ÂÆüË∑µÁöÑ‰æ°ÂÄ§** (Ë¶ñËÅ¥ËÄÖ„ÅåÂÆüÈöõ„Å´Ê¥ªÁî®„Åß„Åç„ÇãÂÜÖÂÆπ)
6. **üí° „Åä„Åô„Åô„ÇÅÊ∑±Êéò„ÇäË≥™Âïè** (ÂãïÁîªÂÜÖÂÆπ„Å´Âü∫„Å•„ÅèÂÖ∑‰ΩìÁöÑ„Å™Ë≥™Âïè„Çí3-5ÂÄã„ÄÇÂøÖ„Åö„ÄåÔºü„Äç„ÅßÁµÇ„Çè„ÇãË≥™ÂïèÂΩ¢Âºè„Å´„Åó„Å¶„Åè„Å†„Åï„ÅÑ)

Ê∑±Êéò„ÇäË≥™Âïè„ÅÆ‰æãÔºö
- „Åì„ÅÆÊâãÊ≥ï„ÇíÂÆüÈöõ„ÅÆ„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Å´ÈÅ©Áî®„Åô„ÇãÈöõ„ÅÆÊ≥®ÊÑèÁÇπ„ÅØÔºü
- ÂãïÁîª„ÅßÁ¥π‰ªã„Åï„Çå„Åü‚óã‚óã„ÅÆË©≥Á¥∞„Å™ÂÆüË£ÖÊñπÊ≥ï„ÅØÔºü
- √ó√ó„ÅÆÈÉ®ÂàÜ„ÅßË®ÄÂèä„Åï„Çå„Åü‚ñ≥‚ñ≥„Å´„Å§„ÅÑ„Å¶Ë©≥„Åó„ÅèÊïô„Åà„Å¶„Åè„Å†„Åï„ÅÑÔºü

Ê≥®ÊÑè‰∫ãÈ†Ö:
- ÊÉÖÂ†±„ÅØÊ≠£Á¢∫„ÅßÁ∞°ÊΩî„Å´
- Â∞ÇÈñÄÁî®Ë™û„ÅØÂàÜ„Åã„Çä„ÇÑ„Åô„ÅèË™¨Êòé
- ÂÆüÁî®ÊÄß„ÇíÈáçË¶ñ
- „Çø„Ç§„É†„Çπ„Çø„É≥„Éó„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØÂøÖ„ÅöÂê´„ÇÅ„Çã

{{transcriptContent}}`;
            } else if (type === 'article') {
                return `„ÅÇ„Å™„Åü„ÅØÊäÄË°ìË®ò‰∫ã„ÅÆÂ∞ÇÈñÄ„É©„Ç§„Çø„Éº„Åß„Åô„ÄÇYouTubeÂãïÁîª„ÅÆÂÜÖÂÆπ„Çí„ÇÇ„Å®„Å´„ÄÅZenn/QiitaÂêë„Åë„ÅÆÈ´òÂìÅË≥™„Å™ÊäÄË°ìËß£Ë™¨Ë®ò‰∫ã„Çí‰ΩúÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ

{{templateNote}}

Ë®ò‰∫ã„ÅÆÊßãÊàêË¶Å‰ª∂:
1. **„Çø„Ç§„Éà„É´**: Ë™≠ËÄÖ„ÅÆËààÂë≥„ÇíÂºï„Åè„ÄÅSEO„ÇíÊÑèË≠ò„Åó„Åü„Çø„Ç§„Éà„É´
2. **Â∞éÂÖ•ÈÉ®**: Ë®ò‰∫ã„ÅÆÊ¶ÇË¶Å„Å®Ë™≠ËÄÖ„ÅåÂæó„Çâ„Çå„Çã‰æ°ÂÄ§„ÇíÊòéÁ¢∫„Å´
3. **Êú¨Êñá**: Ë´ñÁêÜÁöÑ„ÅßÂàÜ„Åã„Çä„ÇÑ„Åô„ÅÑÊßãÊàê
4. **„Ç≥„Éº„Éâ‰æã**: ÂøÖË¶Å„Å´Âøú„Åò„Å¶ÂÆüË£Ö‰æã„ÇÑ„Çµ„É≥„Éó„É´„Ç≥„Éº„Éâ„ÇíÂê´„ÇÅ„Çã
5. **„Åæ„Å®„ÇÅ**: Ë¶ÅÁÇπ„ÅÆÂÜçÊï¥ÁêÜ„Å®Ê¨°„ÅÆ„Ç¢„ÇØ„Ç∑„Éß„É≥„ÅÆÊèêÊ°à

Ë®ò‰∫ã„ÅÆÂìÅË≥™Ë¶Å‰ª∂:
-- ÂàùÂøÉËÄÖ„Å´„ÇÇÁêÜËß£„Åó„ÇÑ„Åô„ÅÑË™¨Êòé
-- ÂÆüË∑µÁöÑ„ÅßÂÜçÁèæÂèØËÉΩ„Å™ÂÜÖÂÆπ
-- ÈÅ©Âàá„Å™Ë¶ãÂá∫„ÅóÊßãÈÄ†ÔºàH1‚ÜíH2‚ÜíH3Ôºâ
-- „Ç≥„Éº„Éâ„Éñ„É≠„ÉÉ„ÇØ„ÅÆÈÅ©Âàá„Å™‰ΩøÁî®
-- Âõ≥Ë°®„ÇÑÁîªÂÉè„ÅÆË™¨ÊòéÔºàÂøÖË¶Å„Å´Âøú„Åò„Å¶Ôºâ
-- SEO„ÇíÊÑèË≠ò„Åó„Åü„Ç≠„Éº„ÉØ„Éº„ÉâÈÖçÁΩÆ

Âá∫ÂäõÂΩ¢Âºè:
MarkdownÂΩ¢Âºè„ÅßË®ò‰∫ã„Çí‰ΩúÊàê„Åó„ÄÅ‰ª•‰∏ã„ÅÆË¶ÅÁ¥†„ÇíÂê´„ÇÅ„Å¶„Åè„Å†„Åï„ÅÑÔºö
- „Çø„Ç§„Éà„É´ÔºàH1Ôºâ
- Â∞éÂÖ•ÈÉ®
- ÁõÆÊ¨°ÔºàÂøÖË¶Å„Å´Âøú„Åò„Å¶Ôºâ
- Êú¨ÊñáÔºàÈÅ©Âàá„Å™Ë¶ãÂá∫„ÅóÊßãÈÄ†Ôºâ
- „Åæ„Å®„ÇÅ
- ÂèÇËÄÉ„É™„É≥„ÇØÔºàÂÖÉÂãïÁîª„ÅÆURLÂê´„ÇÄÔºâ`;
            }
            return '';
        }

        async function loadPrompts() {
            try {
                const response = await fetch('/prompts');
                const data = await response.json();
                
                // Ë¶ÅÁ¥Ñ„Éó„É≠„É≥„Éó„Éà„ÇíË®≠ÂÆö
                const summaryTextarea = document.getElementById('summaryPromptText');
                if (data.success && data.prompts && data.prompts.summary && data.prompts.summary.template) {
                    summaryTextarea.value = data.prompts.summary.template;
                } else {
                    // „Ç´„Çπ„Çø„É†„Éó„É≠„É≥„Éó„Éà„Åå„Å™„ÅÑÂ†¥Âêà„ÅØ„Éá„Éï„Ç©„É´„Éà„Éó„É≠„É≥„Éó„Éà„ÇíË°®Á§∫
                    summaryTextarea.value = getDefaultPromptTemplate('summary');
                    summaryTextarea.placeholder = '„Éá„Éï„Ç©„É´„Éà„Éó„É≠„É≥„Éó„Éà„ÅåË°®Á§∫„Åï„Çå„Å¶„ÅÑ„Åæ„Åô„ÄÇÁ∑®ÈõÜ„Åó„Å¶‰øùÂ≠ò„Åß„Åç„Åæ„Åô„ÄÇ';
                }
                
                // Ëß£Ë™¨Ë®ò‰∫ã„Éó„É≠„É≥„Éó„Éà„ÇíË®≠ÂÆö
                const articleTextarea = document.getElementById('articlePromptText');
                if (data.success && data.prompts && data.prompts.article && data.prompts.article.template) {
                    articleTextarea.value = data.prompts.article.template;
                } else {
                    // „Ç´„Çπ„Çø„É†„Éó„É≠„É≥„Éó„Éà„Åå„Å™„ÅÑÂ†¥Âêà„ÅØ„Éá„Éï„Ç©„É´„Éà„Éó„É≠„É≥„Éó„Éà„ÇíË°®Á§∫
                    articleTextarea.value = getDefaultPromptTemplate('article');
                    articleTextarea.placeholder = '„Éá„Éï„Ç©„É´„Éà„Éó„É≠„É≥„Éó„Éà„ÅåË°®Á§∫„Åï„Çå„Å¶„ÅÑ„Åæ„Åô„ÄÇÁ∑®ÈõÜ„Åó„Å¶‰øùÂ≠ò„Åß„Åç„Åæ„Åô„ÄÇ';
                }
            } catch (error) {
                console.error('Error loading prompts:', error);
                // „Ç®„É©„Éº„ÅÆÂ†¥Âêà„ÇÇ„Éá„Éï„Ç©„É´„Éà„Éó„É≠„É≥„Éó„Éà„ÇíË°®Á§∫
                const summaryTextarea = document.getElementById('summaryPromptText');
                const articleTextarea = document.getElementById('articlePromptText');
                summaryTextarea.value = getDefaultPromptTemplate('summary');
                articleTextarea.value = getDefaultPromptTemplate('article');
            }
        }

        async function savePrompt(type) {
            const textareaId = type + 'PromptText';
            const textarea = document.getElementById(textareaId);
            const template = textarea.value.trim();
            
            if (!template) {
                showPromptMessage(type, '„Éó„É≠„É≥„Éó„Éà„ÅåÁ©∫„Åß„Åô„ÄÇÂÜÖÂÆπ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ', false);
                return;
            }
            
            try {
                const response = await fetch('/prompts', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ type, template })
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Server error:', response.status, errorText);
                    showPromptMessage(type, `‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ„Çµ„Éº„Éê„Éº„Ç®„É©„Éº: ${response.status}`, false);
                    return;
                }
                
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const responseText = await response.text();
                    console.error('Invalid response format:', responseText);
                    showPromptMessage(type, '„Çµ„Éº„Éê„Éº„Åã„Çâ„ÅÆÂøúÁ≠î„ÅåÊ≠£„Åó„Åè„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ', false);
                    return;
                }
                
                const data = await response.json();
                
                if (data.success) {
                    showPromptMessage(type, `${type === 'summary' ? 'Ë¶ÅÁ¥Ñ' : 'Ëß£Ë™¨Ë®ò‰∫ã'}„Éó„É≠„É≥„Éó„Éà„Çí‰øùÂ≠ò„Åó„Åæ„Åó„ÅüÔºÅ`, true);
                } else {
                    showPromptMessage(type, '‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + data.error, false);
                }
            } catch (error) {
                console.error('Error saving prompt:', error);
                showPromptMessage(type, '‰øùÂ≠ò‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: ' + error.message, false);
            }
        }

        function showMessage(message, type = 'info', duration = 3000) {
            const container = document.getElementById('messageContainer');
            const messageElement = document.createElement('div');
            messageElement.className = `message-item message-${type}`;
            messageElement.textContent = message;
            
            container.appendChild(messageElement);
            
            // ÊåáÂÆöÊôÇÈñìÂæå„Å´Ëá™ÂãïÁöÑ„Å´ÂâäÈô§
            setTimeout(() => {
                if (messageElement.parentNode) {
                    messageElement.parentNode.removeChild(messageElement);
                }
            }, duration);
        }
        
        function showPromptMessage(type, message, isSuccess = true) {
            const messageElement = document.getElementById(type + 'PromptMessage');
            messageElement.textContent = message;
            messageElement.style.display = 'block';
            
            if (isSuccess) {
                messageElement.style.background = '#d4edda';
                messageElement.style.color = '#155724';
                messageElement.style.border = '1px solid #c3e6cb';
            } else {
                messageElement.style.background = '#f8d7da';
                messageElement.style.color = '#721c24';
                messageElement.style.border = '1px solid #f5c6cb';
            }
            
            // 3ÁßíÂæå„Å´Ëá™ÂãïÁöÑ„Å´ÈùûË°®Á§∫
            setTimeout(() => {
                messageElement.style.display = 'none';
            }, 3000);
        }

        async function resetPrompt(type) {
            const textareaId = type + 'PromptText';
            const textarea = document.getElementById(textareaId);
            
            // „Éá„Éï„Ç©„É´„Éà„Éó„É≠„É≥„Éó„Éà„ÇíË®≠ÂÆö
            textarea.value = getDefaultPromptTemplate(type);
            
            showPromptMessage(type, '„Éá„Éï„Ç©„É´„Éà„Éó„É≠„É≥„Éó„Éà„Å´Êàª„Åó„Åæ„Åó„Åü', true);
        }

        // „Éö„Éº„Ç∏Ë™≠„ÅøËæº„ÅøÊôÇ„Å´„Éó„É≠„É≥„Éó„Éà„ÇíË™≠„ÅøËæº„Åø
        window.addEventListener('load', () => {
            loadPrompts();
            loadSuggestedQuestions(); // „Éö„Éº„Ç∏Ë™≠„ÅøËæº„ÅøÊôÇ„Å´„ÇÇË≥™Âïè„ÇíË™≠„ÅøËæº„Åø
            ensureChatInputVisible(); // „Éö„Éº„Ç∏Ë™≠„ÅøËæº„ÅøÂæå„Å´ÂÖ•ÂäõÊ¨Ñ„ÅÆÂèØË¶ñÊÄß„ÇíÁ¢∫‰øù
            
            // Ëß£ÊûêÈñãÂßã„Éú„Çø„É≥„ÅÆ„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÇíË®≠ÂÆö
            const uploadBtn = document.getElementById('uploadBtn');
            if (uploadBtn) {
                uploadBtn.addEventListener('click', () => {
                    uploadYouTube(false);
                });
            }
            
            // URLÂÖ•Âäõ„Éï„Ç£„Éº„É´„Éâ„ÅÆ„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÇíË®≠ÂÆö
            const youtubeUrl = document.getElementById('youtubeUrl');
            if (youtubeUrl) {
                youtubeUrl.addEventListener('input', checkForExistingContent);
            }
            
            // Ë®ÄË™ûÈÅ∏Êäû„ÅÆ„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÇíË®≠ÂÆö
            const languageSelect = document.getElementById('languageSelect');
            if (languageSelect) {
                languageSelect.addEventListener('change', checkForExistingContent);
            }
            
            // GPT„É¢„Éá„É´ÈÅ∏Êäû„ÅÆ„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÇíË®≠ÂÆö
            const gptModelSelect = document.getElementById('gptModelSelect');
            if (gptModelSelect) {
                gptModelSelect.addEventListener('change', checkForExistingContent);
            }
        });
        
        // Ë®ò‰∫ãÂ±•Ê≠¥ÁÆ°ÁêÜÊ©üËÉΩ
        // currentVideoId „ÅØÊó¢„Å´‰∏äÈÉ®„ÅßÂÆ£Ë®ÄÊ∏à„Åø
        
        function toggleArticleHistory() {
            const panel = document.getElementById('articleHistoryPanel');
            const btn = document.getElementById('toggleArticleHistoryBtn');
            
            if (panel.style.display === 'none') {
                panel.style.display = 'block';
                btn.textContent = 'üìú Â±•Ê≠¥ÈùûË°®Á§∫';
                loadArticleHistory();
            } else {
                panel.style.display = 'none';
                btn.textContent = 'üìú Â±•Ê≠¥Ë°®Á§∫';
            }
        }
        
        async function loadArticleHistory() {
            const historyList = document.getElementById('articleHistoryList');
            
            if (!currentVideoId) {
                historyList.innerHTML = '<p style="color: #718096; text-align: center; padding: 1rem;">ÂãïÁîª„ÅåË™≠„ÅøËæº„Åæ„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì</p>';
                return;
            }
            
            try {
                const response = await fetch(`/article-history/${currentVideoId}`);
                const result = await response.json();
                
                if (result.success && result.history.length > 0) {
                    historyList.innerHTML = result.history.map((item, index) => {
                        const date = new Date(item.timestamp);
                        const dateStr = date.toLocaleString('ja-JP');
                        const typeIcon = item.type === 'generated' ? 'üÜï' : 'üîÑ';
                        const typeText = item.type === 'generated' ? 'ÁîüÊàê' : '„Éû„Éº„Ç∏';
                        
                        return `
                            <div style="border: 1px solid #e2e8f0; border-radius: 6px; padding: 0.75rem; margin-bottom: 0.5rem; background: white; cursor: pointer; transition: all 0.2s ease;" 
                                 onclick="loadHistoryArticle('${item.id}')" 
                                 onmouseover="this.style.background='#f7fafc'" 
                                 onmouseout="this.style.background='white'">
                                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.5rem;">
                                    <span style="font-weight: 600; color: #2d3748;">${typeIcon} ${typeText}Áâà #${result.history.length - index}</span>
                                    <span style="font-size: 0.8rem; color: #718096;">${dateStr}</span>
                                </div>
                                <div style="font-size: 0.9rem; color: #4a5568; line-height: 1.4; max-height: 60px; overflow: hidden; text-overflow: ellipsis;">
                                    ${item.article.substring(0, 100)}...
                                </div>
                            </div>
                        `;
                    }).join('');
                } else {
                    historyList.innerHTML = '<p style="color: #718096; text-align: center; padding: 1rem;">Ë®ò‰∫ãÂ±•Ê≠¥„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>';
                }
            } catch (error) {
                console.error('Failed to load article history:', error);
                historyList.innerHTML = '<p style="color: #e53e3e; text-align: center; padding: 1rem;">Â±•Ê≠¥„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü</p>';
            }
        }
        
        async function loadHistoryArticle(historyId) {
            try {
                const response = await fetch(`/article-history/${currentVideoId}`);
                const result = await response.json();
                
                if (result.success) {
                    const historyItem = result.history.find(item => item.id === historyId);
                    if (historyItem) {
                        const articleDiv = document.getElementById('articleContent');
                        
                        // Ë®ò‰∫ã„ÇíË°®Á§∫
                        if (typeof marked !== 'undefined') {
                            articleDiv.innerHTML = marked.parse(historyItem.article);
                        } else {
                            articleDiv.innerHTML = historyItem.article.replace(/\n/g, '<br>');
                        }
                        
                        // „Çø„Ç§„É†„Çπ„Çø„É≥„Éó„É™„É≥„ÇØ„ÇíÂá¶ÁêÜ
                        processTimestampLinks(articleDiv);
                        
                        // Â±•Ê≠¥„Éë„Éç„É´„ÇíÈñâ„Åò„Çã
                        toggleArticleHistory();
                        
                        // ÊàêÂäü„É°„ÉÉ„Çª„Éº„Ç∏
                        const typeText = historyItem.type === 'generated' ? 'ÁîüÊàê' : '„Éû„Éº„Ç∏';
                        const date = new Date(historyItem.timestamp).toLocaleString('ja-JP');
                        showMessage(`üìú ${typeText}ÁâàË®ò‰∫ã„ÇíË™≠„ÅøËæº„Åø„Åæ„Åó„ÅüÔºà${date}Ôºâ`, 'success');
                    }
                }
            } catch (error) {
                console.error('Failed to load history article:', error);
                showMessage('Â±•Ê≠¥Ë®ò‰∫ã„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
            }
        }
        
        // ÂãïÁîªË™≠„ÅøËæº„ÅøÊôÇ„Å´videoId„ÇíË®≠ÂÆö
        function setCurrentVideoId(videoId) {
            currentVideoId = videoId;
        }
        
    </script>
</body>
</html>