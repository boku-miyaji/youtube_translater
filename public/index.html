<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube ÊñáÂ≠óËµ∑„Åì„Åó & „ÉÅ„É£„ÉÉ„Éà</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://www.youtube.com/iframe_api"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            font-size: 16px;
            line-height: 1.6;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem;
            height: 100vh;
            overflow: hidden;
        }
        .app-header {
            text-align: center;
            padding: 1rem 0;
            color: white;
            margin-bottom: 1rem;
        }
        .app-header h1 {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        .app-header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        .section {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
        }
        .section h2 {
            margin: 0 0 1rem 0;
            color: #2d3748;
            font-size: 1.3rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .section-icon {
            width: 24px;
            height: 24px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.8rem;
        }
        input, textarea, select {
            width: 100%;
            padding: 0.75rem 1rem;
            margin: 0.5rem 0;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 1rem;
            background: #f8fafc;
            transition: all 0.3s ease;
            font-family: inherit;
        }
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #667eea;
            background: white;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        button {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin: 0.5rem 0;
            font-family: inherit;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }
        button:active {
            transform: translateY(0);
        }
        button:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .transcript {
            background: #f9f9f9;
            border-left: 4px solid #007cba;
            padding: 15px;
            margin: 10px 0;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .chat-messages {
            height: 100%;
            overflow-y: auto;
            background: transparent;
            scrollbar-width: thin;
            scrollbar-color: #cbd5e0 transparent;
        }
        .chat-messages::-webkit-scrollbar {
            width: 6px;
        }
        .chat-messages::-webkit-scrollbar-track {
            background: transparent;
        }
        .chat-messages::-webkit-scrollbar-thumb {
            background: #cbd5e0;
            border-radius: 3px;
        }
        .message {
            margin-bottom: 0.75rem;
            padding: 0.75rem;
            border-radius: 12px;
            max-width: 90%;
            animation: fadeIn 0.3s ease;
            font-size: 0.9rem;
            line-height: 1.4;
        }
        .user-message {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            margin-left: auto;
            text-align: right;
        }
        .ai-message {
            background: linear-gradient(135deg, #f1f5f9, #e2e8f0);
            color: #2d3748;
            margin-right: auto;
            white-space: normal;
            word-wrap: break-word;
            line-height: 1.6;
        }
        
        /* AI„É°„ÉÉ„Çª„Éº„Ç∏ÂÜÖ„ÅÆMarkdownË¶ÅÁ¥†„ÅÆ„Çπ„Çø„Ç§„É´ */
        .ai-message h1, .ai-message h2, .ai-message h3, .ai-message h4, .ai-message h5, .ai-message h6 {
            margin: 0.5rem 0;
            color: #1a202c;
        }
        .ai-message p {
            margin: 0.5rem 0;
        }
        .ai-message ul, .ai-message ol {
            margin: 0.5rem 0;
            padding-left: 1.5rem;
        }
        .ai-message li {
            margin: 0.25rem 0;
        }
        .ai-message code {
            background: rgba(102, 126, 234, 0.1);
            padding: 2px 4px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
        }
        .ai-message pre {
            background: #f8fafc;
            padding: 0.75rem;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
            overflow-x: auto;
            margin: 0.5rem 0;
        }
        .ai-message pre code {
            background: none;
            padding: 0;
        }
        .ai-message blockquote {
            border-left: 4px solid #667eea;
            padding-left: 1rem;
            margin: 0.5rem 0;
            color: #4a5568;
            font-style: italic;
        }
        .ai-message strong {
            font-weight: 600;
            color: #2d3748;
        }
        .ai-message em {
            font-style: italic;
            color: #4a5568;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .loading {
            text-align: center;
            color: #666;
            font-style: italic;
        }
        .error {
            color: #dc3545;
            background: #f8d7da;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .success {
            color: #155724;
            background: #d4edda;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .costs-display {
            background: linear-gradient(135deg, #f7fafc, #edf2f7);
            padding: 1.5rem;
            border-radius: 16px;
            border: 2px solid #e2e8f0;
            backdrop-filter: blur(10px);
        }
        .video-player-container {
            margin-bottom: 1rem;
            border-radius: 12px;
            overflow: hidden;
            background: #000;
            position: relative;
            padding-bottom: 56.25%; /* 16:9„ÅÆÊ®ôÊ∫ñÊØîÁéá */
            height: 0;
            width: 100%;
            transition: all 0.3s ease;
        }
        
        .video-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            border: 1px solid #dee2e6;
            overflow: visible; /* „ÅØ„ÅøÂá∫„Åó„ÇíË®±ÂèØ */
            position: relative;
        }
        .video-player-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: none;
        }
        .timestamp-link {
            color: #667eea;
            cursor: pointer;
            text-decoration: underline;
            font-weight: 600;
            padding: 2px 4px;
            border-radius: 4px;
            transition: all 0.3s ease;
        }
        .timestamp-link:hover {
            background: rgba(102, 126, 234, 0.1);
            transform: scale(1.05);
        }
        .timestamp-segment {
            margin: 0 !important;
            padding: 0 !important;
            transition: all 0.3s ease;
            display: block;
            line-height: 1;
        }
        .timestamp-row {
            display: flex;
            align-items: center;
            padding: 2px 4px !important;
            border-radius: 3px;
            transition: all 0.3s ease;
            height: 18px !important;
            min-height: 18px !important;
            max-height: 18px !important;
            overflow: hidden;
            margin: 0;
        }
        .timestamp-row:hover {
            background: rgba(102, 126, 234, 0.08);
        }
        .timestamp-segment.current-segment .timestamp-row {
            background: rgba(102, 126, 234, 0.2);
            border-left: 2px solid #667eea;
            padding-left: 6px !important;
        }
        .timestamp-time {
            min-width: 45px;
            width: 45px;
            font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
            font-size: 0.7rem;
            color: #667eea;
            font-weight: 600;
            cursor: pointer;
            margin-right: 6px;
            text-align: right;
            padding: 0;
            border-radius: 2px;
            transition: all 0.3s ease;
            flex-shrink: 0;
            line-height: 1;
        }
        .timestamp-time:hover {
            background: rgba(102, 126, 234, 0.1);
            transform: scale(1.05);
        }
        .timestamp-text {
            flex: 1;
            line-height: 1 !important;
            color: #2d3748;
            font-size: 0.8rem;
            margin: 0;
            padding: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .timestamp-transcript {
            font-family: inherit;
            line-height: 1 !important;
            padding: 0 !important;
            margin: 0 !important;
        }
        .ai-message {
            background: linear-gradient(135deg, #f1f5f9, #e2e8f0);
            color: #2d3748;
            margin-right: auto;
        }
        .ai-message .timestamp-link {
            background: rgba(102, 126, 234, 0.15);
            color: #667eea;
            padding: 2px 6px;
            border-radius: 4px;
            margin: 0 2px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 500;
            text-decoration: none;
            border: 1px solid rgba(102, 126, 234, 0.2);
        }
        .ai-message .timestamp-link:hover {
            background: rgba(102, 126, 234, 0.25);
            color: #5a67d8;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(102, 126, 234, 0.2);
        }
        .cost-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-family: monospace;
        }
        .total-cost {
            border-top: 2px solid #007cba;
            padding-top: 8px;
            font-weight: bold;
            font-size: 1.1em;
        }
        .costs-tabs {
            display: flex;
            background: #f8fafc;
            border-radius: 8px;
            padding: 2px;
            margin-bottom: 1rem;
        }
        .costs-tab-button {
            flex: 1;
            padding: 0.5rem;
            background: transparent;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.85rem;
            font-weight: 600;
        }
        .costs-tab-button.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }
        .costs-tab-button:not(.active) {
            color: #718096;
            opacity: 0.7;
        }
        .costs-tab-button:not(.active):hover {
            background: #e2e8f0;
            opacity: 1;
        }
        .costs-tab-content {
            display: none;
        }
        .costs-tab-content.active {
            display: block;
        }
        .costs-filter {
            margin-bottom: 1rem;
        }
        .costs-filter select {
            width: 100%;
            padding: 0.5rem;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
        }
        .costs-analysis-summary {
            background: #f8fafc;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }
        .costs-chart {
            background: white;
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            margin-bottom: 1rem;
        }
        .history-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
            background: #fafafa;
        }
        .history-item {
            background: linear-gradient(135deg, #f8fafc, #e2e8f0);
            border: 1px solid rgba(255,255,255,0.5);
            border-radius: 16px;
            padding: 1rem;
            margin-bottom: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }
        .history-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            background: linear-gradient(135deg, #ffffff, #f1f5f9);
        }
        .history-title {
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }
        .history-meta {
            font-size: 0.9em;
            color: #666;
            display: flex;
            justify-content: space-between;
        }
        .history-channel {
            font-size: 0.9em;
            color: #666;
            margin: 3px 0;
        }
        .history-url {
            font-size: 0.85em;
            margin: 3px 0;
        }
        .history-url a {
            color: #007cba;
            text-decoration: none;
        }
        .history-url a:hover {
            text-decoration: underline;
        }
        
        /* Â±•Ê≠¥„Çø„Éñ„Å®„Éï„Ç£„É´„Çø„Éº */
        .history-controls {
            margin-bottom: 1rem;
        }
        
        .history-tabs {
            display: flex;
            background: #f8fafc;
            border-radius: 8px;
            padding: 2px;
            margin-bottom: 1rem;
        }
        
        .history-tab-button {
            flex: 1;
            padding: 0.5rem;
            background: transparent;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        .history-tab-button.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }
        
        .history-tab-button:not(.active) {
            color: #718096;
            opacity: 0.7;
        }
        
        .history-tab-button:not(.active):hover {
            background: #e2e8f0;
            opacity: 1;
        }
        
        /* „Çø„Ç∞Ë°®Á§∫ */
        .video-tags {
            margin: 0.5rem 0;
            display: flex;
            flex-wrap: wrap;
            gap: 0.25rem;
        }
        
        .tag-item {
            background: linear-gradient(135deg, #ebf8ff, #e6fffa);
            color: #2d3748;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.75rem;
            border: 1px solid #bee3f8;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .tag-item:hover {
            background: linear-gradient(135deg, #bee3f8, #81e6d9);
            transform: translateY(-1px);
        }
        
        .suggestion-tag {
            background: #f7fafc;
            color: #4a5568;
            padding: 0.25rem 0.5rem;
            border-radius: 8px;
            font-size: 0.75rem;
            cursor: pointer;
            margin: 0.125rem;
            display: inline-block;
            transition: all 0.3s ease;
        }
        
        .suggestion-tag:hover {
            background: #667eea;
            color: white;
        }
        
        /* „Éï„Ç©„É´„ÉÄ„Çµ„Ç∏„Çß„Çπ„ÉÅ„Éß„É≥ */
        .folder-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            z-index: 1000;
        }
        
        .folder-suggestion-item {
            padding: 0.75rem 1rem;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .folder-suggestion-item:last-child {
            border-bottom: none;
        }
        
        .folder-suggestion-item:hover {
            background: linear-gradient(135deg, #ebf8ff, #e6fffa);
            color: #2d3748;
        }
        
        .folder-suggestion-item .folder-icon {
            color: #667eea;
            font-size: 1rem;
        }
        
        .folder-suggestion-item .folder-name {
            font-weight: 600;
            flex: 1;
        }
        
        .folder-suggestion-item .folder-count {
            font-size: 0.8rem;
            color: #666;
            background: #f1f5f9;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
        }
        
        /* „Ç∞„É´„Éº„ÉóÂåñ„Åï„Çå„ÅüÂ±•Ê≠¥ */
        .history-group {
            margin-bottom: 1.5rem;
        }
        
        .history-group-header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 0.75rem 1rem;
            border-radius: 12px 12px 0 0;
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .history-group-items {
            background: #f8fafc;
            border-radius: 0 0 12px 12px;
            padding: 0.5rem;
        }
        
        .history-group-items .history-item {
            margin-bottom: 0.5rem;
            font-size: 0.85rem;
        }
        
        /* ÈÅ∏Êäû„Åï„Çå„Åü„É°„Ç§„É≥„Çø„Ç∞ */
        .selected-tag {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 0.5rem 0.75rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .selected-tag:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        
        .selected-tag .remove-tag {
            cursor: pointer;
            font-weight: bold;
            padding: 0.125rem 0.25rem;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }
        
        .selected-tag .remove-tag:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        /* „Ç¢„Ç≥„Éº„Éá„Ç£„Ç™„É≥Ê©üËÉΩ */
        .history-group-header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 0.75rem 1rem;
            border-radius: 12px;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .history-group-header:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        
        .history-group-header .toggle-icon {
            font-size: 0.8rem;
            transition: transform 0.3s ease;
        }
        
        .history-group.collapsed .toggle-icon {
            transform: rotate(-90deg);
        }
        
        .history-group-items {
            background: #f8fafc;
            border-radius: 0 0 12px 12px;
            padding: 0.5rem;
            transition: all 0.3s ease;
            overflow: hidden;
        }
        
        .history-group.collapsed .history-group-items {
            display: none;
        }
        .method-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .method-subtitle {
            background: linear-gradient(135deg, #48bb78, #38a169);
            color: white;
        }
        .method-whisper {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }
        .language-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            background: linear-gradient(135deg, #a0aec0, #718096);
            color: white;
            margin-left: 0.5rem;
        }
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }
        .info-item {
            background: white;
            padding: 8px 12px;
            border-radius: 4px;
            border: 1px solid #e9ecef;
        }
        .chapters-info {
            margin-top: 15px;
            padding: 10px;
            background: white;
            border-radius: 4px;
            border: 1px solid #e9ecef;
        }
        .chapter-item {
            padding: 5px 0;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
        }
        .chapter-item:hover {
            background: #f8f9fa;
        }
        .chapter-timestamp {
            font-weight: bold;
            color: #007cba;
            margin-right: 10px;
        }
        .summary {
            background: linear-gradient(135deg, #f0fff4, #ffffff);
            border-left: 4px solid #48bb78;
            border-radius: 16px;
            padding: 1.5rem;
            margin: 1rem 0;
            max-height: 500px;
            overflow-y: auto;
            font-size: 1rem;
            line-height: 1.6;
            scrollbar-width: thin;
            scrollbar-color: #cbd5e0 transparent;
        }
        .summary::-webkit-scrollbar {
            width: 6px;
        }
        .summary::-webkit-scrollbar-track {
            background: transparent;
        }
        .summary::-webkit-scrollbar-thumb {
            background: #cbd5e0;
            border-radius: 3px;
        }
        .summary h2 {
            color: #28a745;
            margin-top: 20px;
            margin-bottom: 10px;
            font-size: 1.2em;
        }
        .summary h3 {
            color: #155724;
            margin-top: 15px;
            margin-bottom: 8px;
            font-size: 1.1em;
        }
        .summary ul {
            padding-left: 20px;
            margin: 10px 0;
        }
        .summary li {
            margin-bottom: 5px;
        }
        .summary p {
            margin: 10px 0;
        }
        .summary code {
            background: #e9ecef;
            padding: 2px 4px;
            border-radius: 3px;
            font-family: monospace;
        }
        .suggested-questions {
            margin-bottom: 0.3rem;
            padding: 0.3rem;
            background: linear-gradient(135deg, #ebf8ff, #e6fffa);
            border-radius: 8px;
            border: 1px solid #bee3f8;
            max-height: 80px;
            overflow-y: auto;
            flex-shrink: 0;
        }
        .question-item {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 0.2rem 0.4rem;
            margin: 0.1rem 0;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.75rem;
            line-height: 1.2;
        }
        .question-item:hover {
            background: linear-gradient(135deg, #f7fafc, #edf2f7);
            border-color: #667eea;
            transform: translateX(4px);
        }
        .transcript {
            background: linear-gradient(135deg, #f8fafc, #ffffff);
            border-left: 4px solid #667eea;
            border-radius: 16px;
            padding: 1.5rem;
            margin: 1rem 0;
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 500px;
            overflow-y: auto;
            font-size: 1rem;
            line-height: 1.8;
        }
        
        /* Ë®ò‰∫ã„Ç≥„É≥„ÉÜ„É≥„ÉÑ„ÅÆ„Çπ„Çø„Ç§„É´ */
        .article-content h1 {
            font-size: 2rem;
            font-weight: 700;
            color: #1a202c;
            margin: 2rem 0 1.5rem 0;
            padding-bottom: 0.75rem;
            border-bottom: 3px solid #667eea;
        }
        
        .article-content h2 {
            font-size: 1.5rem;
            font-weight: 600;
            color: #2d3748;
            margin: 2rem 0 1rem 0;
            padding: 0.75rem 0;
            border-bottom: 2px solid #e2e8f0;
            position: relative;
        }
        
        .article-content h2::before {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 60px;
            height: 2px;
            background: #667eea;
        }
        
        .article-content h3 {
            font-size: 1.25rem;
            font-weight: 600;
            color: #4a5568;
            margin: 1.5rem 0 0.75rem 0;
            padding-left: 1rem;
            border-left: 4px solid #667eea;
            background: linear-gradient(135deg, #f7fafc, #edf2f7);
            padding: 0.5rem 1rem;
            border-radius: 0 8px 8px 0;
        }
        
        .article-content p {
            margin: 1rem 0;
            color: #4a5568;
            line-height: 1.8;
        }
        
        .article-content ul, .article-content ol {
            margin: 1rem 0;
            padding-left: 1.5rem;
        }
        
        .article-content li {
            margin: 0.5rem 0;
            color: #4a5568;
            line-height: 1.6;
        }
        
        .article-content strong {
            color: #2d3748;
            font-weight: 600;
        }
        
        .article-content code {
            background: #f7fafc;
            color: #667eea;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }
        
        .article-content blockquote {
            border-left: 4px solid #667eea;
            background: linear-gradient(135deg, #f0f4ff, #e0e7ff);
            padding: 1rem 1.5rem;
            margin: 1.5rem 0;
            border-radius: 0 8px 8px 0;
            font-style: italic;
            color: #4c1d95;
        }
            font-family: 'Hiragino Sans', 'Yu Gothic', sans-serif;
            scrollbar-width: thin;
            scrollbar-color: #cbd5e0 transparent;
        }
        .transcript::-webkit-scrollbar {
            width: 6px;
        }
        .transcript::-webkit-scrollbar-track {
            background: transparent;
        }
        .transcript::-webkit-scrollbar-thumb {
            background: #cbd5e0;
            border-radius: 3px;
        }
        .input-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 15px;
        }
        .controls-row {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
        }
        .language-selector,
        .model-selector {
            background: #f8fafc;
            padding: 1rem;
            border-radius: 12px;
            border: 2px solid #e2e8f0;
        }
        .language-selector label,
        .model-selector label {
            font-weight: 600;
            color: #2d3748;
            display: block;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }
        .language-selector select,
        .model-selector select {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            background: white;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .language-selector select:focus,
        .model-selector select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        .chat-input-container {
            display: flex;
            gap: 0.75rem;
            align-items: flex-end;
        }
        .chat-input-container input,
        .chat-input-container textarea {
            flex: 1;
            margin: 0;
            padding: 0.75rem;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            font-family: inherit;
            line-height: 1.4;
        }
        .chat-input-container button {
            width: auto;
            min-width: 80px;
            margin: 0;
        }
        
        /* Responsive Design */
        @media (min-width: 768px) {
            .container {
                padding: 2rem;
            }
            .controls-row {
                grid-template-columns: 1fr 1fr;
            }
            .app-header h1 {
                font-size: 3rem;
            }
            .section {
                padding: 2rem;
            }
        }
        @media (min-width: 1024px) {
            .controls-row {
                grid-template-columns: 1fr 1fr;
                gap: 2rem;
            }
        }
        
        /* Êñ∞„Åó„ÅÑ„É¨„Ç§„Ç¢„Ç¶„ÉàÁî®CSS */
        .main-content {
            display: flex;
            gap: 0;
            max-width: 100vw;
            margin: 0 auto;
            padding: 1rem;
            height: calc(100vh - 200px);
        }
        
        .left-panel {
            height: 100%;
            overflow-y: auto;
            width: 350px;
            transition: width 0.3s ease;
            flex-shrink: 0;
        }
        
        .left-panel .section {
            overflow-y: auto;
            position: relative;
            transition: all 0.3s ease;
            max-height: calc(100vh - 280px);
        }
        
        /* „É¨„Çµ„Ç§„Ç∂„Éº */
        .resize-handle {
            position: relative;
            width: 16px;
            height: 100%;
            cursor: col-resize;
            background: #667eea;
            border-radius: 4px;
            opacity: 0.7;
            transition: all 0.3s ease;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 4px;
            flex-shrink: 0;
        }
        
        .resize-handle:hover {
            background: #764ba2;
            opacity: 1;
        }
        
        .resize-handle::before {
            content: '‚ãÆ‚ãÆ';
            color: white;
            font-size: 14px;
            line-height: 1;
            transform: rotate(90deg);
        }
        
        .right-panel {
            flex: 1;
            height: 100%;
            display: flex;
            flex-direction: column;
            min-width: 400px;
        }
        
        .content-tabs {
            display: flex;
            background: #f8fafc;
            border-radius: 12px;
            padding: 4px;
            margin-bottom: 1rem;
        }
        
        .tab-button {
            flex: 1;
            padding: 1rem;
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            font-size: 0.85rem;
            text-align: center;
            line-height: 1.2;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.25rem;
            min-height: 60px;
            color: #4a5568;
        }
        
        .tab-button.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
            border-color: #667eea;
        }
        
        .tab-button:not(.active):hover {
            background: #e2e8f0;
            border-color: #cbd5e0;
            transform: translateY(-1px);
        }
        
        .tab-content {
            display: none;
            height: 500px;
            overflow-y: auto;
            background: white;
            border-radius: 12px;
            padding: 0.5rem;
            border: 2px solid #e2e8f0;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .chat-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: white;
            border-radius: 12px;
            border: 2px solid #e2e8f0;
            margin-top: 1rem;
            min-height: 500px;
            max-height: 600px;
            height: auto;
            overflow: hidden;
            position: relative;
        }
        
        .chat-header {
            padding: 1rem;
            border-bottom: 1px solid #e2e8f0;
            background: linear-gradient(135deg, #f8fafc, #ffffff);
            border-radius: 10px 10px 0 0;
            flex-shrink: 0;
        }
        
        .chat-messages-panel {
            flex: 1;
            padding: 1rem;
            padding-bottom: 100px;
            overflow-y: auto;
            min-height: 300px;
            max-height: 420px;
        }
        
        .chat-input-panel {
            padding: 1rem;
            border-top: 1px solid #e2e8f0;
            background: #f8fafc;
            border-radius: 0 0 10px 10px;
            flex-shrink: 0 !important;
            min-height: 80px !important;
            height: auto !important;
            position: absolute !important;
            bottom: 0 !important;
            left: 0 !important;
            right: 0 !important;
            z-index: 100 !important;
            display: flex !important;
            visibility: visible !important;
        }
        
        .chat-input-container {
            display: flex !important;
            gap: 0.75rem;
            align-items: center;
            width: 100% !important;
        }
        
        .chat-input-container input,
        .chat-input-container textarea {
            flex: 1;
            margin: 0;
            display: block !important;
            visibility: visible !important;
            width: auto !important;
            min-width: 200px;
        }
        
        .chat-input-container button {
            width: auto;
            min-width: 80px;
            margin: 0;
            display: block !important;
            visibility: visible !important;
        }
        
        /* Mobile-first improvements */
        @media (max-width: 1200px) {
            .main-content {
                flex-direction: column;
                gap: 1rem;
                height: auto;
            }
            
            .left-panel {
                width: 100%;
                height: auto;
                max-height: 400px;
            }
            
            .right-panel {
                position: static;
                height: auto;
                min-height: 600px;
            }
            
            .chat-panel {
                min-height: 400px;
                max-height: 550px;
            }
            
            .chat-messages-panel {
                min-height: 200px;
                max-height: 320px;
            }
        }
        
        @media (max-width: 767px) {
            .app-header h1 {
                font-size: 2rem;
            }
            .section {
                padding: 1rem;
                margin-bottom: 1rem;
            }
            .message {
                max-width: 95%;
            }
            .main-content {
                padding: 0.5rem;
            }
            
            .chat-input-container {
                gap: 0.5rem;
            }
            
            .chat-input-container input,
            .chat-input-container textarea {
                font-size: 16px; /* iOS„Åß„Ç∫„Éº„É†„Ç§„É≥„ÇíÈò≤„Åê */
            }
        }
        
        /* Ë®ò‰∫ã„Éû„Éº„ÇØ„ÉÄ„Ç¶„É≥Áî®„Çπ„Çø„Ç§„É´ */
        .article-markdown {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.7;
        }
        
        .article-markdown h1 {
            color: #1a202c;
            font-size: 1.75rem;
            font-weight: 700;
            margin: 0 0 1rem 0;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 0.5rem;
        }
        
        .article-markdown h2 {
            color: #2d3748;
            font-size: 1.4rem;
            font-weight: 600;
            margin: 1.5rem 0 1rem 0;
        }
        
        .article-markdown h3 {
            color: #4a5568;
            font-size: 1.2rem;
            font-weight: 600;
            margin: 1.25rem 0 0.75rem 0;
        }
        
        .article-markdown p {
            margin: 0 0 1rem 0;
            color: #2d3748;
        }
        
        .article-markdown code {
            background: #f7fafc;
            color: #e53e3e;
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
            font-size: 0.9rem;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        }
        
        .article-markdown pre {
            background: #1a202c;
            color: #e2e8f0;
            padding: 1rem;
            border-radius: 8px;
            overflow-x: auto;
            margin: 1rem 0;
        }
        
        .article-markdown pre code {
            background: none;
            color: inherit;
            padding: 0;
        }
        
        .article-markdown ul, .article-markdown ol {
            margin: 0 0 1rem 0;
            padding-left: 1.5rem;
        }
        
        .article-markdown li {
            margin: 0.25rem 0;
        }
        
        .article-markdown blockquote {
            border-left: 4px solid #667eea;
            padding-left: 1rem;
            margin: 1rem 0;
            color: #4a5568;
            font-style: italic;
        }
        
        .article-markdown strong {
            font-weight: 600;
            color: #1a202c;
        }
        
        /* „Ç¢„Ç≥„Éº„Éá„Ç£„Ç™„É≥„Çπ„Çø„Ç§„É´ */
        .costs-accordion {
            margin: 1rem 0;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .accordion-header {
            background: #f8fafc;
            padding: 0.75rem 1rem;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
            color: #4a5568;
            transition: background-color 0.3s ease;
        }
        
        .accordion-header:hover {
            background: #e2e8f0;
        }
        
        .accordion-arrow {
            font-size: 0.8rem;
        }
        
        /* Ê±éÁî®„É°„ÉÉ„Çª„Éº„Ç∏Ë°®Á§∫ */
        .message-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            max-width: 400px;
        }
        
        .message-item {
            padding: 0.75rem 1rem;
            border-radius: 6px;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            animation: slideInRight 0.3s ease;
        }
        
        .message-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .message-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .message-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
            transition: transform 0.3s ease;
        }
        
        .accordion-arrow.expanded {
            transform: rotate(180deg);
        }
        
        .accordion-content {
            padding: 1rem;
            background: white;
            border-top: 1px solid #e2e8f0;
        }
        
    </style>
</head>
<body>
    <!-- Ê±éÁî®„É°„ÉÉ„Çª„Éº„Ç∏Ë°®Á§∫„Ç≥„É≥„ÉÜ„Éä -->
    <div id="messageContainer" class="message-container"></div>
    
    <div class="app-header">
        <h1>üé• YouTube AI Assistant</h1>
        <p>ÂãïÁîª„ÇíÊñáÂ≠óËµ∑„Åì„Åó„Åó„Å¶„ÄÅAI„Å®ÂØæË©±„Åó„Çà„ÅÜ</p>
    </div>
    
    <div class="section">
        <h2><span class="section-icon">üì•</span>YouTubeÂãïÁîª„Çí„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ</h2>
        <div class="input-group">
            <div class="main-tags-container">
                <label for="mainTags" style="font-weight: 600; color: #2d3748; display: block; margin-bottom: 0.5rem;">üè∑Ô∏è „É°„Ç§„É≥„Çø„Ç∞ („Ç´„É≥„ÉûÂå∫Âàá„Çä):</label>
                <input type="text" id="mainTags" placeholder="‰æã: ÂïÜË´á, „Éó„É≠„Ç∏„Çß„ÇØ„Éà, Â≠¶ÁøíË≥áÊñô" 
                       style="width: 100%; padding: 0.75rem; border-radius: 8px; border: 2px solid #e2e8f0; margin-bottom: 0.5rem;"
                       oninput="showMainTagSuggestions(this.value)" onfocus="showMainTagSuggestions(this.value)">
                <div class="main-tag-suggestions" id="mainTagSuggestions" style="display: none; position: relative; z-index: 100;">
                    <div class="suggestion-list" style="background: white; border: 1px solid #e2e8f0; border-radius: 8px; max-height: 150px; overflow-y: auto; box-shadow: 0 4px 12px rgba(0,0,0,0.15);"></div>
                </div>
                <div class="selected-main-tags" id="selectedMainTags" style="margin-top: 0.5rem; display: flex; flex-wrap: wrap; gap: 0.25rem;"></div>
            </div>
            <input type="text" id="youtubeUrl" list="urlHistory" placeholder="YouTube„ÅÆURL„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ">
            <datalist id="urlHistory">
                <!-- URL history will be populated dynamically -->
            </datalist>
            <div class="controls-row">
                <div class="language-selector">
                    <label for="languageSelect">ÊñáÂ≠óËµ∑„Åì„ÅóË®ÄË™û:</label>
                    <select id="languageSelect">
                        <option value="original" selected>Original (Ëá™ÂãïÂà§ÂÆö)</option>
                        <option value="ja">Êó•Êú¨Ë™û</option>
                        <option value="en">English</option>
                    </select>
                </div>
                <div class="model-selector">
                    <label for="gptModelSelect">GPT„É¢„Éá„É´:</label>
                    <select id="gptModelSelect">
                        <option value="gpt-4o-mini">GPT-4o-mini - $0.60/$2.40 per 1M tokens</option>
                        <option value="gpt-4o">GPT-4o (È´òÂìÅË≥™) - $5.00/$15.00 per 1M tokens</option>
                        <option value="gpt-4-turbo">GPT-4-turbo (ÊúÄÈ´òÂìÅË≥™) - $10.00/$30.00 per 1M tokens</option>
                        <option value="gpt-3.5-turbo">GPT-3.5-turbo (È´òÈÄü„Éª‰Ωé„Ç≥„Çπ„Éà) - $0.50/$1.50 per 1M tokens</option>
                        <option value="gpt-4.1-nano">GPT-4.1-nano (Ë∂ÖÈ´òÈÄü) - $0.10/$0.40 per 1M tokens</option>
                        <option value="gpt-4.1-mini" selected>GPT-4.1-mini (Êé®Â•®) - $0.40/$1.60 per 1M tokens</option>
                        <option value="gpt-4.1">GPT-4.1 (ÊúÄÊñ∞) - $2.00/$8.00 per 1M tokens</option>
                        <option value="gpt-o3">GPT-o3 (Êé®Ë´ñÂº∑Âåñ) - $2.00/$8.00 per 1M tokens</option>
                        <option value="gpt-4o-mini-new">GPT-4o-mini (Êñ∞) - $1.10/$4.40 per 1M tokens</option>
                    </select>
                </div>
            </div>
        </div>
        <button id="uploadBtn" onclick="uploadYouTube()">Ëß£ÊûêÈñãÂßã</button>
        <div id="uploadStatus"></div>
        
    </div>

    <div class="main-content">
        <div class="left-panel">
            <div class="section">
                <h2><span class="section-icon">üìä</span>ÂãïÁîªÊÉÖÂ†±</h2>
                <div id="videoInfo" class="video-info" style="display: none;">
                    <div class="video-player-container" id="videoPlayerContainer" style="display: none;">
                        <div id="youtubePlayer"></div>
                    </div>
                    <div class="info-grid" style="grid-template-columns: 1fr; gap: 5px; font-size: 0.85rem;">
                        <div class="info-item" style="padding: 5px 8px;">
                            <strong>„Çø„Ç§„Éà„É´:</strong> <span id="videoTitle">-</span>
                        </div>
                        <div class="info-item" style="padding: 5px 8px;">
                            <strong>„ÉÅ„É£„É≥„Éç„É´:</strong> <span id="videoChannel">-</span>
                        </div>
                        <div class="info-item" style="padding: 5px 8px;">
                            <strong>ÊôÇÈñì:</strong> <span id="videoDuration">-</span> | <strong>ÂÜçÁîüÂõûÊï∞:</strong> <span id="videoViews">-</span>
                        </div>
                        <div class="info-item" style="padding: 5px 8px;">
                            <strong>Âá¶ÁêÜÊñπÊ≥ï:</strong> <span id="processingMethod">-</span>
                        </div>
                    </div>
                    <div id="chaptersInfo" class="chapters-info" style="display: none;">
                        <h4>üìã „ÉÅ„É£„Éó„Çø„ÉºÊÉÖÂ†±</h4>
                        <div id="chaptersList"></div>
                    </div>
                </div>
            </div>

            <div class="section">
                <h2><span class="section-icon">üí∞</span>‰ΩøÁî®ÊñôÈáë</h2>
                
                <div class="costs-tabs">
                    <button class="costs-tab-button active" onclick="switchCostsTab('analysis')">ÂàÜÊûê</button>
                    <button class="costs-tab-button" onclick="switchCostsTab('graph')">„Ç∞„É©„Éï</button>
                </div>
                
                <div id="analysisCosts" class="costs-tab-content active">
                    <div class="costs-filter">
                        <select id="periodSelect" onchange="loadCostsAnalysis()" style="width: 100%; padding: 0.5rem; margin-bottom: 1rem; border-radius: 6px; border: 1px solid #e2e8f0;">
                            <option value="session" selected>„Çª„ÉÉ„Ç∑„Éß„É≥</option>
                            <option value="today">Êú¨Êó•</option>
                            <option value="week">ÈÄ±Èñì</option>
                            <option value="month">ÊúàÈñì</option>
                        </select>
                    </div>
                    <div id="costsAnalysisResult">
                        <!-- ÊñôÈáëÂàÜÊûêÊÉÖÂ†±„Åå„Åì„Åì„Å´Ë°®Á§∫„Åï„Çå„Åæ„Åô -->
                    </div>
                </div>
                
                <div id="graphCosts" class="costs-tab-content">
                    <div class="costs-filter">
                        <select id="graphPeriodSelect" onchange="loadCostsGraph()" style="width: 100%; padding: 0.5rem; margin-bottom: 1rem; border-radius: 6px; border: 1px solid #e2e8f0;">
                            <option value="today" selected>Êú¨Êó•</option>
                            <option value="week">ÈÄ±Èñì</option>
                            <option value="month">ÊúàÈñì</option>
                        </select>
                    </div>
                    <div id="costsGraphResult">
                        <canvas id="costsChart" width="300" height="200"></canvas>
                    </div>
                </div>
            </div>

<div class="section">
                <h2><span class="section-icon">üìö</span>Â±•Ê≠¥</h2>
                
                <div class="history-controls">
                    <div class="history-tabs">
                        <button class="history-tab-button active" onclick="switchHistoryTab('timeline')">ÊôÇÈñìËª∏</button>
                        <button class="history-tab-button" onclick="switchHistoryTab('channel')">„ÉÅ„É£„É≥„Éç„É´Âà•</button>
                        <button class="history-tab-button" onclick="switchHistoryTab('tag')">„Çø„Ç∞Âà•</button>
                    </div>
                    
                    <div class="history-filters">
                        <select id="historyFilter" onchange="filterHistory()" style="width: 100%; padding: 0.5rem; margin: 0.5rem 0; border-radius: 6px; border: 1px solid #e2e8f0;">
                            <option value="all">„Åô„Åπ„Å¶</option>
                            <option value="today">Êú¨Êó•</option>
                            <option value="week">ÈÅéÂéª7Êó•</option>
                            <option value="month">ÈÅéÂéª30Êó•</option>
                        </select>
                        
                        <input type="text" id="historySearch" placeholder="Ê§úÁ¥¢..." 
                               style="width: 100%; padding: 0.5rem; margin: 0.5rem 0; border-radius: 6px; border: 1px solid #e2e8f0;"
                               oninput="searchHistory()">
                    </div>
                </div>
                
                <div id="historyList" class="history-list">
                    Â±•Ê≠¥„ÇíË™≠„ÅøËæº„Åø‰∏≠...
                </div>
                <button onclick="loadHistory()" id="refreshHistoryBtn">Â±•Ê≠¥„ÇíÊõ¥Êñ∞</button>
            </div>
        </div>
        <div class="resize-handle" id="resizeHandle"></div>
        <div class="right-panel">
            <div class="content-tabs">
                <button class="tab-button active" onclick="switchTab('summary')">
                    <span style="font-size: 1.5rem;">üìù</span>
                    <span>Ë¶ÅÁ¥Ñ</span>
                </button>
                <button class="tab-button" onclick="switchTab('transcript')">
                    <span style="font-size: 1.5rem;">üìã</span>
                    <span>ÊñáÂ≠óËµ∑„Åì„Åó</span>
                </button>
                <button class="tab-button" onclick="switchTab('article')">
                    <span style="font-size: 1.5rem;">‚úçÔ∏è</span>
                    <span>Ëß£Ë™¨Ë®ò‰∫ã</span>
                </button>
            </div>
            
            <div id="summaryTab" class="tab-content active">
                <!-- „Éó„É≠„É≥„Éó„ÉàË®≠ÂÆö„Çª„ÇØ„Ç∑„Éß„É≥ -->
                <div class="prompt-settings" style="margin-bottom: 1rem;">
                    <div class="prompt-toggle" onclick="togglePromptSettings('summary')" style="cursor: pointer; padding: 0.75rem; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
                        <span style="font-weight: 600; color: #4a5568;">‚öôÔ∏è Ë¶ÅÁ¥Ñ„Éó„É≠„É≥„Éó„ÉàË®≠ÂÆö</span>
                        <span id="summaryPromptArrow" class="prompt-arrow">‚ñº</span>
                    </div>
                    <div id="summaryPromptSettings" class="prompt-content" style="display: none; margin-top: 0.5rem; padding: 1rem; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px;">
                        <div style="margin-bottom: 1rem;">
                            <label style="font-weight: 600; color: #4a5568; display: block; margin-bottom: 0.5rem;">„Ç´„Çπ„Çø„É†„Éó„É≠„É≥„Éó„Éà:</label>
                            <textarea id="summaryPromptText" rows="10" placeholder="„Éá„Éï„Ç©„É´„Éà„Éó„É≠„É≥„Éó„Éà„ÅåË°®Á§∫„Åï„Çå„Å¶„ÅÑ„Åæ„Åô„ÄÇÁ∑®ÈõÜ„Åó„Å¶‰øùÂ≠ò„Åß„Åç„Åæ„Åô„ÄÇ"
                                      style="width: 100%; font-family: monospace; font-size: 0.85rem; padding: 0.75rem; border: 1px solid #e2e8f0; border-radius: 6px; resize: vertical;"></textarea>
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <button onclick="savePrompt('summary')" style="margin-right: 0.5rem; padding: 0.5rem 1rem; background: #48bb78; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9rem;">üíæ ‰øùÂ≠ò</button>
                            <button onclick="resetPrompt('summary')" style="padding: 0.5rem 1rem; background: #f56565; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9rem;">üîÑ „Éá„Éï„Ç©„É´„Éà„Å´Êàª„Åô</button>
                        </div>
                        <div id="summaryPromptMessage" style="display: none; padding: 0.75rem; border-radius: 6px; font-size: 0.9rem; margin-bottom: 0.5rem;"></div>
                    </div>
                </div>
                
                <!-- Ë¶ÅÁ¥ÑÂÜçÁîüÊàê„Éú„Çø„É≥ -->
                <div id="summaryRegenerateSection" style="display: none; margin-bottom: 0.5rem; padding: 0.4rem 0.6rem; background: #fef5e7; border: 1px solid #f6ad55; border-radius: 6px;">
                    <button onclick="regenerateContent('summary')" id="regenerateSummaryOnlyBtn" 
                            style="background: #38a169; color: white; border: none; padding: 0.4rem 0.8rem; border-radius: 4px; cursor: pointer; font-weight: 500; font-size: 0.8rem; transition: all 0.3s ease;" 
                            onmouseover="this.style.background='#2f855a'" 
                            onmouseout="this.style.background='#38a169'">
                        üìã Ë¶ÅÁ¥Ñ„ÇíÂÜçËß£Êûê
                    </button>
                </div>
                
                <div id="summary" class="summary">
                    Ë¶ÅÁ¥Ñ„Åå„Åì„Åì„Å´Ë°®Á§∫„Åï„Çå„Åæ„Åô...
                </div>
            </div>
            
            <div id="articleTab" class="tab-content">
                <!-- „Éó„É≠„É≥„Éó„ÉàË®≠ÂÆö„Çª„ÇØ„Ç∑„Éß„É≥ -->
                <div class="prompt-settings" style="margin-bottom: 1rem;">
                    <div class="prompt-toggle" onclick="togglePromptSettings('article')" style="cursor: pointer; padding: 0.75rem; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
                        <span style="font-weight: 600; color: #4a5568;">‚öôÔ∏è Ëß£Ë™¨Ë®ò‰∫ã„Éó„É≠„É≥„Éó„ÉàË®≠ÂÆö</span>
                        <span id="articlePromptArrow" class="prompt-arrow">‚ñº</span>
                    </div>
                    <div id="articlePromptSettings" class="prompt-content" style="display: none; margin-top: 0.5rem; padding: 1rem; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px;">
                        <div style="margin-bottom: 1rem;">
                            <label style="font-weight: 600; color: #4a5568; display: block; margin-bottom: 0.5rem;">„Ç´„Çπ„Çø„É†„Éó„É≠„É≥„Éó„Éà:</label>
                            <textarea id="articlePromptText" rows="10" placeholder="„Éá„Éï„Ç©„É´„Éà„Éó„É≠„É≥„Éó„Éà„ÅåË°®Á§∫„Åï„Çå„Å¶„ÅÑ„Åæ„Åô„ÄÇÁ∑®ÈõÜ„Åó„Å¶‰øùÂ≠ò„Åß„Åç„Åæ„Åô„ÄÇ"
                                      style="width: 100%; font-family: monospace; font-size: 0.85rem; padding: 0.75rem; border: 1px solid #e2e8f0; border-radius: 6px; resize: vertical;"></textarea>
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <button onclick="savePrompt('article')" style="margin-right: 0.5rem; padding: 0.5rem 1rem; background: #48bb78; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9rem;">üíæ ‰øùÂ≠ò</button>
                            <button onclick="resetPrompt('article')" style="margin-right: 0.5rem; padding: 0.5rem 1rem; background: #f56565; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9rem;">üîÑ „É™„Çª„ÉÉ„Éà</button>
                        </div>
                        <div id="articlePromptMessage" style="display: none; padding: 0.75rem; border-radius: 6px; font-size: 0.9rem; margin-bottom: 0.5rem;"></div>
                    </div>
                </div>
                
                <div style="margin-bottom: 1rem;">
                    <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                        <label for="articleModelSelect" style="font-weight: 600; color: #4a5568;">Ë®ò‰∫ãÁîüÊàê„É¢„Éá„É´:</label>
                        <select id="articleModelSelect" style="padding: 0.5rem; border-radius: 6px; border: 1px solid #e2e8f0; font-size: 0.9rem;">
                            <option value="gpt-4o-mini">GPT-4o-mini - $0.60/$2.40</option>
                            <option value="gpt-4o">GPT-4o (È´òÂìÅË≥™) - $5.00/$15.00</option>
                            <option value="gpt-4-turbo">GPT-4-turbo (ÊúÄÈ´òÂìÅË≥™) - $10.00/$30.00</option>
                            <option value="gpt-3.5-turbo">GPT-3.5-turbo (È´òÈÄü„Éª‰Ωé„Ç≥„Çπ„Éà) - $0.50/$1.50</option>
                            <option value="gpt-4.1-nano">GPT-4.1-nano (Ë∂ÖÈ´òÈÄü) - $0.10/$0.40</option>
                            <option value="gpt-4.1-mini" selected>GPT-4.1-mini (Êé®Â•®) - $0.40/$1.60</option>
                            <option value="gpt-4.1">GPT-4.1 (ÊúÄÊñ∞) - $2.00/$8.00</option>
                            <option value="gpt-o3">GPT-o3 (Êé®Ë´ñÂº∑Âåñ) - $2.00/$8.00</option>
                            <option value="gpt-4o-mini-new">GPT-4o-mini (Êñ∞) - $1.10/$4.40</option>
                        </select>
                    </div>
                    <div style="display: flex; align-items: center; justify-content: space-between; gap: 1rem;">
                        <button id="generateArticleBtn" onclick="generateArticle()" style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s ease;">
                            üìù Ëß£Ë™¨Ë®ò‰∫ã„Çí‰ΩúÊàê
                        </button>
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <button id="toggleArticleHistoryBtn" onclick="toggleArticleHistory()" style="background: #f7fafc; color: #4a5568; border: 1px solid #e2e8f0; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.9rem; transition: all 0.3s ease;">
                                üìú Â±•Ê≠¥Ë°®Á§∫
                            </button>
                            <span id="articleStatus" style="color: #666;"></span>
                        </div>
                    </div>
                </div>
                
                <!-- Ë®ò‰∫ãÂ±•Ê≠¥„Éë„Éç„É´ -->
                <div id="articleHistoryPanel" style="display: none; margin-bottom: 1rem; padding: 1rem; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px;">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.75rem;">
                        <h4 style="margin: 0; color: #2d3748; font-size: 1rem;">üìú Ë®ò‰∫ãÂ±•Ê≠¥</h4>
                        <button onclick="toggleArticleHistory()" style="background: transparent; border: none; color: #718096; cursor: pointer; font-size: 1.2rem; padding: 0.25rem;">√ó</button>
                    </div>
                    <div id="articleHistoryList" style="max-height: 300px; overflow-y: auto;">
                        <p style="color: #718096; text-align: center; padding: 1rem;">Â±•Ê≠¥„ÇíË™≠„ÅøËæº„Åø‰∏≠...</p>
                    </div>
                </div>
                
                <!-- Á∑®ÈõÜ„ÉÑ„Éº„É´„Éê„Éº -->
                <div id="articleEditToolbar" style="display: none; margin-bottom: 1rem; padding: 0.75rem; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div style="display: flex; gap: 0.5rem;">
                            <button onclick="toggleArticleEdit()" style="background: #4a5568; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.9rem;">
                                ‚úèÔ∏è Á∑®ÈõÜ
                            </button>
                            <button onclick="saveArticleEdit()" id="saveArticleBtn" style="display: none; background: #38a169; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.9rem;">
                                üíæ ‰øùÂ≠ò
                            </button>
                            <button onclick="cancelArticleEdit()" id="cancelArticleBtn" style="display: none; background: #e53e3e; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.9rem;">
                                ‚ùå „Ç≠„É£„É≥„Çª„É´
                            </button>
                        </div>
                        <div id="editingStatus" style="color: #718096; font-size: 0.85rem;"></div>
                    </div>
                </div>
                
                <div id="articleContent" class="article-content" style="line-height: 1.8;">
                    <p style="color: #888; text-align: center; padding: 2rem;">„ÄåËß£Ë™¨Ë®ò‰∫ã„Çí‰ΩúÊàê„Äç„Éú„Çø„É≥„ÇíÊäº„Åô„Å®„ÄÅZenn/QiitaÁî®„ÅÆË®ò‰∫ã„ÅåÁîüÊàê„Åï„Çå„Åæ„Åô</p>
                </div>
                
                <!-- Á∑®ÈõÜ„Ç®„É™„Ç¢ÔºàMarkdown„Ç®„Éá„Ç£„ÇøÔºâ -->
                <div id="articleEditArea" style="display: none;">
                    <textarea id="articleEditor" style="width: 100%; min-height: 500px; padding: 1rem; border: 1px solid #e2e8f0; border-radius: 8px; font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace; font-size: 0.9rem; line-height: 1.6; resize: vertical;"></textarea>
                </div>
            </div>
            
            <div id="transcriptTab" class="tab-content">
                <!-- ÊñáÂ≠óËµ∑„Åì„ÅóÂÜçÁîüÊàê„Éú„Çø„É≥ -->
                <div id="transcriptRegenerateSection" style="display: none; margin-bottom: 0.5rem; padding: 0.4rem 0.6rem; background: #fef5e7; border: 1px solid #f6ad55; border-radius: 6px;">
                    <div style="display: flex; gap: 0.4rem; flex-wrap: wrap;">
                        <button onclick="regenerateContent('transcript')" id="regenerateTranscriptOnlyBtn" 
                                style="background: #3182ce; color: white; border: none; padding: 0.4rem 0.8rem; border-radius: 4px; cursor: pointer; font-weight: 500; font-size: 0.8rem; transition: all 0.3s ease;" 
                                onmouseover="this.style.background='#2c5282'" 
                                onmouseout="this.style.background='#3182ce'">
                            üìù ÊñáÂ≠óËµ∑„Åì„Åó„ÅÆ„ÅøÂÜçËß£Êûê
                        </button>
                        <button onclick="regenerateContent('both')" id="regenerateBothFromTranscriptBtn" 
                                style="background: #f56565; color: white; border: none; padding: 0.4rem 0.8rem; border-radius: 4px; cursor: pointer; font-weight: 500; font-size: 0.8rem; transition: all 0.3s ease;" 
                                onmouseover="this.style.background='#e53e3e'" 
                                onmouseout="this.style.background='#f56565'">
                            üîÑ ÂÖ®„Å¶ÂÜçËß£Êûê
                        </button>
                    </div>
                </div>
                
                <div id="transcript" class="transcript timestamp-transcript">
                    ÊñáÂ≠óËµ∑„Åì„ÅóÁµêÊûú„Åå„Åì„Åì„Å´Ë°®Á§∫„Åï„Çå„Åæ„Åô...
                </div>
            </div>

            <div class="chat-panel">
                <div class="chat-header">
                    <h3><span class="section-icon">ü§ñ</span>AI„Ç¢„Ç∑„Çπ„Çø„É≥„Éà</h3>
                    <p style="font-size: 0.85rem; color: #666; margin: 0.5rem 0 0 0;">ÂãïÁîªÂÜÖÂÆπ„Å∏„ÅÆË≥™Âïè„ÄÅËß£Ë™¨Ë®ò‰∫ã„ÅÆ‰øÆÊ≠£„ÄÅ„Åù„ÅÆ‰ªñ„Å™„Çì„Åß„ÇÇ„ÅäËÅû„Åç„Åè„Å†„Åï„ÅÑ</p>
                    <div id="suggestedQuestions" class="suggested-questions" style="display: none;">
                        <h4 style="margin: 0 0 0.3rem 0; font-size: 0.8rem; color: #4a5568; font-weight: 600;">üí° „Åä„Åô„Åô„ÇÅË≥™Âïè</h4>
                        <div id="questionsList"></div>
                    </div>
                </div>
                <div class="chat-messages-panel">
                    <div id="chatMessages" class="chat-messages">
                        <div class="message ai-message">
                            „Åì„Çì„Å´„Å°„ÅØÔºÅÁßÅ„ÅØAI„Ç¢„Ç∑„Çπ„Çø„É≥„Éà„Åß„Åô„ÄÇüé•<br>
                            ÂãïÁîª„ÅÆÂÜÖÂÆπ„Å´„Å§„ÅÑ„Å¶„ÅÆË≥™Âïè„ÄÅËß£Ë™¨Ë®ò‰∫ã„ÅÆ‰øÆÊ≠£ÊåáÁ§∫„ÄÅË¶ÅÁ¥Ñ„ÅÆÊ∑±Êéò„Çä„Å™„Å©„ÄÅ‰Ωï„Åß„ÇÇ„ÅäËÅû„Åç„Åè„Å†„Åï„ÅÑ„ÄÇ<br>
                            „Åæ„Åö„ÅØYouTubeÂãïÁîª„ÇíÊñáÂ≠óËµ∑„Åì„Åó„Åó„Å¶„Åã„Çâ„ÅîÂà©Áî®„Åè„Å†„Åï„ÅÑ„ÄÇ
                        </div>
                    </div>
                </div>
                <div class="chat-input-panel">
                    <div class="chat-input-container">
                        <textarea id="chatInput" placeholder="Ë≥™Âïè„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ... (Shift+Enter„ÅßÈÄÅ‰ø°)" rows="2" style="resize: none;"></textarea>
                        <button onclick="sendMessage()" id="chatBtn">ÈÄÅ‰ø°</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let isTranscriptReady = false;
        let youtubePlayer = null;
        let currentVideoId = null;
        let userInitiatedPlay = false;
        let currentTimestampedSegments = [];
        let currentTimestampedTranscript = '';
        let currentTranscript = '';
        let currentArticle = ''; // ÁèæÂú®„ÅÆË®ò‰∫ãÂÜÖÂÆπ
        let currentArticleCostInfo = null; // Ë®ò‰∫ã„ÅÆ„Ç≥„Çπ„ÉàÊÉÖÂ†±
        let videoSyncInterval = null;
        let hasProcessedContent = false; // Âá¶ÁêÜÊ∏à„Åø„Ç≥„É≥„ÉÜ„É≥„ÉÑ„Åå„ÅÇ„Çã„Åã„ÅÆ„Éï„É©„Ç∞

        // YouTube Player API ready callback
        function onYouTubeIframeAPIReady() {
            console.log('YouTube IFrame API ready');
        }

        function initializeYouTubePlayer(videoId) {
            currentVideoId = videoId;
            
            if (youtubePlayer) {
                // Êó¢Â≠ò„Éó„É¨„Ç§„É§„Éº„ÅÆÂ†¥Âêà„ÄÅ„Ç≠„É•„Éº„Å´ËøΩÂä†„Åó„Å¶‰∏ÄÊôÇÂÅúÊ≠¢Áä∂ÊÖã„ÅßË™≠„ÅøËæº„Åø
                youtubePlayer.unMute(); // Èü≥Â£∞„Çí„Ç™„É≥„Å´„Åô„Çã
                youtubePlayer.cueVideoById(videoId);
            } else {
                youtubePlayer = new YT.Player('youtubePlayer', {
                    height: '100%',
                    width: '100%',
                    videoId: videoId,
                    playerVars: {
                        'playsinline': 1,
                        'modestbranding': 1,
                        'rel': 0,
                        'autoplay': 0,
                        'controls': 1,
                        'enablejsapi': 1,
                        'mute': 0,
                        'start': 0,
                        'origin': window.location.origin
                    },
                    events: {
                        'onReady': function(event) {
                            console.log('YouTube player ready');
                            // Èü≥Â£∞„Çí„Ç™„É≥„Å´„Åô„Çã
                            event.target.unMute();
                            // ÂãïÁîª„Çí„Ç≠„É•„Éº„Å´ËøΩÂä†ÔºàÂÜçÁîü„Åó„Å™„ÅÑÔºâ
                            event.target.cueVideoById(videoId);
                        },
                        'onStateChange': function(event) {
                            console.log('Player state changed:', event.data, 'userInitiatedPlay:', userInitiatedPlay);
                            
                            // ÊÑèÂõ≥„Åó„Å™„ÅÑÂÜçÁîü„ÇíÈò≤„ÅêÔºà„É¶„Éº„Ç∂„ÉºÈñãÂßã„Åß„Å™„ÅÑÂ†¥Âêà„ÅÆ„ÅøÔºâ
                            if (event.data === YT.PlayerState.PLAYING && !userInitiatedPlay) {
                                console.log('Preventing autoplay - pausing video');
                                event.target.pauseVideo();
                            }
                            
                            // „É¶„Éº„Ç∂„Éº„ÅåÈñãÂßã„Åó„ÅüÂÜçÁîü„ÅÆÂ†¥Âêà„ÄÅ„Éï„É©„Ç∞„ÇíÁ∂≠ÊåÅ
                            if (event.data === YT.PlayerState.PLAYING && userInitiatedPlay) {
                                console.log('User initiated play - allowing playback');
                            }
                            
                            // ÂãïÁîª„ÅåÂÅúÊ≠¢/‰∏ÄÊôÇÂÅúÊ≠¢„Åó„ÅüÂ†¥Âêà„ÄÅ„Éï„É©„Ç∞„Çí„É™„Çª„ÉÉ„Éà
                            if (event.data === YT.PlayerState.PAUSED || event.data === YT.PlayerState.ENDED) {
                                userInitiatedPlay = false;
                                console.log('Video paused/ended - reset userInitiatedPlay flag');
                            }
                        }
                    }
                });
            }
            
            document.getElementById('videoPlayerContainer').style.display = 'block';
        }

        function seekToTime(seconds) {
            if (youtubePlayer && youtubePlayer.seekTo) {
                console.log('Seeking to time:', seconds, 'seconds');
                userInitiatedPlay = true;
                // Èü≥Â£∞„Çí„Ç™„É≥„Å´„Åó„Å¶„Åã„ÇâÂÜçÁîü
                youtubePlayer.unMute();
                youtubePlayer.seekTo(seconds, true);
                youtubePlayer.playVideo();
                console.log('Video play initiated by user');
                // „Éï„É©„Ç∞„ÅØ onStateChange „Åß„É™„Çª„ÉÉ„Éà„Åï„Çå„Çã„ÅÆ„Åß„ÄÅ„Åì„Åì„Åß„ÅØ„É™„Çª„ÉÉ„Éà„Åó„Å™„ÅÑ
            }
        }

        let userScrolling = false;
        let lastScrollTime = 0;
        let scrollEventAdded = false;

        // ÂãïÁîª„Å®„Éà„É©„É≥„Çπ„ÇØ„É™„Éó„Éà„ÅÆÂêåÊúüÊ©üËÉΩ
        function startVideoSync() {
            if (videoSyncInterval) {
                clearInterval(videoSyncInterval);
            }
            
            // „É¶„Éº„Ç∂„Éº„ÅÆ„Çπ„ÇØ„É≠„Éº„É´Ê§úÂá∫ÔºàÈáçË§áËøΩÂä†„ÇíÈò≤„ÅêÔºâ
            if (!scrollEventAdded) {
                const transcriptDiv = document.getElementById('transcript');
                
                // „Çπ„ÇØ„É≠„Éº„É´„Ç§„Éô„É≥„Éà
                transcriptDiv.addEventListener('scroll', handleUserScroll);
                
                // „Éû„Ç¶„Çπ„ÇÑ„Çø„ÉÉ„ÉÅ„ÅÆÊìç‰ΩúÊ§úÂá∫
                transcriptDiv.addEventListener('mousedown', handleUserInteraction);
                transcriptDiv.addEventListener('touchstart', handleUserInteraction);
                transcriptDiv.addEventListener('wheel', handleUserInteraction);
                
                // „ÉÜ„Ç≠„Çπ„ÉàÈÅ∏ÊäûÊ§úÂá∫
                document.addEventListener('selectionchange', handleUserInteraction);
                
                scrollEventAdded = true;
            }
            
            videoSyncInterval = setInterval(() => {
                if (youtubePlayer && youtubePlayer.getCurrentTime && currentTimestampedSegments.length > 0) {
                    const currentTime = youtubePlayer.getCurrentTime();
                    highlightCurrentSegment(currentTime);
                }
            }, 1000);
        }

        function handleUserScroll() {
            userScrolling = true;
            lastScrollTime = Date.now();
            // 5ÁßíÂæå„Å´Ëá™Âãï„Çπ„ÇØ„É≠„Éº„É´„ÇíÂÜçÈñãÔºàÊôÇÈñì„ÇíÂª∂Èï∑Ôºâ
            setTimeout(() => {
                if (Date.now() - lastScrollTime >= 5000) {
                    userScrolling = false;
                }
            }, 5000);
        }

        function handleUserInteraction() {
            userScrolling = true;
            lastScrollTime = Date.now();
            // „É¶„Éº„Ç∂„Éº„ÅåÊìç‰Ωú„Åó„ÅüÂ†¥Âêà„ÅØ10ÁßíÈñìËá™Âãï„Çπ„ÇØ„É≠„Éº„É´„ÇíÂÅúÊ≠¢
            setTimeout(() => {
                if (Date.now() - lastScrollTime >= 10000) {
                    userScrolling = false;
                }
            }, 10000);
        }

        function stopVideoSync() {
            if (videoSyncInterval) {
                clearInterval(videoSyncInterval);
                videoSyncInterval = null;
            }
            userScrolling = false;
            
            // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„Çí„ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„Éó
            if (scrollEventAdded) {
                const transcriptDiv = document.getElementById('transcript');
                transcriptDiv.removeEventListener('scroll', handleUserScroll);
                transcriptDiv.removeEventListener('mousedown', handleUserInteraction);
                transcriptDiv.removeEventListener('touchstart', handleUserInteraction);
                transcriptDiv.removeEventListener('wheel', handleUserInteraction);
                document.removeEventListener('selectionchange', handleUserInteraction);
                scrollEventAdded = false;
            }
        }

        function highlightCurrentSegment(currentTime) {
            // ÁèæÂú®„ÅÆÊôÇÈñì„Å´ÊúÄ„ÇÇËøë„ÅÑ„Çª„Ç∞„É°„É≥„Éà„ÇíË¶ã„Å§„Åë„Çã
            let currentSegmentIndex = -1;
            for (let i = 0; i < currentTimestampedSegments.length; i++) {
                const segment = currentTimestampedSegments[i];
                if (currentTime >= segment.start && currentTime < segment.start + segment.duration) {
                    currentSegmentIndex = i;
                    break;
                }
            }
            
            // ÂÖ®„Å¶„ÅÆ„Çª„Ç∞„É°„É≥„Éà„Åã„Çâ„Éè„Ç§„É©„Ç§„Éà„ÇíÂâäÈô§
            document.querySelectorAll('.timestamp-segment').forEach(el => {
                el.classList.remove('current-segment');
            });
            
            // ÁèæÂú®„ÅÆ„Çª„Ç∞„É°„É≥„Éà„Çí„Éè„Ç§„É©„Ç§„Éà
            if (currentSegmentIndex >= 0) {
                const segments = document.querySelectorAll('.timestamp-segment');
                if (segments[currentSegmentIndex]) {
                    segments[currentSegmentIndex].classList.add('current-segment');
                    
                    // Ëá™Âãï„Çπ„ÇØ„É≠„Éº„É´„ÅÆÊù°‰ª∂„Çí„Çà„ÇäÂé≥„Åó„Åè
                    const transcriptDiv = document.getElementById('transcript');
                    const isTranscriptVisible = transcriptDiv.offsetParent !== null;
                    const hasSelection = window.getSelection().toString().length > 0;
                    
                    // „É¶„Éº„Ç∂„Éº„Åå„Çπ„ÇØ„É≠„Éº„É´„Åó„Å¶„Åä„Çâ„Åö„ÄÅ„ÉÜ„Ç≠„Çπ„ÉàÈÅ∏Êäû„ÇÇ„Åó„Å¶„Åä„Çâ„Åö„ÄÅË¶ÅÁ¥†„ÅåË¶ã„Åà„ÇãÂ†¥Âêà„ÅÆ„ÅøËá™Âãï„Çπ„ÇØ„É≠„Éº„É´
                    if (!userScrolling && !hasSelection && isTranscriptVisible) {
                        segments[currentSegmentIndex].scrollIntoView({
                            behavior: 'smooth',
                            block: 'center'
                        });
                    }
                }
            }
        }

        // Ëß£Ë™¨Ë®ò‰∫ãÁîüÊàêÊ©üËÉΩ
        async function generateArticle() {
            try {
                const generateBtn = document.getElementById('generateArticleBtn');
                const articleStatus = document.getElementById('articleStatus');
                const articleContent = document.getElementById('articleContent');
                
                if (!currentTranscript) {
                    articleStatus.textContent = 'ÂÖà„Å´ÂãïÁîª„ÇíÊñáÂ≠óËµ∑„Åì„Åó„Åó„Å¶„Åè„Å†„Åï„ÅÑ';
                    articleStatus.style.color = '#e53e3e';
                    return;
                }
                
                generateBtn.disabled = true;
                generateBtn.textContent = 'üìù ‰ΩúÊàê‰∏≠...';
                articleStatus.textContent = 'Ëß£Ë™¨Ë®ò‰∫ã„ÇíÁîüÊàê‰∏≠„Åß„Åô...';
                articleStatus.style.color = '#667eea';
                
                console.log('Frontend state before article generation:');
                console.log('- currentTranscript length:', currentTranscript ? currentTranscript.length : 0);
                console.log('- currentTranscript preview:', currentTranscript ? currentTranscript.substring(0, 200) : 'N/A');
                
                const response = await fetch('/generate-article', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        gptModel: document.getElementById('articleModelSelect').value || 'gpt-4.1-mini'
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    // Ë®ò‰∫ãÂÜÖÂÆπ„Å®„Ç≥„Çπ„ÉàÊÉÖÂ†±„Çí‰øùÂ≠ò
                    currentArticle = data.article;
                    currentArticleCostInfo = {
                        cost: data.cost,
                        model: data.model,
                        tokens: data.tokens
                    };
                    
                    // Êñ∞„Åó„ÅÑdisplayArticleÈñ¢Êï∞„Çí‰ΩøÁî®„Åó„Å¶„Ç≥„Çπ„ÉàÊÉÖÂ†±‰ªò„Åç„ÅßË°®Á§∫
                    displayArticle(data.article, currentArticleCostInfo);
                    
                    // ÁîüÊàê„Åï„Çå„Åü„Éû„Éº„ÇØ„ÉÄ„Ç¶„É≥„Å®HTML„Çí‰øùÂ≠òÔºà„Ç≥„Éî„ÉºÁî®Ôºâ
                    window.generatedArticleMarkdown = data.article;
                    window.generatedArticleHTML = marked.parse(data.article);
                    
                    articleStatus.textContent = 'Ë®ò‰∫ã„ÅåÁîüÊàê„Åï„Çå„Åæ„Åó„ÅüÔºÅ';
                    articleStatus.style.color = '#38a169';
                    
                    // „Çª„ÉÉ„Ç∑„Éß„É≥„Ç≥„Çπ„Éà„ÇíÊõ¥Êñ∞
                    if (data.costs) {
                        updateCosts(data.costs);
                    }
                } else {
                    const errorData = await response.json();
                    articleContent.innerHTML = `<div style="color: #e53e3e; text-align: center; padding: 2rem;">„Ç®„É©„Éº: ${errorData.error}</div>`;
                    articleStatus.textContent = '„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü';
                    articleStatus.style.color = '#e53e3e';
                }
            } catch (error) {
                console.error('Article generation error:', error);
                document.getElementById('articleContent').innerHTML = '<div style="color: #e53e3e; text-align: center; padding: 2rem;">„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü</div>';
                document.getElementById('articleStatus').textContent = '„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü';
                document.getElementById('articleStatus').style.color = '#e53e3e';
            } finally {
                document.getElementById('generateArticleBtn').disabled = false;
                document.getElementById('generateArticleBtn').textContent = 'üìù Ëß£Ë™¨Ë®ò‰∫ã„Çí‰ΩúÊàê';
            }
        }

        // Ë®ò‰∫ã„ÇíMarkdown„Åß„ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Å´„Ç≥„Éî„Éº
        function copyArticleToClipboard() {
            if (window.generatedArticleMarkdown) {
                navigator.clipboard.writeText(window.generatedArticleMarkdown).then(() => {
                    // ‰∏ÄÊôÇÁöÑ„Å™ÊàêÂäü„É°„ÉÉ„Çª„Éº„Ç∏
                    const btn = document.querySelector('button[onclick="copyArticleToClipboard()"]');
                    const originalText = btn.textContent;
                    btn.textContent = '‚úÖ MarkdownÊ∏à„Åø';
                    setTimeout(() => {
                        btn.textContent = originalText;
                    }, 2000);
                    showMessage('Markdown„Çí„ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Å´„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü', 'success');
                }).catch(err => {
                    console.error('„Ç≥„Éî„Éº„Å´Â§±Êïó„Åó„Åæ„Åó„Åü:', err);
                    showMessage('Markdown„Ç≥„Éî„Éº„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
                });
            }
        }

        // Ë®ò‰∫ã„ÇíHTML„Åß„ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Å´„Ç≥„Éî„Éº
        function copyArticleAsHTML() {
            if (window.generatedArticleHTML) {
                navigator.clipboard.writeText(window.generatedArticleHTML).then(() => {
                    // ‰∏ÄÊôÇÁöÑ„Å™ÊàêÂäü„É°„ÉÉ„Çª„Éº„Ç∏
                    const btn = document.querySelector('button[onclick="copyArticleAsHTML()"]');
                    const originalText = btn.textContent;
                    btn.textContent = '‚úÖ HTMLÊ∏à„Åø';
                    setTimeout(() => {
                        btn.textContent = originalText;
                    }, 2000);
                    showMessage('HTML„Çí„ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Å´„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü', 'success');
                }).catch(err => {
                    console.error('„Ç≥„Éî„Éº„Å´Â§±Êïó„Åó„Åæ„Åó„Åü:', err);
                    showMessage('HTML„Ç≥„Éî„Éº„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
                });
            }
        }

        // Ë®ò‰∫ã„Çí„ÉÜ„É≥„Éó„É¨„Éº„Éà„Å®„Åó„Å¶‰øùÂ≠ò
        // Removed saveArticleTemplate function
        /*
        async function saveArticleTemplate() {
            if (!window.generatedArticleMarkdown) {
                showMessage('‰øùÂ≠ò„Åô„ÇãË®ò‰∫ã„Åå„ÅÇ„Çä„Åæ„Åõ„Çì', 'error');
                return;
            }

            try {
                const response = await fetch('/save-article-template', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        article: window.generatedArticleMarkdown
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    // ‰∏ÄÊôÇÁöÑ„Å™ÊàêÂäü„É°„ÉÉ„Çª„Éº„Ç∏
                    const btn = document.querySelector('button[onclick="saveArticleTemplate()"]');
                    const originalText = btn.textContent;
                    btn.textContent = '‚úÖ ‰øùÂ≠òÊ∏à„Åø';
                    setTimeout(() => {
                        btn.textContent = originalText;
                    }, 2000);
                    
                    // „ÉÜ„É≥„Éó„É¨„Éº„ÉàÊÉÖÂ†±„ÇíÊõ¥Êñ∞
                    loadTemplateInfo();
                    
                    console.log('„ÉÜ„É≥„Éó„É¨„Éº„Éà‰øùÂ≠òÊàêÂäü:', data.message);
                    showMessage('Ë®ò‰∫ã„ÉÜ„É≥„Éó„É¨„Éº„Éà„Çí‰øùÂ≠ò„Åó„Åæ„Åó„ÅüÔºÅ', 'success');
                } else {
                    const errorData = await response.json();
                    showMessage(`‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ${errorData.error}`, 'error');
                }
            } catch (error) {
                console.error('„ÉÜ„É≥„Éó„É¨„Éº„Éà‰øùÂ≠ò„Ç®„É©„Éº:', error);
                showMessage('„ÉÜ„É≥„Éó„É¨„Éº„Éà‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
            }
        }
        */

        // Removed loadTemplateInfo function
        /*
        async function loadTemplateInfo() {
            try {
                const response = await fetch('/templates-info');
                if (response.ok) {
                    const data = await response.json();
                    const templateInfo = document.getElementById('templateInfo');
                    
                    if (data.templates && data.templates.length > 0) {
                        const latest = data.templates[0];
                        const createdDate = new Date(latest.createdAt).toLocaleDateString('ja-JP');
                        templateInfo.innerHTML = `
                            <div>‰øùÂ≠òÊ∏à„Åø„ÉÜ„É≥„Éó„É¨„Éº„Éà: <strong>${data.templates.length}‰ª∂</strong></div>
                            <div>ÊúÄÊñ∞„ÉÜ„É≥„Éó„É¨„Éº„Éà: ${createdDate} ‰øùÂ≠ò</div>
                            <div>ÊßãÈÄ†: ${latest.structure.hasTitle ? '„Çø„Ç§„Éà„É´' : ''}${latest.structure.hasIntroduction ? '+Â∞éÂÖ•' : ''}${latest.structure.hasCodeBlocks ? '+„Ç≥„Éº„Éâ‰æã' : ''}${latest.structure.hasConclusion ? '+„Åæ„Å®„ÇÅ' : ''}</div>
                            <div style="font-size: 0.75rem; color: #64748b; margin-top: 0.25rem;">Ê¨°Âõû„ÅÆË®ò‰∫ãÁîüÊàêÊôÇ„Å´Ëá™Âãï„ÅßÂèÇËÄÉ„Å´„Åó„Åæ„Åô</div>
                        `;
                    } else {
                        templateInfo.textContent = '„Åæ„Å†„ÉÜ„É≥„Éó„É¨„Éº„Éà„Åå‰øùÂ≠ò„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇËâØ„ÅÑË®ò‰∫ã„Åå„Åß„Åç„Åü„Çâ„Äå„ÉÜ„É≥„Éó„É¨„Éº„Éà‰øùÂ≠ò„Äç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ';
                    }
                } else {
                    document.getElementById('templateInfo').textContent = '„ÉÜ„É≥„Éó„É¨„Éº„ÉàÊÉÖÂ†±„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü';
                }
            } catch (error) {
                console.error('„ÉÜ„É≥„Éó„É¨„Éº„ÉàÊÉÖÂ†±Ë™≠„ÅøËæº„Åø„Ç®„É©„Éº:', error);
                document.getElementById('templateInfo').textContent = '„ÉÜ„É≥„Éó„É¨„Éº„ÉàÊÉÖÂ†±„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü';
            }
        }
        */

        // Â±•Ê≠¥„Åã„ÇâË®ò‰∫ã„ÇíË™≠„ÅøËæº„Åø
        async function loadArticleFromHistory() {
            try {
                // ÁèæÂú®„ÅÆ„Éì„Éá„Ç™ID„ÇíÂèñÂæó
                if (!currentVideoId) {
                    // currentVideoId„Åå„Å™„ÅÑÂ†¥Âêà„ÄÅÁèæÂú®„ÅÆË®ò‰∫ã„ÇíË°®Á§∫
                    const response = await fetch('/current-article');
                    if (response.ok) {
                        const data = await response.json();
                        if (data.hasArticle && data.article) {
                            displayArticle(data.article);
                        } else {
                            displayNoArticleMessage();
                        }
                    } else {
                        displayNoArticleMessage();
                    }
                    return;
                }

                // Â±•Ê≠¥„Åã„ÇâË®ò‰∫ã„ÇíÂèñÂæó
                const response = await fetch(`/article/${currentVideoId}`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.hasArticle && data.article) {
                        displayArticle(data.article);
                    } else {
                        displayNoArticleMessage();
                    }
                } else {
                    displayNoArticleMessage();
                }
            } catch (error) {
                console.error('Ë®ò‰∫ãË™≠„ÅøËæº„Åø„Ç®„É©„Éº:', error);
                displayNoArticleMessage();
            }
        }

        // Ë®ò‰∫ã„ÇíË°®Á§∫„Åô„ÇãÈñ¢Êï∞
        function displayArticle(article, costInfo = null) {
            const articleContent = document.getElementById('articleContent');
            if (articleContent) {
                // article„Åå„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„ÅÆÂ†¥Âêà„ÄÅÈÅ©Âàá„Å™ÊñáÂ≠óÂàó„ÇíÂèñÂæó
                let articleText = '';
                if (typeof article === 'object' && article !== null) {
                    articleText = article.content || article.text || String(article);
                } else if (typeof article === 'string') {
                    articleText = article;
                } else {
                    articleText = String(article || '');
                }
                
                let renderedContent = articleText;
                if (typeof marked !== 'undefined' && articleText) {
                    try {
                        renderedContent = marked.parse(articleText);
                    } catch (error) {
                        console.error('Error parsing article markdown:', error);
                        renderedContent = articleText.replace(/\n/g, '<br>');
                    }
                }
                
                if (costInfo) {
                    // „Ç≥„Çπ„ÉàÊÉÖÂ†±„Åå„ÅÇ„ÇãÂ†¥ÂêàÔºàÊñ∞Ë¶èÁîüÊàêÊôÇÔºâ
                    articleContent.innerHTML = `
                        <div style="background: #f8fafc; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                            <div style="display: flex; justify-content: space-between; align-items: center; gap: 1rem; margin-bottom: 0.5rem;">
                                <span style="font-weight: 600; color: #4a5568;">üí∞ ÁîüÊàê„Ç≥„Çπ„Éà: $${costInfo.cost.toFixed(6)} (${costInfo.model})</span>
                                <div style="display: flex; gap: 0.5rem;">
                                    <button onclick="copyArticleToClipboard()" style="background: #38a169; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.85rem;">
                                        üìã Markdown„Ç≥„Éî„Éº
                                    </button>
                                    <button onclick="copyArticleAsHTML()" style="background: #3182ce; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.85rem;">
                                        üåê HTML„Ç≥„Éî„Éº
                                    </button>
                                </div>
                            </div>
                            <div style="font-size: 0.85rem; color: #666;">
                                üìä ÂÖ•Âäõ: ${costInfo.tokens.input}„Éà„Éº„ÇØ„É≥, Âá∫Âäõ: ${costInfo.tokens.output}„Éà„Éº„ÇØ„É≥
                            </div>
                            <div style="font-size: 0.85rem; color: #2d3748; margin-top: 0.5rem;">
                                üí° Ë®ò‰∫ã„ÅÆ‰øÆÊ≠£„ÅåÂøÖË¶Å„Å™Â†¥Âêà„ÅØ„ÄÅ‰∏ã„ÅÆAI„Ç¢„Ç∑„Çπ„Çø„É≥„Éà„Åß„ÄåË®ò‰∫ã„ÅÆ‚óã‚óã„ÅÆÈÉ®ÂàÜ„Çí‰øÆÊ≠£„Åó„Å¶„Äç„Å™„Å©„Å®ÊåáÁ§∫„Åó„Å¶„Åè„Å†„Åï„ÅÑ
                            </div>
                        </div>
                        <div class="article-markdown">${renderedContent}</div>
                    `;
                } else {
                    // Â±•Ê≠¥„Åã„ÇâË™≠„ÅøËæº„ÅøÊôÇ„ÅØ„Ç∑„É≥„Éó„É´„Å´Ë°®Á§∫
                    articleContent.innerHTML = `
                        <div style="background: #e6fffa; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border: 1px solid #38b2ac;">
                            <div style="display: flex; justify-content: space-between; align-items: center; gap: 1rem; margin-bottom: 0.5rem;">
                                <span style="font-weight: 600; color: #2d3748;">üìö Â±•Ê≠¥„Åã„ÇâË™≠„ÅøËæº„Åæ„Çå„ÅüË®ò‰∫ã</span>
                                <div style="display: flex; gap: 0.5rem;">
                                    <button onclick="copyArticleToClipboard()" style="background: #38a169; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.85rem;">
                                        üìã Markdown„Ç≥„Éî„Éº
                                    </button>
                                    <button onclick="copyArticleAsHTML()" style="background: #3182ce; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.85rem;">
                                        üåê HTML„Ç≥„Éî„Éº
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="article-markdown">${renderedContent}</div>
                    `;
                }
                articleContent.style.textAlign = 'left';
                
                // „Çø„Ç§„É†„Çπ„Çø„É≥„Éó„É™„É≥„ÇØ„ÇíÂá¶ÁêÜ
                processTimestampLinks(articleContent);
                
                // Á∑®ÈõÜ„ÉÑ„Éº„É´„Éê„Éº„ÇíË°®Á§∫
                const editToolbar = document.getElementById('articleEditToolbar');
                if (editToolbar) {
                    editToolbar.style.display = 'block';
                }
            }
        }

        // Ë®ò‰∫ã„Åå„Å™„ÅÑÂ†¥Âêà„ÅÆ„É°„ÉÉ„Çª„Éº„Ç∏„ÇíË°®Á§∫
        function displayNoArticleMessage() {
            const articleContent = document.getElementById('articleContent');
            if (articleContent) {
                articleContent.innerHTML = '<p style="color: #888; text-align: center; padding: 2rem;">„Åæ„Å†Ë®ò‰∫ã„ÅåÁîüÊàê„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ„ÄåËß£Ë™¨Ë®ò‰∫ã„Çí‰ΩúÊàê„Äç„Éú„Çø„É≥„ÇíÊäº„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</p>';
            }
        }

        // „Ç¢„Ç≥„Éº„Éá„Ç£„Ç™„É≥„ÅÆ„Éà„Ç∞„É´Ê©üËÉΩ
        function toggleAccordion(contentId) {
            const content = document.getElementById(contentId);
            const arrow = document.getElementById(contentId + 'Arrow');
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                arrow.classList.add('expanded');
            } else {
                content.style.display = 'none';
                arrow.classList.remove('expanded');
            }
        }

        // „Çø„ÉñÂàá„ÇäÊõø„ÅàÊ©üËÉΩ
        function switchTab(tabName) {
            // ÂÖ®„Å¶„ÅÆ„Çø„Éñ„Éú„Çø„É≥„Åã„Çâ active „ÇØ„É©„Çπ„ÇíÂâäÈô§
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // ÂÖ®„Å¶„ÅÆ„Çø„Éñ„Ç≥„É≥„ÉÜ„É≥„ÉÑ„ÇíÈùûË°®Á§∫
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // ÈÅ∏Êäû„Åï„Çå„Åü„Çø„Éñ„Çí„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Å´
            // „Ç§„Éô„É≥„Éà„ÅåÂ≠òÂú®„Åô„ÇãÂ†¥ÂêàÔºàÈÄöÂ∏∏„ÅÆ„ÇØ„É™„ÉÉ„ÇØÔºâ
            if (typeof event !== 'undefined' && event && event.target) {
                const clickedButton = event.target.closest('.tab-button');
                if (clickedButton) {
                    clickedButton.classList.add('active');
                }
            } else {
                // „Éó„É≠„Ç∞„É©„É†ÁöÑ„Å´Âëº„Å≥Âá∫„Åï„Çå„ÅüÂ†¥Âêà„ÄÅÂØæÂøú„Åô„Çã„Éú„Çø„É≥„ÇíË¶ã„Å§„Åë„Å¶„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Å´„Åô„Çã
                const tabButton = document.querySelector(`[onclick="switchTab('${tabName}')"]`);
                if (tabButton) {
                    tabButton.classList.add('active');
                }
            }
            document.getElementById(tabName + 'Tab').classList.add('active');
            
            // Ëß£Ë™¨Ë®ò‰∫ã„Çø„Éñ„ÅåÈÅ∏Êäû„Åï„Çå„ÅüÂ†¥Âêà„ÄÅË®ò‰∫ã„ÇíË™≠„ÅøËæº„Åø
            if (tabName === 'article') {
                loadArticleFromHistory();
                
                // ‰øùÂ≠ò„Åï„Çå„ÅüË®ò‰∫ã„Åå„ÅÇ„Çå„Å∞Âæ©ÂÖÉ
                if (currentArticle) {
                    displayArticle(currentArticle, currentArticleCostInfo);
                }
            }
            
            // ÊñáÂ≠óËµ∑„Åì„Åó„Çø„Éñ„ÅåÈÅ∏Êäû„Åï„Çå„ÅüÂ†¥Âêà„ÄÅÂêåÊúü„ÇíÈñãÂßã
            if (tabName === 'transcript' && currentTimestampedTranscript) {
                setTimeout(() => {
                    startVideoSync();
                }, 100);
            } else if (tabName === 'summary') {
                stopVideoSync();
            }
        }

        // „Çø„Ç§„É†„Çπ„Çø„É≥„Éó‰ªò„ÅçÊñáÂ≠óËµ∑„Åì„Åó„ÇíË°®Á§∫
        function displayTimestampedTranscript() {
            const transcriptDiv = document.getElementById('transcript');
            if (currentTimestampedTranscript) {
                transcriptDiv.innerHTML = currentTimestampedTranscript;
                // ÁèæÂú®ÊñáÂ≠óËµ∑„Åì„Åó„Çø„Éñ„Åå„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Å™Â†¥Âêà„ÅÆ„ÅøÂêåÊúüÈñãÂßã
                if (document.getElementById('transcriptTab').classList.contains('active')) {
                    startVideoSync();
                }
            }
        }

        function extractVideoId(url) {
            const regex = /(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([^&\n?#]+)/;
            const match = url.match(regex);
            return match ? match[1] : null;
        }

        function updateCosts(costs) {
            // „Çª„ÉÉ„Ç∑„Éß„É≥ÊñôÈáë„ÇÇÂàÜÊûê„Å´Áµ±Âêà„Åô„Çã„Åü„ÇÅ„ÄÅÂàÜÊûê„Éá„Éº„Çø„ÇíÂÜçË™≠„ÅøËæº„Åø
            if (costs) {
                loadCostsAnalysis();
            }
        }

        async function loadHistory() {
            try {
                const response = await fetch('/history');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                console.log('History response:', result);
                
                if (result.success) {
                    displayHistory(result.history);
                } else {
                    console.error('History API returned success: false');
                    const historyList = document.getElementById('historyList');
                    if (historyList) {
                        historyList.innerHTML = '<div style="text-align: center; color: #e53e3e; padding: 1rem;">Â±•Ê≠¥„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü</div>';
                    }
                }
            } catch (error) {
                console.error('Error loading history:', error);
                const historyList = document.getElementById('historyList');
                if (historyList) {
                    historyList.innerHTML = '<div style="text-align: center; color: #e53e3e; padding: 1rem;">Â±•Ê≠¥„ÅÆË™≠„ÅøËæº„Åø‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü</div>';
                }
            }
        }

        // Â±•Ê≠¥Ë°®Á§∫„ÅÆÁä∂ÊÖãÁÆ°ÁêÜ
        let currentHistoryView = 'timeline';
        let allHistoryData = [];
        let filteredHistoryData = [];

        function displayHistory(history) {
            allHistoryData = history;
            filteredHistoryData = history;
            
            if (!history || history.length === 0) {
                document.getElementById('historyList').innerHTML = '<p>Â±•Ê≠¥„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>';
                return;
            }

            // „Çø„Ç∞„Çµ„Ç∏„Çß„Çπ„ÉÅ„Éß„É≥„ÇíÊõ¥Êñ∞
            updateTagSuggestions(history);
            
            // „É°„Ç§„É≥„Çø„Ç∞„Çµ„Ç∏„Çß„Çπ„ÉÅ„Éß„É≥„ÇíÊõ¥Êñ∞
            updateMainTagSuggestions(history);
            
            // ÁèæÂú®„ÅÆ„Éì„É•„Éº„Å´Âøú„Åò„Å¶Ë°®Á§∫
            displayHistoryByView(currentHistoryView);
        }

        function displayHistoryByView(viewType) {
            const historyList = document.getElementById('historyList');
            
            switch(viewType) {
                case 'timeline':
                    displayTimelineHistory();
                    break;
                case 'channel':
                    displayChannelHistory();
                    break;
                case 'tag':
                    displayTagHistory();
                    break;
            }
        }

        function displayTimelineHistory() {
            const historyList = document.getElementById('historyList');
            
            if (filteredHistoryData.length === 0) {
                historyList.innerHTML = '<p>Ë©≤ÂΩì„Åô„ÇãÂ±•Ê≠¥„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>';
                return;
            }

            const historyHTML = filteredHistoryData.map(item => {
                const date = new Date(item.timestamp).toLocaleString('ja-JP');
                const methodClass = item.method === 'subtitle' ? 'method-subtitle' : 'method-whisper';
                const methodText = item.method === 'subtitle' ? 'Â≠óÂπï' : 'Whisper';
                const cost = item.cost > 0 ? `$${item.cost.toFixed(4)}` : 'ÁÑ°Êñô';
                const languageText = getLanguageDisplayName(item.language || 'original');
                const channelName = item.metadata?.basic?.channel || 'Unknown';
                const videoUrl = item.url || '';
                const tags = item.tags || [];
                const mainTags = item.mainTags || [];
                
                const tagsHTML = tags.length > 0 ? `
                    <div class="video-tags">
                        ${tags.map(tag => `<span class="tag-item" onclick="filterByTag('${tag}'); event.stopPropagation();">${tag}</span>`).join('')}
                    </div>
                ` : '';
                
                const mainTagsHTML = mainTags.length > 0 ? `
                    <div class="video-tags" style="margin: 0.25rem 0;">
                        ${mainTags.map(tag => `<span style="background: #667eea; color: white; padding: 0.25rem 0.5rem; border-radius: 8px; font-size: 0.75rem; font-weight: 600; margin-right: 0.25rem; cursor: pointer;" onclick="filterByTag('${tag}'); event.stopPropagation();">üè∑Ô∏è ${tag}</span>`).join('')}
                    </div>
                ` : '';
                
                return `
                    <div class="history-item" onclick="loadFromHistory('${item.id}')">
                        <div class="history-title">${item.title}</div>
                        <div class="history-channel">üì∫ ${channelName}</div>
                        ${mainTagsHTML}
                        ${tagsHTML}
                        <div class="history-url">
                            <a href="${videoUrl}" target="_blank" onclick="event.stopPropagation();">üîó YouTube„ÅßÈñã„Åè</a>
                        </div>
                        <div class="history-meta">
                            <span>${date}</span>
                            <span>
                                <span class="method-badge ${methodClass}">${methodText}</span>
                                <span class="language-badge">${languageText}</span>
                                <span style="margin-left: 10px;">${cost}</span>
                            </span>
                        </div>
                    </div>
                `;
            }).join('');
            
            historyList.innerHTML = historyHTML;
        }

        function displayChannelHistory() {
            const historyList = document.getElementById('historyList');
            
            // „ÉÅ„É£„É≥„Éç„É´Âà•„Å´„Ç∞„É´„Éº„ÉóÂåñ
            const channelGroups = {};
            filteredHistoryData.forEach(item => {
                const channel = item.metadata?.basic?.channel || 'Unknown';
                if (!channelGroups[channel]) {
                    channelGroups[channel] = [];
                }
                channelGroups[channel].push(item);
            });

            if (Object.keys(channelGroups).length === 0) {
                historyList.innerHTML = '<p>Ë©≤ÂΩì„Åô„ÇãÂ±•Ê≠¥„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>';
                return;
            }

            let historyHTML = '';
            Object.entries(channelGroups).forEach(([channel, items]) => {
                historyHTML += `
                    <div class="history-group collapsed">
                        <div class="history-group-header" onclick="toggleHistoryGroup(this)">
                            <span>üì∫ ${channel} (${items.length}‰ª∂)</span>
                            <span class="toggle-icon">‚ñº</span>
                        </div>
                        <div class="history-group-items">
                            ${items.map(item => createHistoryItemHTML(item)).join('')}
                        </div>
                    </div>
                `;
            });
            
            historyList.innerHTML = historyHTML;
        }

        function displayTagHistory() {
            const historyList = document.getElementById('historyList');
            
            // „Çø„Ç∞Âà•„Å´„Ç∞„É´„Éº„ÉóÂåñ
            const tagGroups = {};
            filteredHistoryData.forEach(item => {
                const tags = item.tags || ['Êú™ÂàÜÈ°û'];
                tags.forEach(tag => {
                    if (!tagGroups[tag]) {
                        tagGroups[tag] = [];
                    }
                    tagGroups[tag].push(item);
                });
            });

            if (Object.keys(tagGroups).length === 0) {
                historyList.innerHTML = '<p>Ë©≤ÂΩì„Åô„ÇãÂ±•Ê≠¥„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>';
                return;
            }

            let historyHTML = '';
            Object.entries(tagGroups).forEach(([tag, items]) => {
                // ÈáçË§á„ÇíÈô§Âéª
                const uniqueItems = items.filter((item, index, self) => 
                    index === self.findIndex(t => t.id === item.id)
                );
                
                historyHTML += `
                    <div class="history-group collapsed">
                        <div class="history-group-header" onclick="toggleHistoryGroup(this)">
                            <span>üè∑Ô∏è ${tag} (${uniqueItems.length}‰ª∂)</span>
                            <span class="toggle-icon">‚ñº</span>
                        </div>
                        <div class="history-group-items">
                            ${uniqueItems.map(item => createHistoryItemHTML(item)).join('')}
                        </div>
                    </div>
                `;
            });
            
            historyList.innerHTML = historyHTML;
        }

        function createHistoryItemHTML(item) {
            const date = new Date(item.timestamp).toLocaleString('ja-JP');
            const methodClass = item.method === 'subtitle' ? 'method-subtitle' : 'method-whisper';
            const methodText = item.method === 'subtitle' ? 'Â≠óÂπï' : 'Whisper';
            const cost = item.cost > 0 ? `$${item.cost.toFixed(4)}` : 'ÁÑ°Êñô';
            const languageText = getLanguageDisplayName(item.language || 'original');
            const videoUrl = item.url || '';
            const tags = item.tags || [];
            const mainTags = item.mainTags || [];
            
            const tagsHTML = tags.length > 0 ? `
                <div class="video-tags">
                    ${tags.map(tag => `<span class="tag-item">${tag}</span>`).join('')}
                </div>
            ` : '';
            
            const mainTagsHTML = mainTags.length > 0 ? `
                <div class="video-tags" style="margin: 0.25rem 0;">
                    ${mainTags.map(tag => `<span style="background: #667eea; color: white; padding: 0.25rem 0.5rem; border-radius: 8px; font-size: 0.75rem; font-weight: 600; margin-right: 0.25rem;">üè∑Ô∏è ${tag}</span>`).join('')}
                </div>
            ` : '';
            
            return `
                <div class="history-item" onclick="loadFromHistory('${item.id}')">
                    <div class="history-title">${item.title}</div>
                    ${mainTagsHTML}
                    ${tagsHTML}
                    <div class="history-url">
                        <a href="${videoUrl}" target="_blank" onclick="event.stopPropagation();">üîó YouTube„ÅßÈñã„Åè</a>
                    </div>
                    <div class="history-meta">
                        <span>${date}</span>
                        <span>
                            <span class="method-badge ${methodClass}">${methodText}</span>
                            <span class="language-badge">${languageText}</span>
                            <span style="margin-left: 10px;">${cost}</span>
                        </span>
                    </div>
                </div>
            `;
        }

        async function loadFromHistory(videoId) {
            try {
                const response = await fetch('/load-from-history', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ videoId: videoId })
                });

                const result = await response.json();

                if (result.success) {
                    // „Çø„Ç§„É†„Çπ„Çø„É≥„ÉóÊÉÖÂ†±„Çí‰øùÂ≠ò
                    currentTimestampedSegments = result.timestampedSegments || [];
                    
                    // YouTube„Éó„É¨„Ç§„É§„Éº„ÇíÂàùÊúüÂåñÔºàURL„Åã„ÇâÂãïÁîªID„ÇíÂèñÂæóÔºâ
                    if (result.metadata?.basic?.videoId) {
                        initializeYouTubePlayer(result.metadata.basic.videoId);
                        setCurrentVideoId(result.metadata.basic.videoId);
                    }
                    
                    // „Çø„Ç§„É†„Çπ„Çø„É≥„Éó‰ªò„ÅçÊñáÂ≠óËµ∑„Åì„Åó„ÇíÂèñÂæó„Åó„Å¶Ë°®Á§∫
                    fetch('/transcript')
                        .then(response => response.json())
                        .then(transcriptData => {
                            if (transcriptData.timestampedTranscript) {
                                currentTimestampedTranscript = transcriptData.timestampedTranscript;
                                displayTimestampedTranscript();
                            } else {
                                // „Çø„Ç§„É†„Çπ„Çø„É≥„Éó„Åå„Å™„ÅÑÂ†¥Âêà„ÅØÈÄöÂ∏∏„ÅÆÊñáÂ≠óËµ∑„Åì„Åó„ÇíË°®Á§∫
                                const transcriptDiv = document.getElementById('transcript');
                                transcriptDiv.innerHTML = result.transcript.replace(/\n/g, '<br>');
                                transcriptDiv.style.whiteSpace = 'pre-wrap';
                            }
                        });
                    
                    // ÂãïÁîªÊÉÖÂ†±„ÇíË°®Á§∫
                    if (result.metadata) {
                        displayVideoInfo(result.metadata, result.method, result.language, result.detectedLanguage);
                    }
                    
                    // Ë¶ÅÁ¥Ñ„ÇíË°®Á§∫
                    if (result.summary) {
                        displaySummary(result.summary);
                    }
                    
                    // Êé®Â•®Ë≥™Âïè„ÇíË™≠„ÅøËæº„Åø
                    loadSuggestedQuestions();
                    
                    showMessage(`Â±•Ê≠¥„Åã„ÇâË™≠„ÅøËæº„Åø„Åæ„Åó„Åü: ${result.title}`, 'success');
                    isTranscriptReady = true;
                    
                    // „Ç≥„É≥„ÉÜ„É≥„ÉÑ„ÅåË™≠„ÅøËæº„Åæ„Çå„Åü„Éï„É©„Ç∞„ÇíÊõ¥Êñ∞
                    hasProcessedContent = true;
                    currentTranscript = result.transcript || '';
                    
                    // „Éú„Çø„É≥„ÉÜ„Ç≠„Çπ„Éà„ÇíÊõ¥Êñ∞
                    updateUploadButtonText();
                    ensureChatInputVisible();
                } else {
                    showMessage(`„Ç®„É©„Éº: ${result.error}`, 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showMessage('Â±•Ê≠¥„ÅÆË™≠„ÅøËæº„Åø„Åß„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ', 'error');
            }
        }

        // Êñ∞Ê©üËÉΩ„ÅÆÈñ¢Êï∞
        function displayVideoInfo(metadata, method, language, detectedLanguage) {
            if (!metadata) return;
            
            const videoInfo = document.getElementById('videoInfo');
            const basic = metadata.basic;
            
            document.getElementById('videoTitle').textContent = basic.title;
            document.getElementById('videoChannel').textContent = basic.channel;
            document.getElementById('videoDuration').textContent = 
                `${Math.floor(basic.duration/60)}ÂàÜ${basic.duration%60}Áßí`;
            document.getElementById('videoViews').textContent = 
                basic.viewCount ? basic.viewCount.toLocaleString() + 'Âõû' : 'N/A';
            
            let methodText = method === 'subtitle' ? 'YouTubeÂ≠óÂπï' : 'Whisper API';
            if (detectedLanguage && detectedLanguage !== language) {
                methodText += ` (${detectedLanguage})`;
            }
            document.getElementById('processingMethod').textContent = methodText;
            
            // „ÉÅ„É£„Éó„Çø„ÉºÊÉÖÂ†±
            if (metadata.chapters && metadata.chapters.length > 0) {
                const chaptersInfo = document.getElementById('chaptersInfo');
                const chaptersList = document.getElementById('chaptersList');
                
                chaptersList.innerHTML = metadata.chapters.map(chapter => 
                    `<div class="chapter-item">
                        <span class="chapter-timestamp">${chapter.timestamp}</span>
                        ${chapter.title}
                    </div>`
                ).join('');
                
                chaptersInfo.style.display = 'block';
            }
            
            videoInfo.style.display = 'block';
        }

        function displaySummary(summary) {
            if (!summary) return;
            
            const summaryDiv = document.getElementById('summary');
            
            // summary„Åå„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„ÅÆÂ†¥Âêà„ÄÅcontent„Éó„É≠„Éë„ÉÜ„Ç£„ÇíÂèñÂæó
            let summaryText = '';
            if (typeof summary === 'object' && summary !== null) {
                summaryText = summary.content || summary.text || String(summary);
            } else if (typeof summary === 'string') {
                summaryText = summary;
            } else {
                summaryText = String(summary || '');
            }
            
            let content = summaryText;
            
            // Markdown„Çí„É¨„É≥„ÉÄ„É™„É≥„Ç∞
            if (typeof marked !== 'undefined' && summaryText) {
                try {
                    content = marked.parse(summaryText);
                } catch (error) {
                    console.error('Error parsing markdown:', error);
                    content = summaryText.replace(/\n/g, '<br>');
                }
            }
            
            // „Çø„Ç§„É†„Çπ„Çø„É≥„Éó„É™„É≥„ÇØ„ÇíËøΩÂä† [mm:ss-mm:ss] „Åæ„Åü„ÅØ [mm:ss] „ÅÆÂΩ¢Âºè„ÇíÊ§úÂá∫
            content = content.replace(/\[(\d{1,2}:\d{2})(?:-(\d{1,2}:\d{2}))?\]/g, function(match, startTime, endTime) {
                const startSeconds = timeToSeconds(startTime);
                return `<span class="timestamp-link" onclick="seekToTime(${startSeconds})">${match}</span>`;
            });
            
            summaryDiv.innerHTML = content;
            summaryDiv.style.display = 'block';
        }
        
        function timeToSeconds(timeStr) {
            const parts = timeStr.split(':').map(p => parseInt(p));
            if (parts.length === 2) {
                // mm:ssÂΩ¢Âºè
                return parts[0] * 60 + parts[1];
            } else if (parts.length === 3) {
                // hh:mm:ssÂΩ¢Âºè
                return parts[0] * 3600 + parts[1] * 60 + parts[2];
            }
            return 0;
        }

        // „Çø„Ç§„É†„Çπ„Çø„É≥„Éó„É™„É≥„ÇØ„ÇíÂá¶ÁêÜ„Åô„ÇãÈñ¢Êï∞
        function processTimestampLinks(element) {
            if (!element) return;
            
            // „Åô„Åπ„Å¶„ÅÆ„ÉÜ„Ç≠„Çπ„Éà„Éé„Éº„Éâ„ÇíÂèñÂæó„Åó„Å¶Âá¶ÁêÜ
            const walker = document.createTreeWalker(
                element,
                NodeFilter.SHOW_TEXT,
                null,
                false
            );
            
            const textNodes = [];
            let node;
            while (node = walker.nextNode()) {
                textNodes.push(node);
            }
            
            textNodes.forEach(textNode => {
                const text = textNode.textContent;
                // „Çø„Ç§„É†„Çπ„Çø„É≥„Éó„Éë„Çø„Éº„É≥„ÇíÊ§úÂá∫„Åó„Å¶„É™„É≥„ÇØ„Å´Â§âÊèõ
                const processedText = text.replace(/\[(\d{1,2}:\d{2}(?::\d{2})?)\]/g, function(match, timeStr) {
                    const seconds = timeToSeconds(timeStr);
                    return `<span class="timestamp-link" onclick="seekToTime(${seconds})">${match}</span>`;
                });
                
                // „ÉÜ„Ç≠„Çπ„Éà„ÅåÂ§âÊõ¥„Åï„Çå„ÅüÂ†¥Âêà„ÅÆ„ÅøHTML„ÇíÁΩÆÊèõ
                if (processedText !== text) {
                    const span = document.createElement('span');
                    span.innerHTML = processedText;
                    textNode.parentNode.replaceChild(span, textNode);
                }
            });
        }

        // Ë®ò‰∫ãÂ±•Ê≠¥Ë°®Á§∫„ÅÆÂàá„ÇäÊõø„Åà
        async function toggleArticleHistory() {
            const historyPanel = document.getElementById('articleHistoryPanel');
            const toggleBtn = document.getElementById('toggleArticleHistoryBtn');
            
            if (historyPanel.style.display === 'none') {
                // Â±•Ê≠¥„ÇíË°®Á§∫
                if (currentVideoId) {
                    await loadArticleHistory();
                    historyPanel.style.display = 'block';
                    toggleBtn.textContent = 'üìú Â±•Ê≠¥ÈùûË°®Á§∫';
                } else {
                    showMessage('‚ùå ÂãïÁîª„ÇíË™≠„ÅøËæº„Çì„Åß„Åè„Å†„Åï„ÅÑ', 'error');
                }
            } else {
                // Â±•Ê≠¥„ÇíÈùûË°®Á§∫
                historyPanel.style.display = 'none';
                toggleBtn.textContent = 'üìú Â±•Ê≠¥Ë°®Á§∫';
            }
        }

        // Ë®ò‰∫ãÂ±•Ê≠¥„ÇíË™≠„ÅøËæº„Åø
        async function loadArticleHistory() {
            if (!currentVideoId) {
                console.log('No current video ID available');
                return;
            }
            
            try {
                const response = await fetch(`/article-history/${currentVideoId}`);
                const data = await response.json();
                
                if (data.success) {
                    displayArticleHistory(data.history);
                } else {
                    console.error('Error loading article history:', data.error);
                    document.getElementById('articleHistoryList').innerHTML = '<p style="color: #666; text-align: center;">Â±•Ê≠¥„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü</p>';
                }
            } catch (error) {
                console.error('Error loading article history:', error);
                document.getElementById('articleHistoryList').innerHTML = '<p style="color: #666; text-align: center;">Â±•Ê≠¥„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü</p>';
            }
        }

        // Ë®ò‰∫ãÂ±•Ê≠¥„ÇíË°®Á§∫
        function displayArticleHistory(history) {
            const historyList = document.getElementById('articleHistoryList');
            
            if (!history || history.length === 0) {
                historyList.innerHTML = '<p style="color: #666; text-align: center;">Ë®ò‰∫ãÂ±•Ê≠¥„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>';
                return;
            }
            
            const historyHTML = history.map((item, index) => {
                const date = new Date(item.timestamp).toLocaleString('ja-JP');
                const typeLabel = item.type === 'generated' ? 'ü§ñ ÁîüÊàê' : 
                                item.type === 'edited' ? '‚úèÔ∏è Á∑®ÈõÜ' : 
                                item.type === 'merged' ? 'üîÑ „Éû„Éº„Ç∏' : 'üìù „Åù„ÅÆ‰ªñ';
                
                const preview = item.article.substring(0, 100) + (item.article.length > 100 ? '...' : '');
                
                return `
                    <div style="border: 1px solid #e2e8f0; border-radius: 6px; padding: 0.75rem; margin-bottom: 0.5rem; background: white;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                            <span style="font-weight: 600; color: #2d3748;">${typeLabel}</span>
                            <span style="font-size: 0.8rem; color: #718096;">${date}</span>
                        </div>
                        <div style="font-size: 0.85rem; color: #4a5568; margin-bottom: 0.5rem;">${preview}</div>
                        <button onclick="restoreArticleFromHistory('${item.id}')" style="background: #3182ce; color: white; border: none; padding: 0.3rem 0.75rem; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">
                            Âæ©ÂÖÉ
                        </button>
                    </div>
                `;
            }).join('');
            
            historyList.innerHTML = historyHTML;
        }

        // Â±•Ê≠¥„Åã„ÇâË®ò‰∫ã„ÇíÂæ©ÂÖÉ
        async function restoreArticleFromHistory(historyId) {
            if (!currentVideoId) {
                showMessage('‚ùå ÂãïÁîªID„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì', 'error');
                return;
            }
            
            try {
                const response = await fetch(`/article-history/${currentVideoId}`);
                const data = await response.json();
                
                if (data.success) {
                    const historyItem = data.history.find(item => item.id === historyId);
                    if (historyItem) {
                        // Ë®ò‰∫ã„ÇíË°®Á§∫
                        displayArticle(historyItem.article);
                        showMessage('‚úÖ Â±•Ê≠¥„Åã„ÇâË®ò‰∫ã„ÇíÂæ©ÂÖÉ„Åó„Åæ„Åó„Åü', 'success');
                    } else {
                        showMessage('‚ùå Â±•Ê≠¥„Ç¢„Ç§„ÉÜ„É†„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì', 'error');
                    }
                } else {
                    showMessage('‚ùå Â±•Ê≠¥„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
                }
            } catch (error) {
                console.error('Error restoring from history:', error);
                showMessage('‚ùå Â±•Ê≠¥„ÅÆÂæ©ÂÖÉ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
            }
        }

        async function loadSuggestedQuestions() {
            try {
                const response = await fetch('/suggested-questions');
                const result = await response.json();
                
                console.log('Debug: API response:', result);
                
                if (result.success && result.questions.length > 0) {
                    displaySuggestedQuestions(result.questions);
                } else {
                    // „ÉÜ„Çπ„ÉàÁî®„ÅÆË≥™Âïè„ÇíË°®Á§∫
                    console.log('Debug: No questions from API, showing test questions');
                    const testQuestions = [
                        'ÂãïÁîª„ÅÆÂÜÖÂÆπ„ÇíË©≥„Åó„ÅèË™¨Êòé„Åó„Å¶„Åè„Å†„Åï„ÅÑ',
                        'ÈáçË¶Å„Å™„Éù„Ç§„É≥„Éà„ÇíÊïô„Åà„Å¶„Åè„Å†„Åï„ÅÑ',
                        '„Åì„ÅÆÂãïÁîª„Åã„ÇâÂ≠¶„Åπ„Çã„Åì„Å®„ÅØ‰Ωï„Åß„Åô„ÅãÔºü',
                        'ÂÆüË∑µÁöÑ„Å´Ê¥ªÁî®„Åß„Åç„ÇãÂÜÖÂÆπ„ÅØ„ÅÇ„Çä„Åæ„Åô„ÅãÔºü'
                    ];
                    displaySuggestedQuestions(testQuestions);
                }
            } catch (error) {
                console.error('Error loading suggested questions:', error);
            }
        }

        function displaySuggestedQuestions(questions) {
            const suggestedDiv = document.getElementById('suggestedQuestions');
            const questionsList = document.getElementById('questionsList');
            
            questionsList.innerHTML = questions.map(question => 
                `<div class="question-item" onclick="askSuggestedQuestion('${question.replace(/'/g, "\\'")}')">
                    ${question}
                </div>`
            ).join('');
            
            suggestedDiv.style.display = 'block';
            
            // Ensure chat input remains visible after questions are displayed
            setTimeout(() => {
                ensureChatInputVisible();
            }, 100);
        }

        function askSuggestedQuestion(question) {
            document.getElementById('chatInput').value = question;
            sendMessage();
        }

        function ensureChatInputVisible() {
            // Force chat input panel to be visible
            const chatInputPanel = document.querySelector('.chat-input-panel');
            const chatInputContainer = document.querySelector('.chat-input-container');
            const chatInput = document.getElementById('chatInput');
            const chatBtn = document.getElementById('chatBtn');
            
            if (chatInputPanel) {
                chatInputPanel.style.display = 'flex';
                chatInputPanel.style.visibility = 'visible';
                chatInputPanel.style.position = 'absolute';
                chatInputPanel.style.bottom = '0';
                chatInputPanel.style.left = '0';
                chatInputPanel.style.right = '0';
                chatInputPanel.style.zIndex = '100';
            }
            
            if (chatInputContainer) {
                chatInputContainer.style.display = 'flex';
                chatInputContainer.style.visibility = 'visible';
            }
            
            if (chatInput) {
                chatInput.style.display = 'block';
                chatInput.style.visibility = 'visible';
            }
            
            if (chatBtn) {
                chatBtn.style.display = 'block';
                chatBtn.style.visibility = 'visible';
            }
            
            console.log('Chat input visibility ensured');
        }

        function extractAndDisplayQuestionsFromSummary(summaryContent) {
            try {
                // summaryContent„Åå„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„ÅÆÂ†¥Âêà„ÄÅÈÅ©Âàá„Å™ÊñáÂ≠óÂàó„ÇíÂèñÂæó
                let summaryText = '';
                if (typeof summaryContent === 'object' && summaryContent !== null) {
                    summaryText = summaryContent.content || summaryContent.text || String(summaryContent);
                } else if (typeof summaryContent === 'string') {
                    summaryText = summaryContent;
                } else {
                    summaryText = String(summaryContent || '');
                }
                
                console.log('Extracting questions from summary:', summaryText ? summaryText.substring(0, 200) + '...' : 'null');
                
                if (!summaryText) {
                    console.log('No summary content provided');
                    return;
                }
                
                // „Çµ„Éº„Éê„ÉºÂÅ¥„Å®Âêå„Åò„É≠„Ç∏„ÉÉ„ÇØ„ÅßÊ∑±Êéò„ÇäË≥™Âïè„ÇíÊäΩÂá∫
                const questionPatterns = [
                    /6\.\s*\*\*üí°\s*„Åä„Åô„Åô„ÇÅÊ∑±Êéò„ÇäË≥™Âïè\*\*\s*([\s\S]*?)(?=\n\n|$)/i,
                    /\*\*üí°\s*„Åä„Åô„Åô„ÇÅÊ∑±Êéò„ÇäË≥™Âïè\*\*\s*([\s\S]*?)(?=\n\n|$)/i,
                    /üí°\s*„Åä„Åô„Åô„ÇÅÊ∑±Êéò„ÇäË≥™Âïè[:\s]*([\s\S]*?)(?=\n\n|$)/i,
                    /„Åä„Åô„Åô„ÇÅÊ∑±Êéò„ÇäË≥™Âïè[:\s]*([\s\S]*?)(?=\n\n|$)/i
                ];
                
                let extractedQuestions = [];
                for (const pattern of questionPatterns) {
                    const questionsMatch = summaryText.match(pattern);
                    if (questionsMatch) {
                        console.log('Found questions match with pattern:', pattern.toString());
                        const questionsText = questionsMatch[1];
                        console.log('Questions text:', questionsText);
                        
                        extractedQuestions = questionsText
                            .split(/\n/)
                            .map(line => line.trim())
                            .filter(line => {
                                // „Çà„ÇäÊüîËªü„Å™Ë≥™Âïè„ÅÆÈñãÂßã„Éë„Çø„Éº„É≥„ÇíÊ§úÂá∫
                                return line.startsWith('-') || 
                                       line.startsWith('‚Ä¢') || 
                                       line.match(/^\d+[\.\)]/) ||
                                       (line.includes('Ôºü') && line.length > 5);
                            })
                            .map(line => {
                                // ÂÖàÈ†≠„ÅÆË®òÂè∑„ÇÑÁï™Âè∑„ÇíÂâäÈô§
                                return line.replace(/^[-‚Ä¢\d\.\)\s]+/, '').trim();
                            })
                            .filter(q => q.length > 5 && q.includes('Ôºü'))
                            .slice(0, 5); // ÊúÄÂ§ß5ÂÄã„Åæ„Åß
                        
                        console.log('Extracted questions:', extractedQuestions);
                        
                        if (extractedQuestions.length > 0) {
                            displaySuggestedQuestions(extractedQuestions);
                            return;
                        }
                    }
                }
                
                // Ê∑±Êéò„ÇäË≥™Âïè„ÅåË¶ã„Å§„Åã„Çâ„Å™„ÅÑÂ†¥Âêà„ÅØÊ±éÁî®ÁöÑ„Å™Ë≥™Âïè„ÇíË°®Á§∫
                console.log('No specific questions found, using fallback');
                const fallbackQuestions = [
                    'ÂãïÁîª„ÅÆÂÜÖÂÆπ„ÇíË©≥„Åó„ÅèË™¨Êòé„Åó„Å¶„Åè„Å†„Åï„ÅÑ',
                    'ÈáçË¶Å„Å™„Éù„Ç§„É≥„Éà„ÇíÊïô„Åà„Å¶„Åè„Å†„Åï„ÅÑ',
                    '„Åì„ÅÆÂãïÁîª„Åã„ÇâÂ≠¶„Åπ„Çã„Åì„Å®„ÅØ‰Ωï„Åß„Åô„ÅãÔºü'
                ];
                displaySuggestedQuestions(fallbackQuestions);
                
            } catch (error) {
                console.error('Error extracting questions from summary:', error);
            }
        }

        function getLanguageDisplayName(language) {
            switch (language) {
                case 'ja': return 'Êó•Êú¨Ë™û';
                case 'en': return 'English';
                case 'original': 
                default: return 'Original';
            }
        }

        // ÊñôÈáë„Çø„ÉñÂàá„ÇäÊõø„Åà
        function switchCostsTab(tabName) {
            document.querySelectorAll('.costs-tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelectorAll('.costs-tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            event.target.classList.add('active');
            document.getElementById(tabName + 'Costs').classList.add('active');
            
            if (tabName === 'analysis') {
                loadCostsAnalysis();
            } else if (tabName === 'graph') {
                loadCostsGraph();
            }
        }

        // ÊñôÈáëÂàÜÊûê„Éá„Éº„Çø„ÅÆË™≠„ÅøËæº„Åø
        async function loadCostsAnalysis() {
            try {
                const period = document.getElementById('periodSelect').value;
                const response = await fetch(`/costs-analysis?period=${period}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    displayCostsAnalysis(result);
                } else {
                    throw new Error(result.error || 'ÂàÜÊûê„Éá„Éº„Çø„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                }
            } catch (error) {
                console.error('Error loading costs analysis:', error);
                const errorMessage = error.message || 'ÂàÜÊûê„Éá„Éº„Çø„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü';
                document.getElementById('costsAnalysisResult').innerHTML = 
                    `<p style="color: red;">„Ç®„É©„Éº: ${errorMessage}</p>`;
            }
        }

        // ÊñôÈáëÂàÜÊûêÁµêÊûú„ÅÆË°®Á§∫
        function displayCostsAnalysis(data) {
            const { summary, period, sessionCosts } = data;
            let html = `
                <div class="costs-analysis-summary">
                    <h4>üìä ${getPeriodDisplayName(period)} ÈõÜË®à</h4>
                    <div class="cost-item">
                        <span>ÂãïÁîªÂá¶ÁêÜÊï∞:</span>
                        <span>${summary.videoCount} ‰ª∂</span>
                    </div>
                    <div class="cost-item">
                        <span>WhisperÂêàË®à:</span>
                        <span>$${summary.totalWhisper.toFixed(4)}</span>
                    </div>
                    <div class="cost-item">
                        <span>GPTÂêàË®à:</span>
                        <span>$${summary.totalGpt.toFixed(4)}</span>
                    </div>`;
            
            // „Çª„ÉÉ„Ç∑„Éß„É≥ÊñôÈáë„ÇíËøΩÂä†Ôºà‰ªäÊó•„ÅÆ„Éá„Éº„Çø„ÅÆÂ†¥Âêà„ÅÆ„ÅøÔºâ
            if (period === 'today' && sessionCosts) {
                html += `
                    <div class="cost-item">
                        <span>„Çª„ÉÉ„Ç∑„Éß„É≥ (Whisper):</span>
                        <span>$${sessionCosts.whisper.toFixed(4)}</span>
                    </div>
                    <div class="cost-item">
                        <span>„Çª„ÉÉ„Ç∑„Éß„É≥ (GPT):</span>
                        <span>$${sessionCosts.gpt.toFixed(4)}</span>
                    </div>`;
            }
            
            html += `
                    <div class="cost-item total-cost">
                        <span>Á∑èÂêàË®à:</span>
                        <span>$${summary.totalCost.toFixed(4)}</span>
                    </div>
                </div>
                
                <div class="costs-accordion">
                    <div class="accordion-header" onclick="toggleAccordion('methodCosts')">
                        <span>üìà Âá¶ÁêÜÊñπÊ≥ïÂà•</span>
                        <span class="accordion-arrow" id="methodCostsArrow">‚ñº</span>
                    </div>
                    <div class="accordion-content" id="methodCosts" style="display: none;">
                        ${Object.entries(summary.byMethod).map(([method, data]) => `
                            <div class="cost-item">
                                <span>${method === 'subtitle' ? 'YouTubeÂ≠óÂπï' : 'Whisper API'} (${data.count}‰ª∂):</span>
                                <span>$${data.cost.toFixed(4)}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
                
                <div class="costs-accordion">
                    <div class="accordion-header" onclick="toggleAccordion('modelCosts')">
                        <span>ü§ñ GPT„É¢„Éá„É´Âà•</span>
                        <span class="accordion-arrow" id="modelCostsArrow">‚ñº</span>
                    </div>
                    <div class="accordion-content" id="modelCosts" style="display: none;">
                        ${Object.entries(summary.byModel).map(([model, data]) => `
                            <div class="cost-item">
                                <span>${model} (${data.count}‰ª∂):</span>
                                <span>$${data.cost.toFixed(4)}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            
            document.getElementById('costsAnalysisResult').innerHTML = html;
        }

        function getPeriodDisplayName(period) {
            switch (period) {
                case 'today': return 'Êú¨Êó•';
                case 'week': return 'ÈÅéÂéª7Êó•Èñì';
                case 'month': return 'ÈÅéÂéª30Êó•Èñì';
                case 'total': return 'ÂÖ®ÊúüÈñì';
                default: return period;
            }
        }

        // „Ç∞„É©„ÉïÊèèÁîªÊ©üËÉΩ
        async function loadCostsGraph() {
            try {
                const period = document.getElementById('graphPeriodSelect').value;
                const response = await fetch(`/costs-analysis?period=${period}`);
                const result = await response.json();
                
                if (result.success) {
                    drawCostsChart(result);
                }
            } catch (error) {
                console.error('Error loading costs graph:', error);
            }
        }
        
        function drawCostsChart(data) {
            const canvas = document.getElementById('costsChart');
            const ctx = canvas.getContext('2d');
            const { summary } = data;
            
            // „Ç≠„É£„É≥„Éê„Çπ„Çí„ÇØ„É™„Ç¢
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Êó•Âà•„Éá„Éº„Çø„ÇíÂèñÂæó
            const byDate = summary.byDate || {};
            const dates = Object.keys(byDate).sort();
            
            if (dates.length === 0) {
                ctx.fillStyle = '#666';
                ctx.font = '16px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì', canvas.width / 2, canvas.height / 2);
                return;
            }
            
            // „Ç∞„É©„Éï„ÅÆË®≠ÂÆö
            const padding = 40;
            const graphWidth = canvas.width - padding * 2;
            const graphHeight = canvas.height - padding * 2;
            const startX = padding;
            const startY = padding;
            
            // „Éá„Éº„Çø„ÅÆÊúÄÂ§ßÂÄ§„ÇíÂèñÂæó
            const maxCost = Math.max(...dates.map(date => byDate[date].cost), 0.001);
            
            // Ëª∏„ÇíÊèèÁîª
            ctx.strokeStyle = '#ccc';
            ctx.lineWidth = 1;
            ctx.beginPath();
            // YËª∏
            ctx.moveTo(startX, startY);
            ctx.lineTo(startX, startY + graphHeight);
            // XËª∏
            ctx.moveTo(startX, startY + graphHeight);
            ctx.lineTo(startX + graphWidth, startY + graphHeight);
            ctx.stroke();
            
            // YËª∏„ÅÆ„É©„Éô„É´ÔºàÊñôÈáëÔºâ
            ctx.fillStyle = '#666';
            ctx.font = '10px Arial';
            ctx.textAlign = 'right';
            for (let i = 0; i <= 5; i++) {
                const value = (maxCost / 5) * i;
                const y = startY + graphHeight - (graphHeight / 5) * i;
                ctx.fillText(`$${value.toFixed(3)}`, startX - 5, y + 3);
                
                // „Ç∞„É™„ÉÉ„ÉâÁ∑ö
                if (i > 0) {
                    ctx.strokeStyle = '#f0f0f0';
                    ctx.beginPath();
                    ctx.moveTo(startX, y);
                    ctx.lineTo(startX + graphWidth, y);
                    ctx.stroke();
                }
            }
            
            // Êäò„ÇåÁ∑ö„Ç∞„É©„Éï„ÇíÊèèÁîª
            if (dates.length > 1) {
                ctx.strokeStyle = '#667eea';
                ctx.lineWidth = 2;
                ctx.beginPath();
                
                dates.forEach((date, index) => {
                    const x = startX + (graphWidth / (dates.length - 1)) * index;
                    const cost = byDate[date].cost;
                    const y = startY + graphHeight - (cost / maxCost) * graphHeight;
                    
                    if (index === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                });
                ctx.stroke();
                
                // „Éá„Éº„Çø„Éù„Ç§„É≥„Éà„ÇíÊèèÁîª
                ctx.fillStyle = '#667eea';
                dates.forEach((date, index) => {
                    const x = startX + (graphWidth / (dates.length - 1)) * index;
                    const cost = byDate[date].cost;
                    const y = startY + graphHeight - (cost / maxCost) * graphHeight;
                    
                    ctx.beginPath();
                    ctx.arc(x, y, 3, 0, 2 * Math.PI);
                    ctx.fill();
                });
            }
            
            // XËª∏„ÅÆ„É©„Éô„É´ÔºàÊó•‰ªòÔºâ
            ctx.fillStyle = '#666';
            ctx.font = '8px Arial';
            ctx.textAlign = 'center';
            const maxLabels = 7; // ÊúÄÂ§ß7ÂÄã„ÅÆ„É©„Éô„É´„ÇíË°®Á§∫
            const step = Math.ceil(dates.length / maxLabels);
            
            dates.forEach((date, index) => {
                if (index % step === 0 || index === dates.length - 1) {
                    const x = startX + (graphWidth / (dates.length - 1)) * index;
                    const shortDate = date.slice(5); // MM-DDÂΩ¢Âºè
                    ctx.save();
                    ctx.translate(x, startY + graphHeight + 15);
                    ctx.rotate(-Math.PI / 4); // 45Â∫¶ÂõûËª¢
                    ctx.fillText(shortDate, 0, 0);
                    ctx.restore();
                }
            });
            
            // „Çø„Ç§„Éà„É´
            ctx.fillStyle = '#333';
            ctx.font = 'bold 12px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('Êó•Âà•‰ΩøÁî®ÊñôÈáë', canvas.width / 2, 20);
        }

        
        // „Éë„Éç„É´„É™„Çµ„Ç§„Ç∫Ê©üËÉΩ
        let isResizing = false;
        
        function initializeResize() {
            const resizeHandle = document.getElementById('resizeHandle');
            const leftPanel = document.querySelector('.left-panel');
            const mainContent = document.querySelector('.main-content');
            
            if (!resizeHandle) {
                console.error('Resize handle not found');
                return;
            }
            
            resizeHandle.addEventListener('mousedown', function(e) {
                console.log('Mouse down on resize handle');
                isResizing = true;
                document.body.style.cursor = 'col-resize';
                document.body.style.userSelect = 'none';
                
                document.addEventListener('mousemove', handleMouseMove);
                document.addEventListener('mouseup', handleMouseUp);
                e.preventDefault();
                e.stopPropagation();
            });
            
            function handleMouseMove(e) {
                if (!isResizing) return;
                
                const containerRect = mainContent.getBoundingClientRect();
                const newWidth = Math.max(250, Math.min(800, e.clientX - containerRect.left - 16)); // 16px„ÅØ„Éë„Éá„Ç£„É≥„Ç∞
                
                leftPanel.style.width = `${newWidth}px`;
                
                console.log('Resizing to:', newWidth);
            }
            
            function handleMouseUp() {
                console.log('Mouse up - stop resizing');
                isResizing = false;
                document.body.style.cursor = '';
                document.body.style.userSelect = '';
                document.removeEventListener('mousemove', handleMouseMove);
                document.removeEventListener('mouseup', handleMouseUp);
            }
            
            // „ÉÄ„Éñ„É´„ÇØ„É™„ÉÉ„ÇØ„Åß„É™„Çª„ÉÉ„Éà
            resizeHandle.addEventListener('dblclick', function() {
                leftPanel.style.width = '350px';
            });
        }

        // Â±•Ê≠¥„Çø„ÉñÂàá„ÇäÊõø„Åà
        function switchHistoryTab(tabName) {
            currentHistoryView = tabName;
            
            // „Çø„Éñ„Éú„Çø„É≥„ÅÆÁä∂ÊÖãÊõ¥Êñ∞
            document.querySelectorAll('.history-tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Ë°®Á§∫Êõ¥Êñ∞
            displayHistoryByView(tabName);
        }

        // Â±•Ê≠¥„Éï„Ç£„É´„Çø„É™„É≥„Ç∞
        function filterHistory() {
            const filter = document.getElementById('historyFilter').value;
            const now = new Date();
            
            filteredHistoryData = allHistoryData.filter(item => {
                const itemDate = new Date(item.timestamp);
                
                switch(filter) {
                    case 'today':
                        return itemDate.toDateString() === now.toDateString();
                    case 'week':
                        const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                        return itemDate >= weekAgo;
                    case 'month':
                        const monthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                        return itemDate >= monthAgo;
                    default:
                        return true;
                }
            });
            
            displayHistoryByView(currentHistoryView);
        }

        // Â±•Ê≠¥Ê§úÁ¥¢
        function searchHistory() {
            const searchTerm = document.getElementById('historySearch').value.toLowerCase();
            
            if (!searchTerm) {
                filterHistory(); // „Éï„Ç£„É´„Çø„Éº„ÅÆ„ÅøÈÅ©Áî®
                return;
            }
            
            const baseFilter = document.getElementById('historyFilter').value;
            let baseData = allHistoryData;
            
            // „Åæ„ÅöÊó•‰ªò„Éï„Ç£„É´„Çø„Éº„ÇíÈÅ©Áî®
            if (baseFilter !== 'all') {
                const now = new Date();
                baseData = allHistoryData.filter(item => {
                    const itemDate = new Date(item.timestamp);
                    
                    switch(baseFilter) {
                        case 'today':
                            return itemDate.toDateString() === now.toDateString();
                        case 'week':
                            const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                            return itemDate >= weekAgo;
                        case 'month':
                            const monthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                            return itemDate >= monthAgo;
                        default:
                            return true;
                    }
                });
            }
            
            // „ÉÜ„Ç≠„Çπ„ÉàÊ§úÁ¥¢„ÇíÈÅ©Áî®
            filteredHistoryData = baseData.filter(item => {
                return item.title.toLowerCase().includes(searchTerm) ||
                       (item.metadata?.basic?.channel || '').toLowerCase().includes(searchTerm) ||
                       (item.tags || []).some(tag => tag.toLowerCase().includes(searchTerm));
            });
            
            displayHistoryByView(currentHistoryView);
        }

        // „Çø„Ç∞„Å´„Çà„Çã„Éï„Ç£„É´„Çø„É™„É≥„Ç∞
        function filterByTag(tag) {
            document.getElementById('historySearch').value = tag;
            searchHistory();
            
            // „Çø„Ç∞„Çø„Éñ„Å´Âàá„ÇäÊõø„Åà
            currentHistoryView = 'tag';
            document.querySelectorAll('.history-tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelector('.history-tab-button:nth-child(3)').classList.add('active');
            displayHistoryByView('tag');
        }

        // „Çø„Ç∞„Çµ„Ç∏„Çß„Çπ„ÉÅ„Éß„É≥Êõ¥Êñ∞
        function updateTagSuggestions(history) {
            const allTags = new Set();
            history.forEach(item => {
                if (item.tags) {
                    item.tags.forEach(tag => allTags.add(tag));
                }
            });
            
            const tagArray = Array.from(allTags).slice(0, 10); // ÊúÄÂ§ß10ÂÄã
            
            if (tagArray.length > 0) {
                const suggestionsDiv = document.getElementById('tagSuggestions');
                const suggestionTagsDiv = suggestionsDiv.querySelector('.suggestion-tags');
                
                suggestionTagsDiv.innerHTML = tagArray.map(tag => 
                    `<span class="suggestion-tag" onclick="addTagToInput('${tag}')">${tag}</span>`
                ).join('');
                
                suggestionsDiv.style.display = 'block';
            }
        }

        // „Çø„Ç∞ÂÖ•Âäõ„Å´„Çø„Ç∞„ÇíËøΩÂä†
        function addTagToInput(tag) {
            // „É°„Ç§„É≥„Çø„Ç∞„Ç∑„Çπ„ÉÜ„É†„Å´Áµ±Âêà„Åï„Çå„Åü„Åü„ÇÅ„ÄÅ„Åì„ÅÆÊ©üËÉΩ„ÅØ‰∏çË¶Å
        }

        // „É°„Ç§„É≥„Çø„Ç∞Ê©üËÉΩ
        let selectedMainTagsArray = [];
        let allMainTags = new Set();
        
        function showMainTagSuggestions(input) {
            const suggestionsDiv = document.getElementById('mainTagSuggestions');
            const suggestionListDiv = suggestionsDiv.querySelector('.suggestion-list');
            
            if (!input.trim()) {
                // ÂÖ•Âäõ„ÅåÁ©∫„ÅÆÂ†¥Âêà„ÅØÂÖ®„Çø„Ç∞„ÇíË°®Á§∫
                displayAllMainTags(suggestionListDiv);
                suggestionsDiv.style.display = 'block';
                return;
            }
            
            // ÂÖ•Âäõ„Å´Âü∫„Å•„ÅÑ„Å¶„Éï„Ç£„É´„Çø„É™„É≥„Ç∞
            const filteredTags = Array.from(allMainTags).filter(tag => 
                tag.name.toLowerCase().includes(input.toLowerCase()) &&
                !selectedMainTagsArray.includes(tag.name)
            );
            
            if (filteredTags.length > 0) {
                suggestionListDiv.innerHTML = filteredTags.map(tag => `
                    <div class="folder-suggestion-item" onclick="addMainTag('${tag.name}')">
                        <span class="folder-icon">üè∑Ô∏è</span>
                        <span class="folder-name">${tag.name}</span>
                        <span class="folder-count">${tag.count}‰ª∂</span>
                    </div>
                `).join('');
                suggestionsDiv.style.display = 'block';
            } else {
                suggestionsDiv.style.display = 'none';
            }
        }
        
        function displayAllMainTags(container) {
            const availableTags = Array.from(allMainTags).filter(tag => 
                !selectedMainTagsArray.includes(tag.name)
            );
            
            if (availableTags.length === 0) {
                container.innerHTML = '<div class="folder-suggestion-item" style="color: #666; cursor: default;">„Çø„Ç∞„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>';
                return;
            }
            
            container.innerHTML = availableTags.map(tag => `
                <div class="folder-suggestion-item" onclick="addMainTag('${tag.name}')">
                    <span class="folder-icon">üè∑Ô∏è</span>
                    <span class="folder-name">${tag.name}</span>
                    <span class="folder-count">${tag.count}‰ª∂</span>
                </div>
            `).join('');
        }
        
        function addMainTag(tagName) {
            if (!selectedMainTagsArray.includes(tagName)) {
                selectedMainTagsArray.push(tagName);
                updateSelectedTagsDisplay();
                document.getElementById('mainTags').value = '';
                document.getElementById('mainTagSuggestions').style.display = 'none';
            }
        }
        
        function removeMainTag(tagName) {
            selectedMainTagsArray = selectedMainTagsArray.filter(tag => tag !== tagName);
            updateSelectedTagsDisplay();
        }
        
        function updateSelectedTagsDisplay() {
            const container = document.getElementById('selectedMainTags');
            container.innerHTML = selectedMainTagsArray.map(tag => `
                <div class="selected-tag">
                    <span>üè∑Ô∏è ${tag}</span>
                    <span class="remove-tag" onclick="removeMainTag('${tag}')">√ó</span>
                </div>
            `).join('');
        }
        
        function getSelectedMainTags() {
            return selectedMainTagsArray;
        }
        
        function updateMainTagSuggestions(history) {
            allMainTags.clear();
            const tagCounts = {};
            
            history.forEach(item => {
                const mainTags = item.mainTags || [];
                mainTags.forEach(tag => {
                    tagCounts[tag] = (tagCounts[tag] || 0) + 1;
                });
            });
            
            Object.entries(tagCounts).forEach(([name, count]) => {
                allMainTags.add({ name, count });
            });
        }
        
        // Â§ñÈÉ®„ÇØ„É™„ÉÉ„ÇØ„Åß„Çµ„Ç∏„Çß„Çπ„ÉÅ„Éß„É≥„ÇíÈñâ„Åò„Çã
        document.addEventListener('click', function(event) {
            const mainTagContainer = document.querySelector('.main-tags-container');
            const suggestionsDiv = document.getElementById('mainTagSuggestions');
            
            if (!mainTagContainer.contains(event.target)) {
                suggestionsDiv.style.display = 'none';
            }
        });

        // „Ç¢„Ç≥„Éº„Éá„Ç£„Ç™„É≥Ê©üËÉΩ
        function toggleHistoryGroup(headerElement) {
            const group = headerElement.parentElement;
            const toggleIcon = headerElement.querySelector('.toggle-icon');
            
            if (group.classList.contains('collapsed')) {
                group.classList.remove('collapsed');
                toggleIcon.textContent = '‚ñº';
            } else {
                group.classList.add('collapsed');
                toggleIcon.textContent = '‚ñ∂';
            }
        }

        // „Éö„Éº„Ç∏Ë™≠„ÅøËæº„ÅøÊôÇ„Å´Â±•Ê≠¥„ÇíÂèñÂæó
        window.onload = function() {
            loadHistory();
            loadCostsAnalysis(); // „Éá„Éï„Ç©„É´„Éà„ÅßÂàÜÊûê„ÇíË™≠„ÅøËæº„Åø
            initializeResize(); // „É™„Çµ„Ç§„Ç∫Ê©üËÉΩ„ÇíÂàùÊúüÂåñ
            restoreLatestSession(); // ÊúÄÊñ∞„Çª„ÉÉ„Ç∑„Éß„É≥„ÇíÂæ©ÂÖÉ
            initializeChatInput(); // „ÉÅ„É£„ÉÉ„ÉàÂÖ•Âäõ„ÅÆÂàùÊúüÂåñ
        };

        // „ÉÅ„É£„ÉÉ„ÉàÂÖ•Âäõ„ÅÆÂàùÊúüÂåñ
        function initializeChatInput() {
            const chatInput = document.getElementById('chatInput');
            if (chatInput) {
                chatInput.addEventListener('keydown', function(event) {
                    if (event.key === 'Enter') {
                        if (event.shiftKey) {
                            // Shift+Enter„ÅßÈÄÅ‰ø°
                            event.preventDefault();
                            sendMessage();
                        }
                        // Enter„ÅÆ„Åø„ÅÆÂ†¥Âêà„ÅØÊîπË°åÔºà„Éá„Éï„Ç©„É´„ÉàÂãï‰ΩúÔºâ
                    }
                });
            }
        }

        // ÊúÄÊñ∞„Çª„ÉÉ„Ç∑„Éß„É≥„ÅÆË®≠ÂÆö„ÇíÂæ©ÂÖÉ„Åô„ÇãÈñ¢Êï∞ÔºàURL„ÅØÈô§„ÅèÔºâ
        async function restoreLatestSession() {
            try {
                const response = await fetch('/history');
                const historyData = await response.json();
                
                if (historyData.success && historyData.history && historyData.history.length > 0) {
                    const latestEntry = historyData.history[0];
                    
                    // URL„ÅØËá™ÂãïË®≠ÂÆö„Åó„Å™„ÅÑÔºà„É¶„Éº„Ç∂„Éº„ÅåÊâãÂãï„ÅßÂÖ•Âäõ„Åô„ÇãÔºâ
                    // if (latestEntry.url) {
                    //     document.getElementById('youtubeUrl').value = latestEntry.url;
                    // }
                    
                    // Ë®ÄË™ûË®≠ÂÆö„ÅÆ„ÅøÂæ©ÂÖÉ
                    if (latestEntry.language) {
                        document.getElementById('languageSelect').value = latestEntry.language;
                    }
                    
                    // „É¢„Éá„É´Ë®≠ÂÆö„ÅÆ„ÅøÂæ©ÂÖÉ
                    if (latestEntry.gptModel) {
                        document.getElementById('gptModelSelect').value = latestEntry.gptModel;
                    }
                    
                    // „Çª„ÉÉ„Ç∑„Éß„É≥Âæ©ÂÖÉ„ÅØË°å„Çè„Å™„ÅÑÔºà„É¶„Éº„Ç∂„Éº„ÅåÂ±•Ê≠¥„Åã„ÇâÊâãÂãï„ÅßÈÅ∏Êäû„Åô„ÇãÔºâ
                    // await displayExistingResult(latestEntry);
                    
                    console.log('üîÑ Restored settings from latest session (URL excluded)');
                }
            } catch (error) {
                console.error('Error restoring latest session:', error);
            }
        }

        async function checkForExistingContent() {
            const url = document.getElementById('youtubeUrl').value.trim();
            const language = document.getElementById('languageSelect').value;
            const gptModel = document.getElementById('gptModelSelect').value;
            // Hide all regenerate sections initially
            const summaryRegenerateSection = document.getElementById('summaryRegenerateSection');
            const transcriptRegenerateSection = document.getElementById('transcriptRegenerateSection');
            
            if (!url) {
                if (summaryRegenerateSection) summaryRegenerateSection.style.display = 'none';
                if (transcriptRegenerateSection) transcriptRegenerateSection.style.display = 'none';
                clearResults();
                return;
            }
            
            try {
                const response = await fetch('/history');
                const historyData = await response.json();
                
                const videoId = extractVideoId(url);
                if (!videoId) {
                    regenerateSection.style.display = 'none';
                    clearResults();
                    return;
                }
                
                // history„ÅåÈÖçÂàó„Åã„Å©„ÅÜ„Åã„ÉÅ„Çß„ÉÉ„ÇØ
                const history = Array.isArray(historyData) ? historyData : [];
                const existingEntry = history.find(item => 
                    item.id === videoId && 
                    item.language === language && 
                    item.gptModel === gptModel
                );
                
                if (existingEntry) {
                    // Êó¢Â≠ò„ÅÆÁµêÊûú„ÇíË°®Á§∫
                    await displayExistingResult(existingEntry);
                    if (summaryRegenerateSection) summaryRegenerateSection.style.display = 'block';
                    if (transcriptRegenerateSection) transcriptRegenerateSection.style.display = 'block';
                } else {
                    if (summaryRegenerateSection) summaryRegenerateSection.style.display = 'none';
                    if (transcriptRegenerateSection) transcriptRegenerateSection.style.display = 'none';
                    clearResults();
                }
            } catch (error) {
                console.error('Error checking existing content:', error);
                if (summaryRegenerateSection) summaryRegenerateSection.style.display = 'none';
                if (transcriptRegenerateSection) transcriptRegenerateSection.style.display = 'none';
                clearResults();
            }
        }
        
        function clearResults() {
            // ÁµêÊûú„Çí„ÇØ„É™„Ç¢ÔºàË¶ÅÁ¥†„ÅÆÂ≠òÂú®„ÉÅ„Çß„ÉÉ„ÇØ‰ªò„ÅçÔºâ
            const transcript = document.getElementById('transcript');
            const summary = document.getElementById('summary');
            const articleContent = document.getElementById('articleContent');
            const videoInfo = document.getElementById('videoInfo');
            const videoPlayer = document.getElementById('videoPlayer');
            
            if (transcript) transcript.innerHTML = '';
            if (summary) summary.innerHTML = '';
            if (articleContent) articleContent.innerHTML = '';
            if (videoInfo) videoInfo.style.display = 'none';
            if (videoPlayer) videoPlayer.style.display = 'none';
            isTranscriptReady = false;
        }
        
        async function displayExistingResult(entry) {
            try {
                // ÊñáÂ≠óËµ∑„Åì„ÅóÁµêÊûú„ÇíÂæ©ÂÖÉ
                currentTranscript = entry.transcript || '';
                currentTimestampedSegments = entry.timestampedSegments || [];
                isTranscriptReady = true;
                
                // Â±•Ê≠¥„Åã„ÇâÂèñÂæó„Åó„ÅüÂ†¥Âêà„ÅØÊñáÂ≠óËµ∑„Åì„ÅóÈñãÂßã„Éú„Çø„É≥„ÇíÈö†„Åó„ÄÅÂÜçÁîüÊàê„Çª„ÇØ„Ç∑„Éß„É≥„ÇíË°®Á§∫
                const uploadBtn = document.getElementById('uploadBtn');
                const uploadStatus = document.getElementById('uploadStatus');
                const summaryRegenerateSection = document.getElementById('summaryRegenerateSection');
                const transcriptRegenerateSection = document.getElementById('transcriptRegenerateSection');
                
                if (uploadBtn) uploadBtn.style.display = 'block';
                if (uploadStatus) uploadStatus.innerHTML = '<div style="color: #2d5016; background: #f0f9e8; padding: 0.5rem; border-radius: 6px; font-size: 0.9rem; margin: 0.5rem 0;">üìã Â±•Ê≠¥„Åã„ÇâÂèñÂæóÊ∏à„Åø - ÂÜçËß£Êûê„ÇÑÊñ∞„Åó„ÅÑÂãïÁîª„ÇíÂá¶ÁêÜ„Åß„Åç„Åæ„Åô</div>';
                if (summaryRegenerateSection) summaryRegenerateSection.style.display = 'block';
                if (transcriptRegenerateSection) transcriptRegenerateSection.style.display = 'block';
                
                // YouTube„Éó„É¨„Ç§„É§„Éº„ÇíÂàùÊúüÂåñÔºà„Ç®„É©„Éº„Éè„É≥„Éâ„É™„É≥„Ç∞‰ªò„ÅçÔºâ
                if (entry.id) {
                    try {
                        initializeYouTubePlayer(entry.id);
                    } catch (error) {
                        console.warn('YouTube player initialization failed:', error);
                        // „Éó„É¨„Ç§„É§„ÉºÂàùÊúüÂåñÂ§±Êïó„ÅØÁÑ°Ë¶ñ„Åó„Å¶Á∂öË°å
                    }
                }
                
                // „Çø„Ç§„É†„Çπ„Çø„É≥„Éó‰ªò„ÅçÊñáÂ≠óËµ∑„Åì„Åó„ÇíË°®Á§∫
                if (entry.timestampedTranscript) {
                    currentTimestampedTranscript = entry.timestampedTranscript;
                    displayTimestampedTranscript();
                } else {
                    // ÈÄöÂ∏∏„ÅÆÊñáÂ≠óËµ∑„Åì„Åó„ÇíË°®Á§∫
                    const transcriptDiv = document.getElementById('transcript');
                    transcriptDiv.innerHTML = entry.transcript ? entry.transcript.replace(/\n/g, '<br>') : '';
                    transcriptDiv.style.whiteSpace = 'pre-wrap';
                }
                
                // ÂãïÁîªÊÉÖÂ†±„ÇíË°®Á§∫
                if (entry.metadata) {
                    displayVideoInfo(entry.metadata, entry.method, entry.language, entry.detectedLanguage);
                }
                
                // Ë¶ÅÁ¥Ñ„ÇíË°®Á§∫
                if (entry.summary) {
                    displaySummary(entry.summary);
                    // Â±•Ê≠¥„Åã„ÇâÂæ©ÂÖÉ„Åó„ÅüÂ†¥Âêà„ÄÅË¶ÅÁ¥Ñ„Åã„ÇâÁõ¥Êé•Ê∑±Êéò„ÇäË≥™Âïè„ÇíÊäΩÂá∫
                    extractAndDisplayQuestionsFromSummary(entry.summary);
                }
                
                // Ëß£Ë™¨Ë®ò‰∫ã„ÇíË°®Á§∫
                if (entry.articleContent) {
                    // articleContent„Åå„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„ÅÆÂ†¥Âêà„ÄÅÈÅ©Âàá„Å™ÊñáÂ≠óÂàó„ÇíÂèñÂæó
                    let articleText = '';
                    if (typeof entry.articleContent === 'object' && entry.articleContent !== null) {
                        articleText = entry.articleContent.content || entry.articleContent.text || String(entry.articleContent);
                    } else if (typeof entry.articleContent === 'string') {
                        articleText = entry.articleContent;
                    } else {
                        articleText = String(entry.articleContent || '');
                    }
                    
                    // „Ç∞„É≠„Éº„Éê„É´Áä∂ÊÖã„Å´‰øùÂ≠ò
                    currentArticle = articleText;
                    currentArticleCostInfo = null; // Â±•Ê≠¥„Åã„Çâ„ÅÆÂæ©ÂÖÉÊôÇ„ÅØ„Ç≥„Çπ„ÉàÊÉÖÂ†±„Å™„Åó
                    
                    // Ë®ò‰∫ã„ÇíË°®Á§∫
                    displayArticle(articleText);
                }
                
                // „Ç≥„Çπ„Éà„ÇíË°®Á§∫
                if (entry.costs) {
                    updateCosts(entry.costs);
                }
                
                // Êé®Â•®Ë≥™Âïè„ÇíË™≠„ÅøËæº„Åø
                loadSuggestedQuestions();
                
                showMessage(`ÈÅéÂéª„ÅÆÁµêÊûú„ÇíË°®Á§∫„Åó„Åæ„Åó„Åü: ${entry.title || 'YouTubeÂãïÁîª'} (Â±•Ê≠¥„Åã„ÇâÂèñÂæó)`, 'success');
                
            } catch (error) {
                console.error('Error displaying existing result:', error);
                showMessage('ÈÅéÂéª„ÅÆÁµêÊûú„ÅÆË°®Á§∫‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü', 'error');
            }
        }

        async function regenerateContent(type) {
            const url = document.getElementById('youtubeUrl').value.trim();
            const language = document.getElementById('languageSelect').value;
            const gptModel = document.getElementById('gptModelSelect').value;
            const mainTags = getSelectedMainTags();
            
            if (!url) {
                showMessage('YouTube„ÅÆURL„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
                return;
            }

            // „Éú„Çø„É≥„ÅÆÁä∂ÊÖã„ÇíÊõ¥Êñ∞ (Êñ∞„Åó„ÅÑ„Éú„Çø„É≥ID)
            const transcriptBtn = document.getElementById('regenerateTranscriptOnlyBtn');
            const summaryBtn = document.getElementById('regenerateSummaryOnlyBtn');
            const bothBtn = document.getElementById('regenerateBothFromTranscriptBtn');
            
            // „Åô„Åπ„Å¶„ÅÆ„Éú„Çø„É≥„ÇíÁÑ°ÂäπÂåñ
            [transcriptBtn, summaryBtn, bothBtn].forEach(btn => {
                if (btn) btn.disabled = true;
            });
            
            try {
                let endpoint, bodyData, statusMessage;
                
                switch (type) {
                    case 'transcript':
                        endpoint = '/upload-youtube';
                        bodyData = { url, language, gptModel, mainTags, tags: '', forceRegenerate: true, regenerateType: 'transcript' };
                        statusMessage = 'üìù ÊñáÂ≠óËµ∑„Åì„Åó„ÇíÂÜçËß£Êûê‰∏≠...';
                        if (transcriptBtn) transcriptBtn.textContent = 'ÂÜçËß£Êûê‰∏≠...';
                        break;
                    case 'summary':
                        endpoint = '/regenerate-summary';
                        bodyData = { url, language, gptModel };
                        statusMessage = 'üìã Ë¶ÅÁ¥Ñ„ÇíÂÜçËß£Êûê‰∏≠...';
                        if (summaryBtn) summaryBtn.textContent = 'ÂÜçËß£Êûê‰∏≠...';
                        break;
                    case 'both':
                        endpoint = '/upload-youtube';
                        bodyData = { url, language, gptModel, mainTags, tags: '', forceRegenerate: true, regenerateType: 'both' };
                        statusMessage = 'üîÑ ÂÖ®„Å¶ÂÜçËß£Êûê‰∏≠...';
                        if (bothBtn) bothBtn.textContent = 'ÂÜçËß£Êûê‰∏≠...';
                        break;
                    default:
                        throw new Error('Invalid regenerate type');
                }
                
                showMessage(statusMessage, 'loading');
                
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(bodyData)
                });

                const result = await response.json();

                if (result.success) {
                    // ÁµêÊûú„ÇíË°®Á§∫
                    if (type === 'transcript' || type === 'both') {
                        // „Çø„Ç§„É†„Çπ„Çø„É≥„ÉóÊÉÖÂ†±„Çí‰øùÂ≠ò
                        currentTimestampedSegments = result.timestampedSegments || [];
                        
                        // YouTube„Éó„É¨„Ç§„É§„Éº„ÇíÂàùÊúüÂåñ
                        if (result.metadata?.basic?.videoId) {
                            initializeYouTubePlayer(result.metadata.basic.videoId);
                            setCurrentVideoId(result.metadata.basic.videoId);
                        }
                        
                        // ÊñáÂ≠óËµ∑„Åì„Åó„ÇíË°®Á§∫
                        fetch('/transcript')
                            .then(response => response.json())
                            .then(transcriptData => {
                                if (transcriptData.timestampedTranscript) {
                                    currentTimestampedTranscript = transcriptData.timestampedTranscript;
                                    displayTimestampedTranscript();
                                } else {
                                    const transcriptDiv = document.getElementById('transcript');
                                    transcriptDiv.innerHTML = result.transcript.replace(/\n/g, '<br>');
                                    transcriptDiv.style.whiteSpace = 'pre-wrap';
                                }
                            });
                        
                        // ÂãïÁîªÊÉÖÂ†±„ÇíË°®Á§∫
                        if (result.metadata) {
                            displayVideoInfo(result.metadata, result.method, result.language, result.detectedLanguage);
                        }
                    }
                    
                    if (type === 'summary' || type === 'both') {
                        // Ë¶ÅÁ¥Ñ„ÇíË°®Á§∫
                        if (result.summary) {
                            displaySummary(result.summary);
                            // Êñ∞„Åó„ÅèÁîüÊàê„Åï„Çå„ÅüË¶ÅÁ¥Ñ„Åã„ÇâÁõ¥Êé•Ê∑±Êéò„ÇäË≥™Âïè„ÇíÊäΩÂá∫
                            extractAndDisplayQuestionsFromSummary(result.summary);
                        } else {
                            // Ë¶ÅÁ¥Ñ„Åå„Å™„ÅÑÂ†¥Âêà„ÅØ„Çµ„Éº„Éê„ÉºAPI„Åã„ÇâÂèñÂæó„ÇíË©¶Ë°å
                            loadSuggestedQuestions();
                        }
                    }
                    
                    isTranscriptReady = true;
                    ensureChatInputVisible();
                    
                    // „Ç≥„Çπ„Éà„ÇíÊõ¥Êñ∞
                    if (result.costs) {
                        updateCosts(result.costs);
                    }
                    
                    // Â±•Ê≠¥„ÇíÊõ¥Êñ∞
                    loadHistory();
                    
                    const successMessage = type === 'transcript' ? 'ÊñáÂ≠óËµ∑„Åì„Åó„ÅÆÂÜçËß£Êûê„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„ÅüÔºÅ' :
                                          type === 'summary' ? 'Ë¶ÅÁ¥Ñ„ÅÆÂÜçËß£Êûê„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„ÅüÔºÅ' :
                                          'ÂÖ®„Å¶„ÅÆÂÜçËß£Êûê„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„ÅüÔºÅ';
                    showMessage(successMessage, 'success');
                    
                } else {
                    showMessage(`„Ç®„É©„Éº: ${result.error}`, 'error');
                }
                
            } catch (error) {
                console.error('Error regenerating content:', error);
                showMessage('ÂÜçËß£Êûê‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ„ÇÇ„ÅÜ‰∏ÄÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ„ÄÇ', 'error');
            } finally {
                // „Éú„Çø„É≥„ÅÆÁä∂ÊÖã„ÇíÂÖÉ„Å´Êàª„Åô
                [transcriptBtn, summaryBtn, bothBtn].forEach(btn => {
                    if (btn) btn.disabled = false;
                });
                
                if (transcriptBtn) transcriptBtn.textContent = 'üìù ÊñáÂ≠óËµ∑„Åì„Åó„ÅÆ„ÅøÂÜçËß£Êûê';
                if (summaryBtn) summaryBtn.textContent = 'üìã Ë¶ÅÁ¥Ñ„ÇíÂÜçËß£Êûê';
                if (bothBtn) bothBtn.textContent = 'üîÑ ÂÖ®„Å¶ÂÜçËß£Êûê';
            }
        }

        // „Éú„Çø„É≥„ÉÜ„Ç≠„Çπ„Éà„ÇíÂãïÁöÑ„Å´Êõ¥Êñ∞„Åô„ÇãÈñ¢Êï∞
        function updateUploadButtonText() {
            const uploadBtn = document.getElementById('uploadBtn');
            if (!uploadBtn) return;
            
            if (hasProcessedContent && currentTranscript && currentTranscript.trim() !== '') {
                uploadBtn.textContent = 'üîÑ ÂÜçËß£Êûê';
                uploadBtn.title = 'ÊñáÂ≠óËµ∑„Åì„Åó„Å®Ë¶ÅÁ¥Ñ„ÇíÂÜçÂÆüË°å„Åó„Åæ„Åô';
            } else {
                uploadBtn.textContent = 'Ëß£ÊûêÈñãÂßã';
                uploadBtn.title = 'ÂãïÁîª„ÅÆÊñáÂ≠óËµ∑„Åì„Åó„Å®Ë¶ÅÁ¥Ñ„ÇíÈñãÂßã„Åó„Åæ„Åô';
            }
        }

        // URL„ÅåÂ§âÊõ¥„Åï„Çå„ÅüÊôÇ„Å´„Éú„Çø„É≥„ÉÜ„Ç≠„Çπ„Éà„Çí„ÉÅ„Çß„ÉÉ„ÇØ„Åô„ÇãÈñ¢Êï∞
        function checkContentForCurrentUrl() {
            const url = document.getElementById('youtubeUrl').value.trim();
            if (!url) {
                hasProcessedContent = false;
                updateUploadButtonText();
                return;
            }
            
            // ÁèæÂú®„ÅÆURL„ÅßÂá¶ÁêÜÊ∏à„Åø„Ç≥„É≥„ÉÜ„É≥„ÉÑ„Åå„ÅÇ„Çã„Åã„ÉÅ„Çß„ÉÉ„ÇØ
            if (currentTranscript && currentTranscript.trim() !== '') {
                hasProcessedContent = true;
            } else {
                hasProcessedContent = false;
            }
            updateUploadButtonText();
        }

        async function uploadYouTube(forceRegenerate = false) {
            console.log('uploadYouTube called with forceRegenerate:', forceRegenerate);
            
            const url = document.getElementById('youtubeUrl').value.trim();
            const language = document.getElementById('languageSelect').value;
            const gptModel = document.getElementById('gptModelSelect').value;
            const uploadBtn = document.getElementById('uploadBtn');
            const uploadStatus = document.getElementById('uploadStatus');
            
            console.log('URL:', url);
            console.log('Language:', language);
            console.log('GPT Model:', gptModel);
            
            if (!url) {
                showMessage('YouTube„ÅÆURL„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
                return;
            }

            // „Ç≥„É≥„ÉÜ„É≥„ÉÑ„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØËá™ÂãïÁöÑ„Å´ÂÜçËß£Êûê„É¢„Éº„Éâ„Å´„Åô„Çã
            if (!forceRegenerate && hasProcessedContent && currentTranscript && currentTranscript.trim() !== '') {
                forceRegenerate = true;
                console.log('Auto-setting forceRegenerate to true due to existing content');
            }

            uploadBtn.disabled = true;
            
            let mainTags = [];
            let tags = '';
            
            try {
                mainTags = getSelectedMainTags();
            } catch (e) {
                console.warn('Failed to get main tags:', e);
                mainTags = [];
            }
            
            if (forceRegenerate) {
                showMessage('üîÑ ÂÜçÁîüÊàêÂá¶ÁêÜ„ÇíÈñãÂßã„Åó„Åæ„Åó„Åü„ÄÇÊñáÂ≠óËµ∑„Åì„Åó„Å®Ë¶ÅÁ¥Ñ„ÇíÊñ∞„Åó„ÅèÁîüÊàê‰∏≠...', 'loading');
            } else {
                uploadBtn.textContent = 'Âá¶ÁêÜ‰∏≠...';
                showMessage('YouTubeÂãïÁîª„ÇíÂá¶ÁêÜ‰∏≠„Åß„Åô„ÄÇ„Åó„Å∞„Çâ„Åè„ÅäÂæÖ„Å°„Åè„Å†„Åï„ÅÑ...', 'loading');
            }

            try {
                console.log('Sending request to /upload-youtube with:', { url, language, gptModel, mainTags, tags, forceRegenerate });
                
                const response = await fetch('/upload-youtube', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ url: url, language: language, gptModel: gptModel, mainTags: mainTags, tags: tags, forceRegenerate: forceRegenerate })
                });

                console.log('Response status:', response.status);
                console.log('Response headers:', response.headers);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                console.log('Response body:', result);

                if (result.success) {
                    // ÊñáÂ≠óËµ∑„Åì„ÅóÁµêÊûú„Çí‰øùÂ≠ò
                    currentTranscript = result.transcript || '';
                    // „Çø„Ç§„É†„Çπ„Çø„É≥„ÉóÊÉÖÂ†±„Çí‰øùÂ≠ò
                    currentTimestampedSegments = result.timestampedSegments || [];
                    
                    // YouTube„Éó„É¨„Ç§„É§„Éº„ÇíÂàùÊúüÂåñ
                    const videoId = extractVideoId(url);
                    if (videoId) {
                        initializeYouTubePlayer(videoId);
                    }
                    
                    // „Çø„Ç§„É†„Çπ„Çø„É≥„Éó‰ªò„ÅçÊñáÂ≠óËµ∑„Åì„Åó„ÇíÂèñÂæó„Åó„Å¶Ë°®Á§∫
                    fetch('/transcript')
                        .then(response => response.json())
                        .then(transcriptData => {
                            if (transcriptData.timestampedTranscript) {
                                currentTimestampedTranscript = transcriptData.timestampedTranscript;
                                displayTimestampedTranscript();
                            } else {
                                // „Çø„Ç§„É†„Çπ„Çø„É≥„Éó„Åå„Å™„ÅÑÂ†¥Âêà„ÅØÈÄöÂ∏∏„ÅÆÊñáÂ≠óËµ∑„Åì„Åó„ÇíË°®Á§∫
                                const transcriptDiv = document.getElementById('transcript');
                                transcriptDiv.innerHTML = result.transcript.replace(/\n/g, '<br>');
                                transcriptDiv.style.whiteSpace = 'pre-wrap';
                            }
                        });
                    
                    // ÂãïÁîªÊÉÖÂ†±„ÇíË°®Á§∫
                    if (result.metadata) {
                        displayVideoInfo(result.metadata, result.method, result.language, result.detectedLanguage);
                    }
                    
                    // Ë¶ÅÁ¥Ñ„ÇíË°®Á§∫
                    if (result.summary) {
                        displaySummary(result.summary);
                    }
                    
                    let message = forceRegenerate ? `ÂÜçÁîüÊàê„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„ÅüÔºÅÂãïÁîª: ${result.title}` : `ÊñáÂ≠óËµ∑„Åì„Åó„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„ÅüÔºÅÂãïÁîª: ${result.title}`;
                    if (result.fromHistory) {
                        message += ' (Â±•Ê≠¥„Åã„ÇâÂèñÂæó)';
                    } else {
                        const methodText = result.method === 'subtitle' ? 'YouTubeÂ≠óÂπï' : 'Whisper API';
                        message += ` (${methodText}‰ΩøÁî®)`;
                        if (forceRegenerate) {
                            message += ' - Êñ∞„Åó„ÅèÁîüÊàê';
                        }
                    }
                    
                    showMessage(message, 'success');
                    isTranscriptReady = true;
                    ensureChatInputVisible();
                    
                    // „Ç≥„É≥„ÉÜ„É≥„ÉÑÂá¶ÁêÜÂÆå‰∫Ü„Éï„É©„Ç∞„ÇíÊõ¥Êñ∞
                    hasProcessedContent = true;
                    
                    // Save URL to history (newest first)
                    saveUrlToHistory(url);
                    
                    // „Ç≥„Çπ„Éà„ÇíÊõ¥Êñ∞
                    if (result.costs) {
                        updateCosts(result.costs);
                    }
                    
                    // Ë¶ÅÁ¥Ñ„Åã„ÇâÁõ¥Êé•Ê∑±Êéò„ÇäË≥™Âïè„ÇíÊäΩÂá∫
                    if (result.summary) {
                        extractAndDisplayQuestionsFromSummary(result.summary);
                    } else {
                        // Ë¶ÅÁ¥Ñ„Åå„Å™„ÅÑÂ†¥Âêà„ÅØ„Çµ„Éº„Éê„ÉºAPI„Åã„ÇâÂèñÂæó„ÇíË©¶Ë°å
                        loadSuggestedQuestions();
                    }
                    
                    // Â±•Ê≠¥„ÇíÊõ¥Êñ∞
                    loadHistory();
                    
                    // ÂÜçÁîüÊàê„Çª„ÇØ„Ç∑„Éß„É≥„ÇíË°®Á§∫ÔºàÂá¶ÁêÜÂÆå‰∫ÜÂæå„ÅØÂ∏∏„Å´ÂÜçÁîüÊàêÂèØËÉΩÔºâ
                    const summaryRegenerateSection = document.getElementById('summaryRegenerateSection');
                    const transcriptRegenerateSection = document.getElementById('transcriptRegenerateSection');
                    if (summaryRegenerateSection) summaryRegenerateSection.style.display = 'block';
                    if (transcriptRegenerateSection) transcriptRegenerateSection.style.display = 'block';
                } else {
                    console.error('Upload failed:', result);
                    const errorMessage = result.message || result.error || 'Unknown error';
                    showMessage(`„Ç®„É©„Éº: ${errorMessage}`, 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showMessage(`„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: ${error.message}`, 'error');
            } finally {
                uploadBtn.disabled = false;
                uploadBtn.style.display = 'block';
                
                // „Éú„Çø„É≥„ÉÜ„Ç≠„Çπ„Éà„ÇíÂãïÁöÑ„Å´Êõ¥Êñ∞
                updateUploadButtonText();
                
                // ÂÜçÁîüÊàê„Çª„ÇØ„Ç∑„Éß„É≥„ÅØÂêÑ„Çø„Éñ„Å´ÂÄãÂà•„Å´ÈÖçÁΩÆ„Åï„Çå„Å¶„ÅÑ„Çã„ÅÆ„ÅßÁâπ„Å´Âá¶ÁêÜ‰∏çË¶Å
            }
        }

        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            const gptModel = document.getElementById('gptModelSelect').value;
            const chatBtn = document.getElementById('chatBtn');
            const chatMessages = document.getElementById('chatMessages');

            if (!message) return;

            if (!isTranscriptReady) {
                showMessage('„Åæ„ÅöÊúÄÂàù„Å´YouTubeÂãïÁîª„ÇíÊñáÂ≠óËµ∑„Åì„Åó„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ', 'info');
                return;
            }

            input.value = '';
            chatBtn.disabled = true;
            chatBtn.textContent = 'ÈÄÅ‰ø°‰∏≠...';

            addMessage(message, 'user');

            try {
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ message: message, gptModel: gptModel })
                });

                const result = await response.json();

                if (result.success) {
                    addMessage(result.response, 'ai');
                    
                    // „Ç≥„Çπ„Éà„ÇíÊõ¥Êñ∞
                    if (result.costs) {
                        updateCosts(result.costs);
                    }
                } else {
                    addMessage(`„Ç®„É©„Éº: ${result.error}`, 'ai');
                }
            } catch (error) {
                console.error('Error:', error);
                addMessage('„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ„ÇÇ„ÅÜ‰∏ÄÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ„ÄÇ', 'ai');
            } finally {
                chatBtn.disabled = false;
                chatBtn.textContent = 'ÈÄÅ‰ø°';
            }
        }

        function addMessage(text, type) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}-message`;
            
            if (type === 'ai') {
                // AI„É°„ÉÉ„Çª„Éº„Ç∏„ÅÆÂ†¥Âêà„ÄÅMarkdown„Çí„É¨„É≥„ÉÄ„É™„É≥„Ç∞„Åó„Å¶„Çø„Ç§„É†„Çπ„Çø„É≥„Éó„É™„É≥„ÇØ„ÇíÂá¶ÁêÜ
                let processedText = text;
                
                // Markdown„Çí„É¨„É≥„ÉÄ„É™„É≥„Ç∞
                if (typeof marked !== 'undefined') {
                    processedText = marked.parse(text);
                } else {
                    // marked„ÅåÂà©Áî®„Åß„Åç„Å™„ÅÑÂ†¥Âêà„ÅØÂü∫Êú¨ÁöÑ„Å™Â§âÊèõ
                    processedText = text
                        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')  // **Â§™Â≠ó**
                        .replace(/\*(.*?)\*/g, '<em>$1</em>')               // *Êñú‰Ωì*
                        .replace(/`(.*?)`/g, '<code>$1</code>')             // `„Ç≥„Éº„Éâ`
                        .replace(/\n/g, '<br>');                            // ÊîπË°å
                }
                
                // „Çø„Ç§„É†„Çπ„Çø„É≥„Éó„É™„É≥„ÇØ„ÇíÂá¶ÁêÜÔºàÊßò„ÄÖ„Å™ÂΩ¢Âºè„Å´ÂØæÂøúÔºâ
                processedText = processedText
                    .replace(/\[(\d{1,2}:\d{2}(?::\d{2})?)\]/g, function(match, timeStr) {
                        const seconds = timeToSeconds(timeStr);
                        return `<span class="timestamp-link" onclick="seekToTime(${seconds})">${match}</span>`;
                    })
                    .replace(/(\d{1,2}:\d{2}(?::\d{2})?)/g, function(match, timeStr) {
                        // []„ÅßÂõ≤„Åæ„Çå„Å¶„ÅÑ„Å™„ÅÑÊôÇÈñì„ÇÇÊ§úÂá∫„Åó„Å¶„É™„É≥„ÇØ„Å´„Åô„Çã
                        if (!match.includes('span')) { // Êó¢„Å´„É™„É≥„ÇØ„Å´„Å™„Å£„Å¶„ÅÑ„Å™„ÅÑÂ†¥Âêà„ÅÆ„Åø
                            const seconds = timeToSeconds(timeStr);
                            return `<span class="timestamp-link" onclick="seekToTime(${seconds})">${match}</span>`;
                        }
                        return match;
                    });
                
                messageDiv.innerHTML = processedText;
                
                // Ë®ò‰∫ã„Å´ÂèçÊò†„Éú„Çø„É≥„ÅØÂâäÈô§
            } else {
                messageDiv.textContent = text;
            }
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // „É°„ÉÉ„Çª„Éº„Ç∏Ë°®Á§∫Èñ¢Êï∞
        function showMessage(message, type = 'info') {
            const uploadStatus = document.getElementById('uploadStatus');
            if (uploadStatus) {
                let className = '';
                let icon = '';
                switch(type) {
                    case 'success':
                        className = 'success-message';
                        icon = '‚úÖ';
                        break;
                    case 'error':
                        className = 'error-message';
                        icon = '‚ùå';
                        break;
                    case 'loading':
                        className = 'loading-message';
                        icon = '‚è≥';
                        break;
                    case 'warning':
                        className = 'warning-message';
                        icon = '‚ö†Ô∏è';
                        break;
                    default:
                        className = 'info-message';
                        icon = '‚ÑπÔ∏è';
                }
                
                uploadStatus.innerHTML = `
                    <div class="${className}" style="padding: 0.75rem; border-radius: 6px; margin: 0.5rem 0; background: ${
                        type === 'success' ? '#f0fdf4' : 
                        type === 'error' ? '#fef2f2' : 
                        type === 'warning' ? '#fffbeb' :
                        type === 'loading' ? '#eff6ff' : '#f8fafc'
                    }; color: ${
                        type === 'success' ? '#166534' : 
                        type === 'error' ? '#991b1b' : 
                        type === 'warning' ? '#92400e' :
                        type === 'loading' ? '#1e40af' : '#374151'
                    }; border: 1px solid ${
                        type === 'success' ? '#bbf7d0' : 
                        type === 'error' ? '#fecaca' : 
                        type === 'warning' ? '#fde68a' :
                        type === 'loading' ? '#bfdbfe' : '#e5e7eb'
                    };">
                        ${icon} ${message}
                    </div>
                `;
                
                // „Ç®„É©„Éº„Åæ„Åü„ÅØÊàêÂäü„É°„ÉÉ„Çª„Éº„Ç∏„ÅØ5ÁßíÂæå„Å´Ëá™ÂãïÁöÑ„Å´Ê∂à„Åà„Çã
                if (type === 'success' || type === 'error' || type === 'warning') {
                    setTimeout(() => {
                        if (uploadStatus.innerHTML.includes(message)) {
                            uploadStatus.innerHTML = '';
                        }
                    }, 5000);
                }
            }
        }

        // Ë®ò‰∫ãÁ∑®ÈõÜÊ©üËÉΩ
        let isArticleEditing = false;
        let originalArticleContent = '';

        function toggleArticleEdit() {
            const articleContent = document.getElementById('articleContent');
            const articleEditor = document.getElementById('articleEditor');
            const articleEditArea = document.getElementById('articleEditArea');
            const saveBtn = document.getElementById('saveArticleBtn');
            const cancelBtn = document.getElementById('cancelArticleBtn');
            const editingStatus = document.getElementById('editingStatus');
            
            if (!isArticleEditing) {
                // Á∑®ÈõÜ„É¢„Éº„Éâ„Å´ÂÖ•„Çã
                isArticleEditing = true;
                
                // ÁèæÂú®„ÅÆË®ò‰∫ãÂÜÖÂÆπ„ÇíÂèñÂæóÔºàHTML„Åã„ÇâMarkdown„Å∏Ôºâ
                originalArticleContent = getMarkdownFromArticle();
                articleEditor.value = originalArticleContent;
                
                // UI„ÇíÁ∑®ÈõÜ„É¢„Éº„Éâ„Å´Âàá„ÇäÊõø„Åà
                articleContent.style.display = 'none';
                articleEditArea.style.display = 'block';
                saveBtn.style.display = 'inline-block';
                cancelBtn.style.display = 'inline-block';
                editingStatus.textContent = 'Á∑®ÈõÜ‰∏≠...';
                
                // „Ç®„Éá„Ç£„Çø„Å´„Éï„Ç©„Éº„Ç´„Çπ
                articleEditor.focus();
            } else {
                // Á∑®ÈõÜ„É¢„Éº„Éâ„ÇíÁµÇ‰∫Ü
                cancelArticleEdit();
            }
        }

        function saveArticleEdit() {
            const articleContent = document.getElementById('articleContent');
            const articleEditor = document.getElementById('articleEditor');
            const articleEditArea = document.getElementById('articleEditArea');
            const saveBtn = document.getElementById('saveArticleBtn');
            const cancelBtn = document.getElementById('cancelArticleBtn');
            const editingStatus = document.getElementById('editingStatus');
            
            const newContent = articleEditor.value;
            
            // Ë®ò‰∫ãÈÉ®ÂàÜ„ÅÆ„Åø„ÇíÊõ¥Êñ∞ÔºàÊó¢Â≠ò„ÅÆ„Ç≥„Çπ„ÉàÊÉÖÂ†±„Å™„Å©„ÅØ‰øùÊåÅÔºâ
            const articleMarkdown = articleContent.querySelector('.article-markdown');
            if (articleMarkdown) {
                // .article-markdown„ÅÆÈÉ®ÂàÜ„ÅÆ„Åø„ÇíÊõ¥Êñ∞
                if (typeof marked !== 'undefined') {
                    articleMarkdown.innerHTML = marked.parse(newContent);
                } else {
                    articleMarkdown.innerHTML = newContent.replace(/\n/g, '<br>');
                }
                
                // „Çø„Ç§„É†„Çπ„Çø„É≥„Éó„É™„É≥„ÇØ„ÇíÂá¶ÁêÜ
                processTimestampLinks(articleMarkdown);
            } else {
                // .article-markdown„ÅåË¶ã„Å§„Åã„Çâ„Å™„ÅÑÂ†¥Âêà„ÅØÂÖ®‰Ωì„ÇíÊõ¥Êñ∞
                if (typeof marked !== 'undefined') {
                    articleContent.innerHTML = marked.parse(newContent);
                } else {
                    articleContent.innerHTML = newContent.replace(/\n/g, '<br>');
                }
                
                // „Çø„Ç§„É†„Çπ„Çø„É≥„Éó„É™„É≥„ÇØ„ÇíÂá¶ÁêÜ
                processTimestampLinks(articleContent);
            }
            
            // ÁîüÊàê„Åï„Çå„ÅüMarkdown„Çí‰øùÂ≠ò
            window.generatedArticleMarkdown = newContent;
            
            // ÁèæÂú®„ÅÆË®ò‰∫ã„Å®„Åó„Å¶‰øùÂ≠ò
            if (currentVideoId) {
                // „Çµ„Éº„Éê„Éº„Å´‰øùÂ≠ò
                saveArticleToServer(newContent);
            }
            
            // UI„ÇíÈÄöÂ∏∏„É¢„Éº„Éâ„Å´Êàª„Åô
            isArticleEditing = false;
            articleContent.style.display = 'block';
            articleEditArea.style.display = 'none';
            saveBtn.style.display = 'none';
            cancelBtn.style.display = 'none';
            editingStatus.textContent = '';
            
            showMessage('‚úÖ Ë®ò‰∫ã„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü', 'success');
        }

        function cancelArticleEdit() {
            const articleContent = document.getElementById('articleContent');
            const articleEditArea = document.getElementById('articleEditArea');
            const saveBtn = document.getElementById('saveArticleBtn');
            const cancelBtn = document.getElementById('cancelArticleBtn');
            const editingStatus = document.getElementById('editingStatus');
            
            // UI„ÇíÈÄöÂ∏∏„É¢„Éº„Éâ„Å´Êàª„Åô
            isArticleEditing = false;
            articleContent.style.display = 'block';
            articleEditArea.style.display = 'none';
            saveBtn.style.display = 'none';
            cancelBtn.style.display = 'none';
            editingStatus.textContent = '';
        }

        function getMarkdownFromArticle() {
            const articleDiv = document.getElementById('articleContent');
            if (!articleDiv) return '';
            
            // Ë®ò‰∫ã„ÅÆMarkdownÈÉ®ÂàÜ„ÅÆ„Åø„ÇíÊäΩÂá∫Ôºà.article-markdown„ÇØ„É©„Çπ„ÅÆË¶ÅÁ¥†Ôºâ
            const articleMarkdown = articleDiv.querySelector('.article-markdown');
            if (!articleMarkdown) {
                // .article-markdown„ÅåË¶ã„Å§„Åã„Çâ„Å™„ÅÑÂ†¥Âêà„ÅØ„ÄÅwindow.generatedArticleMarkdown„Åã„ÇâÂèñÂæó
                return window.generatedArticleMarkdown || '';
            }
            
            // HTML„ÇíMarkdown„Å´Â§âÊèõ„Åô„ÇãÁ∞°ÊòìÂÆüË£Ö
            let markdown = '';
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = articleMarkdown.innerHTML;
            
            // ÂêÑË¶ÅÁ¥†„ÇíÂá¶ÁêÜ
            const walker = document.createTreeWalker(
                tempDiv,
                NodeFilter.SHOW_ELEMENT | NodeFilter.SHOW_TEXT,
                null,
                false
            );
            
            let node;
            let lastNodeName = '';
            while (node = walker.nextNode()) {
                if (node.nodeType === Node.TEXT_NODE) {
                    markdown += node.textContent;
                } else if (node.nodeType === Node.ELEMENT_NODE) {
                    const nodeName = node.nodeName.toLowerCase();
                    
                    switch (nodeName) {
                        case 'h1':
                            markdown += '\n# ' + node.textContent + '\n\n';
                            walker.nextSibling();
                            break;
                        case 'h2':
                            markdown += '\n## ' + node.textContent + '\n\n';
                            walker.nextSibling();
                            break;
                        case 'h3':
                            markdown += '\n### ' + node.textContent + '\n\n';
                            walker.nextSibling();
                            break;
                        case 'p':
                            markdown += node.textContent + '\n\n';
                            walker.nextSibling();
                            break;
                        case 'br':
                            markdown += '\n';
                            break;
                        case 'strong':
                        case 'b':
                            markdown += '**' + node.textContent + '**';
                            walker.nextSibling();
                            break;
                        case 'em':
                        case 'i':
                            markdown += '*' + node.textContent + '*';
                            walker.nextSibling();
                            break;
                        case 'code':
                            if (node.parentNode.nodeName.toLowerCase() === 'pre') {
                                markdown += '```\n' + node.textContent + '\n```\n\n';
                                walker.nextSibling();
                                walker.nextSibling();
                            } else {
                                markdown += '`' + node.textContent + '`';
                                walker.nextSibling();
                            }
                            break;
                        case 'ul':
                        case 'ol':
                            const listItems = node.querySelectorAll('li');
                            listItems.forEach((li, index) => {
                                if (nodeName === 'ul') {
                                    markdown += '- ' + li.textContent + '\n';
                                } else {
                                    markdown += (index + 1) + '. ' + li.textContent + '\n';
                                }
                            });
                            markdown += '\n';
                            walker.nextSibling();
                            break;
                    }
                }
            }
            
            return markdown.trim();
        }

        async function saveArticleToServer(articleContent) {
            if (!currentVideoId) return;
            
            try {
                const response = await fetch('/save-article', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        videoId: currentVideoId,
                        article: articleContent
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    console.log('‚úÖ Article saved to server');
                }
            } catch (error) {
                console.error('Failed to save article:', error);
            }
        }
        
        // „Éó„É≠„É≥„Éó„ÉàË®≠ÂÆöÈñ¢Êï∞
        function togglePromptSettings(type) {
            const content = document.getElementById(type + 'PromptSettings');
            const arrow = document.getElementById(type + 'PromptArrow');
            
            if (content.style.display === 'none' || content.style.display === '') {
                content.style.display = 'block';
                arrow.textContent = '‚ñ≤';
                // ÂàùÂõûË°®Á§∫ÊôÇ„Å´„Éó„É≠„É≥„Éó„Éà„ÇíË™≠„ÅøËæº„ÇÄ
                loadPromptForTextarea(type);
            } else {
                content.style.display = 'none';
                arrow.textContent = '‚ñº';
            }
        }
        
        // ÊóßUI„ÅÆ„ÉÜ„Ç≠„Çπ„Éà„Ç®„É™„Ç¢„Å´„Éó„É≠„É≥„Éó„Éà„ÇíË™≠„ÅøËæº„ÇÄ
        async function loadPromptForTextarea(type) {
            try {
                const response = await fetch('/prompts');
                const prompts = await response.json();
                const textarea = document.getElementById(type + 'PromptText');
                
                if (textarea) {
                    let currentPrompt = prompts[type]?.template || '';
                    // \n„ÇíÂÆüÈöõ„ÅÆÊîπË°å„Å´Â§âÊèõ„Åó„Å¶Ë°®Á§∫
                    currentPrompt = currentPrompt.replace(/\\n/g, '\n');
                    textarea.value = currentPrompt;
                }
            } catch (error) {
                console.error('Error loading prompt:', error);
            }
        }
        
        // ÊóßUI„ÅÆ‰øùÂ≠òÈñ¢Êï∞
        async function savePrompt(type) {
            const textarea = document.getElementById(type + 'PromptText');
            if (!textarea) return;
            
            let template = textarea.value;
            // ÊîπË°å„ÅØ„Åù„ÅÆ„Åæ„Åæ‰øùÂ≠òÔºàJSON.stringify„ÅåËá™ÂãïÁöÑ„Å´„Ç®„Çπ„Ç±„Éº„Éó„Åô„ÇãÔºâ
            // template = template.replace(/\n/g, '\\n'); // „Åì„ÅÆË°å„ÇíÂâäÈô§
            
            try {
                const response = await fetch('/prompts/save', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        type: type,
                        template: template
                    })
                });
                
                const result = await response.json();
                const messageDiv = document.getElementById(type + 'PromptMessage');
                
                if (result.success) {
                    if (messageDiv) {
                        messageDiv.style.display = 'block';
                        messageDiv.style.background = '#d4edda';
                        messageDiv.style.color = '#155724';
                        messageDiv.textContent = '‚úÖ „Éó„É≠„É≥„Éó„Éà„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü';
                        setTimeout(() => {
                            messageDiv.style.display = 'none';
                        }, 3000);
                    }
                } else {
                    if (messageDiv) {
                        messageDiv.style.display = 'block';
                        messageDiv.style.background = '#f8d7da';
                        messageDiv.style.color = '#721c24';
                        messageDiv.textContent = '‚ùå ‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü';
                    }
                }
            } catch (error) {
                console.error('Error saving prompt:', error);
                const messageDiv = document.getElementById(type + 'PromptMessage');
                if (messageDiv) {
                    messageDiv.style.display = 'block';
                    messageDiv.style.background = '#f8d7da';
                    messageDiv.style.color = '#721c24';
                    messageDiv.textContent = '‚ùå ‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü';
                }
            }
        }
        
        // „É™„Çª„ÉÉ„ÉàÈñ¢Êï∞
        async function resetPrompt(type) {
            if (!confirm('„Éó„É≠„É≥„Éó„Éà„Çí„Éá„Éï„Ç©„É´„Éà„Å´Êàª„Åó„Åæ„Åô„ÅãÔºü')) return;
            
            try {
                // „Éá„Éï„Ç©„É´„Éà„Éó„É≠„É≥„Éó„Éà„ÇíÁ©∫ÊñáÂ≠ó„Å®„Åó„Å¶‰øùÂ≠òÔºà„Çµ„Éº„Éê„ÉºÂÅ¥„Åß„Éá„Éï„Ç©„É´„Éà„ÅåÈÅ©Áî®„Åï„Çå„ÇãÔºâ
                const response = await fetch('/prompts/save', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        type: type,
                        template: ''
                    })
                });
                
                if (response.ok) {
                    // „Éó„É≠„É≥„Éó„Éà„ÇíÂÜçË™≠„ÅøËæº„Åø
                    loadPromptForTextarea(type);
                    
                    const messageDiv = document.getElementById(type + 'PromptMessage');
                    if (messageDiv) {
                        messageDiv.style.display = 'block';
                        messageDiv.style.background = '#d4edda';
                        messageDiv.style.color = '#155724';
                        messageDiv.textContent = '‚úÖ „Éá„Éï„Ç©„É´„Éà„Å´Êàª„Åó„Åæ„Åó„Åü';
                        setTimeout(() => {
                            messageDiv.style.display = 'none';
                        }, 3000);
                    }
                }
            } catch (error) {
                console.error('Error resetting prompt:', error);
            }
        }
        
        async function loadPromptSettings(type) {
            try {
                const response = await fetch('/prompts');
                const prompts = await response.json();
                
                const container = document.getElementById(type + 'PromptSettings');
                let currentPrompt = prompts[type]?.template || '';
                
                // \n„ÇíÂÆüÈöõ„ÅÆÊîπË°å„Å´Â§âÊèõ„Åó„Å¶Ë°®Á§∫
                currentPrompt = currentPrompt.replace(/\\n/g, '\n');
                
                container.innerHTML = `
                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">„Éó„É≠„É≥„Éó„Éà„ÉÜ„É≥„Éó„É¨„Éº„Éà:</label>
                        <textarea id="${type}PromptTemplate" style="width: 100%; height: 200px; padding: 0.75rem; border: 1px solid #e2e8f0; border-radius: 6px; font-family: 'Consolas', 'Monaco', monospace; font-size: 0.9rem;" placeholder="„Éó„É≠„É≥„Éó„Éà„ÉÜ„É≥„Éó„É¨„Éº„Éà„ÇíÂÖ•Âäõ...">${currentPrompt.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</textarea>
                    </div>
                    <div style="text-align: right;">
                        <button onclick="savePromptSettings('${type}')" style="background: #4f46e5; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer;">‰øùÂ≠ò</button>
                        <button onclick="resetPromptSettings('${type}')" style="background: #6b7280; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; margin-left: 0.5rem;">„É™„Çª„ÉÉ„Éà</button>
                    </div>
                `;
            } catch (error) {
                console.error('Error loading prompt settings:', error);
            }
        }
        
        async function savePromptSettings(type) {
            let template = document.getElementById(type + 'PromptTemplate').value;
            
            // ÊîπË°å„ÅØ„Åù„ÅÆ„Åæ„Åæ‰øùÂ≠òÔºàJSON.stringify„ÅåËá™ÂãïÁöÑ„Å´„Ç®„Çπ„Ç±„Éº„Éó„Åô„ÇãÔºâ
            // template = template.replace(/\n/g, '\\n'); // „Åì„ÅÆË°å„ÇíÂâäÈô§
            
            try {
                const response = await fetch('/prompts/save', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        type: type,
                        template: template
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    showMessage('‚úÖ „Éó„É≠„É≥„Éó„ÉàË®≠ÂÆö„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü', 'success');
                } else {
                    showMessage('‚ùå „Éó„É≠„É≥„Éó„ÉàË®≠ÂÆö„ÅÆ‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
                }
            } catch (error) {
                console.error('Error saving prompt settings:', error);
                showMessage('‚ùå „Éó„É≠„É≥„Éó„ÉàË®≠ÂÆö„ÅÆ‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
            }
        }
        
        function resetPromptSettings(type) {
            document.getElementById(type + 'PromptTemplate').value = '';
            showMessage('„Éó„É≠„É≥„Éó„Éà„Çí„É™„Çª„ÉÉ„Éà„Åó„Åæ„Åó„Åü', 'info');
        }
        
        // ÂàÜÊûê„Çø„Éñ„ÅÆÊñôÈáë„Éá„Éº„ÇøË™≠„ÅøËæº„Åø
        async function loadCostsAnalysis() {
            const periodSelect = document.getElementById('periodSelect');
            const period = periodSelect ? periodSelect.value : 'today';
            await loadCostData(period, 'analysis');
        }
        
        // „Ç∞„É©„Éï„Çø„Éñ„ÅÆÊñôÈáë„Éá„Éº„ÇøË™≠„ÅøËæº„Åø
        async function loadCostsGraph() {
            const graphPeriodSelect = document.getElementById('graphPeriodSelect');
            const period = graphPeriodSelect ? graphPeriodSelect.value : 'today';
            await loadCostData(period, 'graph');
        }
        
        async function loadCostData(period = 'today', tabType = 'analysis') {
            try {
                // „Çª„ÉÉ„Ç∑„Éß„É≥„Éá„Éº„Çø„ÅÆÂ†¥Âêà„ÅØ /session-costs „Ç®„É≥„Éâ„Éù„Ç§„É≥„Éà„Çí‰ΩøÁî®
                if (period === 'session') {
                    const sessionResponse = await fetch('/session-costs');
                    if (!sessionResponse.ok) {
                        throw new Error(`HTTP ${sessionResponse.status}: ${sessionResponse.statusText}`);
                    }
                    const sessionCosts = await sessionResponse.json();
                    displaySessionCosts(sessionCosts, tabType);
                    return;
                }
                
                // Â±•Ê≠¥„Éá„Éº„Çø„ÅåÂøÖË¶Å„Å™Â†¥Âêà„ÅÆ„Åø /costs „Ç®„É≥„Éâ„Éù„Ç§„É≥„Éà„ÇíÂëº„Å≥Âá∫„Åó
                const response = await fetch('/costs');
                if (!response.ok) {
                    throw new Error(`Costs API error! status: ${response.status}`);
                }
                
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    throw new Error('Response is not JSON');
                }
                
                const costs = await response.json();
                
                let filteredCosts = costs;
                const now = new Date();
                
                switch (period) {
                    case 'today':
                        const today = now.toISOString().split('T')[0];
                        filteredCosts = costs.filter(cost => cost.date === today);
                        break;
                    case 'week':
                        const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                        filteredCosts = costs.filter(cost => new Date(cost.timestamp) >= weekAgo);
                        break;
                    case 'month':
                        const monthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                        filteredCosts = costs.filter(cost => new Date(cost.timestamp) >= monthAgo);
                        break;
                }
                
                if (tabType === 'graph') {
                    console.log(`Displaying graph for ${period} with ${filteredCosts.length} records`);
                    
                    // „Éá„Éê„ÉÉ„Ç∞: „Éï„Ç£„É´„Çø„É™„É≥„Ç∞ÊúüÈñì„ÇíË°®Á§∫
                    if (period === 'week') {
                        const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                        console.log(`Week period: from ${weekAgo.toISOString()} to ${now.toISOString()}`);
                    } else if (period === 'month') {
                        const monthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                        console.log(`Month period: from ${monthAgo.toISOString()} to ${now.toISOString()}`);
                    }
                    
                    // Êó•‰ªò„Åî„Å®„ÅÆ„Ç≥„Çπ„Éà„ÇíÁ¢∫Ë™ç
                    const dateGroups = {};
                    filteredCosts.forEach(cost => {
                        const date = cost.date || cost.timestamp.split('T')[0];
                        if (!dateGroups[date]) {
                            dateGroups[date] = [];
                        }
                        dateGroups[date].push(cost);
                    });
                    console.log(`${period} - Dates with data:`, Object.keys(dateGroups).sort());
                    
                    // ÁâπÂÆö„ÅÆÊó•‰ªò„ÅÆ„Éá„Éº„Çø„ÇíË©≥„Åó„ÅèË°®Á§∫Ôºà„Éá„Éê„ÉÉ„Ç∞Áî®Ôºâ
                    const targetDate = '2025-06-18';
                    if (dateGroups[targetDate]) {
                        console.log(`${period} - ${targetDate} entries:`, dateGroups[targetDate].length);
                        const total = dateGroups[targetDate].reduce((sum, cost) => sum + cost.totalCost, 0);
                        console.log(`${period} - ${targetDate} total cost: $${total.toFixed(4)}`);
                    }
                    
                    displayPeriodGraph(filteredCosts, period);
                } else {
                    displayPeriodCosts(filteredCosts, period, tabType);
                }
                
            } catch (error) {
                console.error('Error loading cost data:', error);
                
                // „Ç®„É©„ÉºÊôÇ„ÅÆË°®Á§∫
                const container = tabType === 'analysis' ? 
                    document.getElementById('costsAnalysisResult') : 
                    document.getElementById('costsGraphResult');
                
                if (container) {
                    const isSessionPeriod = period === 'session';
                    const errorMessage = error.message.includes('Session costs') 
                        ? '„Çª„ÉÉ„Ç∑„Éß„É≥„Éá„Éº„Çø„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ„Çµ„Éº„Éê„Éº„ÅåËµ∑Âãï„Åó„Å¶„ÅÑ„Çã„ÅãÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ'
                        : error.message.includes('Costs API') 
                        ? 'Â±•Ê≠¥„Éá„Éº„Çø„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ„Çµ„Éº„Éê„Éº„ÅåÊ≠£Â∏∏„Å´Âãï‰Ωú„Åó„Å¶„ÅÑ„Çã„ÅãÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ'
                        : '„Éá„Éº„Çø„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ';
                    
                    container.innerHTML = `
                        <div style="padding: 1rem; background: #fef2f2; border: 1px solid #fecaca; border-radius: 8px; color: #dc2626;">
                            <h4 style="margin: 0 0 0.5rem 0;">‚ùå ${errorMessage}</h4>
                            <div style="margin: 0.5rem 0; font-size: 0.9rem;">
                                <p style="margin: 0;">ËÄÉ„Åà„Çâ„Çå„ÇãÂéüÂõ†:</p>
                                <ul style="margin: 0.5rem 0; padding-left: 1.2rem;">
                                    <li>„Çµ„Éº„Éê„Éº„ÅåËµ∑Âãï„Åó„Å¶„ÅÑ„Å™„ÅÑ</li>
                                    <li>„Éù„Éº„ÉàÁï™Âè∑„ÅåÁï∞„Å™„Çã</li>
                                    <li>„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØÊé•Á∂ö„ÅÆÂïèÈ°å</li>
                                </ul>
                            </div>
                            <button onclick="loadCostData('${period}', '${tabType}')" 
                                    style="background: #dc2626; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer; font-size: 0.9rem;">
                                ÂÜçË©¶Ë°å
                            </button>
                            <details style="margin-top: 0.5rem;">
                                <summary style="cursor: pointer; font-size: 0.8rem; color: #7f1d1d;">Ë©≥Á¥∞„Å™„Ç®„É©„ÉºÊÉÖÂ†±</summary>
                                <p style="margin: 0.5rem 0 0 0; font-size: 0.8rem; color: #7f1d1d; font-family: monospace;">${error.message}</p>
                            </details>
                        </div>
                    `;
                }
            }
        }
        
        function displaySessionCosts(sessionCosts, tabType = 'analysis') {
            const container = tabType === 'analysis' ? 
                document.getElementById('costsAnalysisResult') : 
                document.getElementById('costsGraphResult');
            
            if (container) {
                container.innerHTML = `
                    <div style="padding: 1rem; background: #f8fafc; border-radius: 8px;">
                        <h3 style="margin: 0 0 1rem 0; color: #374151;">üí∞ „Çª„ÉÉ„Ç∑„Éß„É≥‰ΩøÁî®ÊñôÈáë</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 1rem;">
                            <div style="text-align: center; padding: 0.5rem; background: white; border-radius: 6px; border: 1px solid #e2e8f0;">
                                <div style="font-size: 0.9rem; color: #6b7280;">Whisper</div>
                                <div style="font-size: 1.1rem; font-weight: 600; color: #059669;">$${sessionCosts.whisper.toFixed(4)}</div>
                            </div>
                            <div style="text-align: center; padding: 0.5rem; background: white; border-radius: 6px; border: 1px solid #e2e8f0;">
                                <div style="font-size: 0.9rem; color: #6b7280;">GPT</div>
                                <div style="font-size: 1.1rem; font-weight: 600; color: #0369a1;">$${sessionCosts.gpt.toFixed(4)}</div>
                            </div>
                            <div style="text-align: center; padding: 0.5rem; background: white; border-radius: 6px; border: 1px solid #e2e8f0;">
                                <div style="font-size: 0.9rem; color: #6b7280;">ÂêàË®à</div>
                                <div style="font-size: 1.1rem; font-weight: 600; color: #dc2626;">$${sessionCosts.total.toFixed(4)}</div>
                            </div>
                        </div>
                    </div>
                `;
            }
        }
        
        function displayPeriodCosts(costs, period, tabType = 'analysis') {
            const container = tabType === 'analysis' ? 
                document.getElementById('costsAnalysisResult') : 
                document.getElementById('costsGraphResult');
            
            const totalWhisper = costs.reduce((sum, cost) => sum + cost.whisperCost, 0);
            const totalGpt = costs.reduce((sum, cost) => sum + cost.gptCost, 0);
            const totalCost = costs.reduce((sum, cost) => sum + cost.totalCost, 0);
            
            const periodNames = {
                'today': 'Êú¨Êó•',
                'week': 'ÈÅéÂéª7Êó•Èñì',
                'month': 'ÈÅéÂéª30Êó•Èñì'
            };
            
            if (container) {
                container.innerHTML = `
                    <div style="padding: 1rem; background: #f8fafc; border-radius: 8px;">
                        <h3 style="margin: 0 0 1rem 0; color: #374151;">üí∞ ${periodNames[period]}„ÅÆ‰ΩøÁî®ÊñôÈáë</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
                            <div style="text-align: center; padding: 0.5rem; background: white; border-radius: 6px; border: 1px solid #e2e8f0;">
                                <div style="font-size: 0.9rem; color: #6b7280;">Whisper</div>
                                <div style="font-size: 1.1rem; font-weight: 600; color: #059669;">$${totalWhisper.toFixed(4)}</div>
                            </div>
                            <div style="text-align: center; padding: 0.5rem; background: white; border-radius: 6px; border: 1px solid #e2e8f0;">
                                <div style="font-size: 0.9rem; color: #6b7280;">GPT</div>
                                <div style="font-size: 1.1rem; font-weight: 600; color: #0369a1;">$${totalGpt.toFixed(4)}</div>
                            </div>
                            <div style="text-align: center; padding: 0.5rem; background: white; border-radius: 6px; border: 1px solid #e2e8f0;">
                                <div style="font-size: 0.9rem; color: #6b7280;">ÂêàË®à</div>
                                <div style="font-size: 1.1rem; font-weight: 600; color: #dc2626;">$${totalCost.toFixed(4)}</div>
                            </div>
                        </div>
                        <div style="font-size: 0.9rem; color: #6b7280;">Âá¶ÁêÜ‰ª∂Êï∞: ${costs.length}‰ª∂</div>
                    </div>
                `;
            }
        }
        
        // „Ç∞„É©„ÉïË°®Á§∫Áî®„ÅÆÈñ¢Êï∞
        function displaySessionGraph(sessionCosts) {
            // „Çª„ÉÉ„Ç∑„Éß„É≥Ë°®Á§∫„ÅØÂâäÈô§
        }
        
        function displayPeriodGraph(costs, period) {
            const canvas = document.getElementById('costsChart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;
            
            // „Ç≠„É£„É≥„Éê„Çπ„Çí„ÇØ„É™„Ç¢
            ctx.clearRect(0, 0, width, height);
            
            const periodNames = {
                'today': 'Êú¨Êó•',
                'week': 'ÈÄ±Èñì',
                'month': 'ÊúàÈñì'
            };
            
            if (period === 'today') {
                // Êú¨Êó•„ÅÆÂ†¥Âêà„ÅØÊôÇÈñìÂà•„Å´ÈõÜË®à
                const hourData = {};
                // 0ÊôÇ„Åã„Çâ23ÊôÇ„Åæ„Åß„ÅÆ„Éá„Éº„Çø„ÇíÂàùÊúüÂåñ
                for (let i = 0; i < 24; i++) {
                    hourData[i] = { whisper: 0, gpt: 0, total: 0 };
                }
                
                costs.forEach(cost => {
                    const hour = new Date(cost.timestamp).getHours();
                    hourData[hour].whisper += cost.whisperCost;
                    hourData[hour].gpt += cost.gptCost;
                    hourData[hour].total += cost.totalCost;
                });
                
                // 24ÊôÇÈñì„Åô„Åπ„Å¶Ë°®Á§∫
                const hours = Array.from({length: 24}, (_, i) => i);
                const labels = hours.map(h => `${h}ÊôÇ`);
                
                drawLineChart(ctx, labels, hourData, width, height, `${periodNames[period]}„ÅÆÊôÇÈñìÂà•‰ΩøÁî®ÊñôÈáë`, period);
            } else {
                // ÈÄ±Èñì„ÉªÊúàÈñì„ÅÆÂ†¥Âêà„ÅØÊó•‰ªòÂà•„Å´ÈõÜË®à
                const dateData = {};
                costs.forEach(cost => {
                    // date„Éï„Ç£„Éº„É´„Éâ„ÇíÂÑ™ÂÖà„ÄÅ„Å™„Åë„Çå„Å∞timestamp„Åã„ÇâÊäΩÂá∫
                    const date = cost.date || (cost.timestamp ? cost.timestamp.split('T')[0] : null);
                    if (!date) {
                        console.warn('Cost entry missing date/timestamp:', cost);
                        return;
                    }
                    
                    if (!dateData[date]) {
                        dateData[date] = { whisper: 0, gpt: 0, total: 0 };
                    }
                    dateData[date].whisper += cost.whisperCost || 0;
                    dateData[date].gpt += cost.gptCost || 0;
                    dateData[date].total += cost.totalCost || 0;
                });
                
                // Êó•‰ªò„Åß„ÇΩ„Éº„Éà
                const sortedDates = Object.keys(dateData).sort();
                
                console.log(`${period} period - dates:`, sortedDates, 'data:', dateData);
                console.log(`${period} costs data:`, costs);
                // „É©„Éô„É´ÂΩ¢Âºè„ÇíË™øÊï¥ÔºàÊó•‰ªò„ÅÆ„ÅøË°®Á§∫Ôºâ
                const formattedLabels = sortedDates.map(date => date.substring(5)); // MM-DDÂΩ¢Âºè
                const formattedData = {};
                sortedDates.forEach((date, index) => {
                    formattedData[index] = dateData[date];
                });
                drawLineChart(ctx, formattedLabels, formattedData, width, height, `${periodNames[period]}‰ΩøÁî®ÊñôÈáë`, period);
            }
        }
        
        function drawLineChart(ctx, labels, data, width, height, title, period) {
            const padding = 40;
            const chartWidth = width - 2 * padding;
            const chartHeight = height - 2 * padding - 30;
            
            // „Çø„Ç§„Éà„É´„ÇíÊèèÁîª
            ctx.fillStyle = '#374151';
            ctx.font = '14px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText(title, width / 2, 20);
            
            if (labels.length === 0) {
                ctx.fillStyle = '#6b7280';
                ctx.font = '12px sans-serif';
                ctx.fillText('„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì', width / 2, height / 2);
                return;
            }
            
            // „Éá„Éº„Çø„ÅÆ„Ç≠„Éº„ÇíÂèñÂæóÔºàÊï∞ÂÄ§„Åæ„Åü„ÅØÊó•‰ªòÊñáÂ≠óÂàóÔºâ
            const dataKeys = Object.keys(data);
            
            // ÊúÄÂ§ßÂÄ§„ÇíË®àÁÆó
            const maxTotal = Math.max(...dataKeys.map(key => data[key].total || 0));
            
            // Ëª∏„ÇíÊèèÁîª
            ctx.strokeStyle = '#e2e8f0';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(padding, padding + 30);
            ctx.lineTo(padding, height - padding);
            ctx.lineTo(width - padding, height - padding);
            ctx.stroke();
            
            // YËª∏„ÅÆÁõÆÁõõ„Çä„ÇíÊèèÁîª
            const ySteps = 5;
            for (let i = 0; i <= ySteps; i++) {
                const y = padding + 30 + (chartHeight / ySteps) * i;
                const value = maxTotal * (1 - i / ySteps);
                
                ctx.fillStyle = '#6b7280';
                ctx.font = '9px sans-serif';
                ctx.textAlign = 'right';
                ctx.fillText(`$${value.toFixed(3)}`, padding - 5, y + 3);
                
                // „Ç∞„É™„ÉÉ„Éâ„É©„Ç§„É≥
                ctx.strokeStyle = '#f3f4f6';
                ctx.beginPath();
                ctx.moveTo(padding, y);
                ctx.lineTo(width - padding, y);
                ctx.stroke();
            }
            
            // „Éá„Éº„Çø„Éù„Ç§„É≥„Éà„ÅÆÂ∫ßÊ®ô„ÇíË®àÁÆó
            const xStep = chartWidth / (labels.length - 1 || 1);
            const points = {
                whisper: [],
                gpt: [],
                total: []
            };
            
            labels.forEach((label, index) => {
                const x = padding + index * xStep;
                // period„Ååtoday„ÅÆÂ†¥Âêà„ÅØÊôÇÈñìÔºàindexÔºâ„Çí„Ç≠„Éº„Å´„ÄÅ„Åù„Çå‰ª•Â§ñ„ÅØ„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ„Çí„Ç≠„Éº„Å´‰ΩøÁî®
                let currentData;
                if (period === 'today') {
                    // Êú¨Êó•„ÅÆÂ†¥Âêà„ÄÅlabel„Åã„ÇâÊôÇÈñì„ÇíÊäΩÂá∫
                    const hour = parseInt(label.replace('ÊôÇ', ''));
                    currentData = data[hour] || { whisper: 0, gpt: 0, total: 0 };
                } else {
                    // ÈÄ±Èñì„ÉªÊúàÈñì„ÅÆÂ†¥Âêà„ÅØ„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ„Çí‰ΩøÁî®
                    currentData = data[index] || { whisper: 0, gpt: 0, total: 0 };
                }
                
                const yWhisper = maxTotal > 0 ? height - padding - (currentData.whisper / maxTotal) * chartHeight : height - padding;
                const yGpt = maxTotal > 0 ? height - padding - (currentData.gpt / maxTotal) * chartHeight : height - padding;
                const yTotal = maxTotal > 0 ? height - padding - (currentData.total / maxTotal) * chartHeight : height - padding;
                
                points.whisper.push({ x, y: yWhisper });
                points.gpt.push({ x, y: yGpt });
                points.total.push({ x, y: yTotal });
                
                // XËª∏„É©„Éô„É´ÔºàÊúüÈñì„Å´Âøú„Åò„Å¶Ë°®Á§∫È†ªÂ∫¶„ÇíË™øÊï¥Ôºâ
                let shouldShowLabel = true;
                if (period === 'today') {
                    // Êú¨Êó•„ÅÆÂ†¥Âêà„ÄÅ3ÊôÇÈñì„Åî„Å®„Å´Ë°®Á§∫Ôºà0, 3, 6, 9, 12, 15, 18, 21ÊôÇÔºâ
                    shouldShowLabel = index % 3 === 0;
                } else if (period === 'week' && labels.length > 7) {
                    // ÈÄ±Èñì„ÅÆÂ†¥Âêà„ÄÅ7ÂÄã‰ª•‰∏ä„Å™„ÇâÈÅ©Â∫¶„Å´ÈñìÂºï„Åè
                    shouldShowLabel = index % Math.ceil(labels.length / 7) === 0 || index === labels.length - 1;
                } else if (period === 'month' && labels.length > 15) {
                    // ÊúàÈñì„ÅÆÂ†¥Âêà„ÄÅ15ÂÄã‰ª•‰∏ä„Å™„ÇâÈÅ©Â∫¶„Å´ÈñìÂºï„Åè
                    shouldShowLabel = index % Math.ceil(labels.length / 10) === 0 || index === labels.length - 1;
                }
                
                if (shouldShowLabel) {
                    ctx.fillStyle = '#6b7280';
                    ctx.font = '9px sans-serif';
                    ctx.textAlign = 'center';
                    ctx.save();
                    ctx.translate(x, height - padding + 15);
                    ctx.rotate(-Math.PI / 4);
                    ctx.fillText(label, 0, 0);
                    ctx.restore();
                }
            });
            
            // Á∑ö„ÇíÊèèÁîª
            const lines = [
                { points: points.whisper, color: '#059669', label: 'Whisper' },
                { points: points.gpt, color: '#0369a1', label: 'GPT' },
                { points: points.total, color: '#dc2626', label: 'ÂêàË®à' }
            ];
            
            lines.forEach(line => {
                // Á∑ö„ÇíÊèèÁîª
                ctx.strokeStyle = line.color;
                ctx.lineWidth = 2;
                ctx.beginPath();
                line.points.forEach((point, index) => {
                    if (index === 0) {
                        ctx.moveTo(point.x, point.y);
                    } else {
                        ctx.lineTo(point.x, point.y);
                    }
                });
                ctx.stroke();
                
                // „Éá„Éº„Çø„Éù„Ç§„É≥„Éà„ÇíÊèèÁîª
                line.points.forEach(point => {
                    ctx.fillStyle = line.color;
                    ctx.beginPath();
                    ctx.arc(point.x, point.y, 3, 0, 2 * Math.PI);
                    ctx.fill();
                });
            });
            
            // Âá°‰æã„ÇíÊèèÁîª
            const legendY = 40;
            lines.forEach((line, index) => {
                const legendX = width - 100;
                ctx.fillStyle = line.color;
                ctx.fillRect(legendX, legendY + index * 15, 10, 10);
                ctx.fillStyle = '#374151';
                ctx.font = '10px sans-serif';
                ctx.textAlign = 'left';
                ctx.fillText(line.label, legendX + 15, legendY + index * 15 + 8);
            });
        }
        
        // „Éö„Éº„Ç∏Ë™≠„ÅøËæº„ÅøÊôÇ„ÅÆÂàùÊúüÂåñ
        document.addEventListener('DOMContentLoaded', function() {
            // „Çª„ÉÉ„Ç∑„Éß„É≥ÊñôÈáë„Çí„Éá„Éï„Ç©„É´„ÉàË°®Á§∫
            setTimeout(() => {
                loadCostsAnalysis();
                loadCostsGraph();
            }, 1000); // 1ÁßíÂæÖ„Å£„Å¶„Åã„Çâ„É≠„Éº„Éâ
        });
        
        // „Çµ„Éº„Éê„ÉºÊé•Á∂ö„ÉÜ„Çπ„ÉàÈñ¢Êï∞
        async function testServerConnection() {
            try {
                const response = await fetch('/session-costs');
                return response.ok;
            } catch (error) {
                return false;
            }
        }

        // URL History Management Functions
        function getUrlHistory() {
            try {
                const historyString = localStorage.getItem('youtubeUrlHistory');
                console.log('Raw localStorage data:', historyString);
                const history = historyString ? JSON.parse(historyString) : [];
                console.log('Parsed URL history:', history);
                return history;
            } catch (error) {
                console.error('Error loading URL history:', error);
                return [];
            }
        }

        function saveUrlToHistory(url) {
            if (!url || !url.trim()) return;
            
            try {
                let history = getUrlHistory();
                
                // Remove the URL if it already exists (to avoid duplicates)
                history = history.filter(item => item.url !== url);
                
                // Add the new URL at the beginning (newest first)
                history.unshift({
                    url: url,
                    timestamp: new Date().toISOString(),
                    date: new Date().toLocaleDateString('ja-JP')
                });
                
                // Keep only the last 20 URLs
                if (history.length > 20) {
                    history = history.slice(0, 20);
                }
                
                localStorage.setItem('youtubeUrlHistory', JSON.stringify(history));
                updateUrlSuggestions();
            } catch (error) {
                console.error('Error saving URL to history:', error);
            }
        }

        function updateUrlSuggestions() {
            try {
                const datalist = document.getElementById('urlHistory');
                if (!datalist) {
                    console.warn('urlHistory datalist element not found');
                    return;
                }
                
                // Clear existing options
                datalist.innerHTML = '';
                
                const history = getUrlHistory();
                console.log('URL History loaded:', history);
                
                if (history.length === 0) {
                    console.log('No URL history found');
                    return;
                }
                
                // Add each URL as an option (newest first)
                history.forEach((item, index) => {
                    const option = document.createElement('option');
                    option.value = item.url;
                    option.textContent = `${item.url} (${item.date})`;
                    datalist.appendChild(option);
                    console.log(`Added URL option ${index + 1}:`, item.url);
                });
                
                console.log(`Updated ${history.length} URL suggestions`);
            } catch (error) {
                console.error('Error updating URL suggestions:', error);
            }
        }

        function clearUrlHistory() {
            try {
                localStorage.removeItem('youtubeUrlHistory');
                updateUrlSuggestions();
                console.log('URL history cleared');
            } catch (error) {
                console.error('Error clearing URL history:', error);
            }
        }
        
        // Debug functions for testing (available in console)
        window.debugUrlHistory = {
            show: () => {
                console.log('Current URL History:', getUrlHistory());
            },
            add: (url) => {
                saveUrlToHistory(url);
                console.log('Added URL:', url);
            },
            clear: () => {
                clearUrlHistory();
            },
            refresh: () => {
                updateUrlSuggestions();
            }
        };

        // Initialize URL suggestions and button state when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOMContentLoaded: Initializing URL suggestions and button state');
            updateUrlSuggestions();
            updateUploadButtonText();
            
            // URLÂÖ•Âäõ„Éï„Ç£„Éº„É´„Éâ„ÅÆÂ§âÊõ¥„ÇíÁõ£Ë¶ñ
            const urlInput = document.getElementById('youtubeUrl');
            if (urlInput) {
                urlInput.addEventListener('input', function() {
                    checkContentForCurrentUrl();
                });
                urlInput.addEventListener('blur', function() {
                    checkContentForCurrentUrl();
                });
            }
        });
        
        // Also try to initialize after a short delay for safety
        window.addEventListener('load', function() {
            setTimeout(() => {
                console.log('Window load: Re-initializing URL suggestions and button state');
                updateUrlSuggestions();
                updateUploadButtonText();
            }, 100);
        });
    </script>
</body>
</html>
